<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<title>Domácí start</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{--bg:#0f1720;--panel:#14212b;--border:#1e2c37;--text:#dbe6ef;--muted:#9bb3c6;--good:#1fb974;--warn:#efb33f;--bad:#ff6b6b;--chip:#1b2b38}
html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.wrap{max-width:1160px;margin:32px auto;padding:0 16px}
h1{margin:0 0 8px 0;font-weight:800}
.sub{color:var(--muted);margin-bottom:22px}
.grid{display:grid;gap:18px;grid-template-columns:1fr 1fr 1fr}
@media (max-width:1024px){.grid{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
.title{font-size:13px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.btn{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.pill{font-size:12px;border-radius:999px;padding:3px 8px;background:#113244;border:1px solid #214457;color:#a7c5d9}
.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.dep{display:flex;gap:10px;background:#10202b;border:1px solid var(--border);border-radius:12px;padding:10px 12px;align-items:center}
.line{min-width:44px;text-align:center;font-weight:700;background:#0e1a23;border:1px solid #22313d;border-radius:10px;padding:6px 8px}
.where{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.time{font-variant-numeric:tabular-nums}
.delay{font-size:12px;margin-left:8px}
.ok{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}
.muted{color:var(--muted)} .error{color:var(--bad);white-space:pre-wrap}
.foot{margin-top:8px;color:var(--muted);font-size:12px;word-break:break-all}
dialog{border:1px solid var(--border);border-radius:14px;background:var(--panel);color:var(--text);padding:20px}
dialog::backdrop{background:rgba(0,0,0,.5)}
input[type=text]{width:100%;background:#0e1a23;border:1px solid #22313d;border-radius:10px;color:var(--text);padding:10px 12px;box-sizing:border-box}
</style>
</head>
<body>
<div class="wrap">
  <h1>Domácí start</h1>
  <div class="sub">Soukromá nástěnka – počasí, MHD, dostupnost sítě a rychlé odkazy.</div>

  <div class="grid">
    <!-- POČASÍ -->
    <section class="card">
      <div class="title">Počasí (Vršovice)</div>
      <div id="wMain" class="muted" style="margin-top:12px">Načítám počasí…</div>
      <div id="wBadges" class="row" style="margin-top:10px;gap:10px"></div>
      <div id="wHours" class="list"></div>
    </section>

    <!-- MHD -->
    <section class="card">
      <div class="title">Odjezdy MHD</div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="dirBtn">Směr: Koh-i-noor</button>
        <div class="pill" id="stopPill">Slavia – nádraží Eden</div>
        <div style="flex:1"></div>
        <button class="btn" id="keyBtn">Změnit API klíč</button>
      </div>
      <div id="depList" class="list" style="min-height:48px;margin-top:12px"><span class="muted">Načítám…</span></div>
      <div id="depFoot" class="foot"></div>
    </section>

    <!-- SLUŽBY / INFO -->
    <section class="card">
      <div class="title">Domácí internet</div>
      <div class="muted" style="margin-top:12px">Pozn.: z veřejného webu je HTTP blokované (mixed content). Testuj lokálně nebo přes HTTPS tunel.</div>
    </section>

    <!-- ODKAZY -->
    <section class="card">
      <div class="title">Rychlé odkazy</div>
      <div id="links" class="list" style="margin-top:12px"></div>
    </section>

    <!-- ZPRÁVY -->
    <section class="card">
      <div class="title">iRozhlas.cz – nejnovější zprávy</div>
      <div id="news" class="list" style="margin-top:12px"><span class="muted">Stahuji…</span></div>
    </section>

    <section class="card">
      <div class="title">Domácí služby</div>
      <div class="muted" style="margin-top:12px">Plex / HA odkazy přes HTTP se z HTTPS nenačtou – to je v pořádku.</div>
    </section>
  </div>
</div>

<!-- Dialog pro API token -->
<dialog id="keyDlg">
  <form method="dialog">
    <h3 style="margin:0 0 8px 0">Golemio API klíč</h3>
    <p class="muted" style="margin:0 0 10px 0">Vlož svůj <em>X-Access-Token</em> (uloží se jen v tomto prohlížeči).</p>
    <input id="keyInput" type="text" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…" />
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" value="cancel">Zrušit</button>
      <button class="btn" value="ok">Uložit</button>
    </div>
  </form>
</dialog>

<script>
/* ====== KONFIG ====== */
const CONFIG = {
  weather: { lat:50.0704, lon:14.4709, tz:"Europe/Prague" },
  departures: {
    // >>> TADY JE TEN SPRÁVNÝ WORKER <<<
    proxyUrl: "https://golemioproxy.m88wqgcdpd.workers.dev",
    ids: "U680Z1P,U680Z2P,U680Z301", // A, B, vlak
    limit: 20,
    mode: "mins",
    minMinutes: 5,
    title: "Slavia – nádraží Eden"
  }
};
const LINKS = [
  { label:"E-mail", url:"https://mail.google.com" },
  { label:"Kalendář", url:"https://calendar.google.com" },
  { label:"Nextcloud", url:"https://cloud.example.com" }
];
const KEY_NAME="golemio_api_key";
const getToken=()=>localStorage.getItem(KEY_NAME)||"";
const setToken=v=>localStorage.setItem(KEY_NAME,v||"");
let DIR="A"; // A = Koh-i-noor, B = Kubánské nám.
/* ====== UTIL ====== */
const $=s=>document.querySelector(s);
const fmtHM=d=>`${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
const fmtISO=iso=>{const d=new Date(iso);return fmtHM(d);}
const minsTo=iso=>{const d=new Date(iso);return Math.max(0,Math.ceil((d-Date.now())/60000));}
const delayMin=(s,p)=>(!s||!p)?0:Math.round((new Date(p)-new Date(s))/60000);
const iconByType=t=>(t===0?"🚋":t===2?"🚆":t===3?"🚌":t===11?"🚎":"🧭");
/* ====== POČASÍ (Open-Meteo) ====== */
async function loadWeather(){
  try{
    const u=new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude",CONFIG.weather.lat);
    u.searchParams.set("longitude",CONFIG.weather.lon);
    u.searchParams.set("timezone",CONFIG.weather.tz);
    u.searchParams.set("current","temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,weather_code");
    u.searchParams.set("hourly","precipitation,precipitation_probability,weather_code,temperature_2m,wind_gusts_10m");
    u.searchParams.set("daily","temperature_2m_min,temperature_2m_max");
    u.searchParams.set("forecast_days","2");
    const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error("Počasí se nepodařilo načíst.");
    const j=await r.json();
    const c=j.current;
    const tMin=Math.round(j.daily.temperature_2m_min[0]);
    const tMax=Math.round(j.daily.temperature_2m_max[0]);
    // déšť
    const H=j.hourly.time.map(t=>new Date(t)); const now=Date.now();
    let nxt=-1,dur=0;
    for(let i=0;i<H.length;i++){const p=j.hourly.precipitation[i]||0;const pr=j.hourly.precipitation_probability[i]||0;
      if(H[i]>=now&&(p>0||pr>=30)){nxt=i;break;}
    }
    if(nxt>=0){for(let k=nxt;k<H.length;k++){const p=j.hourly.precipitation[k]||0;const pr=j.hourly.precipitation_probability[k]||0;if(p>0||pr>=30)dur++;else break;}}
    $("#wMain").innerHTML=
      `<div class="row" style="justify-content:space-between;gap:12px">
         <div>
           <div style="font-size:38px;font-weight:800">${Math.round(c.temperature_2m)}°C</div>
           <div class="muted" style="margin-top:6px">Dnes: min ${tMin}° / max ${tMax}°</div>
           <div class="muted">Pocitově ${Math.round(c.apparent_temperature)}°C, vlhkost ${c.relative_humidity_2m}%</div>
           <div class="muted">Vítr ${Math.round(c.wind_speed_10m)} km/h</div>
           <div class="muted">${nxt>=0?`Déšť za ~${Math.max(0,Math.round((H[nxt]-now)/60000))} min · ≈${dur} h`:"Beze srážek v nejbližších hodinách"}</div>
         </div>
       </div>`;
    const gustSoon=j.hourly.wind_gusts_10m.slice(0,6).reduce((a,b)=>Math.max(a,b||0),0);
    const probSoon=j.hourly.precipitation_probability.slice(0,6).reduce((a,b)=>Math.max(a,b||0),0);
    const badges=[];
    if(probSoon>=30) badges.push(`<span class="pill">☂️ Deštník se hodí</span>`);
    if(gustSoon>=60) badges.push(`<span class="pill">💨 Silný vítr</span>`);
    badges.push(`<a class="pill" href="https://www.chmi.cz/radary" target="_blank" rel="noopener">🛰️ Radar</a>`);
    $("#wBadges").innerHTML=badges.join("");
    // 3 hodiny
    const rows=[]; for(let i=0,sh=0;i<H.length&&sh<3;i++){ if(H[i]>=now){ const d=H[i];
      const hh=String(d.getHours()).padStart(2,"0"); const mm=d.getMinutes()===0?"00":String(d.getMinutes()).padStart(2,"0");
      const label=(mm==="00")?`${hh}:00`:`${hh} h`;
      const wind=Math.round(j.hourly.wind_gusts_10m[i]||0); const pr=j.hourly.precipitation[i]||0;
      rows.push(`<div class="row" style="justify-content:space-between"><span class="muted">${label}</span><span class="muted">💧 ${pr.toFixed(1)} mm/h</span><span class="muted">💨 ${wind} km/h</span></div>`); sh++;}}
    $("#wHours").innerHTML=rows.join("");
  }catch(e){ $("#wMain").innerHTML=`<div class="error">${e.message||e}</div>`; $("#wBadges").innerHTML=""; $("#wHours").innerHTML=""; }
}
/* ====== DEPARTURES ====== */
function buildProxyUrl(params){
  const base=CONFIG.departures.proxyUrl.replace(/\/+$/,'')+"/v2/pid/departureboards";
  const u=new URL(base);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v)));
  return u.toString();
}
async function fetchDepartures(){
  const token=getToken();
  if(!token) throw new Error("Chybí API klíč. Klikni na „Změnit API klíč“ a vlož svůj X-Access-Token.");
  const url=buildProxyUrl({
    ids:CONFIG.departures.ids,
    minutesBefore:0,
    minutesAfter:45,
    limit:CONFIG.departures.limit,
    preferredTimezone:"Europe/Prague",
    includeMetroTrains:true
  });
  const res=await fetch(url,{headers:{ "X-Access-Token":token, "Accept":"application/json" }});
  if(!res.ok){ const t=await res.text().catch(()=>res.status); throw new Error(`Chyba proxy: ${res.status}\n${t}`); }
  return res.json();
}
function renderDepartures(data){
  const list=$("#depList"); list.innerHTML="";
  const all=Array.isArray(data.departures)?data.departures:[];
  const filtered=all.filter(d=>{
    const type=d?.route?.type;
    if(type===2) return true; // vlaky vždy
    const plat=(d?.stop?.platform_code||"").toUpperCase();
    return plat===DIR;
  }).filter(d=>{
    const iso=d?.departure_timestamp?.predicted||d?.departure_timestamp?.scheduled;
    if(!iso) return false;
    return minsTo(iso) >= (CONFIG.departures.minMinutes||0);
  }).slice(0,CONFIG.departures.limit);
  if(!filtered.length){ list.innerHTML=`<div class="error">Žádné odjezdy ≥ ${CONFIG.departures.minMinutes} min pro směr ${DIR}.</div>`; return; }
  for(const d of filtered){
    const row=document.createElement("div"); row.className="dep";
    const ico=document.createElement("div"); ico.textContent=iconByType(d?.route?.type); ico.style.opacity=.85;
    const line=document.createElement("div"); line.className="line"; line.textContent=d?.route?.short_name||"?";
    const where=document.createElement("div"); where.className="where";
    const head=d?.trip?.headsign||d?.last_stop?.name||""; const plat=d?.stop?.platform_code?` · st. ${d.stop.platform_code}`:"";
    where.textContent=head+plat;
    const time=document.createElement("div"); time.className="time";
    const iso=d?.departure_timestamp?.predicted||d?.departure_timestamp?.scheduled;
    time.textContent=(CONFIG.departures.mode==="time")?fmtISO(iso):`${minsTo(iso)} min`;
    const del=delayMin(d?.departure_timestamp?.scheduled,d?.departure_timestamp?.predicted);
    if(del){ const sp=document.createElement("span"); sp.className="delay "+(del>0?"warn":"ok"); sp.textContent=(del>0?` +${del}`:` ${del}`); time.appendChild(sp); }
    row.append(ico,line,where,time); list.appendChild(row);
  }
  const called=buildProxyUrl({ids:CONFIG.departures.ids,minutesBefore:0,minutesAfter:45,limit:CONFIG.departures.limit,preferredTimezone:"Europe/Prague",includeMetroTrains:true});
  $("#depFoot").textContent=`${CONFIG.departures.title} · Poslední kontrola ${fmtHM(new Date())} · URL: ${called}`;
}
/* ====== NEWS (rss2json) ====== */
async function loadNews(){
  const feed="https://www.irozhlas.cz/rss/irozhlas";
  const api=new URL("https://api.rss2json.com/v1/api.json");
  api.searchParams.set("rss_url",feed);
  try{
    const r=await fetch(api.toString(),{cache:"no-store"}); if(!r.ok) throw new Error(`RSS HTTP ${r.status}`);
    const j=await r.json(); if(j.status!=="ok"||!Array.isArray(j.items)) throw new Error("RSS ve špatném formátu");
    $("#news").innerHTML=j.items.slice(0,8).map(it=>`<a class="btn" href="${it.link}" target="_blank" rel="noopener">${it.title}</a>`).join("");
  }catch(e){ $("#news").innerHTML=`<div class="error">${e.message||e}</div>`; }
}
/* ====== ODKAZY ====== */
function renderLinks(){ $("#links").innerHTML=LINKS.map(l=>`<a class="btn" href="${l.url}" target="_blank" rel="noopener">${l.label}</a>`).join(""); }
/* ====== INIT & UI ====== */
$("#stopPill").textContent=CONFIG.departures.title;
$("#dirBtn").addEventListener("click",()=>{ DIR = (DIR==="A"?"B":"A"); $("#dirBtn").textContent=`Směr: ${DIR==="A"?"Koh-i-noor":"Kubánské nám."}`; refreshDepartures(); });
const dlg=$("#keyDlg"), inp=$("#keyInput");
$("#keyBtn").addEventListener("click",()=>{ inp.value=getToken(); dlg.showModal(); });
dlg.addEventListener("close",()=>{ if(dlg.returnValue==="ok"){ setToken(inp.value.trim()); refreshDepartures(); }});
async function refreshDepartures(){ try{ const data=await fetchDepartures(); renderDepartures(data); } catch(e){ $("#depList").innerHTML=`<div class="error">${e.message||e}</div>`; $("#depFoot").textContent=""; } }
(async function(){
  renderLinks();
  await loadWeather();
  await loadNews();
  if(!getToken()) $("#keyBtn").click(); // vyžádá si token
  await refreshDepartures();
  setInterval(refreshDepartures,60*1000);
  setInterval(loadWeather,20*60*1000);
  setInterval(loadNews,30*60*1000);
})();
</script>
</body>
</html>
