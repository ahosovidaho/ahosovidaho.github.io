<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Dom√°c√≠ start</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1720; --panel:#14212b; --border:#1e2c37; --text:#dbe6ef; --muted:#9bb3c6;
      --good:#1fb974; --warn:#efb33f; --bad:#ff6b6b; --chip:#1b2b38;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1160px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);margin-bottom:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
    .title{font-size:13px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);display:flex;align-items:center;gap:8px}
    .row{display:flex;align-items:center;gap:8px}
    .spacer{flex:1}
    .btn{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .pill{font-size:12px;border-radius:999px;padding:3px 8px;background:#113244;border:1px solid #214457;color:#a7c5d9}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .dep{display:flex;align-items:center;gap:10px;background:#10202b;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .line{min-width:44px;text-align:center;font-weight:700;background:#0e1a23;border:1px solid #22313d;border-radius:10px;padding:6px 8px}
    .where{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-variant-numeric:tabular-nums}
    .delay{font-size:12px;margin-left:8px}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .error{color:var(--bad);white-space:pre-wrap}
    /* simple modal */
    dialog{border:1px solid var(--border);border-radius:14px;background:var(--panel);color:var(--text);padding:20px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    input[type=text]{width:100%;box-sizing:border-box;background:#0e1a23;border:1px solid #22313d;border-radius:10px;color:var(--text);padding:10px 12px}
    small{color:var(--muted)}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dom√°c√≠ start</h1>
    <div class="sub">Soukrom√° n√°stƒõnka ‚Äì poƒças√≠, MHD, dostupnost s√≠tƒõ a rychl√© odkazy.</div>

    <div class="grid">
      <!-- Poƒças√≠ placeholder -->
      <section class="card">
        <div class="title">Poƒças√≠</div>
        <div style="margin-top:14px" class="muted">Placeholder (beze zmƒõn).</div>
      </section>

      <!-- ODJEZDY MHD -->
      <section class="card" id="mhdCard">
        <div class="title">Odjezdy MHD</div>
        <div class="row" style="margin-top:10px;gap:10px">
          <button class="btn" id="dirBtn">Smƒõr: A</button>
          <div class="pill" id="titlePill">Slavia ‚Äì n√°dra≈æ√≠ Eden</div>
          <div class="spacer"></div>
          <button class="btn" id="apiBtn">Zmƒõnit API kl√≠ƒç</button>
        </div>
        <div id="mhdList" class="list" aria-live="polite" style="min-height:48px;margin-top:14px">
          <div class="muted">Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</div>
        </div>
        <div class="foot" id="mhdFoot"></div>
      </section>

      <!-- Internet placeholder -->
      <section class="card">
        <div class="title">Dom√°c√≠ internet</div>
        <div style="margin-top:14px" class="muted">Placeholder (beze zmƒõn).</div>
      </section>

      <!-- Dal≈°√≠ ≈ô√°dek -->
      <section class="card">
        <div class="title">Rychl√© odkazy</div>
        <div class="muted" style="margin-top:14px">Placeholder.</div>
      </section>

      <section class="card">
        <div class="title">iRozhlas.cz ‚Äì zpr√°vy</div>
        <div class="muted" style="margin-top:14px">Placeholder.</div>
      </section>

      <section class="card">
        <div class="title">Dom√°c√≠ slu≈æby</div>
        <div class="muted" style="margin-top:14px">Placeholder.</div>
      </section>
    </div>
  </div>

  <!-- Modal API key -->
  <dialog id="apiDlg">
    <form method="dialog">
      <h3 style="margin:0 0 8px 0">Golemio API kl√≠ƒç</h3>
      <p class="muted" style="margin:0 0 10px 0">Vlo≈æ sv≈Øj <em>X-Access-Token</em> (bude ulo≈æen pouze v tomto prohl√≠≈æeƒçi).</p>
      <input type="text" id="apiInput" autocomplete="off" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9‚Ä¶" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" value="cancel">Zru≈°it</button>
        <button class="btn" value="ok">Ulo≈æit</button>
      </div>
      <small>Tip: token m≈Ø≈æe≈° kdykoli zmƒõnit.</small>
    </form>
  </dialog>

  <script>
    // --- BEZPEƒåN√Å INICIALIZACE KONFIGU ---
    window.CONFIG = window.CONFIG || {};
    CONFIG.departures = CONFIG.departures || {};
    // URL tv√©ho Cloudflare Worker proxy (ta nyn√≠ funguje a p≈ôid√°v√° CORS + X-Access-Token)
    CONFIG.departures.proxyUrl = "https://golemioproxy.m88wqgcdpd.workers.dev";
    // V√Ωchoz√≠ nastaven√≠
    CONFIG.departures.ids = "U680Z1P,U680Z301"; // Slavia ‚Äì n√°dra≈æ√≠ Eden (A) + Praha-Eden vlak (S9)
    CONFIG.departures.title = "Slavia ‚Äì n√°dra≈æ√≠ Eden";
    CONFIG.departures.limit = 12;
    CONFIG.departures.mode = "mins"; // "mins" | "time"

    // --- UTIL ---
    const $ = sel => document.querySelector(sel);
    const fmtHHMM = iso => {
      const d = new Date(iso); const h = String(d.getHours()).padStart(2,'0'); const m = String(d.getMinutes()).padStart(2,'0');
      return `${h}:${m}`;
    };
    const minsTo = iso => {
      const d = new Date(iso); const diff = Math.ceil((d.getTime() - Date.now())/60000);
      return Math.max(0, diff);
    };
    const delayMin = (sched, pred) => {
      if(!sched || !pred) return 0;
      return Math.round((new Date(pred) - new Date(sched))/60000);
    };
    const iconByType = t => (t===0 ? "üöã" : t===2 ? "üöÜ" : t===3 ? "üöå" : t===11 ? "üöé" : "üß≠");

    // --- API KEY (localStorage) ---
    const KEY_NAME = "golemio_api_key";
    function getToken(){ return localStorage.getItem(KEY_NAME) || ""; }
    function setToken(v){ localStorage.setItem(KEY_NAME, v || ""); }

    // --- FETCH DEPARTURES p≈ôes proxy Worker ---
    async function fetchDepartures({ids, limit, minutesBefore=0, minutesAfter=45}) {
      const base = CONFIG.departures.proxyUrl.replace(/\/+$/,'') + "/v2/pid/departureboards";
      const url = new URL(base);
      url.searchParams.set("ids", ids);
      url.searchParams.set("minutesBefore", String(minutesBefore));
      url.searchParams.set("minutesAfter", String(minutesAfter));
      url.searchParams.set("limit", String(limit));
      url.searchParams.set("preferredTimezone", "Europe/Prague");
      url.searchParams.set("includeMetroTrains", "true");

      const token = getToken();
      if(!token) throw new Error("Chyb√≠ API kl√≠ƒç. Klikni na ‚ÄûZmƒõnit API kl√≠ƒç‚Äú a vlo≈æ X-Access-Token.");

      const res = await fetch(url.toString(), {
        headers: { "X-Access-Token": token, "Accept": "application/json" }
      });
      if(!res.ok){
        const txt = await res.text().catch(()=>String(res.status));
        throw new Error(`Chyba proxy: ${res.status}\n\n${txt}`);
      }
      return res.json();
    }

    // --- RENDER ---
    const listEl = $("#mhdList");
    const footEl = $("#mhdFoot");
    const titlePill = $("#titlePill");
    const dirBtn = $("#dirBtn");
    const apiBtn = $("#apiBtn");
    const apiDlg = $("#apiDlg");
    const apiInput = $("#apiInput");

    let currentPlatform = "A"; // p≈ôep√≠n√°me A <-> B (tram)
    titlePill.textContent = CONFIG.departures.title;

    function renderDepartures(data){
      listEl.innerHTML = "";
      const deps = Array.isArray(data.departures) ? data.departures.slice(0, CONFIG.departures.limit) : [];

      // Filtr smƒõru pro tramvaje: platform_code A/B
      const filtered = deps.filter(d => {
        const isTrain = (d?.route?.type === 2);
        if(isTrain) return true; // vlaky zobrazujeme obousmƒõrnƒõ
        const plat = d?.stop?.platform_code || "";
        return String(plat).toUpperCase() === currentPlatform.toUpperCase();
      });

      if(filtered.length === 0){
        const div = document.createElement("div");
        div.className = "error";
        div.textContent = `Nebyly nalezeny ≈æ√°dn√© odjezdy pro zadan√Ω filtr (${currentPlatform}).`;
        listEl.appendChild(div);
        return;
      }

      for(const d of filtered){
        const row = document.createElement("div");
        row.className = "dep";
        const line = document.createElement("div");
        line.className = "line";
        line.textContent = (d?.route?.short_name ?? "?");

        const where = document.createElement("div");
        where.className = "where";
        const head = d?.trip?.headsign ?? d?.last_stop?.name ?? "";
        const plat = d?.stop?.platform_code ? ` ¬∑ st. ${d.stop.platform_code}` : "";
        where.textContent = `${head}${plat}`;

        const timeBox = document.createElement("div");
        timeBox.className = "time";
        const shownISO = d?.departure_timestamp?.predicted || d?.departure_timestamp?.scheduled;
        const mins = minsTo(shownISO);
        timeBox.textContent = (CONFIG.departures.mode === "time") ? fmtHHMM(shownISO) : (mins <= 0 ? "odj√≠≈æd√≠" : `${mins} min`);

        const del = delayMin(d?.departure_timestamp?.scheduled, d?.departure_timestamp?.predicted);
        if(del){
          const span = document.createElement("span");
          span.className = "delay " + (del>0?"warn":"ok");
          span.textContent = (del>0?`+${del}`:`${del}`);
          timeBox.appendChild(span);
        }

        const ico = document.createElement("div");
        ico.textContent = iconByType(d?.route?.type);
        ico.style.opacity = .85;

        row.appendChild(ico);
        row.appendChild(line);
        row.appendChild(where);
        row.appendChild(timeBox);
        listEl.appendChild(row);
      }
    }

    async function refresh(){
      try{
        const data = await fetchDepartures({
          ids: CONFIG.departures.ids,
          limit: CONFIG.departures.limit
        });
        renderDepartures(data);
        const ts = new Date();
        footEl.textContent = `${CONFIG.departures.title} ¬∑ Posledn√≠ kontrola ${String(ts.getHours()).padStart(2,"0")}:${String(ts.getMinutes()).padStart(2,"0")}`;
      }catch(err){
        listEl.innerHTML = `<div class="error">${(err?.message || err)}</div>`;
        footEl.textContent = `${CONFIG.departures.title}`;
      }
    }

    // --- UI HANDLERS ---
    dirBtn.addEventListener("click", () => {
      currentPlatform = currentPlatform === "A" ? "B" : "A";
      dirBtn.textContent = `Smƒõr: ${currentPlatform}`;
      refresh();
    });

    apiBtn.addEventListener("click", () => {
      apiInput.value = getToken();
      apiDlg.showModal();
    });
    apiDlg.addEventListener("close", () => {
      if(apiDlg.returnValue === "ok"){
        setToken(apiInput.value.trim());
        refresh();
      }
    });

    // Prvn√≠ naƒçten√≠
    (async function init(){
      if(!getToken()){
        // jemn√Ω prompt, ale umo≈æn√≠ zav≈ô√≠t a pod√≠vat se nejd≈ô√≠v na str√°nku
        apiDlg.showModal();
      }
      await refresh();
      // periodick√Ω refresh
      setInterval(refresh, 60*1000);
    })();
  </script>
</body>
</html>
