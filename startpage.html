<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dom√°c√≠ start</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome bez integrity (vyhne se blokaci kv≈Øli ≈°patn√© SRI hash) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer">

  <style>
    :root{
      color-scheme:dark;
      --bg:#0f172a;--bg-card:rgba(15,23,42,.8);--border:rgba(148,163,184,.2);
      --text:#e2e8f0;--text-muted:#94a3b8;--accent:#38bdf8;
      --danger:#f87171;--success:#34d399;--warning:#facc15;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;background:radial-gradient(circle at top,#1e293b,#0f172a 45%);color:var(--text);padding:32px;display:flex;justify-content:center}
    .app{width:min(1200px,100%);display:flex;flex-direction:column;gap:24px}
    header{display:flex;flex-direction:column;gap:8px}
    header h1{font-size:clamp(32px,5vw,44px);font-weight:700}
    header p{color:var(--text-muted);max-width:600px}
    .top-grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .panel{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:20px;backdrop-filter:blur(16px);box-shadow:0 20px 40px -24px rgba(15,23,42,.65);display:flex;flex-direction:column;gap:16px;transition:transform .2s ease,border .2s ease}
    .panel:hover{transform:translateY(-2px);border-color:rgba(56,189,248,.4)}
    .panel-header{display:flex;align-items:center;gap:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;font-size:12px;color:var(--text-muted)}
    .departure-list{display:grid;gap:12px}
    .departure-item{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08)}
    .departure-time{font-size:20px;font-weight:600}
    .departure-destination{margin-top:6px;color:var(--text-muted);font-size:14px}
    .departure-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;background:rgba(148,163,184,.16);color:var(--text)}
    .badge.success{background:rgba(52,211,153,.15);color:var(--success)}
    .badge.danger{background:rgba(248,113,113,.15);color:var(--danger)}
    .badge.warning{background:rgba(250,204,21,.15);color:var(--warning)}
    .panel-actions{display:flex;gap:12px;flex-wrap:wrap}
    .ghost-button{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.3);background:transparent;color:var(--text);font-weight:500;cursor:pointer;transition:border .2s ease,color .2s ease,background .2s ease}
    .ghost-button:hover{border-color:rgba(56,189,248,.6);color:var(--accent);background:rgba(56,189,248,.1)}
    .timestamp{font-size:12px;color:var(--text-muted)}
    .error-message{font-size:14px;color:var(--danger)}
    @media (max-width:640px){body{padding:16px}.panel{padding:16px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Dom√°c√≠ start</h1>
      <p>Soukrom√° n√°stƒõnka pro ka≈ædodenn√≠ p≈ôehled ‚Äì poƒças√≠, MHD, dostupnost dom√°c√≠ s√≠tƒõ a rychl√© odkazy.</p>
    </header>

    <div class="top-grid">
      <!-- Poƒças√≠ ‚Äì beze zmƒõn -->
      <section class="panel" id="weather-panel">
        <div class="panel-header"><i class="fa-solid fa-cloud-sun"></i><span>Poƒças√≠</span></div>
        <div id="weather-content"><p>Naƒç√≠t√°m aktu√°ln√≠ poƒças√≠‚Ä¶</p></div>
      </section>

      <!-- ODJEZDY MHD ‚Äì UPRAVENO -->
      <section class="panel" id="departures-panel">
        <div class="panel-header"><i class="fa-solid fa-train-tram"></i><span>Odjezdy MHD</span></div>
        <div id="departures-content"><p>Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</p></div>
        <div class="panel-actions">
          <button type="button" class="ghost-button" id="departures-direction">Smƒõr: v≈°e</button>
          <button type="button" class="ghost-button" id="departures-set-key"><i class="fa-solid fa-key"></i><span id="departures-key-label">Nastavit API kl√≠ƒç</span></button>
          <button type="button" class="ghost-button" id="departures-set-proxy"><i class="fa-solid fa-shuffle"></i><span id="departures-proxy-label">Nastavit proxy</span></button>
        </div>
      </section>

      <!-- Internet ‚Äì beze zmƒõn (m≈Ø≈æe hl√°sit Mixed Content pokud bƒõ≈æ√≠≈° p≈ôes HTTPS a c√≠l je HTTP) -->
      <section class="panel" id="internet-panel">
        <div class="panel-header"><i class="fa-solid fa-wifi"></i><span>Dom√°c√≠ internet</span></div>
        <div id="internet-status" class="status"><div class="indicator"></div><div><div class="status-text">Kontroluji dostupnost‚Ä¶</div><div class="timestamp" id="internet-timestamp"></div></div></div>
        <p class="error-message" id="internet-error"></p>
      </section>
    </div>
  </div>

  <script>
    const CONFIG = {
      weather: { latitude: 50.0704, longitude: 14.4709, timezone: 'Europe/Prague' },
      departures: {
        stopIds: ['U680Z1P','U680Z301'], // tram Slavia ‚Äì N√°dra≈æ√≠ Eden + vlak Praha-Eden (S9)
        stopLabel: 'Slavia ‚Äì n√°dra≈æ√≠ Eden',
        proxyUrl: 'https://golemio.m88wqgcdpd.workers.dev/', // <‚Äî TV≈ÆJ WORKER. nech pr√°zdn√© pro p≈ô√≠m√© vol√°n√≠ Golemio (vy≈æaduje kl√≠ƒç)
        apiKey: '', // jen kdy≈æ proxyUrl je pr√°zdn√©
        directionFilter: ['Koh-i-noor'], // voliteln√© ‚Äì filtr textem
        limit: 12,
        minutesBefore: 0,
        minutesAfter: 45,
        timezone: 'Europe/Prague'
      },
      connectivity: { url: 'http://192.168.1.1/status', method: 'GET', timeoutMs: 4000, mode: 'no-cors' }
    };

    // --- UI elementy
    const departuresContent = document.getElementById('departures-content');
    const departuresSetKeyButton = document.getElementById('departures-set-key');
    const departuresKeyLabel = document.getElementById('departures-key-label');
    const departuresSetProxyButton = document.getElementById('departures-set-proxy');
    const departuresProxyLabel = document.getElementById('departures-proxy-label');
    const directionBtn = document.getElementById('departures-direction');

    // --- utility
    function safeArray(v){ if(Array.isArray(v)) return v; if(typeof v==='string') return v.split(',').map(s=>s.trim()).filter(Boolean); return []; }
    function formatDate(d){ return new Intl.DateTimeFormat('cs-CZ',{hour:'2-digit',minute:'2-digit'}).format(d); }
    function toDate(v){ return v ? new Date(v) : null; }
    function minutesUntil(d){ if(!d) return null; const diff = Math.ceil((d.getTime()-Date.now())/60000); return diff<0?0:diff; }
    function createBadge(label, extra=''){ const cls=['badge']; if(extra) cls.push(extra); return `<span class="${cls.join(' ')}">${label}</span>`; }
    function normalizeSearchText(value){ if(typeof value!=='string') return ''; return value.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[\s\-‚Äì‚Äî]+/g,' ').trim(); }
    function buildSearchVariants(value){ const n=normalizeSearchText(value); if(!n) return []; const c=n.replace(/\s+/g,''); return c&&c!==n?[n,c]:[n]; }

    const ROUTE_TYPE_ICONS={0:'üöã',1:'‚ìÇÔ∏è',2:'üöÜ',3:'üöå',11:'üöé'};

    // --- localStorage keys
    const GOLEMIO_STORAGE_KEY='golemio_api_key';
    const PROXY_STORAGE_KEY='golemio_proxy_url';
    const PLATFORM_STORAGE_KEY='departures_platform'; // 'all' | 'A' | 'B'

    // --- A/B toggle pouze pro tram
    const TRAM_STOP_ID='U680Z1P';
    const TRAIN_STOP_ID='U680Z301';
    function getPlatformState(){ const val=(localStorage.getItem(PLATFORM_STORAGE_KEY)||'all').toUpperCase(); return ['ALL','A','B'].includes(val)?(val==='ALL'?'all':val):'all'; }
    function setPlatformState(v){ localStorage.setItem(PLATFORM_STORAGE_KEY,v); }
    function labelForPlatform(p){ return p==='A'?'Smƒõr: A':p==='B'?'Smƒõr: B':'Smƒõr: v≈°e'; }

    if(directionBtn){
      directionBtn.textContent = labelForPlatform(getPlatformState());
      directionBtn.onclick = () => {
        const cur=getPlatformState();
        const next= cur==='all'?'A':(cur==='A'?'B':'all');
        setPlatformState(next);
        directionBtn.textContent=labelForPlatform(next);
        loadDepartures();
      };
    }

    // --- kl√≠ƒç & proxy
    function readStored(k){ try{const v=localStorage.getItem(k); return v? v.trim():'';}catch{return '';} }
    function persist(k,v){ try{ v? localStorage.setItem(k,v.trim()) : localStorage.removeItem(k);}catch{} }
    function getApiKey(){ return readStored(GOLEMIO_STORAGE_KEY) || (CONFIG.departures.apiKey||'').trim(); }
    function getProxyUrl(){ return readStored(PROXY_STORAGE_KEY) || (CONFIG.departures.proxyUrl||'').trim(); }

    function updateButtons(){
      const hasKey=!!getApiKey(); const hasProxy=!!getProxyUrl();
      if(departuresKeyLabel) departuresKeyLabel.textContent = hasKey ? 'Zmƒõnit API kl√≠ƒç' : 'Nastavit API kl√≠ƒç';
      if(departuresProxyLabel) departuresProxyLabel.textContent = hasProxy ? 'Zmƒõnit proxy' : 'Nastavit proxy';
    }

    if(departuresSetKeyButton){
      departuresSetKeyButton.addEventListener('click',()=>{
        const cur=readStored(GOLEMIO_STORAGE_KEY);
        const next=window.prompt('Zadej Golemio API kl√≠ƒç (X-Access-Token).\nPr√°zdn√Ω vstup kl√≠ƒç odstran√≠.',cur);
        if(next===null) return;
        persist(GOLEMIO_STORAGE_KEY,next.trim());
        updateButtons(); loadDepartures();
      });
    }
    if(departuresSetProxyButton){
      departuresSetProxyButton.addEventListener('click',()=>{
        const cur=readStored(PROXY_STORAGE_KEY) || (CONFIG.departures.proxyUrl||'');
        const next=window.prompt('Zadej URL proxy (nap≈ô. Cloudflare Worker).\nPr√°zdn√Ω vstup proxy odstran√≠.',cur);
        if(next===null) return;
        persist(PROXY_STORAGE_KEY,next.trim());
        updateButtons(); loadDepartures();
      });
    }

    function buildGolemioUrl(){
      const ids = safeArray(CONFIG.departures.stopIds).join(',');
      const qs = new URLSearchParams({
        ids,
        minutesBefore:String(CONFIG.departures.minutesBefore??0),
        minutesAfter:String(CONFIG.departures.minutesAfter??30),
        limit:String(Math.max(CONFIG.departures.limit??6,1)),
        preferredTimezone:CONFIG.departures.timezone||'Europe/Prague',
        includeMetroTrains:'true'
      }).toString();
      return `https://api.golemio.cz/v2/pid/departureboards?${qs}`;
    }

    async function loadDepartures(){
      updateButtons();
      const proxyUrl = getProxyUrl();
      const apiKey   = getApiKey();

      // kontrola vstup≈Ø
      if(!safeArray(CONFIG.departures.stopIds).length){
        departuresContent.innerHTML = '<p class="error-message">Chyb√≠ nastaven√≠ ID zast√°vek.</p>'; return;
      }
      if(!proxyUrl && !apiKey){
        departuresContent.innerHTML = `
          <p class="error-message">Nelze naƒç√≠st odjezdy p≈ô√≠mo z Golemio z ve≈ôejn√© HTTPS dom√©ny kv≈Øli CORS.</p>
          <p class="timestamp">≈òe≈°en√≠: nastav <strong>CONFIG.departures.proxyUrl</strong> na vlastn√≠ proxy (Cloudflare Worker), kter√° p≈ôid√° hlaviƒçku X-Access-Token a Access-Control-Allow-Origin. Nebo vlo≈æ API kl√≠ƒç a spus≈• str√°nku lok√°lnƒõ (http://localhost).</p>
        `;
        return;
      }

      try{
        const url = buildGolemioUrl();
        const finalUrl = proxyUrl ? `${proxyUrl.replace(/\/+$/,'')}/?${url.split('?')[1]}` : url;

        const res = await fetch(finalUrl, {
          headers: proxyUrl ? { 'Accept':'application/json' } : { 'Accept':'application/json','X-Access-Token': apiKey }
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        let departuresRaw = Array.isArray(data.departures) ? data.departures : [];

        // A/B filtr pouze pro TRAM_STOP_ID
        const platformState = getPlatformState(); // 'all'|'A'|'B'
        const platformFiltered = departuresRaw.filter(d=>{
          const stopId = d?.stop?.id;
          const plat = (d?.stop?.platform_code || '').toUpperCase();
          if(stopId === TRAM_STOP_ID){
            if(platformState==='all') return true;
            return plat === platformState;
          }
          return true; // vlaky S9 a dal≈°√≠ neomezujeme
        });

        // Filtr smƒõru (voliteln√©)
        const directionFilters = safeArray(CONFIG.departures.directionFilter).flatMap(buildSearchVariants).filter(Boolean);
        const afterDirection = directionFilters.length
          ? platformFiltered.filter(item=>{
              const possible=[
                item.trip?.headsign,
                item.trip?.direction,
                item.last_stop?.name,
                item.route?.long_name,
                item.route?.description
              ].flatMap(buildSearchVariants).filter(Boolean);
              if(!possible.length) return false;
              return directionFilters.some(f=>possible.some(c=>c.includes(f)||f.includes(c)));
            })
          : platformFiltered;

        const departures = afterDirection.slice(0, CONFIG.departures.limit ?? 6);

        if(!departures.length){
          departuresContent.innerHTML = `
            <p>Nebyly nalezeny ≈æ√°dn√© odjezdy pro zadan√Ω filtr (${labelForPlatform(getPlatformState()).replace('Smƒõr: ','')}).</p>
            <p class="timestamp">${CONFIG.departures.stopLabel} ¬∑ Posledn√≠ kontrola ${formatDate(new Date())}</p>
          `;
          return;
        }

        const list = departures.map(dep=>{
          const sched=toDate(dep.departure_timestamp?.scheduled);
          const pred =toDate(dep.departure_timestamp?.predicted);
          const show = pred || sched;
          const abs  = show ? formatDate(show) : '‚Äî';
          const mins = minutesUntil(show);
          const countdown = mins===null ? '‚Äî' : (mins===0 ? 'odj√≠≈æd√≠' : `${mins} min`);
          const countdownClass = (mins!==null && mins<=1) ? 'success' : '';

          let delay=null;
          if(sched && pred){ delay=Math.round((pred.getTime()-sched.getTime())/60000); }
          else if(typeof dep.departure_delay==='number'){ delay=Math.round(dep.departure_delay/60); }

          let delayBadge='';
          if(delay!==null){
            if(delay===0) delayBadge=createBadge('Vƒças','success');
            else if(delay>0) delayBadge=createBadge(`+${delay} min`,'danger');
            else delayBadge=createBadge(`${delay} min`,'success');
          }

          const line = dep.route?.short_name || dep.route?.long_name || 'Linka';
          const type = Number(dep.route?.type);
          const icon = Number.isFinite(type) ? (ROUTE_TYPE_ICONS[type]||'') : '';
          const platform = dep.stop?.platform_code || dep.stop?.platform_name;
          const headsignBase = dep.trip?.headsign || dep.trip?.direction || dep.last_stop?.name || '‚Äî';
          const headsign = platform ? `${headsignBase} ¬∑ st. ${platform}` : headsignBase;

          const badges=[createBadge(countdown,countdownClass),delayBadge].filter(Boolean).join('');

          return `
            <div class="departure-item">
              <div>
                <div class="badge">${icon?`${icon} `:''}${line}</div>
                <div class="departure-destination">${headsign}</div>
              </div>
              <div class="departure-time">${abs}</div>
              <div class="departure-meta">${badges}</div>
            </div>
          `;
        }).join('');

        departuresContent.innerHTML = `
          <div class="departure-list">${list}</div>
          <div class="timestamp">${CONFIG.departures.stopLabel} ¬∑ ${labelForPlatform(getPlatformState())} ¬∑ Posledn√≠ kontrola ${formatDate(new Date())}</div>
        `;
      }catch(err){
        departuresContent.innerHTML = `<p class="error-message">Chyba: ${err.message || err}</p>`;
      }
    }

    // ‚Äî‚Äî‚Äî Poƒças√≠ (rychl√©, beze zmƒõn)
    const weatherContent=document.getElementById('weather-content');
    const weatherCodeLabels={0:'Jasno',1:'P≈ôev√°≈ænƒõ jasno',2:'Oblaƒçno',3:'Zata≈æeno',45:'Mlha',48:'Mrznouc√≠ mlha',51:'M√≠rn√© mrholen√≠',53:'Mrholen√≠',55:'Intenzivn√≠ mrholen√≠',56:'Mrznouc√≠ mrholen√≠',57:'Mrznouc√≠ mrholen√≠',61:'Slab√Ω d√©≈°≈•',63:'D√©≈°≈•',65:'Siln√Ω d√©≈°≈•',66:'Mrznouc√≠ d√©≈°≈•',67:'Mrznouc√≠ d√©≈°≈•',71:'Slab√© snƒõ≈æen√≠',73:'Snƒõ≈æen√≠',75:'Siln√© snƒõ≈æen√≠',77:'Kroupy',80:'P≈ôeh√°≈àky',81:'D√©≈°≈•',82:'Siln√Ω d√©≈°≈•',85:'Snƒõhov√© p≈ôeh√°≈àky',86:'Siln√© snƒõhov√© p≈ôeh√°≈àky',95:'Bou≈ôka',96:'Bou≈ôka s krupobit√≠m',99:'Siln√° bou≈ôka'};
    async function loadWeather(){
      try{
        const {latitude,longitude,timezone}=CONFIG.weather;
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,weather_code&timezone=${timezone}`;
        const res=await fetch(url); if(!res.ok) throw new Error('Nepoda≈ôilo se naƒç√≠st poƒças√≠.');
        const data=await res.json(); const c=data.current; const label=weatherCodeLabels[c.weather_code]||'Poƒças√≠ nezn√°m√©'; const updated=new Date(c.time);
        weatherContent.innerHTML=`
          <div class="weather-main" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
            <div><div class="weather-temp" style="font-size:56px;font-weight:700">${Math.round(c.temperature_2m)}¬∞C</div><div>${label}</div></div>
            <div class="weather-meta" style="display:grid;gap:6px;font-size:14px;color:var(--text-muted)">
              <span>Pocitovƒõ ${Math.round(c.apparent_temperature)}¬∞C</span>
              <span>Vlhkost ${c.relative_humidity_2m}%</span>
              <span>V√≠tr ${Math.round(c.wind_speed_10m)} km/h</span>
              <span class="timestamp">Aktualizov√°no ${formatDate(updated)}</span>
            </div>
          </div>`; 
      }catch(e){ weatherContent.innerHTML=`<p class="error-message">${e.message}</p>`; }
    }

    function init(){
      loadWeather();
      loadDepartures();
      setInterval(loadWeather, 20*60*1000);
      setInterval(loadDepartures, 60*1000);
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>