<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dom√°c√≠ start</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- bez SRI -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer">

  <style>
    :root{color-scheme:dark;--bg:#0f172a;--bg-card:rgba(15,23,42,.8);--bg-card-solid:#111a33;--border:rgba(148,163,184,.2);--text:#e2e8f0;--text-muted:#94a3b8;--accent:#38bdf8;--danger:#f87171;--success:#34d399;--warning:#facc15;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;background:radial-gradient(circle at top,#1e293b,#0f172a 45%);color:var(--text);padding:32px;display:flex;justify-content:center}
    .app{width:min(1200px,100%);display:flex;flex-direction:column;gap:24px}
    header{display:flex;flex-direction:column;gap:8px}
    header h1{font-size:clamp(32px,5vw,44px);font-weight:700}
    header p{color:var(--text-muted);max-width:600px}
    .top-grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .panel{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:20px;backdrop-filter:blur(16px);box-shadow:0 20px 40px -24px rgba(15,23,42,.65);display:flex;flex-direction:column;gap:16px}
    .panel-header{display:flex;align-items:center;gap:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;font-size:12px;color:var(--text-muted)}
    .panel-actions{display:flex;gap:12px;flex-wrap:wrap}
    .ghost-button{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.3);background:transparent;color:var(--text);font-weight:500;cursor:pointer}
    .ghost-button:hover{border-color:rgba(56,189,248,.6);color:var(--accent);background:rgba(56,189,248,.1)}
    .timestamp{font-size:12px;color:var(--text-muted)}
    .error-message{font-size:14px;color:var(--danger)}
    .departure-list{display:grid;gap:12px}
    .departure-item{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08)}
    .departure-time{font-size:20px;font-weight:600}
    .departure-destination{margin-top:6px;color:var(--text-muted);font-size:14px}
    .departure-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;background:rgba(148,163,184,.16);color:var(--text)}
    .badge.success{background:rgba(52,211,153,.15);color:var(--success)}
    .badge.danger{background:rgba(248,113,113,.15);color:var(--danger)}
    .badge.warning{background:rgba(250,204,21,.15);color:var(--warning)}
    .main-layout{display:grid;gap:24px;grid-template-columns:minmax(220px,1fr) minmax(0,2fr) minmax(220px,1fr);grid-template-areas:'links news servers';align-items:start}
    #links-panel{grid-area:links} #news-panel{grid-area:news} #servers-panel{grid-area:servers}
    .links-grid{display:flex;flex-direction:column;gap:12px}
    .quick-link{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08);color:var(--text);text-decoration:none;font-weight:500}
    .quick-link:hover{background:rgba(56,189,248,.16);color:var(--accent)}
    .news-list{display:grid;gap:16px}
    .news-item{display:grid;gap:8px;padding-bottom:12px;border-bottom:1px solid rgba(148,163,184,.1)}
    .news-item:last-child{border-bottom:none;padding-bottom:0}
    .news-item a{color:var(--text);font-weight:600;text-decoration:none;font-size:18px}
    .news-item a:hover{color:var(--accent)}
    .news-meta{font-size:13px;color:var(--text-muted)}
    .news-summary{font-size:14px;color:var(--text-muted)}
    .server-list{display:grid;gap:16px}
    .server-item{padding:16px;border-radius:12px;background:rgba(148,163,184,.08);display:grid;gap:8px}
    .server-header{display:flex;align-items:center;gap:12px}
    .server-header i{font-size:20px}
    @media (max-width:1024px){body{padding:24px}.main-layout{grid-template-columns:1fr;grid-template-areas:'links' 'news' 'servers'}}
    @media (max-width:640px){body{padding:16px}.panel{padding:16px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Dom√°c√≠ start</h1>
      <p>Soukrom√° n√°stƒõnka pro ka≈ædodenn√≠ p≈ôehled ‚Äì poƒças√≠, MHD, dostupnost dom√°c√≠ s√≠tƒõ a rychl√© odkazy.</p>
    </header>

    <div class="top-grid">
      <section class="panel" id="weather-panel">
        <div class="panel-header"><i class="fa-solid fa-cloud-sun"></i><span>Poƒças√≠</span></div>
        <div id="weather-content"><p>Naƒç√≠t√°m aktu√°ln√≠ poƒças√≠‚Ä¶</p></div>
      </section>

      <section class="panel" id="departures-panel">
        <div class="panel-header"><i class="fa-solid fa-train-tram"></i><span>Odjezdy MHD</span></div>
        <div id="departures-content"><p>Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</p></div>
        <div class="panel-actions">
          <button type="button" class="ghost-button" id="departures-direction">Smƒõr: A (Koh-i-noor)</button>
          <button type="button" class="ghost-button" id="departures-set-proxy">
            <i class="fa-solid fa-shuffle"></i><span id="departures-proxy-label">Zmƒõnit proxy</span>
          </button>
        </div>
      </section>

      <section class="panel" id="internet-panel">
        <div class="panel-header"><i class="fa-solid fa-wifi"></i><span>Dom√°c√≠ internet</span></div>
        <div id="internet-status" class="status">
          <div class="indicator"></div>
          <div>
            <div class="status-text">Kontroluji dostupnost‚Ä¶</div>
            <div class="timestamp" id="internet-timestamp"></div>
          </div>
        </div>
        <p class="error-message" id="internet-error"></p>
      </section>
    </div>

    <div class="main-layout">
      <aside class="panel" id="links-panel">
        <div class="panel-header"><i class="fa-solid fa-bookmark"></i><span>Rychl√© odkazy</span></div>
        <div class="links-grid" id="links-grid"></div>
      </aside>

      <section class="panel" id="news-panel">
        <div class="panel-header"><i class="fa-solid fa-newspaper"></i><span>iRozhlas.cz ‚Äì nejnovƒõj≈°√≠ zpr√°vy</span></div>
        <div id="news-content"><p class="timestamp">Na HTTPS dom√©nƒõ m≈Ø≈æe b√Ωt RSS blokov√°no CORS. Pou≈æij RSS proxy nebo bƒõ≈æ lok√°lnƒõ.</p></div>
      </section>

      <aside class="panel" id="servers-panel">
        <div class="panel-header"><i class="fa-solid fa-server"></i><span>Dom√°c√≠ slu≈æby</span></div>
        <div class="server-list" id="server-list"></div>
      </aside>
    </div>
  </div>

  <script>
    const CONFIG = {
      weather:{ latitude:50.0704, longitude:14.4709, timezone:'Europe/Prague' },
      departures:{
        stopLabel:'Slavia ‚Äì n√°dra≈æ√≠ Eden',
        proxyUrl:'https://golemio.m88wqgcdpd.workers.dev', // <<< TV≈ÆJ WORKER
        limit:12, minutesBefore:0, minutesAfter:45, timezone:'Europe/Prague'
      }
    };

    const departuresContent=document.getElementById('departures-content');
    const directionBtn=document.getElementById('departures-direction');
    const setProxyBtn=document.getElementById('departures-set-proxy');
    const setProxyLbl=document.getElementById('departures-proxy-label');

    const TRAM_STOP_A='U680Z1P';
    const TRAM_STOP_B='U680Z2P';
    const TRAIN_STOP_S='U680Z301';

    const PROXY_STORAGE_KEY='golemio_proxy_url';
    const PLATFORM_STORAGE_KEY='departures_platform';

    function getPlatform(){ const v=(localStorage.getItem(PLATFORM_STORAGE_KEY)||'A').toUpperCase(); return v==='B'?'B':'A'; }
    function setPlatform(v){ localStorage.setItem(PLATFORM_STORAGE_KEY,v); }
    function labelFor(p){ return p==='B'?'Smƒõr: B (Kub√°nsk√© n√°m.)':'Smƒõr: A (Koh-i-noor)'; }
    function buildIds(){ const p=getPlatform(); const tram=(p==='B')?TRAM_STOP_B:TRAM_STOP_A; return [tram, TRAIN_STOP_S]; }
    function getProxy(){ return localStorage.getItem(PROXY_STORAGE_KEY) || CONFIG.departures.proxyUrl = "https://golemioproxy.m88wqgcdpd.workers.dev"; }
    function setProxy(v){ if(v) localStorage.setItem(PROXY_STORAGE_KEY,v); else localStorage.removeItem(PROXY_STORAGE_KEY); }
    function formatDate(d){ return new Intl.DateTimeFormat('cs-CZ',{hour:'2-digit',minute:'2-digit'}).format(d); }
    function toDate(v){ return v?new Date(v):null; }
    function minutesUntil(d){ if(!d) return null; const diff=Math.ceil((d.getTime()-Date.now())/60000); return diff<0?0:diff; }
    function createBadge(t,c=''){ const cls=['badge']; if(c) cls.push(c); return `<span class="${cls.join(' ')}">${t}</span>`; }
    const ROUTE_TYPE_ICONS={0:'üöã',1:'‚ìÇÔ∏è',2:'üöÜ',3:'üöå',11:'üöé'};

    function buildQuery(ids){
      return new URLSearchParams({
        ids: ids.join(','),
        minutesBefore:String(CONFIG.departures.minutesBefore??0),
        minutesAfter:String(CONFIG.departures.minutesAfter??45),
        limit:String(CONFIG.departures.limit??12),
        preferredTimezone:CONFIG.departures.timezone||'Europe/Prague',
        includeMetroTrains:'true'
      }).toString();
    }

    async function tryProxy(proxyBase, query) {
      const base = proxyBase.replace(/\/+$/,'');
      const variants = [
        `${base}/v2/pid/departureboards?${query}`,
        `${base}/pid/departureboards?${query}`,
        `${base}/?${query}`
      ];
      let lastErr;
      for (const u of variants) {
        try {
          const r = await fetch(u, { headers:{ 'Accept':'application/json' }});
          if (r.ok) return r;
          if (r.status === 404) { lastErr = new Error('404'); continue; }
          // jin√Ω k√≥d ne≈æ 404 ‚Äì vra≈• ho
          return r;
        } catch(e){ lastErr=e; }
      }
      throw lastErr || new Error('Proxy unreachable');
    }

    async function loadDepartures(){
      const ids = buildIds();
      const q = buildQuery(ids);
      const proxy = getProxy();

      if(!proxy){
        departuresContent.innerHTML = `<p class="error-message">Nen√≠ nastavena proxy URL.</p>`;
        return;
      }

      try{
        const res = await tryProxy(proxy, q);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const deps = Array.isArray(data.departures) ? data.departures.slice(0, CONFIG.departures.limit) : [];

        if(!deps.length){
          departuresContent.innerHTML = `
            <p>Nebyly nalezeny ≈æ√°dn√© odjezdy pro zadan√Ω smƒõr (${labelFor(getPlatform()).replace('Smƒõr: ','')}).</p>
            <p class="timestamp">${CONFIG.departures.stopLabel} ¬∑ Posledn√≠ kontrola ${formatDate(new Date())}</p>`;
          return;
        }

        const list = deps.map(d=>{
          const sched=toDate(d.departure_timestamp?.scheduled);
          const pred =toDate(d.departure_timestamp?.predicted);
          const show = pred || sched;
          const abs = show ? formatDate(show) : '‚Äî';
          const mins = minutesUntil(show);
          const countdown = mins===null ? '‚Äî' : (mins===0 ? 'odj√≠≈æd√≠' : `${mins} min`);
          const countdownClass = (mins!==null && mins<=1) ? 'success' : '';
          let delay=null;
          if(sched && pred){ delay=Math.round((pred.getTime()-sched.getTime())/60000); }
          else if(typeof d.departure_delay==='number'){ delay=Math.round(d.departure_delay/60); }
          let delayBadge='';
          if(delay!==null){
            if(delay===0) delayBadge=createBadge('Vƒças','success');
            else if(delay>0) delayBadge=createBadge(`+${delay} min`,'danger');
            else delayBadge=createBadge(`${delay} min`,'success');
          }
          const line = d.route?.short_name || d.route?.long_name || 'Linka';
          const type = Number(d.route?.type);
          const icon = Number.isFinite(type)?(ROUTE_TYPE_ICONS[type]||''):'';
          const platform = d.stop?.platform_code || d.stop?.platform_name;
          const headsignBase = d.trip?.headsign || d.trip?.direction || d.last_stop?.name || '‚Äî';
          const headsign = platform ? `${headsignBase} ¬∑ st. ${platform}` : headsignBase;
          const badges=[createBadge(countdown,countdownClass),delayBadge].filter(Boolean).join('');
          return `
            <div class="departure-item">
              <div>
                <div class="badge">${icon?`${icon} `:''}${line}</div>
                <div class="departure-destination">${headsign}</div>
              </div>
              <div class="departure-time">${abs}</div>
              <div class="departure-meta">${badges}</div>
            </div>`;
        }).join('');

        departuresContent.innerHTML = `
          <div class="departure-list">${list}</div>
          <div class="timestamp">${CONFIG.departures.stopLabel} ¬∑ ${labelFor(getPlatform())} ¬∑ Posledn√≠ kontrola ${formatDate(new Date())}</div>`;
      }catch(e){
        departuresContent.innerHTML = `<p class="error-message">Chyba proxy: ${e.message||e}</p>
        <p class="timestamp">Zkontroluj k√≥d Workeru (cesty /v2/pid/departureboards, /pid/departureboards, /) a ≈æe m√°≈° nastaven√Ω GOLEMIO_TOKEN.</p>`;
      }
    }

    // P≈ôep√≠n√°n√≠ smƒõru
    directionBtn.textContent = labelFor(getPlatform());
    directionBtn.onclick = () => { const cur=getPlatform(); const next=(cur==='A')?'B':'A'; setPlatform(next); directionBtn.textContent=labelFor(next); loadDepartures(); };

    // Nastaven√≠ proxy
    setProxyLbl.textContent = getProxy() ? 'Zmƒõnit proxy' : 'Nastavit proxy';
    setProxyBtn.onclick = () => {
      const cur=getProxy();
      const next=prompt('Zadej adresu sv√©ho Cloudflare Workeru', cur||'https://golemio.m88wqgcdpd.workers.dev');
      if(next===null) return;
      setProxy((next||'').trim());
      setProxyLbl.textContent = getProxy() ? 'Zmƒõnit proxy' : 'Nastavit proxy';
      loadDepartures();
    };

    // Poƒças√≠ (beze zmƒõn, volitelnƒõ)
    (async function loadWeather(){
      try{
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${CONFIG.weather.latitude}&longitude=${CONFIG.weather.longitude}&current=temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,weather_code&timezone=${CONFIG.weather.timezone}`;
        const r=await fetch(url); if(!r.ok) throw new Error('Nepoda≈ôilo se naƒç√≠st poƒças√≠.');
        const d=await r.json(); const c=d.current; const labels={0:'Jasno',1:'P≈ôev√°≈ænƒõ jasno',2:'Oblaƒçno',3:'Zata≈æeno',45:'Mlha',48:'Mrznouc√≠ mlha',51:'M√≠rn√© mrholen√≠',53:'Mrholen√≠',55:'Intenzivn√≠ mrholen√≠',56:'Mrznouc√≠ mrholen√≠',57:'Mrznouc√≠ mrholen√≠',61:'Slab√Ω d√©≈°≈•',63:'D√©≈°≈•',65:'Siln√Ω d√©≈°≈•',66:'Mrznouc√≠ d√©≈°≈•',67:'Mrznouc√≠ d√©≈°≈•',71:'Slab√© snƒõ≈æen√≠',73:'Snƒõ≈æen√≠',75:'Siln√© snƒõ≈æen√≠',77:'Kroupy',80:'P≈ôeh√°≈àky',81:'D√©≈°≈•',82:'Siln√Ω d√©≈°≈•',85:'Snƒõhov√© p≈ôeh√°≈àky',86:'Siln√© snƒõhov√© p≈ôeh√°≈àky',95:'Bou≈ôka',96:'Bou≈ôka s krupobit√≠m',99:'Siln√° bou≈ôka'};
        document.getElementById('weather-content').innerHTML=`
          <div class="weather-main" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
            <div><div class="weather-temp" style="font-size:56px;font-weight:700">${Math.round(c.temperature_2m)}¬∞C</div><div>${labels[c.weather_code]||'Poƒças√≠ nezn√°m√©'}</div></div>
            <div class="weather-meta" style="display:grid;gap:6px;font-size:14px;color:var(--text-muted)">
              <span>Pocitovƒõ ${Math.round(c.apparent_temperature)}¬∞C</span>
              <span>Vlhkost ${c.relative_humidity_2m}%</span>
              <span>V√≠tr ${Math.round(c.wind_speed_10m)} km/h</span>
              <span class="timestamp">Aktualizov√°no ${formatDate(new Date(c.time))}</span>
            </div>
          </div>`;
      }catch(e){ document.getElementById('weather-content').innerHTML=`<p class="error-message">${e.message}</p>`; }
      setTimeout(loadWeather, 20*60*1000);
    })();

    // Init
    function init(){
      loadDepartures();
      setInterval(loadDepartures, 60*1000);
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
