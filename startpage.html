<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dom√°c√≠ start</title>

  <!-- Fonts + Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-p0rV4D6wXYSMBi3uB5pRgJWSn8z0QKBFsSDnoefUp0tOSAuF0zZjwkzPWxgSWAIymFcpnG8m7nWwIBQHyZhCgA==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      color-scheme: dark;
      --bg:#0f172a; --bg-card:rgba(15,23,42,.8); --border:rgba(148,163,184,.2);
      --text:#e2e8f0; --text-muted:#94a3b8; --accent:#38bdf8;
      --danger:#f87171; --success:#34d399; --warning:#facc15;
      font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:radial-gradient(circle at top,#1e293b,#0f172a 45%);color:var(--text);min-height:100vh;padding:32px;display:flex;justify-content:center}
    .app{width:min(1200px,100%);display:flex;flex-direction:column;gap:24px}
    header{display:flex;flex-direction:column;gap:8px}
    header h1{font-size:clamp(32px,5vw,44px);font-weight:700}
    header p{color:var(--text-muted);max-width:600px}
    .top-grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .panel{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:20px;backdrop-filter:blur(16px);box-shadow:0 20px 40px -24px rgba(15,23,42,.65);display:flex;flex-direction:column;gap:16px;transition:transform .2s ease,border .2s ease}
    .panel:hover{transform:translateY(-2px);border-color:rgba(56,189,248,.4)}
    .panel-header{display:flex;align-items:center;gap:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;font-size:12px;color:var(--text-muted)}
    .panel-header i{font-size:14px}
    .weather-main{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .weather-temp{font-size:clamp(40px,5vw,56px);font-weight:700}
    .weather-meta{display:grid;gap:6px;font-size:14px;color:var(--text-muted)}

    .departure-list{display:grid;gap:12px}
    .departure-item{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08)}
    .departure-time{font-size:20px;font-weight:600}
    .departure-destination{margin-top:6px;color:var(--text-muted);font-size:14px}
    .departure-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;background:rgba(148,163,184,.16);color:var(--text)}
    .badge.success{background:rgba(52,211,153,.15);color:var(--success)}
    .badge.danger{background:rgba(248,113,113,.15);color:var(--danger)}
    .timestamp{font-size:12px;color:var(--text-muted)}
    .error-message{font-size:14px;color:var(--danger)}
    .error-message code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px}

    .status{display:flex;align-items:center;gap:12px}
    .status .indicator{width:10px;height:10px;border-radius:999px;background:var(--warning);box-shadow:0 0 0 4px rgba(250,204,21,.16)}
    .status.online .indicator{background:var(--success);box-shadow:0 0 0 4px rgba(52,211,153,.16)}
    .status.offline .indicator{background:var(--danger);box-shadow:0 0 0 4px rgba(248,113,113,.16)}

    .main-layout{display:grid;gap:24px;grid-template-columns:minmax(220px,1fr) minmax(0,2fr) minmax(220px,1fr);grid-template-areas:'links news servers';align-items:start}
    #links-panel{grid-area:links} #news-panel{grid-area:news} #servers-panel{grid-area:servers}
    .links-grid{display:flex;flex-direction:column;gap:12px}
    .quick-link{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08);color:var(--text);text-decoration:none;font-weight:500;transition:background .2s ease}
    .quick-link:hover{background:rgba(56,189,248,.16);color:var(--accent)}
    .server-list{display:grid;gap:16px}
    .server-item{padding:16px;border-radius:12px;background:rgba(148,163,184,.08);display:grid;gap:8px}
    .server-header{display:flex;align-items:center;gap:12px}
    .panel-actions{display:flex;gap:12px;flex-wrap:wrap}
    .ghost-button{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.3);background:transparent;color:var(--text);font-weight:500;cursor:pointer}
    .ghost-button:hover{border-color:rgba(56,189,248,.6);color:var(--accent);background:rgba(56,189,248,.1)}

    .news-list{display:grid;gap:16px}
    .news-item{display:grid;gap:8px;padding-bottom:12px;border-bottom:1px solid rgba(148,163,184,.1)}
    .news-item:last-child{border-bottom:none;padding-bottom:0}
    .news-item a{color:var(--text);font-weight:600;text-decoration:none;font-size:18px}
    .news-item a:hover{color:var(--accent)}

    @media (max-width:1024px){
      body{padding:24px}
      .main-layout{grid-template-columns:1fr;grid-template-areas:'links' 'news' 'servers'}
    }
    @media (max-width:640px){
      body{padding:16px}
      .panel{padding:16px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Dom√°c√≠ start</h1>
      <p>Soukrom√° n√°stƒõnka pro ka≈ædodenn√≠ p≈ôehled ‚Äì poƒças√≠, MHD, dostupnost dom√°c√≠ s√≠tƒõ a rychl√© odkazy.</p>
    </header>

    <div class="top-grid">
      <!-- Poƒças√≠ -->
      <section class="panel" id="weather-panel">
        <div class="panel-header"><i class="fa-solid fa-cloud-sun"></i><span>Poƒças√≠</span></div>
        <div id="weather-content"><p>Naƒç√≠t√°m aktu√°ln√≠ poƒças√≠‚Ä¶</p></div>
      </section>

      <!-- Odjezdy MHD -->
      <section class="panel" id="departures-panel">
        <div class="panel-header"><i class="fa-solid fa-train-tram"></i><span>Odjezdy MHD</span></div>
        <div id="departures-content"><p>Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</p></div>
        <div class="panel-actions">
          <button type="button" class="ghost-button" id="departures-toggle-platform">
            <i class="fa-solid fa-right-left"></i>
            <span id="departures-platform-label">Smƒõr: A</span>
          </button>
          <button type="button" class="ghost-button" id="departures-set-key">
            <i class="fa-solid fa-key"></i>
            <span id="departures-key-label">Nastavit API kl√≠ƒç</span>
          </button>
        </div>
      </section>

      <!-- Internet -->
      <section class="panel" id="internet-panel">
        <div class="panel-header"><i class="fa-solid fa-wifi"></i><span>Dom√°c√≠ internet</span></div>
        <div id="internet-status" class="status">
          <div class="indicator"></div>
          <div>
            <div class="status-text">Kontroluji dostupnost‚Ä¶</div>
            <div class="timestamp" id="internet-timestamp"></div>
          </div>
        </div>
        <p class="error-message" id="internet-error"></p>
      </section>
    </div>

    <div class="main-layout">
      <aside class="panel" id="links-panel">
        <div class="panel-header"><i class="fa-solid fa-bookmark"></i><span>Rychl√© odkazy</span></div>
        <div class="links-grid" id="links-grid"></div>
      </aside>

      <section class="panel" id="news-panel">
        <div class="panel-header"><i class="fa-solid fa-newspaper"></i><span>iRozhlas.cz ‚Äì nejnovƒõj≈°√≠ zpr√°vy</span></div>
        <div id="news-content"><p>Stahuji aktu√°ln√≠ ƒçl√°nky‚Ä¶</p></div>
      </section>

      <aside class="panel" id="servers-panel">
        <div class="panel-header"><i class="fa-solid fa-server"></i><span>Dom√°c√≠ slu≈æby</span></div>
        <div class="server-list" id="server-list"></div>
      </aside>
    </div>
  </div>

  <script>
  (function(){
    /* ====== Konfigurace ====== */
    const CONFIG = {
      weather:{ latitude:50.0704, longitude:14.4709, timezone:'Europe/Prague' },
      departures:{
        stopIds:['U680Z1P'],
        stopLabel:'Slavia ‚Äì n√°dra≈æ√≠ Eden',
        apiKey:'',
        directionFilter:[],
        routeFilter:[],
        platformFilter:'A',                 // 'A' | 'B' | '' (v≈°e) ‚Äì NEplat√≠ pro vlaky
        displayMode:'mins',                 // 'mins' nebo 'time'
        limit:8, minutesBefore:0, minutesAfter:45, timezone:'Europe/Prague'
      },
      connectivity:{ url:'http://192.168.1.1/status', method:'GET', timeoutMs:4000, mode:'no-cors' },
      servers:[
        {name:'Plex (Mac mini M4)', icon:'fa-clapperboard-play', url:'http://192.168.1.50:32400/web/index.html', method:'GET', mode:'no-cors'},
        {name:'Nextcloud (Mac mini 2012)', icon:'fa-cloud', url:'http://192.168.1.60/status.php', method:'GET', mode:'no-cors'},
        {name:'Home Assistant', icon:'fa-house-signal', url:'http://192.168.1.60:8123/', method:'GET', mode:'no-cors'}
      ],
      news:{ feedUrl:'https://www.irozhlas.cz/rss/irozhlas', limit:8 },
      links:[
        {label:'E-mail', url:'https://mail.google.com', icon:'fa-envelope'},
        {label:'Kalend√°≈ô', url:'https://calendar.google.com', icon:'fa-calendar-days'},
        {label:'Nextcloud', url:'https://cloud.example.com', icon:'fa-cloud'},
        {label:'Home Assistant', url:'https://ha.example.com', icon:'fa-house-signal'},
        {label:'Plex', url:'https://plex.tv/web', icon:'fa-clapperboard-play'},
        {label:'Bankovnictv√≠', url:'https://ib.examplebank.cz', icon:'fa-piggy-bank'}
      ]
    };

    /* ====== DOM refs ====== */
    const weatherContent = document.getElementById('weather-content');
    const departuresContent = document.getElementById('departures-content');
    const newsContent = document.getElementById('news-content');
    const serverList = document.getElementById('server-list');
    const linksGrid = document.getElementById('links-grid');
    const departuresSetKeyButton = document.getElementById('departures-set-key');
    const departuresKeyLabel = document.getElementById('departures-key-label');
    const departuresTogglePlatform = document.getElementById('departures-toggle-platform');
    const departuresPlatformLabel = document.getElementById('departures-platform-label');

    /* ====== Utils ====== */
    const ROUTE_TYPE_ICONS = {0:'üöã',1:'‚ìÇÔ∏è',2:'üöÜ',3:'üöå',11:'üöé'};
    const GOLEMIO_STORAGE_KEY = 'golemio_api_key';
    const PLATFORM_STORAGE_KEY = 'departures_platform';

    const safeArray = v => Array.isArray(v) ? v : (typeof v==='string' ? v.split(',').map(s=>s.trim()).filter(Boolean) : []);
    const formatDate = d => new Intl.DateTimeFormat('cs-CZ',{hour:'2-digit',minute:'2-digit'}).format(d);
    const toDate = v => v ? new Date(v) : null;
    const minutesUntil = d => { if(!d) return null; const diff=Math.ceil((d.getTime()-Date.now())/60000); return diff<0?0:diff; };
    const createBadge = (t,cls='') => `<span class="badge ${cls}">${t}</span>`;
    const normalize = s => (typeof s==='string'? s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[\s\-‚Äì‚Äî]+/g,' ').trim() : '');
    const variants = s => { const n=normalize(s); if(!n) return []; const c=n.replace(/\s+/g,''); return c&&c!==n?[n,c]:[n]; };

    const readStoredKey = () => { try{ return (localStorage.getItem(GOLEMIO_STORAGE_KEY)||'').trim(); }catch{ return ''; } };
    const persistKey = v => { try{ v?localStorage.setItem(GOLEMIO_STORAGE_KEY,v.trim()):localStorage.removeItem(GOLEMIO_STORAGE_KEY);}catch{} };
    const getApiKey = () => readStoredKey() || (CONFIG.departures.apiKey||'').trim();
    const updateKeyLabel = () => { if(departuresKeyLabel) departuresKeyLabel.textContent = getApiKey() ? 'Zmƒõnit API kl√≠ƒç' : 'Nastavit API kl√≠ƒç'; };

    const readPlatformPref = () => { try { return (localStorage.getItem(PLATFORM_STORAGE_KEY) || ''); } catch { return ''; } };
    const persistPlatformPref = (v) => { try { localStorage.setItem(PLATFORM_STORAGE_KEY, v); } catch {} };
    function updatePlatformLabel(){
      if (!departuresPlatformLabel) return;
      const p = (CONFIG.departures.platformFilter || '').toString().toUpperCase();
      departuresPlatformLabel.textContent = `Smƒõr: ${p || 'v≈°e'}`;
    }

    function readUrlParams(){
      const p = new URLSearchParams(location.search);
      const o = {};
      if (p.get('ids'))       o.stopIds = p.get('ids').split(',').map(s=>s.trim()).filter(Boolean);
      if (p.get('title'))     o.stopLabel = p.get('title').trim();
      if (p.get('limit'))     o.limit = Math.max(1, parseInt(p.get('limit'),10) || CONFIG.departures.limit);
      if (p.get('mode'))      o.displayMode = (p.get('mode').toLowerCase()==='time') ? 'time' : 'mins';
      if (p.get('platform'))  o.platformFilter = p.get('platform').trim().toUpperCase();
      if (p.get('before'))    o.minutesBefore = Math.max(0, parseInt(p.get('before'),10) || 0);
      if (p.get('after'))     o.minutesAfter = Math.max(1, parseInt(p.get('after'),10) || CONFIG.departures.minutesAfter);
      if (p.get('dir'))       o.directionFilter = p.get('dir').split(',').map(s=>s.trim()).filter(Boolean);
      if (p.get('route'))     o.routeFilter = p.get('route').split(',').map(s=>s.trim()).filter(Boolean);
      return o;
    }

    /* === NOV√â: detekce spu≈°tƒõn√≠ z file:// kv≈Øli CORS === */
    const isFileOrigin = () => location.protocol === 'file:';

    /* ====== Weather ====== */
    const weatherLabels = {0:'Jasno',1:'P≈ôev√°≈ænƒõ jasno',2:'Oblaƒçno',3:'Zata≈æeno',45:'Mlha',48:'Mrznouc√≠ mlha',51:'M√≠rn√© mrholen√≠',53:'Mrholen√≠',55:'Intenzivn√≠ mrholen√≠',56:'Mrznouc√≠ mrholen√≠',57:'Mrznouc√≠ mrholen√≠',61:'Slab√Ω d√©≈°≈•',63:'D√©≈°≈•',65:'Siln√Ω d√©≈°≈•',66:'Mrznouc√≠ d√©≈°≈•',67:'Mrznouc√≠ d√©≈°≈•',71:'Slab√© snƒõ≈æen√≠',73:'Snƒõ≈æen√≠',75:'Siln√© snƒõ≈æen√≠',77:'Kroupy',80:'P≈ôeh√°≈àky',81:'D√©≈°≈•',82:'Siln√Ω d√©≈°≈•',85:'Snƒõhov√© p≈ôeh√°≈àky',86:'Siln√© snƒõhov√© p≈ôeh√°≈àky',95:'Bou≈ôka',96:'Bou≈ôka s krupobit√≠m',99:'Siln√° bou≈ôka'};

    async function loadWeather(){
      try{
        const {latitude,longitude,timezone}=CONFIG.weather;
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,weather_code&timezone=${timezone}`;
        const res=await fetch(url);
        if(!res.ok) throw new Error('Nepoda≈ôilo se naƒç√≠st poƒças√≠.');
        const data=await res.json(); const c=data.current; const label=weatherLabels[c.weather_code]||'Poƒças√≠ nezn√°m√©';
        weatherContent.innerHTML = `
          <div class="weather-main">
            <div><div class="weather-temp">${Math.round(c.temperature_2m)}¬∞C</div><div>${label}</div></div>
            <div class="weather-meta">
              <span>Pocitovƒõ ${Math.round(c.apparent_temperature)}¬∞C</span>
              <span>Vlhkost ${c.relative_humidity_2m}%</span>
              <span>V√≠tr ${Math.round(c.wind_speed_10m)} km/h</span>
              <span class="timestamp">Aktualizov√°no ${formatDate(new Date(c.time))}</span>
            </div>
          </div>`;
      }catch(e){ weatherContent.innerHTML = `<p class="error-message">${e.message}</p>`; }
    }

    /* ====== Departures ====== */
    function directionSummary(){ const f=safeArray(CONFIG.departures.directionFilter); return f.length?f.join(', '):'v≈°echny smƒõry'; }

    async function loadDepartures(){
      /* NOV√â: p≈ôehledn√© varov√°n√≠ p≈ôi file:// */
      if (isFileOrigin()) {
        departuresContent.innerHTML = `
          <p class="error-message">Nelze naƒç√≠st odjezdy: str√°nka bƒõ≈æ√≠ z <code>file://</code> a prohl√≠≈æeƒç blokuje po≈æadavek s&nbsp;vlastn√≠ hlaviƒçkou.</p>
          <p class="timestamp">Spus≈• p≈ôes <strong>http://localhost</strong> (nap≈ô. <code>python3 -m http.server 8080</code>) nebo ji hostuj na webu.</p>`;
        return;
      }

      updateKeyLabel();
      const apiKey=getApiKey();
      if(!apiKey){
        departuresContent.innerHTML = `
          <p class="error-message">Pro naƒçten√≠ odjezd≈Ø je pot≈ôeba Golemio API kl√≠ƒç.</p>
          <p class="timestamp">Klikni na ‚Äû${departuresKeyLabel?departuresKeyLabel.textContent:'Nastavit API kl√≠ƒç'}‚Äú a vlo≈æ token.</p>
          <p class="timestamp">Zast√°vka: ${CONFIG.departures.stopLabel} ¬∑ ${directionSummary()}</p>`;
        return;
      }

      const stopIds=safeArray(CONFIG.departures.stopIds);
      if(!stopIds.length){ departuresContent.innerHTML='<p class="error-message">Chyb√≠ CONFIG.departures.stopIds.</p>'; return; }

      try{
        const params=new URLSearchParams({
          ids:stopIds.join(','), minutesBefore:String(CONFIG.departures.minutesBefore??0),
          minutesAfter:String(CONFIG.departures.minutesAfter??30), limit:String(Math.max(CONFIG.departures.limit??6,1)),
          preferredTimezone:CONFIG.departures.timezone||'Europe/Prague', includeMetroTrains:'true'
        });
        const res=await fetch(`https://api.golemio.cz/v2/pid/departureboards?${params.toString()}`,{
          headers:{'X-Access-Token':apiKey,'Accept':'application/json'}
        });
        if(!res.ok){ const t=await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status}: ${t||'Nepoda≈ôilo se naƒç√≠st odjezdy.'}`); }
        const data=await res.json();

        const platform = (CONFIG.departures.platformFilter||'').toString().trim().toLowerCase();
        const dirFilters = safeArray(CONFIG.departures.directionFilter).flatMap(variants).filter(Boolean);
        const routeFilter = safeArray(CONFIG.departures.routeFilter).map(s=>s.toLowerCase());
        const all = Array.isArray(data.departures)? data.departures : [];

        // 1) Platforma A/B NEplat√≠ pro vlaky (type === 2) ‚Üí S9 projde v≈ædy
        const byPlatform = platform ? all.filter(d=>{
          const type = Number(d.route?.type);
          if (type === 2) return true;
          const code=(d.stop?.platform_code||'').toString().toLowerCase();
          const name=(d.stop?.platform_name||'').toString().toLowerCase();
          return code===platform || name===`st. ${platform}` || name===platform;
        }) : all;

        // 2) Voliteln√Ω filtr linek (short_name), nap≈ô. ['S9']
        const byRoute = routeFilter.length
          ? byPlatform.filter(d => {
              const short = String(d.route?.short_name || '').toLowerCase();
              return short && routeFilter.includes(short);
            })
          : byPlatform;

        // 3) Voliteln√Ω textov√Ω filtr smƒõru / headsignu
        const filtered = dirFilters.length ? byRoute.filter(d=>{
          const possible=[d.trip?.headsign,d.trip?.direction,d.last_stop?.name,d.route?.long_name,d.route?.description]
            .flatMap(variants).filter(Boolean);
          if(!possible.length) return false;
          return dirFilters.some(f=>possible.some(c=>c.includes(f)||f.includes(c)));
        }) : byRoute;

        if(!filtered.length){
          const bits=[];
          if(platform) bits.push(`st. ${platform.toUpperCase()}`);
          if(routeFilter.length) bits.push(`linky ${routeFilter.join(', ').toUpperCase()}`);
          if(dirFilters.length) bits.push(`smƒõr ${directionSummary()}`);
          departuresContent.innerHTML = `
            <p>Nebyly nalezeny ≈æ√°dn√© odjezdy pro zadan√Ω filtr (${bits.join(' ¬∑ ')||'v≈°echny smƒõry'}).</p>
            <p class="timestamp">${CONFIG.departures.stopLabel} ¬∑ Posledn√≠ kontrola ${formatDate(new Date())}</p>`;
          return;
        }

        const list = filtered.slice(0, CONFIG.departures.limit??6).map(dep=>{
          const s=dep.departure_timestamp?.scheduled, p=dep.departure_timestamp?.predicted;
          const sd=toDate(s), pd=toDate(p), show=pd||sd;
          const hhmm = show ? formatDate(show) : '‚Äî';
          const mins = minutesUntil(show);

          const mode = CONFIG.departures.displayMode||'mins';
          const cnt = (mode==='time') ? hhmm : (mins===null?'‚Äî':(mins===0?'odj√≠≈æd√≠':`${mins} min`));
          const cntClass = (mode==='mins' && mins!==null && mins<=1) ? 'success' : '';

          let delay=null;
          if(sd&&pd) delay=Math.round((pd.getTime()-sd.getTime())/60000);
          else if(typeof dep.departure_delay==='number') delay=Math.round(dep.departure_delay/60);

          let delayBadge='';
          if(delay!==null){ delayBadge = delay===0 ? createBadge('Vƒças','success') : (delay>0?createBadge(`+${delay} min`,'danger'):createBadge(`${delay} min`,'success')); }

          const line=dep.route?.short_name||dep.route?.long_name||'Linka';
          const icon=ROUTE_TYPE_ICONS[Number(dep.route?.type)]||'';
          const platformText=dep.stop?.platform_code||dep.stop?.platform_name;
          const head=dep.trip?.headsign||dep.trip?.direction||dep.last_stop?.name||'‚Äî';
          const headFull = platformText ? `${head} ¬∑ st. ${platformText}` : head;

          return `
            <div class="departure-item">
              <div>
                <div class="badge">${icon?`${icon} `:''}${line}</div>
                <div class="departure-destination">${headFull}</div>
              </div>
              <div class="departure-time">${hhmm}</div>
              <div class="departure-meta">${createBadge(cnt,cntClass)}${delayBadge}</div>
            </div>`;
        }).join('');

        const usedBits=[];
        if(platform) usedBits.push(`st. ${platform.toUpperCase()}`);
        if(routeFilter.length) usedBits.push(`linky ${routeFilter.join(', ').toUpperCase()}`);
        if(dirFilters.length) usedBits.push(`smƒõr ${directionSummary()}`);
        const used = usedBits.length ? usedBits.join(' ¬∑ ') : 'v≈°echny smƒõry';

        departuresContent.innerHTML = `
          <div class="departure-list">${list}</div>
          <div class="timestamp">${CONFIG.departures.stopLabel} ¬∑ ${used} ¬∑ Posledn√≠ kontrola ${formatDate(new Date())}</div>`;
      }catch(e){
        departuresContent.innerHTML = `<p class="error-message">${e.message}</p>`;
      }
    }

    /* ====== News ====== */
    async function loadNews(){
      try{
        const url=`https://api.allorigins.win/raw?url=${encodeURIComponent(CONFIG.news.feedUrl)}`;
        const res=await fetch(url);
        if(!res.ok) throw new Error('Nepoda≈ôilo se naƒç√≠st RSS.');
        const text=await res.text(); const xml=new DOMParser().parseFromString(text,'application/xml');
        const items=Array.from(xml.querySelectorAll('item')).slice(0,CONFIG.news.limit);
        if(!items.length){ newsContent.innerHTML='<p>Nenaƒçteny ≈æ√°dn√© ƒçl√°nky.</p>'; return; }
        const list=items.map(it=>{
          const title=it.querySelector('title')?.textContent||'Bez n√°zvu';
          const link=it.querySelector('link')?.textContent||'#';
          const pub=it.querySelector('pubDate')? new Date(it.querySelector('pubDate').textContent) : null;
          const desc=(it.querySelector('description')?.textContent||'').replace(/<[^>]*>/g,' ').replace(/&nbsp;/g,' ').replace(/\s+/g,' ').trim();
          return `<article class="news-item"><a href="${link}" target="_blank" rel="noopener">${title}</a><div class="news-meta">${pub?formatDate(pub):''}</div><p class="news-summary">${desc}</p></article>`;
        }).join('');
        newsContent.innerHTML = `<div class="news-list">${list}</div>`;
      }catch(e){ newsContent.innerHTML = `<p class="error-message">${e.message}</p>`; }
    }

    /* ====== Connectivity / Servers ====== */
    function withTimeout(promise, ms){
      return new Promise((res,rej)=>{
        const t=setTimeout(()=>rej(new Error('Vypr≈°el ƒçasov√Ω limit.')),ms);
        promise.then(v=>{clearTimeout(t);res(v)}).catch(e=>{clearTimeout(t);rej(e)});
      });
    }
    async function checkEndpoint({url,method='GET',timeoutMs=5000,mode='cors',headers}){
      const ctrl=new AbortController(); const tm=setTimeout(()=>ctrl.abort(),timeoutMs);
      try{ const r=await fetch(url,{method,mode,cache:'no-store',headers,signal:ctrl.signal}); clearTimeout(tm); return r.ok||r.type==='opaque'; }
      catch(e){ clearTimeout(tm); throw e; }
    }
    async function checkConnectivity(){
      const statusEl=document.getElementById('internet-status');
      const statusText=statusEl.querySelector('.status-text');
      const ts=document.getElementById('internet-timestamp');
      const err=document.getElementById('internet-error');
      statusEl.classList.remove('online','offline'); statusText.textContent='Kontroluji dostupnost‚Ä¶'; err.textContent='';
      try{
        const ok=await withTimeout(checkEndpoint(CONFIG.connectivity), CONFIG.connectivity.timeoutMs+1000);
        statusEl.classList.add(ok?'online':'offline'); statusText.textContent=ok?'Gateway je dostupn√°':'Gateway je nedostupn√°'; ts.textContent=`Aktualizov√°no ${formatDate(new Date())}`;
      }catch{ statusEl.classList.add('offline'); statusText.textContent='Gateway nedostupn√°'; ts.textContent=`Aktualizov√°no ${formatDate(new Date())}`; err.textContent='Zkontroluj CORS nebo adresu za≈ô√≠zen√≠.'; }
    }
    function renderLinks(){
      linksGrid.innerHTML = CONFIG.links.map(l=>`
        <a class="quick-link" href="${l.url}" target="_blank" rel="noopener">
          <i class="fa-solid ${l.icon}"></i><span>${l.label}</span>
        </a>`).join('');
    }
    async function checkServers(){
      serverList.innerHTML=''; const now=formatDate(new Date());
      for(const s of CONFIG.servers){
        const item=document.createElement('div'); item.className='server-item';
        item.innerHTML=`<div class="server-header"><i class="fa-solid ${s.icon}"></i><div><div>${s.name}</div><div class="timestamp">Kontroluji‚Ä¶</div></div></div>`;
        serverList.appendChild(item);
        try{
          const ok=await withTimeout(checkEndpoint({...s,timeoutMs:5000}),6000);
          item.innerHTML=`<div class="server-header"><i class="fa-solid ${s.icon}"></i><div><div>${s.name}</div><div class="timestamp">Aktualizov√°no ${now}</div></div></div><div class="status ${ok?'online':'offline'}"><div class="indicator"></div><div>${ok?'Online':'Offline'}</div></div>`;
        }catch{
          item.innerHTML=`<div class="server-header"><i class="fa-solid ${s.icon}"></i><div><div>${s.name}</div><div class="timestamp">Aktualizov√°no ${now}</div></div></div><div class="status offline"><div class="indicator"></div><div>Offline</div></div><p class="error-message">Nelze nav√°zat spojen√≠. Ovƒõ≈ô adresu a CORS.</p>`;
        }
      }
    }

    /* ====== Init ====== */
    function init(){
      Object.assign(CONFIG.departures, readUrlParams());

      const urlHasPlatform = new URLSearchParams(location.search).has('platform');
      if (!urlHasPlatform) {
        const storedPlat = readPlatformPref();
        if (storedPlat === '' || storedPlat === 'A' || storedPlat === 'B') {
          CONFIG.departures.platformFilter = storedPlat || '';
        }
      }

      if (departuresSetKeyButton){
        departuresSetKeyButton.addEventListener('click',()=>{
          const cur=readStoredKey();
          const nxt=window.prompt('Zadej Golemio API kl√≠ƒç (X-Access-Token).\nPr√°zdn√Ω vstup kl√≠ƒç odstran√≠.',cur||'');
          if(nxt===null) return;
          persistKey((nxt||'').trim()); updateKeyLabel(); loadDepartures();
        });
      }
      if (departuresTogglePlatform){
        departuresTogglePlatform.addEventListener('click', ()=>{
          const cur = (CONFIG.departures.platformFilter || '').toString().toUpperCase();
          const next = cur === 'A' ? 'B' : (cur === 'B' ? '' : 'A'); // A ‚Üí B ‚Üí v≈°e ‚Üí A
          CONFIG.departures.platformFilter = next;
          persistPlatformPref(next);
          updatePlatformLabel();
          loadDepartures();
        });
      }

      renderLinks();
      loadWeather();
      loadNews();
      updatePlatformLabel();
      loadDepartures();
      checkConnectivity();
      checkServers();

      setInterval(loadWeather, 20*60*1000);
      setInterval(loadNews, 30*60*1000);
      setInterval(loadDepartures, 60*1000);
      setInterval(checkConnectivity, 60*1000);
      setInterval(checkServers, 5*60*1000);
    }
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
