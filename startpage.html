<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dom√°c√≠ start</title>

  <!-- Bez SRI, a≈• se nic neblokuje -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      color-scheme:dark;
      --bg:#0f172a; --panel:rgba(15,23,42,.8); --border:rgba(148,163,184,.2);
      --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8;
      --ok:#10b981; --late:#ef4444; --chip:#1f2a44;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:32px; min-height:100vh; background:radial-gradient(circle at top,#1e293b,#0f172a 45%);
         color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; display:flex; justify-content:center}
    .app{width:min(1100px,100%); display:flex; flex-direction:column; gap:24px}
    header h1{margin:0 0 8px; font-size:clamp(28px,4.5vw,40px)}
    header p{margin:0; color:var(--muted)}
    .grid{display:grid; gap:24px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px; backdrop-filter:blur(16px)}
    .ph{display:flex; gap:10px; align-items:center; text-transform:uppercase; letter-spacing:.08em; font-size:12px; color:var(--muted); font-weight:600; margin-bottom:10px}

    /* MHD */
    .dep-ctl{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:10px}
    .seg{background:#0c1327; border:1px solid var(--border); border-radius:10px; padding:3px; display:inline-flex; gap:3px}
    .seg button{border:0; background:transparent; color:var(--text); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; font-size:12px}
    .seg button.active{background:rgba(56,189,248,.15); color:#8bdcff}
    .timestamp{color:var(--muted); font-size:12px}
    .dep-list{display:grid; gap:10px}
    .dep-item{display:grid; grid-template-columns:1fr auto auto; gap:10px; align-items:center;
              padding:10px 12px; border-radius:12px; background:rgba(148,163,184,.08)}
    .badge{padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; background:rgba(148,163,184,.16)}
    .badge.ok{background:rgba(16,185,129,.15); color:#8ef5ce}
    .badge.late{background:rgba(239,68,68,.15); color:#ffb3b3}
    .dep-dest{color:var(--muted); font-size:14px}
    .dep-time{font-weight:700; font-size:20px}
    .dep-meta{display:flex; flex-direction:column; gap:6px; align-items:flex-end}
    .error{color:#ffb3b3}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Dom√°c√≠ start</h1>
      <p>Rychl√Ω p≈ôehled: MHD odjezdy, poƒças√≠ a zpr√°vy.</p>
    </header>

    <section class="grid">
      <!-- MHD ‚Äì ponech√°na posledn√≠ funkƒçn√≠ varianta -->
      <section class="panel" id="departures-panel">
        <div class="ph"><i class="fa-solid fa-train-tram"></i> Odjezdy MHD ‚Äì Slavia / Praha-Eden (S9)</div>
        <div class="dep-ctl">
          <div class="seg" id="dep-dir-toggle">
            <button data-platform="A" class="active">Smƒõr A</button>
            <button data-platform="B">Smƒõr B</button>
          </div>
          <div class="timestamp" id="dep-stamp">Naƒç√≠t√°m‚Ä¶</div>
        </div>
        <div id="dep-content"><p>Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</p></div>
      </section>

      <!-- Poƒças√≠ (jednoduch√©, abychom teƒè nezasahovali do funkƒçn√≠ho MHD) -->
      <section class="panel" id="weather-panel">
        <div class="ph"><i class="fa-solid fa-cloud-sun"></i> Poƒças√≠ ‚Äì Vr≈°ovice</div>
        <div id="weather-content"><p>Naƒç√≠t√°m‚Ä¶</p></div>
      </section>

      <!-- Zpr√°vy (bez CORS probl√©m≈Ø: rss2json) -->
      <section class="panel" id="news-panel">
        <div class="ph"><i class="fa-solid fa-newspaper"></i> iRozhlas.cz ‚Äì nejnovƒõj≈°√≠</div>
        <div id="news-content"><p>Stahuji aktu√°ln√≠ ƒçl√°nky‚Ä¶</p></div>
      </section>
    </section>
  </div>

<script>
/* =========================
   KONFIG
========================= */
const CONFIG = {
  tz: 'Europe/Prague',

  // Cloudflare Worker ‚Äì pouze ROOT varianta, kter√° ti fungovala
  // ‚ö†Ô∏è NEMƒöNIT na /v2/... ani /pid/... ‚Äì tv≈Øj Worker vrac√≠ 404!
  golemioProxy: 'https://golemio.m88wqgcdpd.workers.dev',

  // CIS ID: TRAM Slavia ‚Äì N√°dra≈æ√≠ Eden a ≈æelezniƒçn√≠ Praha-Eden (S9)
  cisTram: 'U680Z1P',
  cisTrain: 'U680Z301',

  // Zobrazit jen spoje s odjezdem >= N minut
  minOffsetMins: 5,

  // Open-Meteo + RSS
  lat: 50.0704, lon: 14.4709,
  rssUrl: 'https://www.irozhlas.cz/rss/irozhlas'
};

const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function z(n){return String(n).padStart(2,'0')}
function fmtHM(d){return `${z(d.getHours())}:${z(d.getMinutes())}`}
function toDate(x){return x?new Date(x):null}
function minutesUntil(d){ if(!d) return null; return Math.max(0,Math.ceil((d.getTime()-Date.now())/60000)); }

/* =========================
   MHD ‚Äì pouze ROOT proxy
========================= */
const DEP = {
  platform:'A',
  async load(){
    const p = new URLSearchParams({
      ids: `${CONFIG.cisTram},${CONFIG.cisTrain}`,
      minutesBefore: '0',
      minutesAfter: '45',
      limit: '40',
      preferredTimezone: CONFIG.tz,
      includeMetroTrains: 'true'
    });
    const url = `${CONFIG.golemioProxy}/?${p.toString()}`; // ‚Üê JEN ROOT!
    const res = await fetch(url);
    if(!res.ok) throw new Error(`Chyba proxy: ${res.status}`);
    const data = await res.json();
    this.render(data);
  },
  pickTime(d){
    const s=toDate(d?.departure_timestamp?.scheduled);
    const p=toDate(d?.departure_timestamp?.predicted);
    return p||s||null;
  },
  render(data){
    const cont = $('#dep-content');
    const stamp = $('#dep-stamp');
    const iconMap = {0:'üöã',1:'‚ìÇÔ∏è',2:'üöÜ',3:'üöå',11:'üöé'};

    const list = (Array.isArray(data.departures)?data.departures:[])
      .filter(d=>{
        // min offset
        const t=this.pickTime(d), mins=minutesUntil(t);
        if(mins===null || mins<CONFIG.minOffsetMins) return false;

        // TRAM ‚Äì respektovat platformu A/B na U680Z1P
        if(d?.route?.type===0 && d?.stop?.id===CONFIG.cisTram){
          const plat=(d?.stop?.platform_code||'').toUpperCase();
          return plat===this.platform;
        }

        // VLAKY (S9) ‚Äì zobraz v≈ædy (oba smƒõry), pouze na stanici U680Z301
        if(d?.route?.type===2 && d?.stop?.id===CONFIG.cisTrain) return true;

        return false;
      })
      .sort((a,b)=> (this.pickTime(a)?.getTime()||0) - (this.pickTime(b)?.getTime()||0))
      .slice(0,12);

    if(!list.length){
      cont.innerHTML = `<p>Nebyly nalezeny ≈æ√°dn√© odjezdy pro zadan√Ω filtr (${this.platform}).</p>`;
      stamp.textContent = `Aktualizov√°no ${fmtHM(new Date())}`;
      return;
    }

    const rows = list.map(dep=>{
      const t = this.pickTime(dep);
      const mins = minutesUntil(t);
      const timeBadge = mins<=1 ? `<span class="badge ok">odj√≠≈æd√≠</span>` : `<span class="badge">${mins} min</span>`;

      // zpo≈ædƒõn√≠
      let delayBadge='';
      const s=toDate(dep?.departure_timestamp?.scheduled), p=toDate(dep?.departure_timestamp?.predicted);
      if(s&&p){
        const d=Math.round((p.getTime()-s.getTime())/60000);
        if(d>0) delayBadge=`<span class="badge late">+${d} min</span>`;
        else if(d===0) delayBadge=`<span class="badge ok">vƒças</span>`;
      }

      const line = dep?.route?.short_name || dep?.route?.long_name || '‚Äî';
      const rt = Number(dep?.route?.type ?? 0);
      const ic = iconMap[rt] || '';
      const plat = dep?.stop?.platform_code ? ` ¬∑ st. ${dep.stop.platform_code}` : '';
      const head = dep?.trip?.headsign || dep?.last_stop?.name || '‚Äî';

      return `
        <div class="dep-item">
          <div>
            <div class="badge">${ic} ${line}</div>
            <div class="dep-dest">${head}${plat}</div>
          </div>
          <div class="dep-time">${fmtHM(t)}</div>
          <div class="dep-meta">${timeBadge}${delayBadge}</div>
        </div>`;
    }).join('');

    cont.innerHTML = `<div class="dep-list">${rows}</div>`;
    stamp.textContent = `Aktualizov√°no ${fmtHM(new Date())}`;
  }
};

$('#dep-dir-toggle').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  $$('#dep-dir-toggle button').forEach(x=>x.classList.toggle('active', x===b));
  DEP.platform = b.dataset.platform.toUpperCase();
  DEP.load().catch(err=>{
    $('#dep-content').innerHTML = `<p class="error">Odjezdy: ${String(err.message||err)}</p>`;
  });
});

/* =========================
   Poƒças√≠ ‚Äì jednoduch√© info
========================= */
async function loadWeather(){
  const url = new URL('https://api.open-meteo.com/v1/forecast');
  url.searchParams.set('latitude', CONFIG.lat);
  url.searchParams.set('longitude', CONFIG.lon);
  url.searchParams.set('timezone', CONFIG.tz);
  url.searchParams.set('current', 'temperature_2m,apparent_temperature,weather_code,wind_speed_10m');
  url.searchParams.set('daily', 'temperature_2m_min,temperature_2m_max');
  url.searchParams.set('forecast_days', '1');

  const wrap = $('#weather-content');
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('Poƒças√≠ nelze naƒç√≠st');
    const d = await r.json();
    const c = d.current;
    const min = Math.round(d.daily.temperature_2m_min?.[0] ?? NaN);
    const max = Math.round(d.daily.temperature_2m_max?.[0] ?? NaN);
    wrap.innerHTML = `
      <p><strong>${Math.round(c.temperature_2m)}¬∞C</strong> (pocitovƒõ ${Math.round(c.apparent_temperature)}¬∞C)</p>
      <p>Min/Max dnes: ${isFinite(min)?min:'‚Äî'} / ${isFinite(max)?max:'‚Äî'}¬∞C</p>
      <p class="timestamp">Aktualizov√°no ${fmtHM(new Date())}</p>
    `;
  }catch(err){
    wrap.innerHTML = `<p class="error">Poƒças√≠: ${String(err.message||err)}</p>`;
  }
}

/* =========================
   Zpr√°vy ‚Äì rss2json
========================= */
async function loadNews(){
  const wrap = $('#news-content');
  try{
    const r = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(CONFIG.rssUrl)}`);
    if(!r.ok) throw new Error('RSS nelze naƒç√≠st');
    const j = await r.json();
    const items = (j.items||[]).slice(0,8);
    if(!items.length){ wrap.innerHTML='<p>≈Ω√°dn√© ƒçl√°nky.</p>'; return; }
    wrap.innerHTML = `<div class="news-list">
      ${items.map(it=>`
        <article class="news-item">
          <a href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
          <div class="timestamp">${new Date(it.pubDate).toLocaleString('cs-CZ',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}</div>
        </article>
      `).join('')}
    </div>`;
  }catch(err){
    wrap.innerHTML = `<p class="error">RSS: ${String(err.message||err)}</p>`;
  }
}

/* =========================
   INIT
========================= */
async function init(){
  // MHD (kl√≠ƒçov√° ƒç√°st ‚Äì posledn√≠ funkƒçn√≠ varianta)
  DEP.load().catch(err=>{
    $('#dep-content').innerHTML = `<p class="error">Odjezdy: ${String(err.message||err)}</p>`;
  });

  // Ostatn√≠ ‚Äì jen lehk√©, a≈• neru≈°√≠ MHD
  loadWeather();
  loadNews();

  // refreshy
  setInterval(()=>DEP.load().catch(()=>{}), 60*1000);
  setInterval(()=>loadWeather().catch(()=>{}), 20*60*1000);
  setInterval(()=>loadNews().catch(()=>{}), 30*60*1000);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>