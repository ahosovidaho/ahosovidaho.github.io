<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Dom√°c√≠ start</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ikony bez SRI (minule padalo na integrity) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{
      color-scheme: dark;
      --bg:#0f172a; --panel:rgba(15,23,42,.8); --border:rgba(148,163,184,.2);
      --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8; --danger:#f87171; --good:#34d399; --warn:#facc15;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    html,body{margin:0;padding:0;background:radial-gradient(circle at top, #1e293b, #0f172a 45%);color:var(--text)}
    .app{max-width:1200px;margin:32px auto;padding:0 16px;display:flex;flex-direction:column;gap:24px}
    header{display:flex;flex-direction:column;gap:8px}
    header h1{font-size:clamp(32px,5vw,44px);font-weight:700}
    header p{color:var(--muted);max-width:600px}
    .top-grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;backdrop-filter:blur(16px);box-shadow:0 20px 40px -24px rgba(15,23,42,.65);display:flex;flex-direction:column;gap:16px}
    .panel-header{display:flex;align-items:center;gap:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;font-size:12px;color:var(--muted)}
    .panel-actions{display:flex;gap:12px;flex-wrap:wrap}
    .ghost-button{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.3);background:transparent;color:var(--text);font-weight:500;cursor:pointer}
    .ghost-button:hover{border-color:rgba(56,189,248,.6);color:var(--accent);background:rgba(56,189,248,.1)}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;background:rgba(148,163,184,.16);color:var(--text);display:inline-flex;align-items:center;gap:.5em}
    .badge.success{background:rgba(52,211,153,.15);color:var(--good)}
    .badge.warn{background:rgba(250,204,21,.15);color:var(--warn)}
    .badge.danger{background:rgba(248,113,113,.15);color:var(--danger)}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .col{display:flex;flex-direction:column;gap:6px}
    .big{font-size:clamp(40px,5vw,56px);font-weight:800}
    .mono{font-variant-numeric:tabular-nums}
    .divider{height:1px;background:var(--border);margin:4px 0}
    .grid2{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .departure-list{display:grid;gap:12px}
    .departure-item{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08)}
    .departure-time{font-size:20px;font-weight:700}
    .departure-destination{margin-top:6px;color:var(--muted);font-size:14px}
    .departure-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .main-layout{display:grid;gap:24px;grid-template-columns:minmax(220px,1fr) minmax(0,2fr) minmax(220px,1fr);grid-template-areas:'links news servers';align-items:start}
    #links-panel{grid-area:links} #news-panel{grid-area:news} #servers-panel{grid-area:servers}
    .links-grid{display:flex;flex-direction:column;gap:12px}
    .quick-link{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08);color:var(--text);text-decoration:none;font-weight:500}
    .quick-link:hover{background:rgba(56,189,248,.16);color:var(--accent)}
    .news-list{display:grid;gap:16px}
    .news-item{display:grid;gap:8px;padding-bottom:12px;border-bottom:1px solid rgba(148,163,184,.1)}
    .news-item:last-child{border-bottom:none;padding-bottom:0}
    .news-item a{color:var(--text);font-weight:600;text-decoration:none;font-size:18px}
    .news-item a:hover{color:var(--accent)}
    .timestamp{font-size:12px;color:var(--muted)}
    .status{display:flex;align-items:center;gap:12px}
    .status .indicator{width:10px;height:10px;border-radius:999px;background:var(--warn);box-shadow:0 0 0 4px rgba(250,204,21,.16)}
    .status.online .indicator{background:var(--good);box-shadow:0 0 0 4px rgba(52,211,153,.16)}
    .status.offline .indicator{background:var(--danger);box-shadow:0 0 0 4px rgba(248,113,113,.16)}
    @media (max-width:1024px){.main-layout{grid-template-columns:1fr;grid-template-areas:'links' 'news' 'servers'}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Dom√°c√≠ start</h1>
      <p class="muted">Rann√≠/veƒçern√≠ p≈ôehled ‚Äì poƒças√≠, MHD, dostupnost dom√°c√≠ s√≠tƒõ a rychl√© odkazy.</p>
    </header>

    <div class="top-grid">
      <!-- POƒåAS√ç (ponech√°no z posledn√≠ verze) -->
      <section class="panel" id="weather-panel">
        <div class="panel-header">
          <i class="fa-solid fa-cloud-sun"></i><span>Poƒças√≠ ‚Äì Vr≈°ovice</span>
        </div>
        <div id="weather-content"><p class="muted">Naƒç√≠t√°m aktu√°ln√≠ poƒças√≠‚Ä¶</p></div>
      </section>

      <!-- ODJEZDY MHD ‚Äì VR√ÅCEN√Å P≈ÆVODN√ç LOGIKA (worker jen na /?...) -->
      <section class="panel" id="departures-panel">
        <div class="panel-header">
          <i class="fa-solid fa-train-tram"></i><span>Odjezdy MHD</span>
        </div>
        <div id="departures-content"><p class="muted">Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</p></div>
        <div class="panel-actions">
          <button type="button" class="ghost-button" id="dir-a"><i class="fa-solid fa-arrow-right"></i> smƒõr A (Koh-i-noor)</button>
          <button type="button" class="ghost-button" id="dir-b"><i class="fa-solid fa-arrow-left"></i> smƒõr B (Kub√°nsk√© n√°m.)</button>
        </div>
      </section>

      <!-- INTERNET (pozn.: zvenku HTTP lok√°ly blokuje https prohl√≠≈æeƒçe) -->
      <section class="panel" id="internet-panel">
        <div class="panel-header"><i class="fa-solid fa-wifi"></i><span>Dom√°c√≠ internet</span></div>
        <div id="internet-status" class="status"><div class="indicator"></div><div><div class="status-text">Kontroluji dostupnost‚Ä¶</div><div class="timestamp" id="internet-timestamp"></div></div></div>
        <p class="timestamp muted">Kontrola dom√°c√≠ch IP z≈Øst√°v√° lok√°ln√≠ ‚Äì pro HTTPS dom√©nu zvenku prohl√≠≈æeƒç blokuje HTTP (mixed content).</p>
      </section>
    </div>

    <div class="main-layout">
      <aside class="panel" id="links-panel">
        <div class="panel-header"><i class="fa-solid fa-bookmark"></i><span>Rychl√© odkazy</span></div>
        <div class="links-grid" id="links-grid"></div>
      </aside>

      <section class="panel" id="news-panel">
        <div class="panel-header"><i class="fa-solid fa-newspaper"></i><span>iRozhlas.cz ‚Äì nejnovƒõj≈°√≠</span></div>
        <div id="news-content"><p class="muted">Stahuji aktu√°ln√≠ ƒçl√°nky‚Ä¶</p></div>
      </section>

      <aside class="panel" id="servers-panel">
        <div class="panel-header"><i class="fa-solid fa-server"></i><span>Dom√°c√≠ slu≈æby</span></div>
        <div class="status"><div class="indicator"></div><div>Lok√°ln√≠ ping skryt ‚Äì viz pozn√°mku u ‚ÄûDom√°c√≠ internet‚Äú</div></div>
      </aside>
    </div>
  </div>

  <script>
    // ===== KONFIG =====
    const CONFIG = {
      weather: { latitude: 50.0699, longitude: 14.4712, timezone: 'Europe/Prague' },
      departures: {
        // !!! PONECH√ÅNO NA KO≈òENU WORKERU (to byla verze, kter√° fungovala)
        proxyBase: 'https://golemio.m88wqgcdpd.workers.dev/',

        // A/B tram + S9 vlak:
        stopIdsTram_A: ['U680Z1P'],   // platforma A (Koh-i-noor)
        stopIdsTram_B: ['U680Z2P'],   // platforma B (Kub√°nsk√© n√°m.)
        stopIdsTrain:  ['U680Z301'],  // Praha-Eden (S9)
        limit: 12,
        minutesBefore: 0,
        minutesAfter: 45,
        timezone: 'Europe/Prague',
        minLeadMinutes: 5   // zobraz jen odjezdy nejd≈ô√≠ve za 5 min (to jsme ladili)
      },
      news: {
        feedUrl: 'https://www.irozhlas.cz/rss/irozhlas',
        limit: 8
      },
      links: [
        { label: 'E-mail', url: 'https://mail.google.com', icon: 'fa-envelope' },
        { label: 'Kalend√°≈ô', url: 'https://calendar.google.com', icon: 'fa-calendar-days' },
        { label: 'Nextcloud', url: 'https://cloud.example.com', icon: 'fa-cloud' },
        { label: 'Home Assistant', url: 'https://ha.example.com', icon: 'fa-house-signal' },
        { label: 'Plex', url: 'https://plex.tv/web', icon: 'fa-clapperboard-play' },
        { label: 'Bankovnictv√≠', url: 'https://ib.examplebank.cz', icon: 'fa-piggy-bank' }
      ]
    };

    // ===== UTILS =====
    const weatherContent = document.getElementById('weather-content');
    const departuresContent = document.getElementById('departures-content');
    const newsContent = document.getElementById('news-content');
    const linksGrid = document.getElementById('links-grid');

    const ROUTE_TYPE_ICONS = {0:'üöã',1:'‚ìÇÔ∏è',2:'üöÜ',3:'üöå',11:'üöé'};

    const WMO = {
      0:'Jasno',1:'P≈ôev√°≈ænƒõ jasno',2:'Oblaƒçno',3:'Zata≈æeno',
      45:'Mlha',48:'Mrznouc√≠ mlha',
      51:'M√≠rn√© mrholen√≠',53:'Mrholen√≠',55:'Intenzivn√≠ mrholen√≠',
      56:'Mrznouc√≠ mrholen√≠',57:'Mrznouc√≠ mrholen√≠',
      61:'Slab√Ω d√©≈°≈•',63:'D√©≈°≈•',65:'Siln√Ω d√©≈°≈•',
      66:'Mrznouc√≠ d√©≈°≈•',67:'Mrznouc√≠ d√©≈°≈•',
      71:'Slab√© snƒõ≈æen√≠',73:'Snƒõ≈æen√≠',75:'Siln√© snƒõ≈æen√≠',
      77:'Kroupy',
      80:'P≈ôeh√°≈àky',81:'P≈ôeh√°≈àky',82:'Siln√© p≈ôeh√°≈àky',
      85:'Snƒõhov√© p≈ôeh√°≈àky',86:'Siln√© snƒõhov√© p≈ôeh√°≈àky',
      95:'Bou≈ôka',96:'Bou≈ôka s krupobit√≠m',99:'Siln√° bou≈ôka'
    };

    const dd = n => String(n).padStart(2,'0');
    const fmtTime = d => new Intl.DateTimeFormat('cs-CZ',{hour:'2-digit',minute:'2-digit'}).format(d);
    const dateKey = d => `${d.getFullYear()}-${dd(d.getMonth()+1)}-${dd(d.getDate())}`;
    const chip = (label, cls='') => `<span class="badge ${cls}">${label}</span>`;

    function minutesUntil(tsISO){
      if(!tsISO) return null;
      const t = new Date(tsISO).getTime() - Date.now();
      return Math.max(0, Math.ceil(t/60000));
    }

    // ===== POƒåAS√ç (posledn√≠ verze) =====
    async function loadWeather(){
      const { latitude, longitude, timezone } = CONFIG.weather;
      const url = new URL('https://api.open-meteo.com/v1/forecast');
      const params = {
        latitude, longitude, timezone,
        past_days: 1, forecast_days: 1,
        current: 'temperature_2m,apparent_temperature,precipitation,wind_speed_10m,wind_gusts_10m,weather_code,is_day',
        daily: 'temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max'
      };
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, String(v)));

      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Nepoda≈ôilo se naƒç√≠st poƒças√≠.');
        const data = await res.json();

        const cur = data.current;
        const now = new Date(cur.time);
        const t = Math.round(cur.temperature_2m);
        const feels = Math.round(cur.apparent_temperature);
        const wLabel = WMO[cur.weather_code] || 'Poƒças√≠ nezn√°m√©';
        const wind = Math.round(cur.wind_speed_10m || 0);
        const gust = Math.round(cur.wind_gusts_10m || 0);
        const precipNow = Number(cur.precipitation || 0);

        const idxToday = data.daily.time.findIndex(s => s === dateKey(new Date()));
        const idxYday  = data.daily.time.findIndex(s => s === dateKey(new Date(Date.now()-86400000)));

        const tMaxToday = idxToday>=0 ? Math.round(data.daily.temperature_2m_max[idxToday]) : null;
        const tMinToday = idxToday>=0 ? Math.round(data.daily.temperature_2m_min[idxToday]) : null;
        const tMaxYday  = idxYday>=0  ? Math.round(data.daily.temperature_2m_max[idxYday])  : null;
        const deltaVsY  = (tMaxToday!=null && tMaxYday!=null) ? (tMaxToday - tMaxYday) : null;

        const precipSumToday = idxToday>=0 ? (data.daily.precipitation_sum[idxToday] || 0) : 0;

        const needUmbrella = precipNow > 0 || precipSumToday >= 0.3;
        const strongWind = gust >= 45;
        const icingRisk = (t <= 2 && t >= -2 && (precipNow > 0 || precipSumToday > 0));

        const verdict = [
          `Teƒè pocitovƒõ ${feels}¬∞C (${wLabel})`,
          needUmbrella ? '‚òî vhodn√Ω de≈°tn√≠k' : 'bez de≈°tn√≠ku',
          strongWind ? `üí® poryvy a≈æ ${gust} km/h` : `v√≠tr ${wind} km/h`
        ].join(' ¬∑ ');

        const outfit = buildClothingAdvice(feels, strongWind, needUmbrella);
        const deltaTxt = (deltaVsY==null) ? '' :
          (deltaVsY>0 ? `Dnes tepleji o +${deltaVsY}¬∞C vs. vƒçera` :
           deltaVsY<0 ? `Dnes chladnƒõji o ${deltaVsY}¬∞C vs. vƒçera` : 'Stejnƒõ jako vƒçera');

        const badges = [
          needUmbrella ? chip('P≈ôeh√°≈àky', 'warn') : '',
          strongWind ? chip(`Siln√Ω v√≠tr ¬∑ ${gust} km/h`, 'danger') : '',
          icingRisk ? chip('N√°led√≠', 'danger') : ''
        ].filter(Boolean).join(' ');

        weatherContent.innerHTML = `
          <div class="col">
            <div class="row">
              <div class="big mono">${feels}¬∞C</div>
              <div class="col">
                <div>${verdict}</div>
                <div class="row">${badges || chip('Bez varov√°n√≠','success')}</div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="grid2">
              <div class="row">
                <span class="badge">Min ${tMinToday ?? '‚Äî'}¬∞</span>
                <span class="badge">Max ${tMaxToday ?? '‚Äî'}¬∞</span>
                ${deltaTxt ? `<span class="badge">${deltaTxt}</span>` : ''}
              </div>
              <div class="timestamp">Aktualizov√°no ${fmtTime(now)}</div>
            </div>
            <div class="row">
              <i class="fa-solid fa-shirt"></i>
              <div>${outfit}</div>
            </div>
          </div>
        `;
      }catch(err){
        weatherContent.innerHTML = `<p class="badge danger">Poƒças√≠: ${err.message || err}</p>`;
      }
    }

    function buildClothingAdvice(feels, strongWind, needUmbrella){
      let base;
      if (feels <= -5) base = 'zimn√≠ bunda, ƒçepice a rukavice';
      else if (feels <= 3) base = 'tepl√° bunda, ƒçepice';
      else if (feels <= 10) base = 'bunda + teplej≈°√≠ spodn√≠ pr√°dlo';
      else if (feels <= 18) base = 'mikina / lehk√° bunda';
      else if (feels <= 24) base = 'triƒçko + lehk√° vrstva';
      else base = 'velmi lehk√© obleƒçen√≠';
      const extras = [];
      if (needUmbrella) extras.push('de≈°tn√≠k');
      if (strongWind) extras.push('nefoukav√° vrstva');
      return extras.length ? `${base} (+ ${extras.join(', ')})` : base;
    }

    // ===== MHD ‚Äì VR√ÅCEN√ù P≈ÆVODN√ç FETCH (pouze root /?...) =====
    let currentDir = 'A'; // A = Koh-i-noor, B = Kub√°nsk√© n√°mƒõst√≠
    document.getElementById('dir-a').addEventListener('click', ()=>{ currentDir='A'; loadDepartures(); });
    document.getElementById('dir-b').addEventListener('click', ()=>{ currentDir='B'; loadDepartures(); });

    async function fetchDepartures(idsArr){
      const { proxyBase, minutesBefore, minutesAfter, limit, timezone } = CONFIG.departures;
      const url = new URL(proxyBase); // D≈ÆLE≈ΩIT√â: jen ko≈ôen, ≈æ√°dn√° cesta
      url.searchParams.set('ids', idsArr.join(','));
      url.searchParams.set('minutesBefore', String(minutesBefore||0));
      url.searchParams.set('minutesAfter',  String(minutesAfter||30));
      url.searchParams.set('limit',         String(limit||12));
      url.searchParams.set('preferredTimezone', timezone || 'Europe/Prague');
      url.searchParams.set('includeMetroTrains', 'true');

      const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
      if(!res.ok) throw new Error(`Chyba proxy: ${res.status}`);
      return await res.json();
    }

    function normalizeDepartures(list){
      return (Array.isArray(list)?list:[]).map(d => {
        const scheduled = d?.departure_timestamp?.scheduled || null;
        const predicted = d?.departure_timestamp?.predicted || null;
        const iso = predicted || scheduled;
        const mins = minutesUntil(iso);
        const line = d?.route?.short_name || d?.route?.long_name || 'Linka';
        const type = Number(d?.route?.type);
        const icon = Number.isFinite(type) ? (ROUTE_TYPE_ICONS[type]||'') : '';
        const platform = d?.stop?.platform_code || d?.stop?.platform_name || '';
        const headsignBase = d?.trip?.headsign || d?.last_stop?.name || '‚Äî';
        const headsign = platform ? `${headsignBase} ¬∑ st. ${platform}` : headsignBase;

        // zpo≈ædƒõn√≠
        let delayMin = null;
        const s = scheduled ? new Date(scheduled) : null;
        const p = predicted ? new Date(predicted) : null;
        if (s && p) delayMin = Math.round((p.getTime()-s.getTime())/60000);
        else if (typeof d?.departure_delay === 'number') delayMin = Math.round(d.departure_delay/60);

        return { iso, mins, line, icon, headsign, delayMin, stopId: d?.stop?.id || null };
      }).filter(x => x.iso);
    }

    function renderDepartures(list, label){
      if (!list.length){
        departuresContent.innerHTML = `
          <p>Nebyly nalezeny ≈æ√°dn√© odjezdy pro zadan√Ω filtr (${label}).</p>
          <div class="timestamp">Posledn√≠ kontrola ${fmtTime(new Date())}</div>
        `;
        return;
      }
      const items = list.map(x=>{
        const when = fmtTime(new Date(x.iso));
        const mins = x.mins==null ? '‚Äî' : (x.mins===0 ? 'odj√≠≈æd√≠' : `${x.mins} min`);
        const delayBadge = x.delayMin==null ? '' :
            (x.delayMin===0 ? chip('Vƒças','success') :
             x.delayMin>0   ? chip(`+${x.delayMin} min`,'danger') :
                              chip(`${x.delayMin} min`,'success'));
        const speedBadge = x.mins!=null && x.mins<=1 ? chip(mins,'success') : chip(mins);
        return `
          <div class="departure-item">
            <div>
              <div class="badge">${x.icon?`${x.icon} `:''}${x.line}</div>
              <div class="departure-destination">${x.headsign}</div>
            </div>
            <div class="departure-time mono">${when}</div>
            <div class="departure-meta">${speedBadge}${delayBadge}</div>
          </div>
        `;
      }).join('');
      departuresContent.innerHTML = `
        <div class="departure-list">${items}</div>
        <div class="timestamp">Slavia ‚Äì n√°dra≈æ√≠ Eden ¬∑ smƒõr ${label==='A'?'Koh-i-noor':'Kub√°nsk√© n√°mƒõst√≠'} ¬∑ Aktualizov√°no ${fmtTime(new Date())}</div>
      `;
    }

    async function loadDepartures(){
      try{
        const idsTram = (currentDir==='A') ? CONFIG.departures.stopIdsTram_A : CONFIG.departures.stopIdsTram_B;
        const idsAll = [...idsTram, ...CONFIG.departures.stopIdsTrain]; // tram dle smƒõru + vlaky S9
        const data = await fetchDepartures(idsAll);

        // vyber jen odjezdy pro dan√© platformy + vlak
        const allow = new Set(idsTram.concat(CONFIG.departures.stopIdsTrain));
        const byStop = (data.departures||[]).filter(d => allow.has(d?.stop?.id));
        let list = normalizeDepartures(byStop);

        // jen odjezdy nejd≈ô√≠ve za N minut (zachov√°v√°m vyladƒõn√≠)
        const minLead = Number(CONFIG.departures.minLeadMinutes||0);
        if (minLead>0) list = list.filter(x => x.mins==null ? false : x.mins >= minLead);

        // fallback: kdy≈æ by filtr vypr√°zdnil, zobraz aspo≈à nƒõco
        if (!list.length){
          let all = normalizeDepartures(data.departures||[]);
          if (minLead>0) all = all.filter(x => x.mins!=null && x.mins>=minLead);
          list = all;
        }

        renderDepartures(list, currentDir);
      }catch(err){
        departuresContent.innerHTML = `<p class="badge danger">Odjezdy MHD: ${err.message || err}</p>`;
      }
    }

    // ===== NEWS (tich√Ω fallback) =====
    async function loadNews(){
      const tryFetch = async (u) => {
        try{
          const r = await fetch(u);
          if(!r.ok) return null;
          const text = await r.text();
          const xml = new DOMParser().parseFromString(text,'application/xml');
          const items = Array.from(xml.querySelectorAll('item'));
          return items.length ? items : null;
        }catch{ return null; }
      };
      const urls = [
        `https://r.jina.ai/https://www.irozhlas.cz/rss/irozhlas`,
        `https://r.jina.ai/http://www.irozhlas.cz/rss/irozhlas`
      ];
      let items = null;
      for (const u of urls){ items = await tryFetch(u); if(items) break; }
      if(!items){ newsContent.innerHTML = `<p class="muted">Zpr√°vy: doƒçasnƒõ nedostupn√©.</p>`; return; }

      const list = items.slice(0, CONFIG.news.limit).map(item=>{
        const title = item.querySelector('title')?.textContent || 'Bez n√°zvu';
        const link = item.querySelector('link')?.textContent || '#';
        const pub = item.querySelector('pubDate') ? new Date(item.querySelector('pubDate').textContent) : null;
        const descrRaw = item.querySelector('description')?.textContent || '';
        const descr = descrRaw.replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim();
        return `
          <article class="news-item">
            <a href="${link}" target="_blank" rel="noopener">${title}</a>
            <div class="timestamp">${pub ? fmtTime(pub) : ''}</div>
            <p class="muted">${descr}</p>
          </article>
        `;
      }).join('');
      newsContent.innerHTML = `<div class="news-list">${list}</div>`;
    }

    function renderLinks(){
      document.getElementById('links-grid').innerHTML = CONFIG.links.map(l => `
        <a class="quick-link" href="${l.url}" target="_blank" rel="noopener">
          <i class="fa-solid ${l.icon}"></i><span>${l.label}</span>
        </a>
      `).join('');
    }

    // ===== INIT =====
    (async function init(){
      renderLinks();
      await loadWeather();
      await loadNews();
      await loadDepartures();
      setInterval(loadWeather, 20*60*1000);
      setInterval(loadNews, 30*60*1000);
      setInterval(loadDepartures, 60*1000);
    })();
  </script>
</body>
</html>