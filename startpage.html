<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>DomÃ¡cÃ­ start</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#0f1720; --panel:#14212b; --border:#1e2c37; --text:#dbe6ef; --muted:#9bb3c6;
      --good:#1fb974; --warn:#efb33f; --bad:#ff6b6b; --chip:#1b2b38;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1160px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);margin-bottom:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
    .title{font-size:13px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);display:flex;align-items:center;gap:8px}
    .row{display:flex;align-items:center;gap:8px}
    .spacer{flex:1}
    .btn{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .switch{display:inline-flex;background:var(--chip);border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .switch button{border:0;background:transparent;color:var(--muted);padding:8px 12px;cursor:pointer}
    .switch button.active{color:var(--text);background:#0f2530}
    .pill{font-size:12px;border-radius:999px;padding:3px 8px;background:#113244;border:1px solid #214457;color:#a7c5d9}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .dep{display:flex;align-items:center;gap:10px;background:#10202b;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .line{min-width:44px;text-align:center;font-weight:700;background:#0e1a23;border:1px solid #22313d;border-radius:10px;padding:6px 8px}
    .where{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-variant-numeric:tabular-nums}
    .delay{font-size:12px;margin-left:8px}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .error{color:var(--bad);white-space:pre-wrap}
    dialog{border:1px solid var(--border);border-radius:14px;background:var(--panel);color:var(--text);padding:20px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    input[type=text]{width:100%;box-sizing:border-box;background:#0e1a23;border:1px solid #22313d;border-radius:10px;color:var(--text);padding:10px 12px}
    small{color:var(--muted)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:#0e1f29;border:1px solid #22313d;border-radius:999px;padding:6px 10px;font-size:13px}
    .bigtemp{font-size:38px;font-weight:800}
    .delta{font-weight:700}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>DomÃ¡cÃ­ start</h1>
    <div class="sub">SoukromÃ¡ nÃ¡stÄ›nka â€“ poÄasÃ­, MHD, dostupnost sÃ­tÄ› a rychlÃ© odkazy.</div>

    <div class="grid">
      <!-- POÄŒASÃ -->
      <section class="card" id="weatherCard">
        <div class="title">PoÄasÃ­ (VrÅ¡ovice)</div>
        <div class="row" style="margin-top:10px;gap:10px">
          <div class="switch" id="daySwitch" role="tablist" aria-label="Zvol den">
            <button id="dayToday" class="active" role="tab" aria-selected="true">Dnes</button>
            <button id="dayTomorrow" role="tab" aria-selected="false">ZÃ­tra</button>
          </div>
          <div class="spacer"></div>
          <div class="pill" id="weatherBadge">NaÄÃ­tÃ¡mâ€¦</div>
        </div>
        <div id="weatherBox" style="margin-top:14px" class="muted">NaÄÃ­tÃ¡m aktuÃ¡lnÃ­ poÄasÃ­â€¦</div>
      </section>

      <!-- ODJEZDY MHD -->
      <section class="card" id="mhdCard">
        <div class="title">Odjezdy MHD</div>
        <div class="row" style="margin-top:10px;gap:10px">
          <button class="btn" id="dirBtn">SmÄ›r: Koh-i-noor</button>
          <div class="pill" id="titlePill">Slavia â€“ nÃ¡draÅ¾Ã­ Eden</div>
          <div class="spacer"></div>
          <button class="btn" id="apiBtn">ZmÄ›nit API klÃ­Ä</button>
        </div>
        <div id="mhdList" class="list" aria-live="polite" style="min-height:48px;margin-top:14px">
          <div class="muted">NaÄÃ­tÃ¡m nejbliÅ¾Å¡Ã­ odjezdyâ€¦</div>
        </div>
        <div class="foot" id="mhdFoot"></div>
      </section>

      <!-- DOMÃCÃ INTERNET -->
      <section class="card" id="netCard">
        <div class="title">DomÃ¡cÃ­ internet</div>
        <div id="netBox" style="margin-top:14px" class="muted"></div>
      </section>

      <!-- RYCHLÃ‰ ODKAZY -->
      <section class="card" id="linksCard">
        <div class="title">RychlÃ© odkazy</div>
        <div id="linksBox" class="list" style="margin-top:14px"></div>
      </section>

      <!-- ZPRÃVY -->
      <section class="card" id="newsCard">
        <div class="title">iRozhlas.cz â€“ nejnovÄ›jÅ¡Ã­ zprÃ¡vy</div>
        <div id="newsBox" class="list" style="margin-top:14px">
          <div class="muted">Stahuji ÄlÃ¡nkyâ€¦</div>
        </div>
      </section>

      <!-- SLUÅ½BY -->
      <section class="card" id="svcCard">
        <div class="title">DomÃ¡cÃ­ sluÅ¾by</div>
        <div id="svcBox" class="list" style="margin-top:14px"></div>
      </section>
    </div>
  </div>

  <!-- Modal API key -->
  <dialog id="apiDlg">
    <form method="dialog">
      <h3 style="margin:0 0 8px 0">Golemio API klÃ­Ä</h3>
      <p class="muted" style="margin:0 0 10px 0">VloÅ¾ svÅ¯j <em>X-Access-Token</em> (uloÅ¾Ã­ se jen v tomto prohlÃ­Å¾eÄi).</p>
      <input type="text" id="apiInput" autocomplete="off" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9â€¦" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" value="cancel">ZruÅ¡it</button>
        <button class="btn" value="ok">UloÅ¾it</button>
      </div>
      <small>Token mÅ¯Å¾eÅ¡ kdykoli zmÄ›nit.</small>
    </form>
  </dialog>

  <script>
  // ---------- KONFIG ----------
  window.CONFIG = window.CONFIG || {};
  CONFIG.weather = { lat:50.0704, lon:14.4709, tz:"Europe/Prague" };

  // MHD pÅ™es *golemioproxy*
  CONFIG.departures = {
    proxyUrl: "https://golemioproxy.m88wqgcdpd.workers.dev",
    ids: "U680Z1P,U680Z2P,U680Z301",
    title: "Slavia â€“ nÃ¡draÅ¾Ã­ Eden",
    limit: 20,
    mode: "mins",
    minMinutes: 5
  };

  const LINKS = [
    { label: "E-mail", url: "https://mail.google.com" },
    { label: "KalendÃ¡Å™", url: "https://calendar.google.com" },
    { label: "Nextcloud", url: "#" },
    { label: "Home Assistant", url: "#" },
    { label: "Plex", url: "#" }
  ];

  const SERVICES = [
    { name:"Plex (Mac mini M4)", url:"http://192.168.1.50:32400/web/index.html" },
    { name:"Nextcloud (Mac mini 2012)", url:"http://192.168.1.60/status.php" },
    { name:"Home Assistant", url:"http://192.168.1.60:8123/" },
  ];

  // ---------- UTIL ----------
  const $ = s => document.querySelector(s);
  const fmtHM = d => `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  const fmtHHMM = iso => { const d = new Date(iso); return fmtHM(d); };
  const minsTo = iso => { const d=new Date(iso); return Math.max(0, Math.ceil((d-Date.now())/60000)); };
  const delayMin = (sched, pred) => (!sched||!pred)?0:Math.round((new Date(pred)-new Date(sched))/60000);
  const iconByType = t => (t===0?"ğŸš‹":t===2?"ğŸš†":t===3?"ğŸšŒ":t===11?"ğŸš":"ğŸ§­");
  const round = n => Math.round(Number(n));

  // ---------- API KEY storage ----------
  const KEY_NAME = "golemio_api_key";
  const getToken = () => localStorage.getItem(KEY_NAME) || "";
  const setToken = v => localStorage.setItem(KEY_NAME, v||"");

  // ---------- WEATHER ----------
  let dayIndex = 0; // 0 dnes, 1 zÃ­tra
  let weatherCache = null;

  function clothingAdvice(apparent){
    if (apparent <= -5) return "ğŸ§¥ğŸ§£ğŸ§¤ velmi teplÃ© obleÄenÃ­, klidnÄ› termoprÃ¡dlo";
    if (apparent <= 3)  return "ğŸ§¥ğŸ§£ teplÃ¡ bunda, zvaÅ¾ spodnÃ­ vrstvu navÃ­c";
    if (apparent <= 10) return "ğŸ§¥ lehkÃ¡ bunda/svÄ›tÅ™Ã­k";
    if (apparent <= 18) return "ğŸ§¥ rÃ¡no lehkÃ¡ vrstva, pÅ™es den v pohodÄ›";
    if (apparent <= 24) return "ğŸ‘• triÄko, lehkÃ¡ bunda do vÄ›tru";
    return "ğŸ‘•ğŸ§¢ lehkÃ© obleÄenÃ­";
  }

  function umbrellaNote(minutely, dailyProb, whichDay){
    // Dnes: minutely_15 â†’ do 3h
    if (whichDay===0 && Array.isArray(minutely?.time)) {
      const now = Date.now();
      for (let i=0;i<minutely.time.length;i++){
        const ts = new Date(minutely.time[i]).getTime();
        const mm = minutely.precipitation?.[i] ?? 0;
        if (ts>=now && ts-now <= 3*60*60*1000 && mm>0.05){
          const mins = Math.round((ts-now)/60000);
          return `â˜”ï¸ DeÅ¡tnÃ­k se hodÃ­ â€” za ${mins} min zaÄne prÅ¡et`;
        }
      }
    }
    // ZÃ­tra: pouÅ¾ij dennÃ­ pravdÄ›podobnost
    if ((dailyProb ?? 0) >= 60) return `â˜”ï¸ DeÅ¡tnÃ­k se mÅ¯Å¾e hodit (pravdÄ›podobnost srÃ¡Å¾ek ${dailyProb}%)`;
    if ((dailyProb ?? 0) >= 30) return `ğŸŒ¦ PÅ™ehÃ¡Åˆky moÅ¾nÃ© (${dailyProb}%)`;
    return "ğŸŒ‚ Bez deÅ¡tnÃ­ku";
  }

  async function fetchWeather(){
    const u = new URL("https://api.open-meteo.com/v1/forecast");
    u.searchParams.set("latitude", CONFIG.weather.lat);
    u.searchParams.set("longitude", CONFIG.weather.lon);
    u.searchParams.set("timezone", CONFIG.weather.tz);

    u.searchParams.set("current","temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,wind_gusts_10m,weather_code");
    u.searchParams.set("minutely_15","precipitation");
    u.searchParams.set("hourly","temperature_2m,precipitation,precipitation_probability,weather_code");
    u.searchParams.set("daily","temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_probability_mean,wind_speed_10m_max");
    u.searchParams.set("forecast_days","2");
    u.searchParams.set("past_days","1");

    const r = await fetch(u, {cache:"no-store"});
    if(!r.ok) throw new Error("PoÄasÃ­ nelze naÄÃ­st.");
    return r.json();
  }

  function renderWeather(){
    const j = weatherCache;
    if(!j){ $("#weatherBox").textContent = "PoÄasÃ­ nedostupnÃ©."; return; }

    const c = j.current;
    const labels = {0:"Jasno",1:"PÅ™evÃ¡Å¾nÄ› jasno",2:"OblaÄno",3:"ZataÅ¾eno",45:"Mlha",48:"MrznoucÃ­ mlha",
      51:"MÃ­rnÃ© mrholenÃ­",53:"MrholenÃ­",55:"IntenzivnÃ­ mrholenÃ­",56:"MrznoucÃ­ mrholenÃ­",57:"MrznoucÃ­ mrholenÃ­",
      61:"SlabÃ½ dÃ©Å¡Å¥",63:"DÃ©Å¡Å¥",65:"SilnÃ½ dÃ©Å¡Å¥",66:"MrznoucÃ­ dÃ©Å¡Å¥",67:"MrznoucÃ­ dÃ©Å¡Å¥",
      71:"SlabÃ© snÄ›Å¾enÃ­",73:"SnÄ›Å¾enÃ­",75:"SilnÃ© snÄ›Å¾enÃ­",77:"Kroupy",
      80:"PÅ™ehÃ¡Åˆky",81:"DÃ©Å¡Å¥",82:"SilnÃ½ dÃ©Å¡Å¥",
      85:"SnÄ›hovÃ© pÅ™ehÃ¡Åˆky",86:"SilnÃ© snÄ›hovÃ© pÅ™ehÃ¡Åˆky",
      95:"BouÅ™ka",96:"BouÅ™ka s krupobitÃ­m",99:"SilnÃ¡ bouÅ™ka" };

    // dennÃ­ pole: index 0 = dnes, 1 = zÃ­tra; past_days nÃ¡m pÅ™idÃ¡ v poli index -1 â€vÄeraâ€œ, ale open-meteo ho dÃ¡ na pozici 0 a posune dneÅ¡ek na 1 atd.
    // Najdeme indexy tak, aby dayIndex 0/1 sedÄ›l na dneÅ¡ek/zÃ­tÅ™ek:
    // Pokud je past_days=1, bÃ½vÃ¡ poÅ™adÃ­: [vÄera, dnes, zÃ­tra]
    const isPast1 = (j.daily?.time?.length || 0) >= 2;
    const base = isPast1 ? 1 : 0; // dneÅ¡ek
    const idxToday = base;
    const idxTomorrow = base+1;
    const idxYesterday = base-1; // existuje jen kdyÅ¾ isPast1==true

    const idx = (dayIndex===0)?idxToday:idxTomorrow;

    const tMin = round(j.daily.temperature_2m_min?.[idx] ?? c.temperature_2m);
    const tMax = round(j.daily.temperature_2m_max?.[idx] ?? c.temperature_2m);
    const appMax = round(j.daily.apparent_temperature_max?.[idx] ?? c.apparent_temperature);
    const appNow = round(c.apparent_temperature);
    const windNow = round(c.wind_speed_10m);
    const windGust = round(c.wind_gusts_10m ?? windNow);
    const prob = round(j.daily.precipitation_probability_mean?.[idx] ?? 0);

    // delta vs vÄera (pro "Dnes") nebo vs dnes (pro "ZÃ­tra")
    let deltaTxt = "";
    if(dayIndex===0 && idxYesterday>=0){
      const yApp = round(j.daily.apparent_temperature_max?.[idxYesterday] ?? j.daily.temperature_2m_max?.[idxYesterday]);
      const diff = appMax - yApp;
      deltaTxt = diff===0 ? "stejnÄ› jako vÄera" : (diff>0?`o +${diff}Â° tepleji neÅ¾ vÄera`:`o ${diff}Â° chladnÄ›ji neÅ¾ vÄera`);
    } else if(dayIndex===1){
      const tApp = round(j.daily.apparent_temperature_max?.[idxToday] ?? j.daily.temperature_2m_max?.[idxToday]);
      const diff = appMax - tApp;
      deltaTxt = diff===0 ? "stejnÄ› jako dnes" : (diff>0?`o +${diff}Â° tepleji neÅ¾ dnes`:`o ${diff}Â° chladnÄ›ji neÅ¾ dnes`);
    }

    const umbrella = umbrellaNote(j.minutely_15, prob, dayIndex);
    const windBadge = windGust >= 45 ? `<span class="chip warn">ğŸ’¨ SilnÃ½ vÃ­tr (${windGust} km/h)</span>` : `<span class="chip ok">ğŸ’¨ VÃ­tr v normÄ› (${windGust} km/h)</span>`;
    const feelFocus = dayIndex===0 ? appNow : appMax;
    const wear = clothingAdvice(feelFocus);

    $("#weatherBadge").textContent = labels[c.weather_code] || "PoÄasÃ­";

    $("#weatherBox").innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
        <div>
          <div class="bigtemp">${dayIndex===0?appNow:appMax}Â°C</div>
          <div class="muted">${dayIndex===0?"pocitovÄ› teÄ":"pocitovÄ› max"} Â· Dnes min ${tMin}Â° / max ${tMax}Â°</div>
          <div style="margin-top:6px">
            <span class="delta">${deltaTxt}</span>
          </div>
          <div class="chips">
            <span class="chip">${umbrella}</span>
            ${windBadge}
            <span class="chip">ğŸ§­ ${labels[c.weather_code]||"PoÄasÃ­"}</span>
          </div>
        </div>
        <div style="color:var(--muted);font-size:14px;display:grid;gap:6px;min-width:240px">
          <span>Vlhkost ${round(c.relative_humidity_2m)}%</span>
          <span>VÃ­tr ${windNow} km/h (nÃ¡razy aÅ¾ ${windGust} km/h)</span>
          <span>ObleÄenÃ­: ${wear}</span>
          ${dayIndex===0 ? rainStartDetail(j) : rainTomorrowHint(j)}
        </div>
      </div>
    `;
  }

  function rainStartDetail(j){
    // PouÅ¾ij minutely_15 do 3h
    const now = Date.now();
    const times = j.minutely_15?.time || [];
    const prec = j.minutely_15?.precipitation || [];
    for (let i=0;i<times.length;i++){
      const ts = new Date(times[i]).getTime();
      const mm = prec[i] ?? 0;
      if (ts>=now && ts-now <= 3*60*60*1000 && mm>0.05){
        const mins = Math.round((ts-now)/60000);
        return `<span>ğŸŒ§ ZaÄne prÅ¡et cca za ${mins} min</span>`;
      }
    }
    return `<span>ğŸŒ§ SrÃ¡Å¾ky v nejbliÅ¾Å¡Ã­ch 3 hodinÃ¡ch nehrozÃ­</span>`;
  }

  function rainTomorrowHint(j){
    // HrubÃ½ odhad: prvnÃ­ hodina zÃ­tÅ™ka s srÃ¡Å¾kami >0.1 mm
    const hours = j.hourly?.time || [];
    const pr = j.hourly?.precipitation || [];
    // najdi index zaÄÃ¡tku zÃ­tÅ™ka
    const todayDate = new Date().toISOString().slice(0,10);
    const tomorrowDate = new Date(Date.now()+24*60*60*1000).toISOString().slice(0,10);
    let first = -1;
    for (let i=0;i<hours.length;i++){
      if (hours[i].startsWith(tomorrowDate)){ first=i; break; }
    }
    if (first>=0){
      for (let i=first;i<Math.min(first+24, hours.length);i++){
        if ((pr[i]??0) > 0.1){
          const t = new Date(hours[i]);
          return `<span>ğŸŒ§ ZÃ­tra prÅ¡et od cca ${String(t.getHours()).padStart(2,"0")}:00</span>`;
        }
      }
    }
    return `<span>ğŸŒ§ ZÃ­tra srÃ¡Å¾ky spÃ­Å¡ ne</span>`;
  }

  async function loadWeather(){
    try{
      weatherCache = await fetchWeather();
      renderWeather();
    }catch(e){
      $("#weatherBox").innerHTML = `<div class="error">${e.message||e}</div>`;
    }
  }

  // ---------- DEPARTURES ----------
  let currentDir = "A";

  async function fetchDepartures({ids, limit, minutesBefore=0, minutesAfter=45}) {
    const base = CONFIG.departures.proxyUrl.replace(/\/+$/,'') + "/v2/pid/departureboards";
    const url = new URL(base);
    url.searchParams.set("ids", ids);
    url.searchParams.set("minutesBefore", String(minutesBefore));
    url.searchParams.set("minutesAfter", String(minutesAfter));
    url.searchParams.set("limit", String(limit));
    url.searchParams.set("preferredTimezone", "Europe/Prague");
    url.searchParams.set("includeMetroTrains", "true");

    const token = getToken();
    if(!token) throw new Error("ChybÃ­ API klÃ­Ä. Klikni na â€ZmÄ›nit API klÃ­Äâ€œ a vloÅ¾ X-Access-Token.");

    const res = await fetch(url.toString(), {
      headers: { "X-Access-Token": token, "Accept": "application/json" }
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>String(res.status));
      throw new Error(`Chyba proxy: ${res.status}\n\n${txt}`);
    }
    return res.json();
  }

  function renderDepartures(data){
    const listEl = $("#mhdList");
    listEl.innerHTML = "";

    const deps = Array.isArray(data.departures) ? data.departures.slice(0, CONFIG.departures.limit*3) : [];
    const byPlatform = deps.filter(d => {
      const type = d?.route?.type;
      if (type === 2) return true; // vlaky vÅ¾dy
      const plat = (d?.stop?.platform_code || "").toUpperCase();
      return plat === currentDir;
    });

    const minM = Number(CONFIG.departures.minMinutes ?? 0);
    const afterThreshold = byPlatform.filter(d => {
      const shownISO = d?.departure_timestamp?.predicted || d?.departure_timestamp?.scheduled;
      if (!shownISO) return false;
      const m = minsTo(shownISO);
      return m >= minM;
    });

    if(afterThreshold.length === 0){
      listEl.innerHTML = `<div class="error">Å½Ã¡dnÃ© odjezdy â‰¥ ${minM} min pro smÄ›r ${currentDir}.</div>`;
      return;
    }

    const take = afterThreshold.slice(0, CONFIG.departures.limit);
    for(const d of take){
      const row = document.createElement("div");
      row.className = "dep";

      const ico = document.createElement("div");
      ico.textContent = iconByType(d?.route?.type);
      ico.style.opacity = .85;

      const line = document.createElement("div");
      line.className = "line";
      line.textContent = (d?.route?.short_name ?? d?.route?.long_name ?? "?");

      const where = document.createElement("div");
      where.className = "where";
      const head = d?.trip?.headsign ?? d?.last_stop?.name ?? "";
      const plat = d?.stop?.platform_code ? ` Â· st. ${d.stop.platform_code}` : "";
      where.textContent = `${head}${plat}`;

      const timeBox = document.createElement("div");
      timeBox.className = "time";
      const shownISO = d?.departure_timestamp?.predicted || d?.departure_timestamp?.scheduled;
      const mins = minsTo(shownISO);
      timeBox.textContent = (CONFIG.departures.mode === "time") ? fmtHHMM(shownISO) : `${mins} min`;

      const del = delayMin(d?.departure_timestamp?.scheduled, d?.departure_timestamp?.predicted);
      if(del){
        const span = document.createElement("span");
        span.className = "delay " + (del>0?"warn":"ok");
        span.textContent = (del>0?` +${del}`:` ${del}`);
        timeBox.appendChild(span);
      }

      row.appendChild(ico);
      row.appendChild(line);
      row.appendChild(where);
      row.appendChild(timeBox);
      listEl.appendChild(row);
    }
  }

  async function refreshDepartures(){
    try{
      const data = await fetchDepartures({
        ids: CONFIG.departures.ids,
        limit: CONFIG.departures.limit
      });
      renderDepartures(data);
      const ts = new Date();
      $("#mhdFoot").textContent =
        `${CONFIG.departures.title} Â· PoslednÃ­ kontrola ${fmtHM(ts)} Â· filtr â‰¥ ${CONFIG.departures.minMinutes} min Â· Worker: ${CONFIG.departures.proxyUrl}`;
    }catch(err){
      $("#mhdList").innerHTML = `<div class="error">${(err?.message || err)}</div>`;
      $("#mhdFoot").textContent = CONFIG.departures.title;
    }
  }

  // ---------- LINKS ----------
  function renderLinks(){
    $("#linksBox").innerHTML = LINKS.map(l => `<a class="btn" href="${l.url}" target="_blank" rel="noopener">${l.label}</a>`).join("");
  }

  // ---------- NEWS (rss2json) ----------
  async function loadNews(){
    const feed = "https://www.irozhlas.cz/rss/irozhlas";
    const api = new URL("https://api.rss2json.com/v1/api.json");
    api.searchParams.set("rss_url", feed);

    try{
      const res = await fetch(api.toString(), { cache:"no-store" });
      if(!res.ok) throw new Error(`RSS nelze naÄÃ­st (HTTP ${res.status}).`);
      const json = await res.json();
      if(json.status !== "ok" || !Array.isArray(json.items)){
        throw new Error("RSS ve formÃ¡tu, kterÃ½ neznÃ¡m.");
      }
      const items = json.items.slice(0,8);
      $("#newsBox").innerHTML =
        items.map(it => `
          <div class="row" style="justify-content:space-between;gap:12px">
            <a class="btn" href="${it.link}" target="_blank" rel="noopener" style="text-decoration:none;flex:1">
              ${it.title}
            </a>
            <span class="muted" style="white-space:nowrap">${new Date(it.pubDate).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'})}</span>
          </div>
        `).join("");
    }catch(e){
      $("#newsBox").innerHTML =
        `<div class="error">${e.message||e}</div>
         <div class="muted" style="margin-top:6px">
           Zdroj: <a class="btn" href="${feed}" target="_blank" rel="noopener">RSS iRozhlas</a>
         </div>`;
    }
  }

  // ---------- SERVICES / CONNECTIVITY ----------
  function renderServices(){
    const box = $("#svcBox");
    const https = location.protocol === "https:";
    const rows = SERVICES.map(s => {
      const blocked = https && s.url.startsWith("http://");
      const status = blocked ? `<span class="warn">NedostupnÃ© z HTTPS (mixed content)</span>` : `<span class="muted">Klikni pro otevÅ™enÃ­</span>`;
      const open = blocked ? "#" : s.url;
      return `<div class="row" style="justify-content:space-between">
        <a class="btn" href="${open}" target="_blank" rel="noopener">${s.name}</a>
        <span>${status}</span>
      </div>`;
    }).join("");
    box.innerHTML = rows || `<div class="muted">Å½Ã¡dnÃ© sluÅ¾by.</div>`;

    const nb = $("#netBox");
    const gw = "http://192.168.1.1/status";
    if (location.protocol === "https:" && gw.startsWith("http://")) {
      nb.innerHTML = `Pozn.: test z veÅ™ejnÃ©ho webu blokuje http â†’ https.<br>OvÄ›Å™ lokÃ¡lnÄ› pÅ™es <code>http://</code> nebo nastav HTTPS na brÃ¡nÄ›.`;
    } else {
      nb.innerHTML = `Klikni pro ruÄnÃ­ ovÄ›Å™enÃ­: <a class="btn" href="${gw}" target="_blank" rel="noopener">Gateway status</a>`;
    }
  }

  // ---------- UI ----------
  const apiDlg = document.getElementById("apiDlg");
  const apiInput = document.getElementById("apiInput");
  document.getElementById("apiBtn").addEventListener("click", ()=>{ apiInput.value = getToken(); apiDlg.showModal(); });
  apiDlg.addEventListener("close", () => { if(apiDlg.returnValue==="ok"){ setToken(apiInput.value.trim()); refreshDepartures(); }});

  const dirBtn = document.getElementById("dirBtn");
  dirBtn.addEventListener("click", ()=>{
    currentDir = currentDir === "A" ? "B" : "A";
    dirBtn.textContent = `SmÄ›r: ${currentDir === "A" ? "Koh-i-noor" : "KubÃ¡nskÃ© nÃ¡mÄ›stÃ­"}`;
    refreshDepartures();
  });
  document.getElementById("titlePill").textContent = CONFIG.departures.title;

  // Weather day switch
  const dayTodayBtn = document.getElementById("dayToday");
  const dayTomorrowBtn = document.getElementById("dayTomorrow");
  dayTodayBtn.addEventListener("click", ()=>{ if(dayIndex!==0){ dayIndex=0; dayTodayBtn.classList.add("active"); dayTomorrowBtn.classList.remove("active"); renderWeather(); }});
  dayTomorrowBtn.addEventListener("click", ()=>{ if(dayIndex!==1){ dayIndex=1; dayTomorrowBtn.classList.add("active"); dayTodayBtn.classList.remove("active"); renderWeather(); }});

  // ---------- INIT ----------
  (async function init(){
    if(!getToken()) apiDlg.showModal();
    renderLinks();
    renderServices();
    await loadWeather();
    await loadNews();
    await refreshDepartures();
    setInterval(refreshDepartures, 60*1000);
    setInterval(loadWeather, 20*60*1000);
    setInterval(loadNews, 30*60*1000);
  })();
  </script>
</body>
</html>