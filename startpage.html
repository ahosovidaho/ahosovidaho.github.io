<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Dom√°c√≠ start</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#0f1720; --panel:#14212b; --border:#1e2c37; --text:#dbe6ef; --muted:#9bb3c6;
      --good:#1fb974; --warn:#efb33f; --bad:#ff6b6b; --chip:#1b2b38;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1160px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);margin-bottom:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
    .title{font-size:13px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);display:flex;align-items:center;gap:8px}
    .row{display:flex;align-items:center;gap:8px}
    .spacer{flex:1}
    .btn{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .pill{font-size:12px;border-radius:999px;padding:3px 8px;background:#113244;border:1px solid #214457;color:#a7c5d9}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .dep{display:flex;align-items:center;gap:10px;background:#10202b;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .line{min-width:44px;text-align:center;font-weight:700;background:#0e1a23;border:1px solid #22313d;border-radius:10px;padding:6px 8px}
    .where{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-variant-numeric:tabular-nums}
    .delay{font-size:12px;margin-left:8px}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .error{color:var(--bad);white-space:pre-wrap}
    dialog{border:1px solid var(--border);border-radius:14px;background:var(--panel);color:var(--text);padding:20px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    input[type=text]{width:100%;box-sizing:border-box;background:#0e1a23;border:1px solid #22313d;border-radius:10px;color:var(--text);padding:10px 12px}
    small{color:var(--muted)}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    /* --- Weather styles --- */
.wx-box{display:flex;flex-direction:column;gap:14px}
.wx-top{display:flex;align-items:flex-start;justify-content:space-between;gap:14px}
.wx-main{display:flex;flex-direction:column}
.wx-temp{font-size:38px;font-weight:800}
.wx-feel{color:var(--muted)}
.wx-meta{display:grid;gap:6px;color:var(--muted);font-size:14px}
.wx-chips{display:flex;flex-wrap:wrap;gap:8px}
.wx-chip{font-size:12px;border-radius:999px;padding:4px 8px;background:#113244;border:1px solid #214457;color:#a7c5d9}
.wx-chip.wx-warn{background:#3a2a12;border-color:#6a5123;color:#f0c36b}
.wx-graphWrap{margin-top:4px}
.wx-graphHead{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:13px;margin-bottom:6px}
.wx-mini{display:flex;gap:12px;color:var(--muted)}
.wx-svg{width:100%;height:160px;display:block}
.wx-btn{padding:6px 10px}

    .wx-legend::before{
  content:"";
  display:inline-block;
  width:8px; height:8px; border-radius:999px;
  background:rgb(56,189,248);
  margin-right:6px; vertical-align:middle;
}

    
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dom√°c√≠ start</h1>
    <div class="sub">Soukrom√° n√°stƒõnka ‚Äì poƒças√≠, MHD, dostupnost s√≠tƒõ a rychl√© odkazy.</div>

    <div class="grid">
      
      <!-- POƒåAS√ç (Vr≈°ovice) -->
<section class="card" id="weatherCard">
  <div class="title row" style="align-items:center;gap:10px">
    <span>Poƒças√≠ ‚Äì Vr≈°ovice</span>
    <div class="spacer"></div>
    <button class="btn wx-btn" id="wxDayToggle" title="P≈ôepnout Dnes/Z√≠tra">Dnes</button>
    <button class="btn wx-btn" id="wxTimeFmt" title="P≈ôepnout form√°t ƒçasu">22&nbsp;h</button>
    <a class="btn wx-btn" id="wxRadarBtn" href="https://www.chmi.cz/files/portal/docs/meteo/rad/inca-cz/" target="_blank" rel="noopener">Radar</a>
  </div>

  <div id="weatherBox" class="wx-box" style="margin-top:14px">
    <div class="muted">Naƒç√≠t√°m p≈ôedpovƒõƒè‚Ä¶</div>
  </div>
</section>


      <!-- ODJEZDY MHD -->
      <section class="card" id="mhdCard">
        <div class="title">Odjezdy MHD</div>
        <div class="row" style="margin-top:10px;gap:10px">
          <button class="btn" id="dirBtn">Smƒõr: Koh-i-noor</button>
          <div class="pill" id="titlePill">Slavia ‚Äì n√°dra≈æ√≠ Eden</div>
          <div class="spacer"></div>
          <button class="btn" id="apiBtn">Zmƒõnit API kl√≠ƒç</button>
        </div>
        <div id="mhdList" class="list" aria-live="polite" style="min-height:48px;margin-top:14px">
          <div class="muted">Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</div>
        </div>
        <div class="foot" id="mhdFoot"></div>
      </section>

      <!-- DOM√ÅC√ç INTERNET -->
      <section class="card" id="netCard">
        <div class="title">Dom√°c√≠ internet</div>
        <div id="netBox" style="margin-top:14px" class="muted"></div>
      </section>

      <!-- RYCHL√â ODKAZY -->
      <section class="card" id="linksCard">
        <div class="title">Rychl√© odkazy</div>
        <div id="linksBox" class="list" style="margin-top:14px"></div>
      </section>

      <!-- ZPR√ÅVY -->
      <section class="card" id="newsCard">
        <div class="title">iRozhlas.cz ‚Äì nejnovƒõj≈°√≠ zpr√°vy</div>
        <div id="newsBox" class="list" style="margin-top:14px">
          <div class="muted">Stahuji ƒçl√°nky‚Ä¶</div>
        </div>
      </section>

      <!-- SLU≈ΩBY -->
      <section class="card" id="svcCard">
        <div class="title">Dom√°c√≠ slu≈æby</div>
        <div id="svcBox" class="list" style="margin-top:14px"></div>
      </section>
    </div>
  </div>

  <!-- Modal API key -->
  <dialog id="apiDlg">
    <form method="dialog">
      <h3 style="margin:0 0 8px 0">Golemio API kl√≠ƒç</h3>
      <p class="muted" style="margin:0 0 10px 0">Vlo≈æ sv≈Øj <em>X-Access-Token</em> (ulo≈æ√≠ se jen v tomto prohl√≠≈æeƒçi).</p>
      <input type="text" id="apiInput" autocomplete="off" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9‚Ä¶" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" value="cancel">Zru≈°it</button>
        <button class="btn" value="ok">Ulo≈æit</button>
      </div>
      <small>Token m≈Ø≈æe≈° kdykoli zmƒõnit.</small>
    </form>
  </dialog>

  <script>
  // ---------- KONFIG ----------
  window.CONFIG = window.CONFIG || {};
  CONFIG.weather = { lat:50.0704, lon:14.4709, tz:"Europe/Prague" };

  // D≈ÆLE≈ΩIT√â: nastav na sv≈Øj Worker hostname (bez koncov√© /)
  CONFIG.departures = CONFIG.departures || {};
  CONFIG.departures.proxyUrl = "https://golemioproxy.m88wqgcdpd.workers.dev";
  CONFIG.departures.ids = "U680Z1P,U680Z2P,U680Z301"; // A + B + vlak
  CONFIG.departures.title = "Slavia ‚Äì n√°dra≈æ√≠ Eden";
  CONFIG.departures.limit = 20;
  CONFIG.departures.mode = "mins"; // "mins" | "time"
  CONFIG.departures.minMinutes = 5; // zobrazit a≈æ od 5 minut do odjezdu

  const LINKS = [
    { label: "E-mail", url: "https://mail.google.com" },
    { label: "Kalend√°≈ô", url: "https://calendar.google.com" },
    { label: "Nextcloud", url: "https://cloud.example.com" },
    { label: "Home Assistant", url: "https://ha.example.com" },
    { label: "Plex", url: "https://plex.tv/web" },
    { label: "Bankovnictv√≠", url: "https://ib.examplebank.cz" },
  ];

  const SERVICES = [
    { name:"Plex (Mac mini M4)", url:"http://192.168.1.50:32400/web/index.html" },
    { name:"Nextcloud (Mac mini 2012)", url:"http://192.168.1.60/status.php" },
    { name:"Home Assistant", url:"http://192.168.1.60:8123/" },
  ];

  // ---------- UTIL ----------
  const $ = s => document.querySelector(s);
  const fmtHM = d => `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  const fmtHHMM = iso => { const d = new Date(iso); return fmtHM(d); };
  const minsTo = iso => { const d=new Date(iso); return Math.max(0, Math.ceil((d-Date.now())/60000)); };
  const delayMin = (sched, pred) => (!sched||!pred)?0:Math.round((new Date(pred)-new Date(sched))/60000);
  const iconByType = t => (t===0?"üöã":t===2?"üöÜ":t===3?"üöå":t===11?"üöé":"üß≠");

  // ---------- API KEY storage ----------
  const KEY_NAME = "golemio_api_key";
  const getToken = () => localStorage.getItem(KEY_NAME) || "";
  const setToken = v => localStorage.setItem(KEY_NAME, v||"");

  // ===== Weather (Vr≈°ovice) =====
(function(){
  const wxEl = {
    box: document.getElementById('weatherBox'),
    dayToggle: document.getElementById('wxDayToggle'),
    timeFmtBtn: document.getElementById('wxTimeFmt'),
    radarBtn: document.getElementById('wxRadarBtn'),
  };

  // Konfigurace (Vr≈°ovice)
  const wxCfg = {
    lat: 50.067, lon: 14.468, tz: 'Europe/Prague',
    hoursAhead: 18,            // kolik hodin kreslit do grafu
    rainProbWarn: 60,          // % pravdƒõpodobnosti de≈°tƒõ = ‚Äûde≈°tn√≠k se hod√≠‚Äú
    rainRateWarn: 0.2,         // mm/h od kdy br√°t d√©≈°≈• jako ‚Äûre√°ln√Ω‚Äú
    windWarn: 12,              // m/s = cca 43 km/h siln√Ω v√≠tr
    windGustWarn: 17,          // m/s poryvy
  };

  // Stav
  const wxState = {
    day: 'today',                 // 'today' | 'tomorrow'
    timeLabel: 'h',               // 'h' | ':00'
    data: null,                   // odpovƒõƒè z API
  };

  // Mapy k√≥d≈Ø poƒças√≠
  const wxCodes = {
    0:'Jasno', 1:'P≈ôev√°≈ænƒõ jasno', 2:'Oblaƒçno', 3:'Zata≈æeno',
    45:'Mlha', 48:'Mrznouc√≠ mlha',
    51:'M√≠rn√© mrholen√≠', 53:'Mrholen√≠', 55:'Intenzivn√≠ mrholen√≠',
    56:'Mrznouc√≠ mrholen√≠', 57:'Mrznouc√≠ mrholen√≠',
    61:'Slab√Ω d√©≈°≈•', 63:'D√©≈°≈•', 65:'Siln√Ω d√©≈°≈•',
    66:'Mrznouc√≠ d√©≈°≈•', 67:'Mrznouc√≠ d√©≈°≈•',
    71:'Slab√© snƒõ≈æen√≠', 73:'Snƒõ≈æen√≠', 75:'Siln√© snƒõ≈æen√≠',
    77:'Kroupy',
    80:'P≈ôeh√°≈àky', 81:'D√©≈°≈•', 82:'Siln√Ω d√©≈°≈•',
    85:'Snƒõhov√© p≈ôeh√°≈àky', 86:'Siln√© snƒõhov√© p≈ôeh√°≈àky',
    95:'Bou≈ôka', 96:'Bou≈ôka s krupobit√≠m', 99:'Siln√° bou≈ôka'
  };

  // Pomocn√©
  const wx_pad2 = n => String(n).padStart(2,'0');
  const wx_fmtHM = d => `${wx_pad2(d.getHours())}:${wx_pad2(d.getMinutes())}`;
  const wx_fmtHourLabel = (d) => (wxState.timeLabel === 'h')
      ? `${wx_pad2(d.getHours())} h`
      : `${wx_pad2(d.getHours())}:00`;

  // Fetch z Open-Meteo
  async function wx_fetch(){
    const u = new URL('https://api.open-meteo.com/v1/forecast');
    u.searchParams.set('latitude', wxCfg.lat);
    u.searchParams.set('longitude', wxCfg.lon);
    u.searchParams.set('timezone', wxCfg.tz);

    // Aktu√°l, hodinov√° a denn√≠ data + vƒçerej≈°ek kv≈Øli porovn√°n√≠
    u.searchParams.set('current', [
      'temperature_2m','apparent_temperature','relative_humidity_2m',
      'wind_speed_10m','wind_gusts_10m','weather_code','precipitation'
    ].join(','));

    u.searchParams.set('hourly', [
      'temperature_2m','apparent_temperature','precipitation_probability',
      'rain','showers','snowfall','weather_code','wind_speed_10m','wind_gusts_10m'
    ].join(','));

    u.searchParams.set('daily', [
      'temperature_2m_max','temperature_2m_min','precipitation_sum'
    ].join(','));

    u.searchParams.set('past_days', '1');   // vƒçerej≈°ek
    u.searchParams.set('forecast_days', '2'); // dnes + z√≠tra

    const r = await fetch(u.toString(), { cache: 'no-store' });
    if (!r.ok) throw new Error('Poƒças√≠ nelze naƒç√≠st.');
    return r.json();
  }

  // Najdi index dne (0 = vƒçera, 1 = dnes, 2 = z√≠tra)
  function wx_dayIndex(){
    // daily.time je ISO zaƒç√°tk≈Ø dn≈Ø (00:00)
    // Vybereme 1 (dnes) nebo 2 (z√≠tra)
    return (wxState.day === 'today') ? 1 : 2;
  }

  // De≈°tn√≠k a ‚Äûkdy zaƒçne pr≈°et‚Äú z hodinov√Ωch dat
  function wx_rainAnalysis(hourly){
    const now = Date.now();
    const idxStart = hourly.time.findIndex(t => new Date(t).getTime() >= now);
    const start = idxStart < 0 ? 0 : idxStart;

    let umbrella = false;
    let startsInHours = null;
    let durationH = 0;

    for (let i = start; i < Math.min(start + 24, hourly.time.length); i++){
      const prob = hourly.precipitation_probability?.[i] ?? 0;
      const rate = (hourly.rain?.[i] ?? 0) + (hourly.showers?.[i] ?? 0) + (hourly.snowfall?.[i] ?? 0);
      const wet = (prob >= wxCfg.rainProbWarn) || (rate >= wxCfg.rainRateWarn);
      if (wet && startsInHours === null){
        const t0 = new Date(hourly.time[i]).getTime();
        startsInHours = Math.max(0, Math.round((t0 - now) / 3600000));
        umbrella = true;
      }
      if (wet && startsInHours !== null) durationH++;
      if (!wet && startsInHours !== null && durationH>0) break;
    }
    return { umbrella, startsInHours, durationH };
  }

  // Doporuƒçen√≠ obleƒçen√≠ z pocitov√© teploty
  function wx_clothingHint(feels){
    if (feels >= 24) return 'Lehk√© obleƒçen√≠ (triƒçko).';
    if (feels >= 15) return 'Lehk√° bunda / mikina.';
    if (feels >= 8)  return 'Mikina, p≈ô√≠padnƒõ tenƒç√≠ bunda.';
    if (feels >= 1)  return 'Tepl√° bunda, dlouh√© kalhoty.';
    if (feels >= -5) return 'Tepl√° bunda + ƒçepice, rukavice.';
    return 'Velk√° zima ‚Äì p≈ôidej termopr√°dlo.';
  }

  // Porovn√°n√≠ s vƒçerej≈°kem (max teplota)
  function wx_vsYesterday(daily){
    const y = daily.temperature_2m_max?.[0];
    const t = daily.temperature_2m_max?.[1];
    if (y==null || t==null) return null;
    const diff = Math.round((t - y)*10)/10;
    if (diff > 0) return `Dnes tepleji ne≈æ vƒçera o ${diff}¬∞C.`;
    if (diff < 0) return `Dnes chladnƒõji ne≈æ vƒçera o ${Math.abs(diff)}¬∞C.`;
    return 'Dnes podobnƒõ teplo jako vƒçera.';
  }

  // Vykreslen√≠ mal√©ho SVG grafu (apparent temperature)
  function wx_renderChart(container, hourly){
    const now = Date.now();
    // start na nejbli≈æ≈°√≠ cel√© hodinƒõ >= now
    const fromIdx = hourly.time.findIndex(t => new Date(t).getTime() >= now);
    const start = fromIdx < 0 ? 0 : fromIdx;
    const end = Math.min(start + wxCfg.hoursAhead, hourly.time.length);
    const times = hourly.time.slice(start, end).map(t=>new Date(t));
    const vals = hourly.apparent_temperature.slice(start, end).map(Number);

    if (!times.length){ container.innerHTML = '<div class="muted">Bez dat‚Ä¶</div>'; return; }

    const w = container.clientWidth || 600;
    const h = 140;
    const pad = { l: 30, r: 10, t: 10, b: 24 };

    const vmin = Math.min(...vals);
    const vmax = Math.max(...vals);
    const y = v => {
      if (vmax===vmin) return pad.t + (h-pad.t-pad.b)/2;
      return pad.t + (vmax - v) * (h - pad.t - pad.b) / (vmax - vmin);
    };
    const x = (i) => pad.l + i * ( (w - pad.l - pad.r) / (vals.length - 1 || 1) );

    // Path
    let d = '';
    vals.forEach((v,i)=>{
      const cx = x(i), cy = y(v);
      d += (i===0 ? `M ${cx} ${cy}` : ` L ${cx} ${cy}`);
    });

    // Osy + popisky hodin
    const labels = times.map((t,i)=>({
      x: x(i),
      text: wx_fmtHourLabel(t)
    }));

    container.innerHTML = `
      <div class="wx-graphHead">
        <div class="wx-legend"><span class="wx-dot"></span> Pocitov√° teplota</div>
        <div>${Math.round(vmin)}‚Äì${Math.round(vmax)}¬∞C</div>
      </div>
      <svg class="wx-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" role="img" aria-label="Pocitov√° teplota v ƒçase">
        <defs>
          <linearGradient id="wxfill" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="rgba(56,189,248,0.35)"/>
            <stop offset="100%" stop-color="rgba(56,189,248,0.02)"/>
          </linearGradient>
        </defs>
        <path d="${d}" stroke="rgb(56,189,248)" stroke-width="2" fill="none"/>
        <path d="${d} L ${x(vals.length-1)} ${h-pad.b} L ${x(0)} ${h-pad.b} Z" fill="url(#wxfill)"/>
        ${labels.map((lb,i)=> i%2===0 ? `
          <text x="${lb.x}" y="${h-8}" text-anchor="middle" font-size="10" fill="#9bb3c6">${lb.text}</text>` : ''
        ).join('')}
      </svg>
    `;
  }

  function wx_render(){
    const j = wxState.data;
    if (!j){ wxEl.box.innerHTML = '<div class="muted">Naƒç√≠t√°m‚Ä¶</div>'; return; }

    const dIdx = wx_dayIndex();

    // Aktu√°ln√≠ hodnoty
    const cur = j.current;
    const curTemp = Math.round(cur.temperature_2m);
    const curFeel = Math.round(cur.apparent_temperature);
    const curHum  = cur.relative_humidity_2m;
    const curWind = Math.round(cur.wind_speed_10m);
    const curGust = Math.round(cur.wind_gusts_10m || cur.wind_speed_10m);
    const curCode = wxCodes[cur.weather_code] || 'Poƒças√≠';

    // Denn√≠ min/max pro zvolen√Ω den
    const tMin = Math.round(j.daily.temperature_2m_min?.[dIdx] ?? curTemp);
    const tMax = Math.round(j.daily.temperature_2m_max?.[dIdx] ?? curTemp);
    const rainSum = j.daily.precipitation_sum?.[dIdx] ?? 0;

    // De≈°tn√≠k, kdy a jak dlouho
    const rain = wx_rainAnalysis(j.hourly);

    // Vƒõtrn√© varov√°n√≠
    const windWarn = (curWind >= wxCfg.windWarn) || (curGust >= wxCfg.windGustWarn);

    // Obleƒçen√≠ a porovn√°n√≠ s vƒçerej≈°kem
    const cloth = wx_clothingHint(curFeel);
    const vsY = wx_vsYesterday(j.daily);

    // Sestaven√≠ HTML
    const chips = [];
    chips.push(`<span class="wx-chip">${rain.umbrella ? '‚òîÔ∏è De≈°tn√≠k se hod√≠' : 'üåÇ Bez de≈°tn√≠ku'}</span>`);
    if (rain.umbrella){
      const when = (rain.startsInHours===0) ? 'brzy' : `za ~${rain.startsInHours} h`;
      const dur = rain.durationH ? ` ¬∑ trv√°n√≠ ~${rain.durationH} h` : '';
      chips.push(`<span class="wx-chip">P≈ôeh√°≈àky ${when}${dur}</span>`);
    }
    if (windWarn){
      chips.push(`<span class="wx-chip wx-warn">üí® Siln√Ω v√≠tr (${curWind}‚Äì${curGust} km/h)</span>`);
    }
    chips.push(`<span class="wx-chip">Min ${tMin}¬∞C ¬∑ Max ${tMax}¬∞C</span>`);

    wxEl.box.innerHTML = `
      <div class="wx-top">
        <div class="wx-main">
          <div class="wx-temp">${curTemp}¬∞C</div>
          <div class="wx-feel">Pocitovƒõ ${curFeel}¬∞C</div>
        </div>
        <div class="wx-meta">
          <span>${curCode}</span>
          <span>Vlhkost ${curHum}%</span>
          <span>V√≠tr ${curWind} km/h (n√°razy ${curGust} km/h)</span>
          <span>Sr√°≈æky dnes ${Math.round(rainSum*10)/10} mm</span>
        </div>
      </div>

      <div class="wx-chips">
        ${chips.join('')}
      </div>

      <div class="wx-graphWrap">
        <div class="wx-graphHead">
          <div>V√Ωhled ${wxCfg.hoursAhead} h (pocitov√° teplota)</div>
          <div class="wx-mini">
            <span>Obleƒçen√≠: ${cloth}</span>
            ${vsY ? `<span>${vsY}</span>` : ''}
          </div>
        </div>
        <div id="wxChart"></div>
      </div>
    `;

    // vykresli graf z ‚Äûapparent_temperature‚Äú
    wx_renderChart(document.getElementById('wxChart'), j.hourly);
  }

  async function wx_refresh(){
    try{
      wxEl.box.innerHTML = '<div class="muted">Naƒç√≠t√°m‚Ä¶</div>';
      if (!wxState.data) wxState.data = await wx_fetch();
      wx_render();
    }catch(e){
      wxEl.box.innerHTML = `<div class="error">${e.message || e}</div>`;
    }
  }

  // Toggle Dnes/Z√≠tra
  wxEl.dayToggle.addEventListener('click', ()=>{
    wxState.day = (wxState.day === 'today') ? 'tomorrow' : 'today';
    wxEl.dayToggle.textContent = (wxState.day === 'today') ? 'Dnes' : 'Z√≠tra';
    wx_render();
  });

  // Toggle form√°tu ƒçasu v grafu
  wxEl.timeFmtBtn.addEventListener('click', ()=>{
    wxState.timeLabel = (wxState.timeLabel === 'h') ? ':00' : 'h';
    wxEl.timeFmtBtn.textContent = (wxState.timeLabel === 'h') ? '22 h' : '22:00';
    // p≈ôekreslit graf jen (data u≈æ m√°me)
    if (wxState.data){
      wx_renderChart(document.getElementById('wxChart'), wxState.data.hourly);
    }
  });

  // Init
  wx_refresh();
  // pr≈Øbƒõ≈æn√Ω refresh: aktu√°l po 20 min
  setInterval(()=>{ wxState.data = null; wx_refresh(); }, 20*60*1000);
})();


  // ---------- DEPARTURES (p≈ôes Worker) ----------
  let currentDir = "A"; // A = Koh-i-noor, B = Kub√°nsk√© n√°mƒõst√≠

  async function fetchDepartures({ids, limit, minutesBefore=0, minutesAfter=45}) {
    const base = CONFIG.departures.proxyUrl.replace(/\/+$/,'') + "/v2/pid/departureboards";
    const url = new URL(base);
    url.searchParams.set("ids", ids);
    url.searchParams.set("minutesBefore", String(minutesBefore));
    url.searchParams.set("minutesAfter", String(minutesAfter));
    url.searchParams.set("limit", String(limit));
    url.searchParams.set("preferredTimezone", "Europe/Prague");
    url.searchParams.set("includeMetroTrains", "true");

    const token = getToken();
    if(!token) throw new Error("Chyb√≠ API kl√≠ƒç. Klikni na ‚ÄûZmƒõnit API kl√≠ƒç‚Äú a vlo≈æ X-Access-Token.");

    const res = await fetch(url.toString(), {
      headers: { "X-Access-Token": token, "Accept": "application/json" }
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>String(res.status));
      throw new Error(`Chyba proxy: ${res.status}\n\n${txt}`);
    }
    return res.json();
  }

  function renderDepartures(data){
    const listEl = $("#mhdList");
    listEl.innerHTML = "";

    const deps = Array.isArray(data.departures) ? data.departures.slice(0, CONFIG.departures.limit*3) : [];

    // 1) smƒõr A/B jen pro MHD (tram/bus/trolej), vlaky (type===2) v≈ædy
    const byPlatform = deps.filter(d => {
      const type = d?.route?.type;
      if (type === 2) return true; // S-linky v≈ædy
      const plat = (d?.stop?.platform_code || "").toUpperCase();
      return plat === currentDir;
    });

    // 2) prahov√°n√≠ na minMinutes
    const minM = Number(CONFIG.departures.minMinutes ?? 0);
    const afterThreshold = byPlatform.filter(d => {
      const shownISO = d?.departure_timestamp?.predicted || d?.departure_timestamp?.scheduled;
      if (!shownISO) return false;
      const m = minsTo(shownISO);
      return m >= minM;
    });

    if(afterThreshold.length === 0){
      listEl.innerHTML = `<div class="error">≈Ω√°dn√© odjezdy ‚â• ${minM} min pro smƒõr ${currentDir}.</div>`;
      return;
    }

    const take = afterThreshold.slice(0, CONFIG.departures.limit);
    for(const d of take){
      const row = document.createElement("div");
      row.className = "dep";

      const ico = document.createElement("div");
      ico.textContent = iconByType(d?.route?.type);
      ico.style.opacity = .85;

      const line = document.createElement("div");
      line.className = "line";
      line.textContent = (d?.route?.short_name ?? d?.route?.long_name ?? "?");

      const where = document.createElement("div");
      where.className = "where";
      const head = d?.trip?.headsign ?? d?.last_stop?.name ?? "";
      const plat = d?.stop?.platform_code ? ` ¬∑ st. ${d.stop.platform_code}` : "";
      where.textContent = `${head}${plat}`;

      const timeBox = document.createElement("div");
      timeBox.className = "time";
      const shownISO = d?.departure_timestamp?.predicted || d?.departure_timestamp?.scheduled;
      const mins = minsTo(shownISO);
      timeBox.textContent = (CONFIG.departures.mode === "time") ? fmtHHMM(shownISO) : `${mins} min`;

      const del = delayMin(d?.departure_timestamp?.scheduled, d?.departure_timestamp?.predicted);
      if(del){
        const span = document.createElement("span");
        span.className = "delay " + (del>0?"warn":"ok");
        span.textContent = (del>0?` +${del}`:` ${del}`);
        timeBox.appendChild(span);
      }

      row.appendChild(ico);
      row.appendChild(line);
      row.appendChild(where);
      row.appendChild(timeBox);
      listEl.appendChild(row);
    }
  }

  async function refreshDepartures(){
    try{
      const data = await fetchDepartures({
        ids: CONFIG.departures.ids,
        limit: CONFIG.departures.limit
      });
      renderDepartures(data);
      const ts = new Date();
      document.getElementById("mhdFoot").textContent =
        `${CONFIG.departures.title} ¬∑ Posledn√≠ kontrola ${fmtHM(ts)} ¬∑ filtr ‚â• ${CONFIG.departures.minMinutes} min`;
    }catch(err){
      document.getElementById("mhdList").innerHTML = `<div class="error">${(err?.message || err)}</div>`;
      document.getElementById("mhdFoot").textContent = CONFIG.departures.title;
    }
  }

  // ---------- LINKS ----------
  function renderLinks(){
    const box = document.getElementById("linksBox");
    box.innerHTML = LINKS.map(l => `<a class="btn" href="${l.url}" target="_blank" rel="noopener">${l.label}</a>`).join("");
  }

  // ---------- NEWS (rss2json bez CORS) ----------
  async function loadNews(){
    const feed = "https://www.irozhlas.cz/rss/irozhlas";
    const api = new URL("https://api.rss2json.com/v1/api.json");
    api.searchParams.set("rss_url", feed);

    try{
      const res = await fetch(api.toString(), { cache:"no-store" });
      if(!res.ok) throw new Error(`RSS nelze naƒç√≠st (HTTP ${res.status}).`);
      const json = await res.json();

      if(json.status !== "ok" || !Array.isArray(json.items)){
        throw new Error("RSS ve form√°tu, kter√Ω nezn√°m.");
      }

      const items = json.items.slice(0,8);
      document.getElementById("newsBox").innerHTML =
        items.map(it => `
          <div class="row" style="justify-content:space-between;gap:12px">
            <a class="btn" href="${it.link}" target="_blank" rel="noopener" style="text-decoration:none;flex:1">
              ${it.title}
            </a>
            <span class="muted" style="white-space:nowrap">${new Date(it.pubDate).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'})}</span>
          </div>
        `).join("");
    }catch(e){
      document.getElementById("newsBox").innerHTML =
        `<div class="error">${e.message||e}</div>
         <div class="muted" style="margin-top:6px">
           Zdroj: <a class="btn" href="${feed}" target="_blank" rel="noopener">RSS iRozhlas</a>
         </div>`;
    }
  }

  // ---------- SERVICES / CONNECTIVITY ----------
  function renderServices(){
    const box = document.getElementById("svcBox");
    const https = location.protocol === "https:";
    const rows = SERVICES.map(s => {
      const blocked = https && s.url.startsWith("http://");
      const status = blocked ? `<span class="warn">Nedostupn√© z HTTPS (mixed content)</span>` : `<span class="muted">Klikni pro otev≈ôen√≠</span>`;
      const open = blocked ? "#" : s.url;
      return `<div class="row" style="justify-content:space-between">
        <a class="btn" href="${open}" target="_blank" rel="noopener">${s.name}</a>
        <span>${status}</span>
      </div>`;
    }).join("");
    box.innerHTML = rows || `<div class="muted">≈Ω√°dn√© slu≈æby.</div>`;

    const nb = document.getElementById("netBox");
    const gw = "http://192.168.1.1/status";
    if (location.protocol === "https:" && gw.startsWith("http://")) {
      nb.innerHTML = `Nelze ovƒõ≈ôit z HTTPS (prohl√≠≈æeƒç blokuje HTTP). Ovƒõ≈ô lok√°lnƒõ z <code>http://</code> nebo povol HTTPS na br√°nƒõ.`;
    } else {
      nb.innerHTML = `Klikni pro ruƒçn√≠ ovƒõ≈ôen√≠: <a class="btn" href="${gw}" target="_blank" rel="noopener">Gateway status</a>`;
    }
  }

  // ---------- UI ----------
  const apiDlg = document.getElementById("apiDlg");
  const apiInput = document.getElementById("apiInput");
  document.getElementById("apiBtn").addEventListener("click", ()=>{ apiInput.value = getToken(); apiDlg.showModal(); });
  apiDlg.addEventListener("close", () => { if(apiDlg.returnValue==="ok"){ setToken(apiInput.value.trim()); refreshDepartures(); }});

  const dirBtn = document.getElementById("dirBtn");
  dirBtn.addEventListener("click", ()=>{
    currentDir = currentDir === "A" ? "B" : "A";
    dirBtn.textContent = `Smƒõr: ${currentDir === "A" ? "Koh-i-noor" : "Kub√°nsk√© n√°mƒõst√≠"}`;
    refreshDepartures();
  });

  document.getElementById("titlePill").textContent = CONFIG.departures.title;

  // ---------- INIT ----------
  (async function init(){
    if(!getToken()) apiDlg.showModal();
    renderLinks();
    renderServices();
  await loadNews();
  await refreshDepartures();
  setInterval(refreshDepartures, 60*1000);
  setInterval(loadNews, 30*60*1000);
  })();
  </script>
</body>
</html>
