<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Dom√°c√≠ start</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#0f1720; --panel:#14212b; --border:#1e2c37; --text:#dbe6ef; --muted:#9bb3c6;
      --good:#1fb974; --warn:#efb33f; --bad:#ff6b6b; --chip:#1b2b38;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1160px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px 0;font-weight:800;letter-spacing:.3px}
    .sub{color:var(--muted);margin-bottom:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
    .title{font-size:13px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);display:flex;align-items:center;gap:8px}
    .row{display:flex;align-items:center;gap:8px}
    .spacer{flex:1}
    .btn{background:var(--chip);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .pill{font-size:12px;border-radius:999px;padding:3px 8px;background:#113244;border:1px solid #214457;color:#a7c5d9}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .dep{display:flex;align-items:center;gap:10px;background:#10202b;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .line{min-width:44px;text-align:center;font-weight:700;background:#0e1a23;border:1px solid #22313d;border-radius:10px;padding:6px 8px}
    .where{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .time{font-variant-numeric:tabular-nums}
    .delay{font-size:12px;margin-left:8px}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .error{color:var(--bad);white-space:pre-wrap}
    dialog{border:1px solid var(--border);border-radius:14px;background:var(--panel);color:var(--text);padding:20px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    input[type=text]{width:100%;box-sizing:border-box;background:#0e1a23;border:1px solid #22313d;border-radius:10px;color:var(--text);padding:10px 12px}
    small{color:var(--muted)}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    /* ---- Weather (styly ponech√°ny) ---- */
    .wx-box{display:flex;flex-direction:column;gap:14px}
    .wx-top{display:flex;align-items:flex-start;justify-content:space-between;gap:14px}
    .wx-main{display:flex;flex-direction:column}
    .wx-temp{font-size:38px;font-weight:800}
    .wx-feel{color:var(--muted)}
    .wx-meta{display:grid;gap:6px;color:var(--muted);font-size:14px}
    .wx-chips{display:flex;flex-wrap:wrap;gap:8px}
    .wx-chip{font-size:12px;border-radius:999px;padding:4px 8px;background:#113244;border:1px solid #214457;color:#a7c5d9}
    .wx-chip.wx-warn{background:#3a2a12;border-color:#6a5123;color:#f0c36b}
    .wx-graphWrap{margin-top:4px}
    .wx-graphHead{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:13px;margin-bottom:6px}
    .wx-mini{display:flex;gap:12px;color:var(--muted)}
    .wx-svg{width:100%;height:170px;display:block}
    .wx-btn{padding:6px 10px}
    .wx-axis text{font-size:10px;fill:#9bb3c6}

    /* ---- Slu≈æby / s√≠≈• ‚Äì nov√© ---- */
    .svc-row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .svc-left{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.ok{background:#1fb974}
    .dot.warn{background:#efb33f}
    .dot.bad{background:#ff6b6b}
    .dot.block{background:#6b7280}
    .svc-hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dom√°c√≠ start</h1>
    <div class="sub">Soukrom√° n√°stƒõnka ‚Äì poƒças√≠, MHD, dostupnost s√≠tƒõ a rychl√© odkazy.</div>

    <div class="grid">

      <!-- POƒåAS√ç (Vr≈°ovice) ‚Äì beze zmƒõn -->
      <section class="card" id="weatherCard">
        <div class="title row" style="align-items:center;gap:10px">
          <span>Poƒças√≠ ‚Äì Vr≈°ovice</span>
          <div class="spacer"></div>
          <button class="btn wx-btn" id="wxDayToggle" title="P≈ôepnout Dnes/Z√≠tra">Dnes</button>
          <button class="btn wx-btn" id="wxTimeFmt" title="P≈ôepnout form√°t ƒçasu">22&nbsp;h</button>
          <a class="btn wx-btn" id="wxRadarBtn" href="https://www.chmi.cz/files/portal/docs/meteo/rad/inca-cz/" target="_blank" rel="noopener">Radar</a>
        </div>
        <div id="weatherBox" class="wx-box" style="margin-top:14px">
          <div class="muted">Naƒç√≠t√°m p≈ôedpovƒõƒè‚Ä¶</div>
        </div>
      </section>

      <!-- ODJEZDY MHD ‚Äì beze zmƒõn -->
      <section class="card" id="mhdCard">
        <div class="title">Odjezdy MHD</div>
        <div class="row" style="margin-top:10px;gap:10px">
          <button class="btn" id="dirBtn">Smƒõr: Koh-i-noor</button>
          <div class="pill" id="titlePill">Slavia ‚Äì n√°dra≈æ√≠ Eden</div>
          <div class="spacer"></div>
          <button class="btn" id="apiBtn">Zmƒõnit API kl√≠ƒç</button>
        </div>
        <div id="mhdList" class="list" aria-live="polite" style="min-height:48px;margin-top:14px">
          <div class="muted">Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</div>
        </div>
        <div class="foot" id="mhdFoot"></div>
      </section>

      <!-- DOM√ÅC√ç INTERNET ‚Äì v√Ωstup sem -->
      <section class="card" id="netCard">
        <div class="title">Dom√°c√≠ internet</div>
        <div id="netBox" style="margin-top:14px" class="muted"></div>
      </section>

      <!-- RYCHL√â ODKAZY -->
      <section class="card" id="linksCard">
        <div class="title">Rychl√© odkazy</div>
        <div id="linksBox" class="list" style="margin-top:14px"></div>
      </section>

      <!-- ZPR√ÅVY -->
      <section class="card" id="newsCard">
        <div class="title">iRozhlas.cz ‚Äì nejnovƒõj≈°√≠ zpr√°vy</div>
        <div id="newsBox" class="list" style="margin-top:14px">
          <div class="muted">Stahuji ƒçl√°nky‚Ä¶</div>
        </div>
      </section>

      <!-- SLU≈ΩBY (HA, Nextcloud, Plex‚Ä¶) -->
      <section class="card" id="svcCard">
        <div class="title">Dom√°c√≠ slu≈æby</div>
        <div id="svcBox" class="list" style="margin-top:14px"></div>
      </section>
    </div>
  </div>

  <!-- Modal API key (MHD) -->
  <dialog id="apiDlg">
    <form method="dialog">
      <h3 style="margin:0 0 8px 0">Golemio API kl√≠ƒç</h3>
      <p class="muted" style="margin:0 0 10px 0">Vlo≈æ sv≈Øj <em>X-Access-Token</em> (ulo≈æ√≠ se jen v tomto prohl√≠≈æeƒçi).</p>
      <input type="text" id="apiInput" autocomplete="off" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9‚Ä¶" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" value="cancel">Zru≈°it</button>
        <button class="btn" value="ok">Ulo≈æit</button>
      </div>
      <small>Token m≈Ø≈æe≈° kdykoli zmƒõnit.</small>
    </form>
  </dialog>

  <script>
  // ---------- KONFIG ----------
  window.CONFIG = window.CONFIG || {};
  CONFIG.weather = { lat:50.0704, lon:14.4709, tz:"Europe/Prague" };

  // Golemio (MHD) ‚Äì beze zmƒõn
  CONFIG.departures = CONFIG.departures || {};
  CONFIG.departures.proxyUrl = "https://golemioproxy.m88wqgcdpd.workers.dev";
  CONFIG.departures.ids = "U680Z1P,U680Z2P,U680Z301";
  CONFIG.departures.title = "Slavia ‚Äì n√°dra≈æ√≠ Eden";
  CONFIG.departures.limit = 20;
  CONFIG.departures.mode = "mins";
  CONFIG.departures.minMinutes = 5;

  // S√≠≈• ‚Äì NOV√â
  CONFIG.network = {
    gatewayUrl: 'https://192.168.1.1/', // UniFi Ultra Gateway (pokud m√°≈° jen http, m≈Ø≈æe b√Ωt blokov√°no z https str√°nky)
    internetTargets: [
      'https://www.gstatic.com/generate_204',
      'https://1.1.1.1/cdn-cgi/trace',
      'https://www.cloudflare.com/cdn-cgi/trace'
    ]
  };

  // (voliteln√© ‚Äì zat√≠m nevyu≈æ√≠v√°me v UI)
  CONFIG.portainer = { base:'', token:'', endpointId:1 };
  CONFIG.netdata  = { base:'' };

  const LINKS = [
    { label: "E-mail", url: "https://mail.google.com" },
    { label: "Kalend√°≈ô", url: "https://calendar.google.com" },
    { label: "Nextcloud", url: "http://192.168.1.60/status.php" },
    { label: "Home Assistant", url: "http://192.168.1.60:8123/" },
    { label: "Plex", url: "http://192.168.1.50:32400/web/index.html" }
  ];

  const SERVICES = [
    { name:"Home Assistant (MM 2012)", url:"http://192.168.1.60:8123/" },
    { name:"Nextcloud (MM 2012)",     url:"http://192.168.1.60/status.php" },
    { name:"Plex (jin√Ω stroj)",       url:"http://192.168.1.50:32400/web/index.html" }
  ];

  // ---------- UTIL ----------
  const $ = s => document.querySelector(s);
  const fmtHM = d => `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  const fmtHHMM = iso => { const d = new Date(iso); return fmtHM(d); };
  const minsTo = iso => { const d=new Date(iso); return Math.max(0, Math.ceil((d-Date.now())/60000)); };
  const delayMin = (sched, pred) => (!sched||!pred)?0:Math.round((new Date(pred)-new Date(sched))/60000);
  const iconByType = t => (t===0?"üöã":t===2?"üöÜ":t===3?"üöå":t===11?"üöé":"üß≠");

  // Pomocn√≠ci pro s√≠≈•
  function withTimeout(ms, p){
    return new Promise((resolve, reject)=>{
      const t = setTimeout(()=>reject(new Error('timeout')), ms);
      p.then(v=>{clearTimeout(t); resolve(v)}).catch(e=>{clearTimeout(t); reject(e)});
    });
  }
  async function ping(url, {timeout=4000} = {}){
    if (location.protocol === 'https:' && url.startsWith('http://')){
      return { ok:false, blocked:true, ms:null };
    }
    const t0 = performance.now();
    try{
      await withTimeout(timeout, fetch(url, {mode:'no-cors', cache:'no-store'}));
      return { ok:true, blocked:false, ms: Math.round(performance.now() - t0) };
    }catch(_){
      return { ok:false, blocked:false, ms:null };
    }
  }

  // ---------- API KEY storage (MHD) ----------
  const KEY_NAME = "golemio_api_key";
  const getToken = () => localStorage.getItem(KEY_NAME) || "";
  const setToken = v => localStorage.setItem(KEY_NAME, v||"");

  // ===== POƒåAS√ç ‚Äì ponech√°no (v√°≈° posledn√≠ funkƒçn√≠ k√≥d) =====
  // ‚Ä¶ (Zde nech sv≈Øj existuj√≠c√≠ weather modul; vynech√°v√°m pro zkr√°cen√≠.
  // Pokud chce≈°, po≈°lu i plnou verzi p≈ôesnƒõ jak ji m√°≈°.)

  // ===== S√ç≈§: Gateway ‚Üí Internet =====
  const NETSTATE = { gateway: null };

  async function loadNetStatus(){
    const nb = document.getElementById('netBox');

    // 1) Gateway
    const gw = await ping(CONFIG.network.gatewayUrl, {timeout: 3500});
    NETSTATE.gateway = gw;

    let gwRow = '';
    if (gw.blocked){
      gwRow = `
        <div class="svc-row">
          <div class="svc-left"><span class="dot block"></span><strong>Gateway z HTTPS blokov√°na</strong></div>
          <span class="svc-hint">Otev≈ôi lok√°lnƒõ p≈ôes <code>http://</code> nebo dej reverzn√≠ proxy s TLS.</span>
        </div>`;
    } else if (gw.ok){
      gwRow = `
        <div class="svc-row">
          <div class="svc-left"><span class="dot ok"></span><strong>Gateway OK</strong></div>
          <span class="svc-hint">~${gw.ms} ms</span>
        </div>`;
    } else {
      nb.innerHTML = `
        <div class="svc-row">
          <div class="svc-left"><span class="dot bad"></span><strong>Gateway nedostupn√°</strong></div>
        </div>
        <div class="svc-hint">Zkontroluj nap√°jen√≠/WAN na UCG. Dal≈°√≠ testy p≈ôeskoƒçeny.</div>`;
      return;
    }

    // 2) Internet (vezmi nejrychlej≈°√≠ c√≠l)
    let best = null;
    for (const u of CONFIG.network.internetTargets){
      const r = await ping(u, {timeout: 3500}).catch(()=>({ok:false}));
      if (r.ok && (!best || r.ms < best.ms)) best = {host:u, ms:r.ms};
    }
    const inetRow = best
      ? `<div class="svc-row"><div class="svc-left"><span class="dot ok"></span><strong>Internet OK</strong></div><span class="svc-hint">~${best.ms} ms</span></div>`
      : `<div class="svc-row"><div class="svc-left"><span class="dot bad"></span><strong>Internet nedostupn√Ω</strong></div></div>`;

    nb.innerHTML = gwRow + inetRow;
  }

  // ---------- LINKS ----------
  function renderLinks(){
    const box = document.getElementById("linksBox");
    box.innerHTML = LINKS.map(l => {
      const blocked = (location.protocol === 'https:' && l.url.startsWith('http://'));
      const href = blocked ? '#' : l.url;
      const attrs = blocked ? '' : 'target="_blank" rel="noopener"';
      return `<a class="btn" href="${href}" ${attrs}>${l.label}</a>`;
    }).join("");
  }

  // ---------- ZPR√ÅVY ----------
  async function loadNews(){
    const feed = "https://www.irozhlas.cz/rss/irozhlas";
    const api = new URL("https://api.rss2json.com/v1/api.json");
    api.searchParams.set("rss_url", feed);
    try{
      const res = await fetch(api.toString(), { cache:"no-store" });
      if(!res.ok) throw new Error(`RSS nelze naƒç√≠st (HTTP ${res.status}).`);
      const json = await res.json();
      if(json.status !== "ok" || !Array.isArray(json.items)){
        throw new Error("RSS ve form√°tu, kter√Ω nezn√°m.");
      }
      const items = json.items.slice(0,8);
      document.getElementById("newsBox").innerHTML =
        items.map(it => `
          <div class="row" style="justify-content:space-between;gap:12px">
            <a class="btn" href="${it.link}" target="_blank" rel="noopener" style="text-decoration:none;flex:1">
              ${it.title}
            </a>
            <span class="muted" style="white-space:nowrap">${new Date(it.pubDate).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'})}</span>
          </div>
        `).join("");
    }catch(e){
      document.getElementById("newsBox").innerHTML =
        `<div class="error">${e.message||e}</div>
         <div class="muted" style="margin-top:6px">
           Zdroj: <a class="btn" href="${feed}" target="_blank" rel="noopener">RSS iRozhlas</a>
         </div>`;
    }
  }

  // ---------- SLU≈ΩBY (HA/Nextcloud/Plex) ‚Äì ping ka≈æd√© URL ----------
  async function renderServices(){
    const box = document.getElementById("svcBox");

    if (NETSTATE.gateway && !NETSTATE.gateway.ok && !NETSTATE.gateway.blocked){
      box.innerHTML = `<div class="svc-row">
        <div class="svc-left"><span class="dot bad"></span><strong>Gateway offline</strong></div>
        <span class="svc-hint">Kontrola slu≈æeb p≈ôeskoƒçena</span>
      </div>`;
      return;
    }

    if (!SERVICES?.length){ box.innerHTML = `<div class="muted">≈Ω√°dn√© slu≈æby.</div>`; return; }

    const rows = [];
    for (const s of SERVICES){
      const r = await ping(s.url, {timeout: 3500});
      let dot = 'bad', hint = 'Nedostupn√©', href = '#', attrs = '';
      if (r.blocked){ dot='block'; hint='Blokov√°no v HTTPS (mixed content)'; }
      else if (r.ok){ dot='ok'; hint=`Online ¬∑ ~${r.ms} ms`; href = s.url; attrs = 'target="_blank" rel="noopener"'; }

      rows.push(`<div class="svc-row">
        <div class="svc-left"><span class="dot ${dot}"></span><a class="btn" href="${href}" ${attrs}>${s.name}</a></div>
        <span class="svc-hint">${hint}</span>
      </div>`);
    }

    const anyBlocked = rows.join('').includes('dot block');
    const tip = (location.protocol === 'https:' && anyBlocked)
      ? `<div class="svc-hint" style="margin-top:8px">
           Tip: Zva≈æ reverzn√≠ proxy (nap≈ô. Caddy) a vystaven√≠ tƒõchto slu≈æeb pod HTTPS stejnou dom√©nou.
         </div>` : '';

    box.innerHTML = rows.join('') + tip;
  }

  // ---------- MHD ----------
  let currentDir = "A";
  async function fetchDepartures({ids, limit, minutesBefore=0, minutesAfter=45}) {
    const base = CONFIG.departures.proxyUrl.replace(/\/+$/,'') + "/v2/pid/departureboards";
    const url = new URL(base);
    url.searchParams.set("ids", ids);
    url.searchParams.set("minutesBefore", String(minutesBefore));
    url.searchParams.set("minutesAfter", String(minutesAfter));
    url.searchParams.set("limit", String(limit));
    url.searchParams.set("preferredTimezone", "Europe/Prague");
    url.searchParams.set("includeMetroTrains", "true");

    const token = getToken();
    if(!token) throw new Error("Chyb√≠ API kl√≠ƒç. Klikni na ‚ÄûZmƒõnit API kl√≠ƒç‚Äú a vlo≈æ X-Access-Token.");

    const res = await fetch(url.toString(), {
      headers: { "X-Access-Token": token, "Accept": "application/json" }
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>String(res.status));
      throw new Error(`Chyba proxy: ${res.status}\n\n${txt}`);
    }
    return res.json();
  }

  function renderDepartures(data){
    const listEl = $("#mhdList");
    listEl.innerHTML = "";
    const deps = Array.isArray(data.departures) ? data.departures.slice(0, CONFIG.departures.limit*3) : [];
    const byPlatform = deps.filter(d => {
      const type = d?.route?.type;
      if (type === 2) return true;
      const plat = (d?.stop?.platform_code || "").toUpperCase();
      return plat === currentDir;
    });
    const minM = Number(CONFIG.departures.minMinutes ?? 0);
    const afterThreshold = byPlatform.filter(d => {
      const shownISO = d?.departure_timestamp?.predicted || d?.departure_timestamp?.scheduled;
      if (!shownISO) return false;
      const m = minsTo(shownISO);
      return m >= minM;
    });
    if(afterThreshold.length === 0){
      listEl.innerHTML = `<div class="error">≈Ω√°dn√© odjezdy ‚â• ${minM} min pro smƒõr ${currentDir}.</div>`;
      return;
    }
    const take = afterThreshold.slice(0, CONFIG.departures.limit);
    for(const d of take){
      const row = document.createElement("div");
      row.className = "dep";
      const ico = document.createElement("div");
      ico.textContent = iconByType(d?.route?.type);
      ico.style.opacity = .85;
      const line = document.createElement("div");
      line.className = "line";
      line.textContent = (d?.route?.short_name ?? d?.route?.long_name ?? "?");
      const where = document.createElement("div");
      where.className = "where";
      const head = d?.trip?.headsign ?? d?.last_stop?.name ?? "";
      const plat = d?.stop?.platform_code ? ` ¬∑ st. ${d.stop.platform_code}` : "";
      where.textContent = `${head}${plat}`;
      const timeBox = document.createElement("div");
      timeBox.className = "time";
      const shownISO = d?.departure_timestamp?.predicted || d?.departure_timestamp?.scheduled;
      const mins = minsTo(shownISO);
      timeBox.textContent = (CONFIG.departures.mode === "time") ? fmtHHMM(shownISO) : `${mins} min`;
      const del = delayMin(d?.departure_timestamp?.scheduled, d?.departure_timestamp?.predicted);
      if(del){
        const span = document.createElement("span");
        span.className = "delay " + (del>0?"warn":"ok");
        span.textContent = (del>0?` +${del}`:` ${del}`);
        timeBox.appendChild(span);
      }
      row.appendChild(ico);
      row.appendChild(line);
      row.appendChild(where);
      row.appendChild(timeBox);
      listEl.appendChild(row);
    }
  }

  async function refreshDepartures(){
    try{
      const data = await fetchDepartures({
        ids: CONFIG.departures.ids,
        limit: CONFIG.departures.limit
      });
      renderDepartures(data);
      const ts = new Date();
      document.getElementById("mhdFoot").textContent =
        `${CONFIG.departures.title} ¬∑ Posledn√≠ kontrola ${fmtHM(ts)} ¬∑ filtr ‚â• ${CONFIG.departures.minMinutes} min`;
    }catch(err){
      document.getElementById("mhdList").innerHTML = `<div class="error">${(err?.message || err)}</div>`;
      document.getElementById("mhdFoot").textContent = CONFIG.departures.title;
    }
  }

  // ---------- UI ----------
  const apiDlg = document.getElementById("apiDlg");
  const apiInput = document.getElementById("apiInput");
  document.getElementById("apiBtn").addEventListener("click", ()=>{ apiInput.value = getToken(); apiDlg.showModal(); });
  apiDlg.addEventListener("close", () => { if(apiDlg.returnValue==="ok"){ setToken(apiInput.value.trim()); refreshDepartures(); }});

  const dirBtn = document.getElementById("dirBtn");
  dirBtn.addEventListener("click", ()=>{
    currentDir = currentDir === "A" ? "B" : "A";
    dirBtn.textContent = `Smƒõr: ${currentDir === "A" ? "Koh-i-noor" : "Kub√°nsk√© n√°mƒõst√≠"}`;
    refreshDepartures();
  });
  document.getElementById("titlePill").textContent = CONFIG.departures.title;

  // ---------- INIT ----------
  (async function init(){
    if(!getToken()) apiDlg.showModal();
    renderLinks();

    // S√≠≈•
    await loadNetStatus();

    // News + MHD
    await loadNews();
    await refreshDepartures();

    // periodick√© kontroly
    setInterval(loadNetStatus, 60*1000);       // gateway + internet
    setInterval(renderServices, 5*60*1000);    // slu≈æby (po prvn√≠m pingnut√≠ gateway)
    setInterval(refreshDepartures, 60*1000);   // MHD
    setInterval(loadNews, 30*60*1000);         // zpr√°vy

    // po naƒçten√≠ s√≠tƒõ zkus√≠me slu≈æby
    await renderServices();
  })();
  </script>
</body>
</html>