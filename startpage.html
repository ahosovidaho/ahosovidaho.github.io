<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Dom√°c√≠ start</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Font Awesome bez integrity (aby nepadalo na SRI) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{
      color-scheme: dark;
      --bg:#0f172a; --panel:rgba(15,23,42,.8); --border:rgba(148,163,184,.2);
      --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8; --danger:#f87171; --good:#34d399; --warn:#facc15;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    html,body{margin:0;padding:0;background:radial-gradient(circle at top, #1e293b, #0f172a 45%);color:var(--text)}
    .app{max-width:1200px;margin:32px auto;padding:0 16px;display:flex;flex-direction:column;gap:24px}
    header{display:flex;flex-direction:column;gap:8px}
    header h1{font-size:clamp(32px,5vw,44px);font-weight:700}
    header p{color:var(--muted);max-width:600px}
    .top-grid{display:grid;gap:24px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;backdrop-filter:blur(16px);box-shadow:0 20px 40px -24px rgba(15,23,42,.65);display:flex;flex-direction:column;gap:16px}
    .panel-header{display:flex;align-items:center;gap:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;font-size:12px;color:var(--muted)}
    .panel-actions{display:flex;gap:12px;flex-wrap:wrap}
    .ghost-button{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.3);background:transparent;color:var(--text);font-weight:500;cursor:pointer}
    .ghost-button:hover{border-color:rgba(56,189,248,.6);color:var(--accent);background:rgba(56,189,248,.1)}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;background:rgba(148,163,184,.16);color:var(--text);display:inline-flex;align-items:center;gap:.5em}
    .badge.success{background:rgba(52,211,153,.15);color:var(--good)}
    .badge.warn{background:rgba(250,204,21,.15);color:var(--warn)}
    .badge.danger{background:rgba(248,113,113,.15);color:var(--danger)}
    .muted{color:var(--muted)}
    .big{font-size:clamp(40px,5vw,56px);font-weight:800}
    .mono{font-variant-numeric:tabular-nums}
    .divider{height:1px;background:var(--border);margin:4px 0}
    .grid2{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .departure-list{display:grid;gap:12px}
    .departure-item{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08)}
    .departure-time{font-size:20px;font-weight:700}
    .departure-destination{margin-top:6px;color:var(--muted);font-size:14px}
    .departure-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .main-layout{display:grid;gap:24px;grid-template-columns:minmax(220px,1fr) minmax(0,2fr) minmax(220px,1fr);grid-template-areas:'links news servers';align-items:start}
    #links-panel{grid-area:links} #news-panel{grid-area:news} #servers-panel{grid-area:servers}
    .links-grid{display:flex;flex-direction:column;gap:12px}
    .quick-link{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;background:rgba(148,163,184,.08);color:var(--text);text-decoration:none;font-weight:500}
    .quick-link:hover{background:rgba(56,189,248,.16);color:var(--accent)}
    .timestamp{font-size:12px;color:var(--muted)}
    @media (max-width:1024px){.main-layout{grid-template-columns:1fr;grid-template-areas:'links' 'news' 'servers'}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Dom√°c√≠ start</h1>
      <p class="muted">Rann√≠/veƒçern√≠ p≈ôehled ‚Äì poƒças√≠, MHD, dostupnost dom√°c√≠ s√≠tƒõ a rychl√© odkazy.</p>
    </header>

    <div class="top-grid">
      <!-- POƒåAS√ç ponech√°v√°m (zde jen placeholder, a≈• neh√°≈æe chyby) -->
      <section class="panel" id="weather-panel">
        <div class="panel-header">
          <i class="fa-solid fa-cloud-sun"></i><span>Poƒças√≠ ‚Äì Vr≈°ovice</span>
        </div>
        <div id="weather-content"><p class="muted">Naƒç√≠t√°m aktu√°ln√≠ poƒças√≠‚Ä¶</p></div>
      </section>

      <!-- ODJEZDY MHD ‚Äì PEVNƒö NA KO≈òEN WORKERU -->
      <section class="panel" id="departures-panel">
        <div class="panel-header">
          <i class="fa-solid fa-train-tram"></i><span>Odjezdy MHD</span>
        </div>
        <div id="departures-content"><p class="muted">Naƒç√≠t√°m nejbli≈æ≈°√≠ odjezdy‚Ä¶</p></div>
        <div class="panel-actions">
          <button type="button" class="ghost-button" id="dir-a"><i class="fa-solid fa-arrow-right"></i> smƒõr A (Koh-i-noor)</button>
          <button type="button" class="ghost-button" id="dir-b"><i class="fa-solid fa-arrow-left"></i> smƒõr B (Kub√°nsk√© n√°m.)</button>
        </div>
      </section>

      <!-- INTERNET pozn.: HTTP lok√°ly z HTTPS dom√©ny prohl√≠≈æeƒç blokuje (mixed content) -->
      <section class="panel" id="internet-panel">
        <div class="panel-header"><i class="fa-solid fa-wifi"></i><span>Dom√°c√≠ internet</span></div>
        <div class="timestamp muted">Kontrola dom√°c√≠ch IP je vypnut√° z HTTPS (mixed content). Funguje jen z lok√°ln√≠ s√≠tƒõ/HTTP.</div>
      </section>
    </div>

    <div class="main-layout">
      <aside class="panel" id="links-panel">
        <div class="panel-header"><i class="fa-solid fa-bookmark"></i><span>Rychl√© odkazy</span></div>
        <div class="links-grid" id="links-grid"></div>
      </aside>

      <section class="panel" id="news-panel">
        <div class="panel-header"><i class="fa-solid fa-newspaper"></i><span>iRozhlas.cz ‚Äì nejnovƒõj≈°√≠</span></div>
        <div id="news-content"><p class="muted">Zpr√°vy doƒçasnƒõ vypnut√© (CORS 403) ‚Äì nech√°m bez vol√°n√≠, a≈• to ne≈°pin√≠ konzoli.</p></div>
      </section>

      <aside class="panel" id="servers-panel">
        <div class="panel-header"><i class="fa-solid fa-server"></i><span>Dom√°c√≠ slu≈æby</span></div>
        <div class="timestamp muted">Lok√°ln√≠ ping skryt ‚Äì z HTTPS dom√©ny by se HTTP lok√°ly stejnƒõ blokovaly.</div>
      </aside>
    </div>
  </div>

  <script>
    // ===== KONFIG =====
    const CONFIG = {
      // jen to, co pot≈ôebujeme v tomto fixu
      departures: {
        // TV≈ÆJ WORKER ‚Äì KO≈òENOV√Å URL (mus√≠ konƒçit lom√≠tkem!)
        proxyBase: 'https://golemio.m88wqgcdpd.workers.dev/',

        // A/B tram + S9:
        stopIdsTram_A: ['U680Z1P'],   // platforma A (Koh-i-noor)
        stopIdsTram_B: ['U680Z2P'],   // platforma B (Kub√°nsk√© n√°m.)
        stopIdsTrain:  ['U680Z301'],  // Praha-Eden (S9)
        limit: 12,
        minutesBefore: 0,
        minutesAfter: 45,
        timezone: 'Europe/Prague',
        minLeadMinutes: 5   // odjezdy nejd≈ô√≠v za 5 minut
      },
      links: [
        { label: 'E-mail', url: 'https://mail.google.com', icon: 'fa-envelope' },
        { label: 'Kalend√°≈ô', url: 'https://calendar.google.com', icon: 'fa-calendar-days' },
        { label: 'Nextcloud', url: 'https://cloud.example.com', icon: 'fa-cloud' },
        { label: 'Home Assistant', url: 'https://ha.example.com', icon: 'fa-house-signal' },
        { label: 'Plex', url: 'https://plex.tv/web', icon: 'fa-clapperboard-play' },
        { label: 'Bankovnictv√≠', url: 'https://ib.examplebank.cz', icon: 'fa-piggy-bank' }
      ]
    };

    // ===== UTILS =====
    const departuresContent = document.getElementById('departures-content');
    const linksGrid = document.getElementById('links-grid');
    const ROUTE_TYPE_ICONS = {0:'üöã',1:'‚ìÇÔ∏è',2:'üöÜ',3:'üöå',11:'üöé'};
    const dd = n => String(n).padStart(2,'0');
    const fmtTime = d => new Intl.DateTimeFormat('cs-CZ',{hour:'2-digit',minute:'2-digit'}).format(d);
    const chip = (label, cls='') => `<span class="badge ${cls}">${label}</span>`;
    function minutesUntil(iso){ if(!iso) return null; const t = new Date(iso).getTime() - Date.now(); return Math.max(0, Math.ceil(t/60000)); }

    // ===== MHD: POUZE KO≈òEN WORKERU (/?...) ‚Äì ≈Ω√ÅDN√â /v2, /pid, ani fallbacky =====
    let currentDir = 'A';
    document.getElementById('dir-a').addEventListener('click', ()=>{ currentDir='A'; loadDepartures(); });
    document.getElementById('dir-b').addEventListener('click', ()=>{ currentDir='B'; loadDepartures(); });

    async function fetchDepartures(idsArr){
      const { proxyBase, minutesBefore, minutesAfter, limit, timezone } = CONFIG.departures;

      // D≈ÆLE≈ΩIT√â: Jen ko≈ôen proxyBase a query parametry
      const url = new URL(proxyBase);
      url.searchParams.set('ids', idsArr.join(','));
      url.searchParams.set('minutesBefore', String(minutesBefore||0));
      url.searchParams.set('minutesAfter',  String(minutesAfter||30));
      url.searchParams.set('limit',         String(limit||12));
      url.searchParams.set('preferredTimezone', timezone || 'Europe/Prague');
      url.searchParams.set('includeMetroTrains', 'true');

      const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' }});
      if(!res.ok) throw new Error(`Chyba proxy: ${res.status}`);
      return await res.json();
    }

    function normalizeDepartures(list){
      return (Array.isArray(list)?list:[]).map(d => {
        const scheduled = d?.departure_timestamp?.scheduled || null;
        const predicted = d?.departure_timestamp?.predicted || null;
        const iso = predicted || scheduled;
        const mins = minutesUntil(iso);
        const line = d?.route?.short_name || d?.route?.long_name || 'Linka';
        const type = Number(d?.route?.type);
        const icon = Number.isFinite(type) ? (ROUTE_TYPE_ICONS[type]||'') : '';
        const platform = d?.stop?.platform_code || d?.stop?.platform_name || '';
        const headsignBase = d?.trip?.headsign || d?.last_stop?.name || '‚Äî';
        const headsign = platform ? `${headsignBase} ¬∑ st. ${platform}` : headsignBase;

        // zpo≈ædƒõn√≠
        let delayMin = null;
        const s = scheduled ? new Date(scheduled) : null;
        const p = predicted ? new Date(predicted) : null;
        if (s && p) delayMin = Math.round((p.getTime()-s.getTime())/60000);
        else if (typeof d?.departure_delay === 'number') delayMin = Math.round(d.departure_delay/60);

        return { iso, mins, line, icon, headsign, delayMin, stopId: d?.stop?.id || null };
      }).filter(x => x.iso);
    }

    function renderDepartures(list, label){
      if (!list.length){
        departuresContent.innerHTML = `
          <p>Nebyly nalezeny ≈æ√°dn√© odjezdy pro zadan√Ω filtr (${label}).</p>
          <div class="timestamp">Posledn√≠ kontrola ${fmtTime(new Date())}</div>
        `;
        return;
      }
      const items = list.map(x=>{
        const when = fmtTime(new Date(x.iso));
        const mins = x.mins==null ? '‚Äî' : (x.mins===0 ? 'odj√≠≈æd√≠' : `${x.mins} min`);
        const delayBadge = x.delayMin==null ? '' :
            (x.delayMin===0 ? chip('Vƒças','success') :
             x.delayMin>0   ? chip(`+${x.delayMin} min`,'danger') :
                              chip(`${x.delayMin} min`,'success'));
        const soonBadge = x.mins!=null && x.mins<=1 ? chip(mins,'success') : chip(mins);
        return `
          <div class="departure-item">
            <div>
              <div class="badge">${x.icon?`${x.icon} `:''}${x.line}</div>
              <div class="departure-destination">${x.headsign}</div>
            </div>
            <div class="departure-time mono">${when}</div>
            <div class="departure-meta">${soonBadge}${delayBadge}</div>
          </div>
        `;
      }).join('');
      departuresContent.innerHTML = `
        <div class="departure-list">${items}</div>
        <div class="timestamp">Slavia ‚Äì n√°dra≈æ√≠ Eden ¬∑ smƒõr ${label==='A'?'Koh-i-noor':'Kub√°nsk√© n√°mƒõst√≠'} ¬∑ Aktualizov√°no ${fmtTime(new Date())}</div>
      `;
    }

    async function loadDepartures(){
      try{
        const idsTram = (currentDir==='A') ? CONFIG.departures.stopIdsTram_A : CONFIG.departures.stopIdsTram_B;
        const idsAll = [...idsTram, ...CONFIG.departures.stopIdsTrain]; // tram dle smƒõru + vlaky S9
        const data = await fetchDepartures(idsAll);

        // ponech√°me jen stanice, kter√© chceme (tram smƒõr + vlak)
        const allow = new Set(idsTram.concat(CONFIG.departures.stopIdsTrain));
        const byStop = (data.departures||[]).filter(d => allow.has(d?.stop?.id));
        let list = normalizeDepartures(byStop);

        // filtr ‚Äûnejd≈ô√≠v za N minut‚Äú
        const minLead = Number(CONFIG.departures.minLeadMinutes||0);
        if (minLead>0) list = list.filter(x => x.mins!=null && x.mins>=minLead);

        // kdyby filtr vypr√°zdnil, uka≈æ aspo≈à nƒõco z cel√© odpovƒõdi
        if (!list.length){
          let all = normalizeDepartures(data.departures||[]);
          if (minLead>0) all = all.filter(x => x.mins!=null && x.mins>=minLead);
          list = all;
        }

        renderDepartures(list, currentDir);
      }catch(err){
        departuresContent.innerHTML = `<p class="badge danger">Odjezdy MHD: ${err.message || err}</p>`;
      }
    }

    function renderLinks(){
      linksGrid.innerHTML = CONFIG.links.map(l => `
        <a class="quick-link" href="${l.url}" target="_blank" rel="noopener">
          <i class="fa-solid ${l.icon}"></i><span>${l.label}</span>
        </a>
      `).join('');
    }

    (async function init(){
      renderLinks();
      await loadDepartures();
      setInterval(loadDepartures, 60*1000);
    })();
  </script>
</body>
</html>