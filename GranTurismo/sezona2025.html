<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hric-Pic-Ma-Ma-Tama Championship 2025</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #121212; color: #fff; font-family: sans-serif; }
.nav-tabs .nav-link.active { background-color: #1e1e1e; color: #f00; }
.table { color: #fff; }
.table th, .table td { vertical-align: middle; }
.card { background-color: #1e1e1e; }
.btn-primary { background-color: #0066cc; border-color: #0066cc; }
</style>
</head>
<body>
<div class="container py-3">
  <h1 class="text-center mb-4">Hric-Pic-Ma-Ma-Tama Championship 2025</h1>
  <ul class="nav nav-tabs" id="tabs">
    <li class="nav-item"><a class="nav-link active" data-tab="aktualni">Aktuální sezóna</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="statistiky">Statistiky</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="archiv">Archiv sezon</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="profil">Profil závodníka</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="admin">Admin</a></li>
  </ul>
  
  <div id="tabContent" class="mt-3">
    <div id="aktualni" class="tab-pane active">
      <h3>Nejbližší závod</h3>
      <div id="upcoming" class="mb-4"></div>
      
      <h3>Graf vývoje bodů</h3>
      <canvas id="pointsChart" height="200"></canvas>
      
      <h3 class="mt-4">Celkové pořadí</h3>
      <table class="table table-dark table-striped" id="rankingTable">
        <thead>
          <tr><th>Závodník</th><th>Body</th><th>Pódiová umístění</th><th>DNS</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      
      <h3 class="mt-4">Výsledky závodů</h3>
      <table class="table table-dark table-striped" id="resultsTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Závod a trať</th>
            <th>1. místo</th>
            <th>2. místo</th>
            <th>3. místo</th>
            <th>4. místo</th>
            <th>5. místo</th>
            <th>Video</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="statistiky" class="tab-pane">
      <h3>Statistiky</h3>
      <p>Nejdelší série výher, nejdelší série posledního místa, nejvíce DNS a porovnání H2H.</p>
    </div>
    
    <div id="archiv" class="tab-pane">
      <h3>Archiv sezón</h3>
      <p>Souhrn všech výsledků z minulých sezón.</p>
    </div>
    
    <div id="profil" class="tab-pane">
      <h3>Profil závodníka</h3>
      <p>Nahrání fotky, oblíbené auto, trať, a další údaje.</p>
    </div>
    
    <div id="admin" class="tab-pane">
      <h3>Admin: přidání/úprava závodů</h3>
      <form id="adminForm">
        <div class="mb-2"><label>Datum a čas</label><input type="datetime-local" id="raceDate" class="form-control"></div>
        <div class="mb-2"><label>Název závodu</label><input type="text" id="raceName" class="form-control"></div>
        <div class="mb-2"><label>Trať</label><input type="text" id="raceTrack" class="form-control"></div>
        <div class="mb-2"><label>Kategorie</label>
          <select id="raceCategory" class="form-select">
            <option>Gr.1</option><option>Gr.2</option><option>Gr.3</option><option>Gr.4</option><option>Gr.B</option><option>VGT</option><option>Open</option>
          </select>
        </div>
        <div class="mb-2"><label>Povolená vozidla</label><input type="text" id="raceCars" class="form-control"></div>
        <div class="mb-2"><label>Tuning</label>
          <select id="raceTuning" class="form-select"><option>ANO</option><option>NE</option></select>
        </div>
        <div class="mb-2"><label>Povinný pitstop</label>
          <select id="racePit" class="form-select"><option>ANO</option><option>NE</option></select>
        </div>
        <div class="mb-2"><label>Pneumatiky</label>
          <select id="raceTyres" class="form-select"><option>Komfortní</option><option>Sportovní</option><option>Závodní</option><option>Na sníh</option><option>Na šotolinu</option></select>
        </div>
        <div class="mb-2"><label>Doplňující info</label><textarea id="raceInfo" class="form-control"></textarea></div>
        <button type="submit" class="btn btn-primary">Uložit nový závod</button>
      </form>
      <div id="editRace"></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
  authDomain: "test-gt7.firebaseapp.com",
  projectId: "test-gt7",
  storageBucket: "test-gt7.appspot.com",
  messagingSenderId: "928154989107",
  appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const resultsTable = document.querySelector("#resultsTable tbody");
const rankingTable = document.querySelector("#rankingTable tbody");
const upcomingDiv = document.getElementById("upcoming");

// Základní seznam závodníků
const racers = ["Viki","Mára","Maty","Hárdy","Ondra"];
const pointsMap = [10,8,6,4,2];

let allRaces = [];

async function loadRaces() {
  const querySnapshot = await getDocs(collection(db, "zavody"));
  allRaces = [];
  querySnapshot.forEach((docSnap) => {
    allRaces.push({id: docSnap.id, ...docSnap.data()});
  });
  allRaces.sort((a,b) => new Date(a.date) - new Date(b.date));
  renderRaces();
}

function renderRaces() {
  resultsTable.innerHTML = "";
  let scores = {};
  racers.forEach(r=>scores[r]=0);
  let podiums = {};
  racers.forEach(r=>podiums[r]=0);
  let dnsCount = {};
  racers.forEach(r=>dnsCount[r]=0);

  allRaces.forEach(race=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${new Date(race.date).toLocaleString()}</td>
                    <td>${race.name} - ${race.track}</td>`;
    for(let i=0;i<5;i++){
      const racer = race.order && race.order[i] ? race.order[i] : "DNS";
      tr.innerHTML += `<td>${racer}</td>`;
      if(racer!=="DNS"){
        scores[racer]+=pointsMap[i];
        if(i<3) podiums[racer]++;
      } else {
        dnsCount[racer]++;
      }
    }
    tr.innerHTML += `<td>${race.video ? `<a href="${race.video}" target="_blank">YouTube</a>` : ""}</td>`;
    resultsTable.appendChild(tr);
  });

  // Tabulka pořadí
  rankingTable.innerHTML="";
  let ranking = racers.map(r=>({name:r, points:scores[r], podiums:podiums[r], dns:dnsCount[r]}));
  ranking.sort((a,b)=>b.points-a.points);
  ranking.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${r.name}</td><td>${r.points}</td><td>${r.podiums}</td><td>${r.dns}</td>`;
    rankingTable.appendChild(tr);
  });

  // Nejbližší závod
  const now = new Date();
  const upcoming = allRaces.find(r=>new Date(r.date) > now);
  upcomingDiv.innerHTML = upcoming ? `${new Date(upcoming.date).toLocaleString()} - ${upcoming.name} (${upcoming.track})` : "Žádný nadcházející závod";
}

document.getElementById("adminForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const raceData = {
    date: document.getElementById("raceDate").value,
    name: document.getElementById("raceName").value,
    track: document.getElementById("raceTrack").value,
    category: document.getElementById("raceCategory").value,
    cars: document.getElementById("raceCars").value,
    tuning: document.getElementById("raceTuning").value,
    pitstop: document.getElementById("racePit").value,
    tyres: document.getElementById("raceTyres").value,
    info: document.getElementById("raceInfo").value,
    order: [],
    video: ""
  };
  await addDoc(collection(db, "zavody"), raceData);
  loadRaces();
  e.target.reset();
});

// Přepínání záložek
document.querySelectorAll("#tabs .nav-link").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-pane").forEach(p=>p.classList.remove("active"));
    document.querySelectorAll("#tabs .nav-link").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

loadRaces();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script>
const ctx = document.getElementById('pointsChart').getContext('2d');
const pointsChart = new Chart(ctx, {
  type: 'line',
  data: { labels: [], datasets: [] },
  options: { responsive: true, plugins: { legend: { display: true } } }
});

function updateChart(){
  let labels = allRaces.map(r=>new Date(r.date).toLocaleDateString());
  let datasets = [];
  const scores = {};
  racers.forEach(r=>scores[r]=0);
  allRaces.forEach(race=>{
    const pointsSnapshot = {};
    for(let i=0;i<5;i++){
      const racer = race.order && race.order[i]?race.order[i]:"DNS";
      if(racer!=="DNS"){
        scores[racer]+=pointsMap[i];
      }
      pointsSnapshot[racer]=scores[racer];
    }
    datasets.push({...pointsSnapshot});
  });
  // Rebuild chart datasets
  pointsChart.data.labels = labels;
  pointsChart.data.datasets = racers.map(r=>({
    label:r,
    data: allRaces.map(race=>{
      return race.order ? (race.order.indexOf(r)>=0 ? pointsMap[race.order.indexOf(r)] : 0) : 0;
    }),
    borderColor: r==="Viki"?"#ff0000":r==="Mára"?"#00ff00":r==="Maty"?"#0000ff":r==="Hárdy"?"#ff00ff":"#00ffff",
    tension:0.3,
    fill:false
  }));
  pointsChart.update();
}

loadRaces().then(()=>updateChart());
</script>
</body>
</html>
