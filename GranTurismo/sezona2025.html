<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hric-Pic-Ma-Ma-Tama Championship 2025</title>
<style>
  :root{
    --bg:#121212; --panel:#1e1e1e; --line:#2a2a2a; --muted:#bdbdbd;
    --accent:#0d1b36; --accent2:#610000;
    --viki:#ff058a; --maty:#d0e0e3; --hardy:#00ffea; --mara:#ffff66; --ondra:#7d85c0;
  }
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#fff;margin:0}
  header{padding:20px;text-align:center;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  nav{display:flex;gap:8px;justify-content:center;background:#161616;position:sticky;top:0;z-index:5}
  nav button{background:none;border:none;color:#fff;padding:14px 18px;cursor:pointer;font-size:16px}
  nav button.active{border-bottom:3px solid #ff3b30}
  main{padding:20px}
  section{display:none}
  section.active{display:block}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px 0}
  h2{margin:0 0 12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  th{background:#222}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > .col{flex:1 1 280px;min-width:260px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#222;border:1px solid var(--line);font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#1a1a1a;border:1px solid #2a2a2a}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .dot{width:10px;height:10px;border-radius:50%}
  canvas{max-width:100%;height:auto}
  .countdown{font-variant-numeric:tabular-nums;font-size:28px}
</style>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- Chart.js (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header><h1>Hric-Pic-Ma-Ma-Tama Championship 2025</h1></header>

  <nav>
    <button class="tab active" data-tab="aktualni">Aktuální sezóna</button>
    <button class="tab" data-tab="statistiky">Statistiky</button>
    <button class="tab" data-tab="archiv">Archiv sezón</button>
    <button class="tab" data-tab="profil">Profil závodníka</button>
    <button class="tab" data-tab="admin">Admin</button>
  </nav>

  <main>
    <!-- Aktuální sezóna -->
    <section id="aktualni" class="active">
      <div class="card">
        <h2>Nejbližší závod</h2>
        <div id="next-race-box">
          <div class="muted">Hledám nejbližší naplánovaný závod…</div>
        </div>
      </div>

      <div class="card">
        <h2>Vývoj bodů</h2>
        <div class="legend" id="driver-legend"></div>
        <canvas id="pointsChart" height="120" aria-label="Graf vývoje bodů" role="img"></canvas>
      </div>

      <div class="card">
        <h2>Pořadí závodníků</h2>
        <table id="standings">
          <thead><tr><th>Závodník</th><th>Body</th><th>Pódia</th><th>DNS</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Výsledky závodů</h2>
        <table id="results">
          <thead>
            <tr>
              <th>Datum</th><th>Závod / Trať</th>
              <th>1. místo</th><th>2. místo</th><th>3. místo</th><th>4. místo</th><th>5. místo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" id="planned-wrapper">
        <h2>Naplánované závody</h2>
        <table id="planned">
          <thead><tr><th>Datum</th><th>Závod / Trať</th><th>Detaily</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Statistiky -->
    <section id="statistiky">
      <div class="card">
        <h2>H2H porovnání</h2>
        <div class="row">
          <div class="col">
            <label>Jezdec A:<br/>
              <select id="h2hA"></select>
            </label>
          </div>
          <div class="col">
            <label>Jezdec B:<br/>
              <select id="h2hB"></select>
            </label>
          </div>
        </div>
        <div id="h2h-summary" class="row" style="margin-top:10px"></div>
        <div style="margin-top:12px">
          <table id="h2h-table">
            <thead><tr><th>Datum</th><th>Závod</th><th>Trať</th><th>Výsledek A</th><th>Výsledek B</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:16px">
          <canvas id="h2hMiniChart" height="100"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>Auta &amp; značky</h2>
        <div class="muted" style="margin:6px 0">Počítáno podle vítězných vozů u dokončených závodů. Když vůz není vyplněn, spadá do „Neznámé“.</div>
        <table id="brand-stats">
          <thead><tr><th>Pořadí</th><th>Značka</th><th>Počet vítězství</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Série a DNS</h2>
        <div class="row">
          <div class="col">
            <h3 style="margin:0 0 8px">Nejdelší série výher</h3>
            <table id="streak-wins">
              <thead><tr><th>Jezdec</th><th>Délka série</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="col">
            <h3 style="margin:0 0 8px">Nejdelší série posledních míst <span class="badge">bez DNS</span></h3>
            <table id="streak-last">
              <thead><tr><th>Jezdec</th><th>Délka série</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="col">
            <h3 style="margin:0 0 8px">Nejvíc DNS</h3>
            <table id="dns-max">
              <thead><tr><th>Jezdec</th><th>DNS</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Archiv -->
    <section id="archiv">
      <div class="card">
        <h2>Archiv sezón</h2>
        <div class="muted">Zatím pracujeme s ročníkem 2025.</div>
      </div>
    </section>

    <!-- Profil -->
    <section id="profil">
      <div class="card">
        <h2>Profil závodníka</h2>
        <div class="muted">Login &amp; profil později – fotka, oblíbené auto/trať, atd.</div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin">
      <div class="card">
        <h2>Admin</h2>
        <button id="loginBtn">Přihlásit se přes Google</button>
        <span id="whoami" class="badge" style="margin-left:8px">Nepřihlášen</span>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Přidat naplánovaný závod</h3>
        <div class="row">
          <div class="col">
            <label>Datum a čas<br/>
              <input id="new-date" type="datetime-local" autocomplete="off"/>
            </label>
          </div>
          <div class="col">
            <label>Název závodu<br/>
              <input id="new-name" type="text" placeholder="Název" autocomplete="off"/>
            </label>
          </div>
          <div class="col">
            <label>Trať<br/>
              <input id="new-track" list="trackList" placeholder="Začni psát…" autocomplete="off"/>
              <datalist id="trackList"></datalist>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="col"><label>Povolená vozidla<br/><input id="cfg-vehicles" type="text" placeholder="např. GT3" autocomplete="off"/></label></div>
          <div class="col"><label>Kategorie<br/>
            <select id="cfg-class">
              <option>Gr.1</option><option>Gr.2</option><option>Gr.3</option>
              <option>Gr.4</option><option>Gr.B</option><option>VGT</option>
              <option>Open</option>
            </select></label>
          </div>
          <div class="col"><label>Tuning<br/><select id="cfg-tuning"><option>NE</option><option>ANO</option></select></label></div>
          <div class="col"><label>BoP (rovnováha výkonu)<br/><select id="cfg-bop"><option>ANO</option><option>NE</option></select></label></div>
        </div>
        <div class="row">
          <div class="col"><label>Povolené pneu<br/>
            <select id="cfg-tyres">
              <option>Komfortní</option><option>Sportovní</option><option>Závodní</option><option>Na sníh</option><option>Na šotolinu</option>
            </select></label></div>
          <div class="col"><label>Povinná směs<br/><select id="cfg-compound"><option>Tvrdá</option><option>Střední</option><option>Měkká</option></select></label></div>
          <div class="col"><label>Opotřebení pneumatik<br/><input id="cfg-tyreWear" type="text" placeholder="např. x5" autocomplete="off"/></label></div>
          <div class="col"><label>Spotřeba paliva<br/><input id="cfg-fuelUse" type="text" placeholder="např. x3" autocomplete="off"/></label></div>
        </div>
        <div class="row">
          <div class="col"><label>Rychlost dopl. paliva<br/><input id="cfg-refuel" type="text" placeholder="např. 5 l/s" autocomplete="off"/></label></div>
          <div class="col"><label>Povinný pit-stop<br/><select id="cfg-mandPit"><option>NE</option><option>ANO</option></select></label></div>
          <div class="col"><label>Doplňující info<br/><input id="cfg-notes" type="text" placeholder="volitelné" autocomplete="off"/></label></div>
        </div>
        <button id="btn-add-race">Uložit závod</button>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Editace závodů</h3>
        <div class="muted" style="margin-bottom:8px">Klikni na řádek a data se předvyplní k editaci.</div>
        <table id="admin-races">
          <thead><tr><th>Datum</th><th>Název / Trať</th><th>Stav</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px">
          <button id="btn-save-edit" disabled>Uložit změny</button>
          <button id="btn-cancel-edit" disabled>Zrušit</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Upravit výsledky vybraného závodu</h3>
        <div class="row">
          <div class="col">
            <label>Vyber závod<br/>
              <select id="result-race"></select>
            </label>
          </div>
          <div class="col">
            <label>YouTube odkaz (volitelně)<br/>
              <input id="yt-url" type="url" placeholder="https://youtu.be/..." autocomplete="off"/>
            </label>
          </div>
        </div>

        <div id="result-form" class="row" style="margin-top:10px"></div>
        <button id="btn-save-results" disabled>Uložit výsledky</button>
      </div>
    </section>
  </main>

<script>
/* -------------------- TABY -------------------- */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* -------------------- FIREBASE -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
  authDomain: "test-gt7.firebaseapp.com",
  projectId: "test-gt7",
  storageBucket: "test-gt7.firebasestorage.app",
  messagingSenderId: "928154989107",
  appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
  measurementId: "G-1SG8DW1KQ9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ------------------- STÁLÉ HODNOTY ------------------- */
const DRIVERS = ["Viki","Mára","Maty","Hardy","Ondra"];
const DRIVER_COLORS = { "Viki":"#ff058a", "Maty":"#d0e0e3", "Hardy":"#00ffea", "Mára":"#ffff66", "Ondra":"#7d85c0" };
const POINTS = [10,8,6,4,2];
let RACES = []; // [{...doc, id}]
let EDIT_ID = null;

/* ------------------- POMOCNÉ ------------------- */
function parseDate(s){
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}
function fmtDate(d){
  if(!d) return "—";
  const dd = d.toLocaleString("cs-CZ",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  return dd.replace(",","").replace(/\s/g," ");
}
function isCompleted(r){
  if(!Array.isArray(r.vysledky)) return false;
  const first = r.vysledky[0];
  const name = typeof first==='string' ? first : (first && first.driver) || "";
  return !!name && name!=="DNS";
}
function parseResultsArray(r){
  const out = [];
  for(let i=0;i<5;i++){
    const e = (r.vysledky && r.vysledky[i]) ?? "DNS";
    if(typeof e === 'string'){
      out.push({driver:e, carBrand:null, carModel:null});
    }else if(e && typeof e==='object'){
      const d = e.driver || "DNS";
      out.push({ driver:d, carBrand:e.carBrand||e.brand||null, carModel:e.carModel||e.model||null });
    }else{
      out.push({driver:"DNS", carBrand:null, carModel:null});
    }
  }
  return out;
}
function el(tag, attrs={}, html=""){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=> e.setAttribute(k,v));
  if(html!==undefined) e.innerHTML = html;
  return e;
}

/* ------------------- DATALIST TRATÍ ------------------- */
async function installTrackDatalist(){
  try{
    const res = await fetch('./tracks.json');
    if(!res.ok) return;
    const list = await res.json();
    const dl = document.getElementById('trackList');
    dl.innerHTML = "";
    list.forEach(t=> dl.appendChild(el('option', {value: t})));
  }catch(e){ /* ignore */ }
}

/* ------------------- CARS.JSON NORMALIZACE ------------------- */
let CAR_LIST = [];
function normBrand(b){
  if(!b) return '';
  const t = String(b).trim().replace(/\s+/g,' ');
  const map = {
    'amg':'Mercedes-AMG','mercedes':'Mercedes-Benz','mercedes-benz':'Mercedes-Benz',
    'toyota':'Toyota','vw':'Volkswagen'
  };
  const key = t.toLowerCase();
  return map[key] || t;
}
async function installGt7CarDatalist(){
  try{
    const res = await fetch('./cars.json');
    if(!res.ok) return;
    const raw = await res.json();
    CAR_LIST = raw.map(c=>{
      let brand = normBrand(c.brand||'');
      let model = (c.model||'').trim();
      if(brand && model.toLowerCase().startsWith(brand.toLowerCase()+" ")) {
        model = model.slice(brand.length).trim();
      }
      return {brand, model, label: `${brand} — ${model}`};
    });
  }catch(e){ /* ignore */ }
}
const brandDL = el('datalist',{id:'carBrandList'});
const modelDL = el('datalist',{id:'carModelList'});
document.body.appendChild(brandDL);
document.body.appendChild(modelDL);
function refreshCarDatalists(){
  const brands = [...new Set(CAR_LIST.map(c=>c.brand).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'cs'));
  brandDL.innerHTML = brands.map(b=> `<option value="${b}">`).join('');
  const models = [...new Set(CAR_LIST.map(c=>c.model).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'cs'));
  modelDL.innerHTML = models.map(m=> `<option value="${m}">`).join('');
}

/* ------------------- SNAPSHOT ------------------- */
const unsub = db.collection('zavody').onSnapshot(snap=>{
  RACES = snap.docs.map(d=> ({id:d.id, ...d.data()}));
  renderAllPublic();
  renderAdminTable();
  fillResultRaceSelect();
});

/* ------------------- POŘADÍ + GRAF ------------------- */
function computeStandings(){
  const s = {}; DRIVERS.forEach(n=> s[n]={points:0,podium:0,dns:0});
  const completed = RACES.filter(isCompleted).sort((a,b)=> parseDate(a.datum)-parseDate(b.datum));
  completed.forEach(r=>{
    const parsed = parseResultsArray(r);
    parsed.forEach((p,idx)=>{
      if(p.driver && p.driver!=="DNS" && s[p.driver]){
        s[p.driver].points += (POINTS[idx]||0);
        if(idx<3) s[p.driver].podium++;
      }
    });
    const starters = new Set(parsed.filter(x=>x.driver && x.driver!=="DNS").map(x=>x.driver));
    DRIVERS.forEach(d=>{ if(!starters.has(d)) s[d].dns++; });
  });
  return Object.entries(s).sort((a,b)=> b[1].points - a[1].points || a[0].localeCompare(b[0]));
}

let pointsChart = null;
function renderChart(){
  const canvas = document.getElementById('pointsChart');
  const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
  if(pointsChart && typeof pointsChart.destroy==='function') pointsChart.destroy();

  if(!(window.Chart && ctx)){
    // Chart.js nedostupný – vynecháme graf, ale stránka jede dál
    return;
  }
  const completed = RACES.filter(isCompleted).sort((a,b)=> parseDate(a.datum)-parseDate(b.datum));
  const labels = completed.map(r=> r.nazev || 'Závod');

  // legenda
  const legend = document.getElementById('driver-legend');
  legend.innerHTML = '';
  DRIVERS.forEach(n=>{
    const pill = el('span', {class:'pill'}, `<span class="dot" style="background:${DRIVER_COLORS[n]||'#888'}"></span>${n}`);
    legend.appendChild(pill);
  });

  const datasets = DRIVERS.map(name=>{
    let sum = 0;
    const series = completed.map(r=>{
      const arr = parseResultsArray(r);
      const idx = arr.findIndex(e=>e.driver===name);
      if(idx>=0 && arr[idx].driver!=="DNS") sum += (POINTS[idx]||0);
      return sum;
    });
    return {
      label: name,
      data: series,
      borderColor: DRIVER_COLORS[name] || '#888',
      backgroundColor: 'transparent',
      borderWidth: 2,
      tension: 0.2,
      pointRadius: 3
    };
  });

  pointsChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive:true,
      plugins: { legend: { labels: { color: '#fff' } } },
      scales: {
        x: { ticks: { color:'#fff' }, grid:{color:'#333'} },
        y: { ticks: { color:'#fff' }, grid:{color:'#333'}, beginAtZero:true }
      }
    }
  });
}

/* ------------------- TABULKY PUBLIC ------------------- */
function renderStandings(){
  const tbody = document.querySelector('#standings tbody'); tbody.innerHTML='';
  computeStandings().forEach(([name,data])=>{
    const tr = el('tr');
    tr.innerHTML = `<td>${name}</td><td>${data.points}</td><td>${data.podium}</td><td>${data.dns}</td>`;
    tbody.appendChild(tr);
  });
}
function renderResultsTable(){
  const tbody = document.querySelector('#results tbody'); tbody.innerHTML = '';
  const done = RACES.filter(isCompleted).sort((a,b)=> parseDate(b.datum)-parseDate(a.datum));
  done.forEach(r=>{
    const parsed = parseResultsArray(r);
    const tr = el('tr');
    tr.innerHTML = `
      <td>${fmtDate(parseDate(r.datum))}</td>
      <td>${(r.nazev||'—')} / ${(r.trat||'—')}</td>
      ${parsed.map(p=>`<td>${p.driver}</td>`).join('')}
    `;
    tbody.appendChild(tr);
  });
}
function renderPlannedTable(){
  const tbody = document.querySelector('#planned tbody'); tbody.innerHTML = '';
  const planned = RACES.filter(r=> !isCompleted(r)).sort((a,b)=> (parseDate(a.datum)||Infinity)-(parseDate(b.datum)||Infinity));
  planned.forEach(r=>{
    const when = parseDate(r.datum);
    const details = [
      r.cfg_class?`Kat: ${r.cfg_class}`:null,
      r.cfg_tyres?`Pneu: ${r.cfg_tyres}`:null,
      r.cfg_compound?`Pov. směs: ${r.cfg_compound}`:null,
      r.cfg_tyreWear?`Opotř.: ${r.cfg_tyreWear}`:null,
      r.cfg_fuelUse?`Palivo: ${r.cfg_fuelUse}`:null,
      r.cfg_refuel?`Doplň.: ${r.cfg_refuel}`:null,
      r.cfg_mandPit?`Pit: ${r.cfg_mandPit}`:null
    ].filter(Boolean).join(' • ');
    const tr = el('tr');
    tr.innerHTML = `
      <td>${when?fmtDate(when):'—'}</td>
      <td>${(r.nazev||'—')} / ${(r.trat||'—')}</td>
      <td class="muted">${details||'—'}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('planned-wrapper').style.display = planned.length ? 'block' : 'none';
}

/* ------------------- NEJBLIŽŠÍ ZÁVOD ------------------- */
let countdownTimer = null;
function renderNextRace(){
  const box = document.getElementById('next-race-box');
  if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }

  const planned = RACES.filter(r=> !isCompleted(r) && parseDate(r.datum))
    .sort((a,b)=> parseDate(a.datum)-parseDate(b.datum));
  const next = planned[0];

  if(!next){
    const any = RACES.find(r=> !isCompleted(r) && !r.datum);
    if(any){
      box.innerHTML = `
        <div style="font-size:20px;margin-bottom:8px">${any.nazev||'Naplánovaný závod'}</div>
        <div class="muted">Trať: ${any.trat||'—'}</div>
        <div class="muted" style="margin-top:8px">Termín bude upřesněn.</div>
      `;
    }else{
      box.innerHTML = `<div class="muted">Zatím není naplánovaný žádný závod.</div>`;
    }
    return;
  }

  const dt = parseDate(next.datum);
  function tick(){
    const diff = dt - new Date();
    if(diff <= 0){ renderNextRace(); return; }
    const d = Math.floor(diff/(24*3600e3));
    const h = Math.floor((diff%(24*3600e3))/3600e3);
    const m = Math.floor((diff%3600e3)/60e3);
    const s = Math.floor((diff%60e3)/1e3);

    box.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-size:20px;margin-bottom:6px">${next.nazev||'Naplánovaný závod'}</div>
          <div class="muted">Trať: ${next.trat||'—'}</div>
          <div class="muted">Start: ${fmtDate(dt)}</div>
          <div class="muted">Délka: cca 2 hodiny</div>
          <div class="muted" style="margin-top:6px">
            ${[
              next.cfg_class?`Kat: ${next.cfg_class}`:null,
              next.cfg_tyres?`Pneu: ${next.cfg_tyres}`:null,
              next.cfg_compound?`Směs: ${next.cfg_compound}`:null,
              next.cfg_tyreWear?`Opotř.: ${next.cfg_tyreWear}`:null,
              next.cfg_fuelUse?`Palivo: ${next.cfg_fuelUse}`:null,
              next.cfg_refuel?`Doplň.: ${next.cfg_refuel}`:null,
              next.cfg_mandPit?`Pit: ${next.cfg_mandPit}`:null
            ].filter(Boolean).join(' • ') || ''}
          </div>
        </div>
        <div class="countdown" aria-live="polite">${d} dnů ${h} h ${m} m ${s} s</div>
      </div>
    `;
  }
  tick();
  countdownTimer = setInterval(tick, 1000);
}

/* ------------------- STATISTIKY ------------------- */
function renderBrandStats(){
  const tbody = document.querySelector('#brand-stats tbody'); tbody.innerHTML='';
  const completed = RACES.filter(isCompleted);
  const counts = new Map();
  completed.forEach(r=>{
    const winner = parseResultsArray(r)[0];
    let brand = (winner.carBrand && String(winner.carBrand).trim()) || "Neznámé";
    if(!brand) brand = "Neznámé";
    counts.set(brand, (counts.get(brand)||0)+1);
  });
  const rows = [...counts.entries()].sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="3" class="muted">Zatím nemáme data o vozech vítězů.</td></tr>`;
    return;
  }
  rows.forEach(([brand,n],i)=>{
    const tr = el('tr'); tr.innerHTML = `<td>${i+1}</td><td>${brand}</td><td>${n}</td>`;
    tbody.appendChild(tr);
  });
}
function longestStreakWins(){
  const streaks = {}; DRIVERS.forEach(d=>streaks[d]=0);
  const best = {};   DRIVERS.forEach(d=>best[d]=0);
  const byDate = RACES.filter(isCompleted).sort((a,b)=>parseDate(a.datum)-parseDate(b.datum));
  byDate.forEach(r=>{
    const winner = parseResultsArray(r)[0].driver;
    DRIVERS.forEach(d=>{
      if(d===winner){ streaks[d]++; if(streaks[d]>best[d]) best[d]=streaks[d]; }
      else streaks[d]=0;
    });
  });
  return Object.entries(best).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
}
function lastPlaceWithoutDNS(){
  const streaks = {}; DRIVERS.forEach(d=>streaks[d]=0);
  const best = {};   DRIVERS.forEach(d=>best[d]=0);
  const byDate = RACES.filter(isCompleted).sort((a,b)=>parseDate(a.datum)-parseDate(b.datum));
  byDate.forEach(r=>{
    const arr = parseResultsArray(r).filter(x=>x.driver && x.driver!=="DNS");
    const last = arr[arr.length-1]?.driver || null;
    DRIVERS.forEach(d=>{
      if(!arr.find(a=>a.driver===d)) return;
      if(d===last){ streaks[d]++; if(streaks[d]>best[d]) best[d]=streaks[d]; }
      else streaks[d]=0;
    });
  });
  return Object.entries(best).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
}
function dnsCounts(){
  const res = {}; DRIVERS.forEach(d=>res[d]=0);
  const byDate = RACES.filter(isCompleted);
  byDate.forEach(r=>{
    const started = new Set(parseResultsArray(r).filter(x=>x.driver && x.driver!=="DNS").map(x=>x.driver));
    DRIVERS.forEach(d=> { if(!started.has(d)) res[d]++; });
  });
  return Object.entries(res).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
}
function renderStreaksAndDNS(){
  const wT = document.querySelector('#streak-wins tbody'); wT.innerHTML='';
  longestStreakWins().forEach(([d, n])=>{ wT.innerHTML += `<tr><td>${d}</td><td>${n}</td></tr>`; });
  if(!wT.children.length) wT.innerHTML = `<tr><td colspan="2" class="muted">Zatím žádná data.</td></tr>`;

  const lT = document.querySelector('#streak-last tbody'); lT.innerHTML='';
  lastPlaceWithoutDNS().forEach(([d, n])=>{ lT.innerHTML += `<tr><td>${d}</td><td>${n}</td></tr>`; });
  if(!lT.children.length) lT.innerHTML = `<tr><td colspan="2" class="muted">Zatím žádná data.</td></tr>`;

  const dT = document.querySelector('#dns-max tbody'); dT.innerHTML='';
  dnsCounts().forEach(([d,n])=>{ dT.innerHTML += `<tr><td>${d}</td><td>${n}</td></tr>`; });
  if(!dT.children.length) dT.innerHTML = `<tr><td colspan="2" class="muted">Zatím žádná data.</td></tr>`;
}

/* ------------------- H2H ------------------- */
function fillH2HSelects(){
  const a = document.getElementById('h2hA');
  const b = document.getElementById('h2hB');
  a.innerHTML = ''; b.innerHTML='';
  DRIVERS.forEach(n=>{ a.appendChild(el('option',{},n)); b.appendChild(el('option',{},n)); });
  a.value = 'Viki'; b.value='Maty';
}
function renderH2H(){
  const A = document.getElementById('h2hA').value;
  const B = document.getElementById('h2hB').value;
  const tb = document.querySelector('#h2h-table tbody'); tb.innerHTML='';
  const completed = RACES.filter(isCompleted).sort((a,b)=>parseDate(a.datum)-parseDate(b.datum));
  let aWins=0, bWins=0, ties=0;
  const series = [];
  completed.forEach(r=>{
    const arr = parseResultsArray(r);
    const posA = arr.findIndex(x=>x.driver===A);
    const posB = arr.findIndex(x=>x.driver===B);
    if(posA<0 && posB<0) return;
    const resA = posA<0?'DNS':(posA+1)+'.';
    const resB = posB<0?'DNS':(posB+1)+'.';
    tb.innerHTML += `<tr><td>${fmtDate(parseDate(r.datum))}</td><td>${r.nazev||'—'}</td><td>${r.trat||'—'}</td><td>${resA}</td><td>${resB}</td></tr>`;
    if(posA>=0 && posB>=0){
      if(posA < posB) aWins++; else if(posB < posA) bWins++; else ties++;
      series.push({label:r.nazev||'Závod', diff:(posB-posA)});
    }
  });
  const ctx = document.getElementById('h2hMiniChart').getContext('2d');
  if(window.h2hChart && typeof window.h2hChart.destroy==='function') window.h2hChart.destroy();
  if(window.Chart){
    window.h2hChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: series.map(s=>s.label), datasets:[{ label:`Pozice B - A (nižší je lepší A)`, data: series.map(s=>s.diff) }]},
      options:{
        plugins:{ legend:{labels:{color:'#fff'}} },
        scales:{ x:{ticks:{color:'#fff'},grid:{color:'#333'}}, y:{ticks:{color:'#fff'},grid:{color:'#333'},beginAtZero:true} }
      }
    });
  }
  const sum = document.getElementById('h2h-summary');
  sum.innerHTML = `
    <div class="pill"><strong>${A}</strong> vítězství: ${aWins}</div>
    <div class="pill"><strong>${B}</strong> vítězství: ${bWins}</div>
    <div class="pill">Remízy: ${ties}</div>
  `;
}
document.getElementById('h2hA').addEventListener('change', renderH2H);
document.getElementById('h2hB').addEventListener('change', renderH2H);

/* ------------------- ADMIN LOGIN ------------------- */
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    const res = await auth.signInWithPopup(provider);
    document.getElementById('whoami').textContent = 'Přihlášen: ' + (res.user.displayName||res.user.email);
  }catch(e){ alert(e.message||e); }
});

/* ------------------- ADMIN: PŘIDÁNÍ / EDIT ------------------- */
async function addRace(){
  const payload = {
    datum: document.getElementById('new-date').value || null,
    nazev: document.getElementById('new-name').value || '',
    trat:  document.getElementById('new-track').value || '',
    cfg_vehicles: document.getElementById('cfg-vehicles').value || '',
    cfg_class: document.getElementById('cfg-class').value || '',
    cfg_tuning: document.getElementById('cfg-tuning').value || 'NE',
    cfg_bop: document.getElementById('cfg-bop').value || 'ANO',
    cfg_tyres: document.getElementById('cfg-tyres').value || '',
    cfg_compound: document.getElementById('cfg-compound').value || '',
    cfg_tyreWear: document.getElementById('cfg-tyreWear').value || '',
    cfg_fuelUse: document.getElementById('cfg-fuelUse').value || '',
    cfg_refuel: document.getElementById('cfg-refuel').value || '',
    cfg_mandPit: document.getElementById('cfg-mandPit').value || 'NE',
    cfg_notes: document.getElementById('cfg-notes').value || ''
  };
  await db.collection('zavody').add(payload);
  ['new-date','new-name','new-track','cfg-vehicles','cfg-tyreWear','cfg-fuelUse','cfg-refuel','cfg-notes']
    .forEach(id=> document.getElementById(id).value='');
}
document.getElementById('btn-add-race').addEventListener('click', addRace);

function renderAdminTable(){
  const tb = document.querySelector('#admin-races tbody'); tb.innerHTML='';
  const list = [...RACES].sort((a,b)=> (parseDate(a.datum)||Infinity)-(parseDate(b.datum)||Infinity));
  list.forEach(r=>{
    const tr = el('tr');
    tr.innerHTML = `
      <td>${r.datum?fmtDate(parseDate(r.datum)):'—'}</td>
      <td>${(r.nazev||'—')} / ${(r.trat||'—')}</td>
      <td>${isCompleted(r)?'dokončeno':'naplánováno'}</td>
    `;
    tr.style.cursor='pointer';
    tr.addEventListener('click', ()=> startEdit(r));
    tb.appendChild(tr);
  });
}
function startEdit(r){
  EDIT_ID = r.id;
  document.getElementById('new-date').value = r.datum ? new Date(r.datum).toISOString().slice(0,16) : '';
  document.getElementById('new-name').value = r.nazev || '';
  document.getElementById('new-track').value = r.trat || '';
  document.getElementById('cfg-vehicles').value = r.cfg_vehicles || '';
  document.getElementById('cfg-class').value = r.cfg_class || 'Open';
  document.getElementById('cfg-tuning').value = r.cfg_tuning || 'NE';
  document.getElementById('cfg-bop').value = r.cfg_bop || 'ANO';
  document.getElementById('cfg-tyres').value = r.cfg_tyres || 'Závodní';
  document.getElementById('cfg-compound').value = r.cfg_compound || 'Střední';
  document.getElementById('cfg-tyreWear').value = r.cfg_tyreWear || '';
  document.getElementById('cfg-fuelUse').value = r.cfg_fuelUse || '';
  document.getElementById('cfg-refuel').value = r.cfg_refuel || '';
  document.getElementById('cfg-mandPit').value = r.cfg_mandPit || 'NE';
  document.getElementById('cfg-notes').value = r.cfg_notes || '';

  fillResultRaceSelect(r.id);
  buildResultForm(r);
  document.getElementById('btn-save-edit').disabled = false;
  document.getElementById('btn-cancel-edit').disabled = false;
  document.getElementById('btn-save-results').disabled = false;
  document.getElementById('yt-url').value = r.youtube || '';
}
document.getElementById('btn-cancel-edit').addEventListener('click', ()=>{
  EDIT_ID = null;
  document.getElementById('btn-save-edit').disabled = true;
  document.getElementById('btn-cancel-edit').disabled = true;
});
document.getElementById('btn-save-edit').addEventListener('click', async ()=>{
  if(!EDIT_ID) return;
  const payload = {
    datum: document.getElementById('new-date').value || null,
    nazev: document.getElementById('new-name').value || '',
    trat:  document.getElementById('new-track').value || '',
    cfg_vehicles: document.getElementById('cfg-vehicles').value || '',
    cfg_class: document.getElementById('cfg-class').value || '',
    cfg_tuning: document.getElementById('cfg-tuning').value || 'NE',
    cfg_bop: document.getElementById('cfg-bop').value || 'ANO',
    cfg_tyres: document.getElementById('cfg-tyres').value || '',
    cfg_compound: document.getElementById('cfg-compound').value || '',
    cfg_tyreWear: document.getElementById('cfg-tyreWear').value || '',
    cfg_fuelUse: document.getElementById('cfg-fuelUse').value || '',
    cfg_refuel: document.getElementById('cfg-refuel').value || '',
    cfg_mandPit: document.getElementById('cfg-mandPit').value || 'NE',
    cfg_notes: document.getElementById('cfg-notes').value || ''
  };
  await db.collection('zavody').doc(EDIT_ID).update(payload);
});

/* ------------------- VÝSLEDKY EDITOR ------------------- */
function fillResultRaceSelect(preselectId=null){
  const sel = document.getElementById('result-race'); sel.innerHTML='';
  const list = [...RACES].sort((a,b)=> (parseDate(a.datum)||Infinity)-(parseDate(b.datum)||Infinity));
  list.forEach(r=>{
    const o = el('option',{value:r.id}, `${(r.nazev||'—')} / ${(r.trat||'—')}`);
    sel.appendChild(o);
  });
  if(preselectId) sel.value = preselectId;
  sel.dispatchEvent(new Event('change'));
}
document.getElementById('result-race').addEventListener('change', ()=>{
  const id = document.getElementById('result-race').value;
  const r = RACES.find(x=>x.id===id);
  buildResultForm(r);
  document.getElementById('btn-save-results').disabled = !r;
  document.getElementById('yt-url').value = (r && r.youtube) || '';
});
function buildResultForm(race){
  const host = document.getElementById('result-form');
  host.innerHTML = '';
  for(let i=0;i<5;i++){
    const row = el('div',{class:'col'});
    const current = (race && Array.isArray(race.vysledky) && race.vysledky[i]) || "DNS";
    const driverVal = (typeof current==='string') ? current : (current && current.driver) || "DNS";
    const brandVal  = (typeof current==='object' && current && current.carBrand) ? current.carBrand : '';
    const modelVal  = (typeof current==='object' && current && current.carModel) ? current.carModel : '';
    row.innerHTML = `
      <div class="card" style="padding:12px">
        <div class="muted" style="text-align:right">Pozice ${i+1}.</div>
        <label>Jezdec<br/>
          <select class="res-driver">
            ${['DNS',...DRIVERS].map(n=> `<option ${n===driverVal?'selected':''}>${n}</option>`).join('')}
          </select>
        </label>
        <div class="row" style="margin-top:6px">
          <div class="col">
            <label>Značka<br/>
              <input class="res-brand" list="carBrandList" value="${brandVal||''}" placeholder="volitelné" autocomplete="off"/>
            </label>
          </div>
          <div class="col">
            <label>Model<br/>
              <input class="res-model" list="carModelList" value="${modelVal||''}" placeholder="volitelné" autocomplete="off"/>
            </label>
          </div>
        </div>
      </div>
    `;
    host.appendChild(row);
  }
}
document.getElementById('btn-save-results').addEventListener('click', async ()=>{
  const id = document.getElementById('result-race').value;
  if(!id) return;
  const yt = document.getElementById('yt-url').value.trim();
  const cards = [...document.querySelectorAll('#result-form .card')];
  const out = cards.map(card=>{
    const driver = card.querySelector('.res-driver').value;
    const brand = card.querySelector('.res-brand').value.trim();
    const model = card.querySelector('.res-model').value.trim();
    if(driver==='DNS') return 'DNS';
    const obj = { driver };
    if(brand) obj.carBrand = brand;
    if(model) obj.carModel = model;
    return obj;
  });
  const payload = { vysledky: out };
  if(yt) payload.youtube = yt; else payload.youtube = firebase.firestore.FieldValue.delete();
  await db.collection('zavody').doc(id).update(payload);
});

/* ------------------- FULL PUBLIC RENDER ------------------- */
function renderAllPublic(){
  renderChart();
  renderStandings();
  renderResultsTable();
  renderPlannedTable();
  renderNextRace();
  fillH2HSelects();
  renderH2H();
  renderBrandStats();
  renderStreaksAndDNS();
}

/* ------------------- INIT ------------------- */
(async function init(){
  await installTrackDatalist();
  await installGt7CarDatalist();
  refreshCarDatalists();
})();
</script>
</body>
</html>
