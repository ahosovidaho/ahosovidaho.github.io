<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hric-Pic-Ma-Ma-Tama Championship 2025</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: #fff; margin:0; padding:0;}
  header { padding:20px; text-align:center; background: linear-gradient(90deg, #0d1b36, #610000); }
  nav { display:flex; justify-content:center; background:#1e1e1e; flex-wrap:wrap; }
  nav button { background:none; border:none; color:#fff; padding:15px 20px; cursor:pointer; font-size:16px; }
  nav button.active { border-bottom: 3px solid #ff0000; }
  section { padding:20px; display:none; }
  section.active { display:block; }
  table { width:100%; border-collapse: collapse; margin-top:20px;}
  th, td { border:1px solid #444; padding:8px; text-align:center; }
  th { background:#222; }
  canvas { max-width:100%; height:auto; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h1>Hric-Pic-Ma-Ma-Tama Championship 2025</h1>
</header>

<nav>
  <button class="tablink active" data-tab="aktualni">Aktuální sezóna</button>
  <button class="tablink" data-tab="statistiky">Statistiky</button>
  <button class="tablink" data-tab="archiv">Archiv sezón</button>
  <button class="tablink" data-tab="profil">Profil závodníka</button>
  <button class="tablink" data-tab="admin">Admin</button>
</nav>

<section id="aktualni" class="active">
  <h2>Nejbližší závod</h2>
  <div id="nextRaceBanner">Zatím žádný naplánovaný závod</div>

  <h2>Vývoj bodů</h2>
  <canvas id="pointsChart"></canvas>

  <h2>Pořadí závodníků</h2>
  <table id="standings">
    <thead>
      <tr><th>Závodník</th><th>Body</th><th>Pódiová umístění</th><th>DNS</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Výsledky závodů</h2>
  <table id="results">
    <thead>
      <tr>
        <th>Datum</th><th>Závod a trať</th><th>1. místo</th><th>2. místo</th><th>3. místo</th><th>4. místo</th><th>5. místo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Naplánované závody</h2>
  <table id="planned">
    <thead>
      <tr><th>Datum</th><th>Závod a trať</th><th>Povolená vozidla</th><th>Kategorie</th><th>Tuning</th><th>Rovnováha výkonu</th><th>Pneumatiky</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="statistiky"><h2>Statistiky</h2></section>
<section id="archiv"><h2>Archiv sezón</h2></section>
<section id="profil"><h2>Profil závodníka</h2></section>

<section id="admin">
  <h2>Admin – Přidat / Upravit závod</h2>
  <button id="loginBtn">Přihlásit se přes Google</button>
</section>

<script>
const tabs = document.querySelectorAll('.tablink');
tabs.forEach(btn=>{
  btn.addEventListener('click',()=> {
    document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
    document.querySelector('#'+btn.dataset.tab).classList.add('active');
    tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

const firebaseConfig = {
  apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
  authDomain: "test-gt7.firebaseapp.com",
  projectId: "test-gt7",
  storageBucket: "test-gt7.firebasestorage.app",
  messagingSenderId: "928154989107",
  appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
  measurementId: "G-1SG8DW1KQ9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

document.getElementById('loginBtn').addEventListener('click', ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result=>{
    alert('Přihlášeno: '+result.user.displayName);
  }).catch(console.error);
});

// --- Načtení dokončených závodů ---
const drivers = ["Viki","Mára","Maty","Hardy","Ondra"];
const pointsMap = [10,8,6,4,2];

async function loadRaces() {
  const completedSnapshot = await db.collection('completedRaces').orderBy('date','asc').get();
  const completedRaces = completedSnapshot.docs.map(d=>d.data());
  renderResults(completedRaces);
  renderStandings(completedRaces);
  renderPointsChart(completedRaces);
  loadPlannedRaces();
}

function renderResults(races){
  const tbody = document.querySelector('#results tbody');
  tbody.innerHTML='';
  races.slice().reverse().forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.name} / ${r.track}</td>` +
      drivers.map(d=>{
        const idx = r.order.indexOf(d);
        return `<td>${idx>=0?r.order[idx]:"DNS"}</td>`;
      }).join('');
    tbody.appendChild(tr);
  });
}

function calculateStandings(races){
  const standings = {};
  drivers.forEach(d=>standings[d]={points:0,podium:0,dns:0});
  races.forEach(r=>{
    r.order.forEach((d,i)=>{
      if(d==="DNS"){ standings[drivers[i]].dns++; return; }
      standings[d].points += pointsMap[i]||0;
      if(i<3) standings[d].podium++;
    });
  });
  return Object.entries(standings).sort((a,b)=>b[1].points - a[1].points);
}

function renderStandings(races){
  const tbody = document.querySelector('#standings tbody');
  tbody.innerHTML='';
  calculateStandings(races).forEach(([name,data])=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${name}</td><td>${data.points}</td><td>${data.podium}</td><td>${data.dns}</td>`;
    tbody.appendChild(tr);
  });
}

function renderPointsChart(races){
  const ctx = document.getElementById('pointsChart').getContext('2d');
  const datasets = drivers.map(d=>{
    let sum=0;
    const data = races.map(r=>{
      const idx = r.order.indexOf(d);
      if(idx==-1 || r.order[idx]==="DNS") return sum;
      sum += pointsMap[idx]||0;
      return sum;
    });
    return {label:d,data,borderColor:getRandomColor(),fill:false,tension:0.1};
  });
  new Chart(ctx,{type:'line',data:{labels:races.map(r=>r.name),datasets},options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}});
}

function getRandomColor(){ const letters="0123456789ABCDEF"; return "#"+Array.from({length:6}).map(()=>letters[Math.floor(Math.random()*16)]).join(''); }

// --- Naplánované závody ---
async function loadPlannedRaces(){
  const tbody = document.querySelector('#planned tbody');
  tbody.innerHTML='';
  const snapshot = await db.collection('plannedRaces').orderBy('date','asc').get();
  let nextRace=null;
  snapshot.forEach(doc=>{
    const r = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date||''}</td><td>${r.name} / ${r.track}</td><td>${r.allowedVehicles||''}</td><td>${r.allowedCategory||''}</td><td>${r.tuning||''}</td><td>${r.bo||''}</td><td>${r.allowedTyres||''}</td>`;
    tbody.appendChild(tr);
    if(!nextRace && r.date && new Date(r.date) > new Date()) nextRace=r;
  });
  const banner = document.getElementById('nextRaceBanner');
  if(nextRace){
    banner.innerHTML = `<strong>${nextRace.name}</strong> na trati ${nextRace.track} – ${nextRace.date}`;
  }
}

loadRaces();
</script>

</body>
</html>
