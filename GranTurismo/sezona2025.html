<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Sezona 2025 GT7</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        canvas { max-width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Výsledky závodů GT7 – sezona 2025</h1>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>Datum</th>
                <th>Název závodu</th>
                <th>Trať</th>
                <th>Výsledky</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <canvas id="pointsChart"></canvas>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
            authDomain: "test-gt7.firebaseapp.com",
            projectId: "test-gt7",
            storageBucket: "test-gt7.firebasestorage.app",
            messagingSenderId: "928154989107",
            appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
            measurementId: "G-1SG8DW1KQ9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let windowPointsChart = null;

        const initialRaces = [
            {datum: "2025-03-01T15:00", vysledky: ["Viki", "DNS", "Maty", "Hardy", "DNS"], trat: "Daytona road circuit", nazev: "American Muscle"},
            {datum: "2025-03-15T15:00", nazev: "Limonádový Joe", trat: "Red Bull Ring", vysledky: ["Viki", "Hardy", "Maty", "DNS", "DNS"]},
            {vysledky: ["Hardy", "Viki", "Maty", "DNS", "DNS"], trat: "Monza", nazev: "Forza Italia", datum: "2025-04-01T15:00"},
            {datum: "2025-04-15T15:00", vysledky: ["Viki", "DNS", "Maty", "Hardy", "DNS"], nazev: "Dovolená v Chorvatsku", trat: "Dragon Trail - přímořská trať"},
            {vysledky: ["Viki", "DNS", "Maty", "Hardy", "DNS"], datum: "2025-05-01T15:00", nazev: "Tokyo Drift", trat: "Suzuka"},
            {nazev: "Po stopách Jamese Bonda", vysledky: ["Maty", "Viki", "Hardy", "DNS", "DNS"], datum: "2025-05-15T15:00", trat: "Brands Hatch"},
            {nazev: "24h Le Mans", vysledky: ["Viki", "Hardy", "Maty (PEN)", "DNS", "DNS"], trat: "Le Mans", datum: "2025-06-01T15:00"}
        ];

        function renderAll(races) {
            console.log("=== RenderAll start ===");
            console.log("Results data:", races);

            // Render table
            const tbody = document.querySelector("#resultsTable tbody");
            tbody.innerHTML = "";
            races.forEach(race => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${new Date(race.datum).toLocaleDateString()}</td>
                    <td>${race.nazev}</td>
                    <td>${race.trat}</td>
                    <td>${race.vysledky.join(", ")}</td>
                `;
                tbody.appendChild(tr);
            });

            // Render chart
            if (windowPointsChart) {
                windowPointsChart.destroy();
            }

            const labels = races.map(r => new Date(r.datum).toLocaleDateString());
            const participants = races[0]?.vysledky.map((_, i) => races.map(r => r.vysledky[i] === "DNS" ? 0 : 1)); // jednoduchý bodový příklad

            const datasets = races[0]?.vysledky.map((_, i) => ({
                label: races[0].vysledky[i],
                data: participants[i].map((v, idx) => participants[i].slice(0, idx + 1).reduce((a,b)=>a+b,0)),
                borderColor: `hsl(${i*60},70%,50%)`,
                fill: false
            }));

            const ctx = document.getElementById("pointsChart").getContext("2d");
            windowPointsChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function loadRaces() {
            console.log("Loading races from Firestore...");
            db.collection("zavody").orderBy("datum").onSnapshot(snapshot => {
                const races = snapshot.docs.map(doc => doc.data());
                console.log("Snapshot received, total documents:", races.length);
                if (races.length > 0) {
                    renderAll(races);
                } else {
                    // fallback na initialRaces
                    renderAll(initialRaces.sort((a,b)=>new Date(a.datum)-new Date(b.datum)));
                }
            }, err => {
                console.error("Firestore snapshot error:", err);
                renderAll(initialRaces.sort((a,b)=>new Date(a.datum)-new Date(b.datum)));
            });
        }

        loadRaces();
    </script>
</body>
</html>
