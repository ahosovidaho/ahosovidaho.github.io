<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hric-Pic-Ma-Ma-Tama Championship 2025</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<style>
body { background-color: #0d0d0d; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
.nav-tabs .nav-link { color: #fff; }
.nav-tabs .nav-link.active { color: #0d6efd; background-color: #1a1a1a; }
table { color: #fff; }
table thead { background-color: #1a1a1a; }
table tbody tr:nth-child(even) { background-color: #222; }
.btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
</style>
</head>
<body>
<div class="container my-3">
  <h1 class="text-center">Hric-Pic-Ma-Ma-Tama Championship 2025</h1>
  <ul class="nav nav-tabs mt-3" id="tabs">
    <li class="nav-item"><a class="nav-link active" data-tab="aktualni" href="#">Aktuální sezóna</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="statistiky" href="#">Statistiky</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="archiv" href="#">Archiv sezón</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="profil" href="#">Profil závodníka</a></li>
    <li class="nav-item"><a class="nav-link" data-tab="admin" href="#">Admin</a></li>
  </ul>

  <div id="tab-content" class="mt-3">
    <div id="aktualni" class="tab-pane active">
      <h3>Nejbližší závod:</h3>
      <div id="nextRace"></div>

      <h3 class="mt-4">Graf vývoje bodů:</h3>
      <canvas id="pointsChart" height="150"></canvas>

      <h3 class="mt-4">Pořadí závodníků:</h3>
      <table class="table table-striped" id="standingsTable">
        <thead><tr><th>Závodník</th><th>Body</th><th>Pódia</th><th>DNS</th></tr></thead>
        <tbody></tbody>
      </table>

      <h3 class="mt-4">Výsledky závodů:</h3>
      <table class="table table-striped" id="racesTable">
        <thead><tr><th>Datum</th><th>Závod a trať</th><th>1.místo</th><th>2.místo</th><th>3.místo</th><th>4.místo</th><th>5.místo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="statistiky" class="tab-pane">
      <h3>Statistiky</h3>
      <div id="statsContent">Seznam statistik, H2H porovnání bude doplněn.</div>
    </div>

    <div id="archiv" class="tab-pane">
      <h3>Archiv sezón</h3>
      <div id="archiveContent">Archiv všech sezón bude zde.</div>
    </div>

    <div id="profil" class="tab-pane">
      <h3>Profil závodníka</h3>
      <div id="profileContent">Profilové údaje a foto závodníka.</div>
    </div>

    <div id="admin" class="tab-pane">
      <h3>Admin</h3>
      <form id="raceForm">
        <div class="mb-2">
          <label>Datum a čas:</label>
          <input type="datetime-local" id="raceDate" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Název závodu:</label>
          <input type="text" id="raceName" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Trať:</label>
          <input type="text" id="raceTrack" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Kategorie:</label>
          <select id="raceCategory" class="form-control">
            <option>Gr.1</option><option>Gr.2</option><option>Gr.3</option><option>Gr.4</option>
            <option>Gr.B</option><option>VGT</option><option>open</option>
          </select>
        </div>
        <div class="mb-2">
          <label>Povolená vozidla:</label>
          <input type="text" id="raceVehicles" class="form-control">
        </div>
        <div class="mb-2">
          <label>Tuning:</label>
          <select id="raceTuning" class="form-control"><option>ANO</option><option>NE</option></select>
        </div>
        <div class="mb-2">
          <label>Povinný pitstop:</label>
          <select id="racePitstop" class="form-control"><option>ANO</option><option>NE</option></select>
        </div>
        <div class="mb-2">
          <label>Pneumatiky:</label>
          <select id="raceTyres" class="form-control">
            <option>Komfortní</option><option>Sportovní</option><option>Závodní</option><option>Na sníh</option><option>Na šotolinu</option>
          </select>
        </div>
        <div class="mb-2">
          <label>Doplňující info:</label>
          <textarea id="raceInfo" class="form-control"></textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-2">Uložit nový závod</button>
      </form>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
  authDomain: "test-gt7.firebaseapp.com",
  projectId: "test-gt7",
  storageBucket: "test-gt7.app",
  messagingSenderId: "928154989107",
  appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
  measurementId: "G-1SG8DW1KQ9"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const racers = ["Viki","Mára","Maty","Hárdy","Ondra"];
let racesData = [];
let standingsData = {};

const racesCollection = collection(db, "races");

async function loadRaces() {
  racesData = [];
  standingsData = {};
  const querySnapshot = await getDocs(racesCollection);
  querySnapshot.forEach(doc => {
    racesData.push({id: doc.id, ...doc.data()});
  });
  racesData.sort((a,b)=> new Date(a.date) - new Date(b.date));

  // Pořadí
  racers.forEach(r=>standingsData[r]={points:0, podium:0, dns:0});
  racesData.forEach(race=>{
    racers.forEach((r,i)=>{
      const place = race["position"+(i+1)];
      if(!place || place==="DNS") { standingsData[r].dns++; return; }
      if(place==="1") { standingsData[r].points+=10; standingsData[r].podium++; }
      else if(place==="2") { standingsData[r].points+=8; standingsData[r].podium++; }
      else if(place==="3") { standingsData[r].points+=6; standingsData[r].podium++; }
      else if(place==="4") standingsData[r].points+=4;
      else if(place==="5") standingsData[r].points+=2;
    });
  });

  displayNextRace();
  displayStandings();
  displayRacesTable();
  displayChart();
}

function displayNextRace() {
  const next = racesData.find(r=> new Date(r.date)>new Date());
  document.getElementById("nextRace").textContent = next ? `${next.name} – ${next.track} (${new Date(next.date).toLocaleString()})` : "Žádný nadcházející závod";
}

function displayStandings() {
  const tbody = document.querySelector("#standingsTable tbody");
  tbody.innerHTML = "";
  const sorted = Object.entries(standingsData).sort((a,b)=>b[1].points - a[1].points);
  sorted.forEach(([r, stats])=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r}</td><td>${stats.points}</td><td>${stats.podium}</td><td>${stats.dns}</td>`;
    tbody.appendChild(tr);
  });
}

function displayRacesTable() {
  const tbody = document.querySelector("#racesTable tbody");
  tbody.innerHTML = "";
  racesData.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${new Date(r.date).toLocaleDateString()}</td>
                    <td>${r.name} – ${r.track}</td>
                    <td>${r.position1||"DNS"}</td>
                    <td>${r.position2||"DNS"}</td>
                    <td>${r.position3||"DNS"}</td>
                    <td>${r.position4||"DNS"}</td>
                    <td>${r.position5||"DNS"}</td>`;
    tbody.appendChild(tr);
  });
}

import Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.esm.js";
let chart;
function displayChart() {
  const ctx = document.getElementById('pointsChart').getContext('2d');
  const labels = Object.keys(standingsData);
  const dataSets = labels.map(label=>{
    let data = [];
    let total = 0;
    racesData.forEach(r=>{
      let placeIndex = racers.indexOf(label);
      const place = r["position"+(placeIndex+1)];
      if(!place || place==="DNS") total+=0;
      else if(place==="1") total+=10;
      else if(place==="2") total+=8;
      else if(place==="3") total+=6;
      else if(place==="4") total+=4;
      else if(place==="5") total+=2;
      data.push(total);
    });
    return {label, data, borderColor:'#0d6efd', fill:false};
  });
  if(chart) chart.destroy();
  chart = new Chart(ctx,{type:'line', data:{labels:racesData.map(r=>r.name), datasets:dataSets}, options:{responsive:true, plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}}}});
}

// Nav Tabs
document.querySelectorAll('#tabs .nav-link').forEach(link=>{
  link.addEventListener('click',e=>{
    e.preventDefault();
    document.querySelectorAll('.tab-pane').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('#tabs .nav-link').forEach(l=>l.classList.remove('active'));
    const tab = link.getAttribute('data-tab');
    document.getElementById(tab).classList.add('active');
    link.classList.add('active');
  });
});

// Admin - přidání závodu
document.getElementById("raceForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const race = {
    date: document.getElementById("raceDate").value,
    name: document.getElementById("raceName").value,
    track: document.getElementById("raceTrack").value,
    category: document.getElementById("raceCategory").value,
    vehicles: document.getElementById("raceVehicles").value,
    tuning: document.getElementById("raceTuning").value,
    pitstop: document.getElementById("racePitstop").value,
    tyres: document.getElementById("raceTyres").value,
    info: document.getElementById("raceInfo").value
  };
  await addDoc(racesCollection, race);
  loadRaces();
  e.target.reset();
});

// Inicializace
loadRaces();
</script>
</body>
</html>
