<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hric-Pic-Ma-Ma-Tama Championship 2025</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #121212; color: #fff; margin:0; padding:0;}
  header { padding:20px; text-align:center; background: linear-gradient(90deg, #0d1b36, #610000); }
  nav { display:flex; justify-content:center; background:#1e1e1e; }
  nav button { background:none; border:none; color:#fff; padding:15px 20px; cursor:pointer; font-size:16px; }
  nav button.active { border-bottom: 3px solid #ff0000; }
  section { padding:20px; display:none; }
  section.active { display:block; }
  table { width:100%; border-collapse: collapse; margin-top:20px;}
  th, td { border:1px solid #444; padding:8px; text-align:center; }
  th { background:#222; }
  canvas { max-width:100%; height:auto; }
  input { margin:5px; padding:5px; }
  button { margin:5px; padding:5px 10px; cursor:pointer; }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h1>Hric-Pic-Ma-Ma-Tama Championship 2025</h1>
</header>

<nav>
  <button class="tablink active" data-tab="aktualni">Aktuální sezóna</button>
  <button class="tablink" data-tab="statistiky">Statistiky</button>
  <button class="tablink" data-tab="archiv">Archiv sezón</button>
  <button class="tablink" data-tab="profil">Profil závodníka</button>
  <button class="tablink" data-tab="admin">Admin</button>
</nav>

<section id="aktualni" class="active">
  <h2>Nejbližší závod</h2>
  <div id="banner">Zde bude upoutávka na nadcházející závod</div>

  <h2>Vývoj bodů</h2>
  <canvas id="pointsChart"></canvas>

  <h2>Pořadí závodníků</h2>
  <table id="standings">
    <thead>
      <tr><th>Závodník</th><th>Body</th><th>Pódiová umístění</th><th>DNS</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Výsledky závodů</h2>
  <table id="results">
    <thead>
      <tr>
        <th>Datum</th><th>Závod a trať</th><th>1. místo</th><th>2. místo</th><th>3. místo</th><th>4. místo</th><th>5. místo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="statistiky">
  <h2>Statistiky</h2>
  <div id="statsBanner">Statistiky a H2H porovnání</div>
</section>

<section id="archiv">
  <h2>Archiv sezón</h2>
  <div id="archiveBanner">Sezónní výsledky</div>
</section>

<section id="profil">
  <h2>Profil závodníka</h2>
  <div id="profileBanner">Informace a oblíbené auta závodníků</div>
</section>

<section id="admin">
  <h2>Admin</h2>
  <button id="loginBtn">Přihlásit se přes Google</button>
  <div id="adminBanner">
    <label>Datum: <input type="datetime-local" id="raceDate"></label>
    <label>Název: <input type="text" id="raceName"></label>
    <label>Trať: <input type="text" id="raceTrack"></label>
    <button id="addRaceBtn">Přidat závod</button>
  </div>
</section>

<script>
  // --- TAB SWITCH ---
  const tabs = document.querySelectorAll('.tablink');
  tabs.forEach(btn=>{
    btn.addEventListener('click',()=> {
      document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
      document.querySelector('#'+btn.dataset.tab).classList.add('active');
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // --- FIREBASE INIT ---
  const firebaseConfig = {
    apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
    authDomain: "test-gt7.firebaseapp.com",
    projectId: "test-gt7",
    storageBucket: "test-gt7.app",
    messagingSenderId: "928154989107",
    appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
    measurementId: "G-1SG8DW1KQ9"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  document.getElementById('loginBtn').addEventListener('click', ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(result=>{
      alert('Přihlášeno: '+result.user.displayName);
    }).catch(console.error);
  });

  // --- DRIVERS ---
  const drivers = ["Viki","Mára","Maty","Hardy","Ondra"];
  const driverColors = {
    "Viki":"#FF0000","Mára":"#00FF00","Maty":"#0000FF","Hardy":"#FFAA00","Ondra":"#AA00FF"
  };
  let resultsData = [];

  // --- LOAD RACES FROM FIRESTORE ---
  function loadRaces(){
    db.collection("zavody").orderBy("datum","asc").onSnapshot(snapshot=>{
      resultsData = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      refreshAll();
    });
  }

  // --- STANDINGS ---
  const pointsMap = [10,8,6,4,2];
  const tbodyResults = document.querySelector('#results tbody');
  const tbodyStandings = document.querySelector('#standings tbody');

  function calculateStandings(){
    const standings = {};
    drivers.forEach(d=>standings[d]={points:0,podium:0,dns:0});
    resultsData.forEach(r=>{
      if(!r.vysledky) return; // závod ještě neproběhl
      r.vysledky.forEach((d,i)=>{
        if(d==="DNS"){ standings[drivers[i]].dns++; return;}
        if(!standings[d]) standings[d]={points:0,podium:0,dns:0};
        standings[d].points += pointsMap[i] || 0;
        if(i<3) standings[d].podium++;
      });
    });
    return Object.entries(standings).sort((a,b)=>b[1].points - a[1].points);
  }

  function renderResults(){
    tbodyResults.innerHTML="";
    resultsData.slice().reverse().forEach(r=>{
      const tr = document.createElement('tr');
      const dateStr = new Date(r.datum).toLocaleDateString('cs-CZ',{day:'2-digit',month:'2-digit',year:'numeric'});
      const orderCells = r.vysledky ? r.vysledky.map(d=>`<td>${d}</td>`).join('') : "<td colspan='5'>Závod neproběhl</td>";
      tr.innerHTML = `<td>${dateStr}</td><td>${r.nazev} / ${r.trat}</td>${orderCells}`;
      tbodyResults.appendChild(tr);
    });
  }

  function renderStandings(){
    tbodyStandings.innerHTML="";
    calculateStandings().forEach(([name,data])=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${data.points}</td><td>${data.podium}</td><td>${data.dns}</td>`;
      tbodyStandings.appendChild(tr);
    });
  }

  // --- CHART ---
  const ctx = document.getElementById('pointsChart').getContext('2d');
  let pointsChart;
  function renderChart(){
    const datasets = drivers.map(d=>{
      let sum=0;
      const data = resultsData.map(r=>{
        if(!r.vysledky) return sum;
        const idx = r.vysledky.indexOf(d);
        if(idx==-1 || r.vysledky[idx]==="DNS") return sum;
        sum += pointsMap[idx]||0;
        return sum;
      });
      return {label:d,data, borderColor:driverColors[d], fill:false, tension:0.1};
    });
    const labels = resultsData.map(r=>r.nazev);
    if(pointsChart) pointsChart.destroy();
    pointsChart = new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,plugins:{legend:{labels:{color:'#fff'}}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}});
  }

  function refreshAll(){ renderResults(); renderStandings(); renderChart(); }

  // --- ADD RACE ---
  document.getElementById('addRaceBtn').addEventListener('click',()=>{
    const datum = document.getElementById('raceDate').value;
    const nazev = document.getElementById('raceName').value.trim();
    const trat = document.getElementById('raceTrack').value.trim();
    if(!datum||!nazev||!trat){ alert("Vyplň všechny údaje!"); return; }
    db.collection("zavody").add({datum,nazev,trat}).then(()=>alert("Závod přidán!")).catch(console.error);
  });

  loadRaces();
</script>

</body>
</html>
