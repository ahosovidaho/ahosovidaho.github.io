<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hric-Pic-Ma-Ma-Tama Championship 2025</title>
<style>
  :root{--bg:#121212;--card:#171717;--muted:#9aa0a6;--accent:#0d6efd;--accent2:#c62828}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  header{padding:18px;text-align:center;background:linear-gradient(90deg,#0d1b36,#610000)}
  header h1{margin:0;font-size:20px}
  .container{max-width:1100px;margin:16px auto;padding:0 12px}
  nav{display:flex;gap:8px;justify-content:center;background:#141414;padding:8px;border-radius:6px;flex-wrap:wrap}
  nav button{background:none;border:none;color:#fff;padding:8px 12px;cursor:pointer;font-size:15px}
  nav button.active{border-bottom:3px solid var(--accent2)}
  section{display:none;padding:12px 0}
  section.active{display:block}
  .card{background:var(--card);border:1px solid #2a2a2a;padding:12px;border-radius:8px;margin-top:12px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #2a2a2a;padding:8px;text-align:center;vertical-align:middle}
  th{background:#131313}
  label{display:block;font-size:13px;margin-top:8px}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff;box-sizing:border-box}
  textarea{min-height:80px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .formBtn{background:var(--accent2);border:none;color:#fff;padding:10px 14px;border-radius:6px;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid #444;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .youtube-thumb{width:120px;height:auto;border-radius:6px}
  .admin-only{display:none}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .legend-chip{display:inline-flex;align-items:center;gap:6px;margin-right:10px}
  .chip{display:inline-block;width:10px;height:10px;border-radius:2px}
  .name-chip{display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #2a2a2a;margin-right:6px;line-height:1}
  .pill{display:inline-block;border:1px solid #2a2a2a;border-radius:999px;padding:2px 8px}
  .muted{color:#9aa0a6}
  @media(max-width:800px){ .row{flex-direction:column} .youtube-thumb{width:80px} th,td{font-size:13px} header h1{font-size:18px} }
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js UMD -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header><h1>Hric-Pic-Ma-Ma-Tama Championship 2025</h1></header>

<div class="container">
  <nav>
    <button class="tablink active" data-tab="home">Aktuální sezóna</button>
    <button class="tablink" data-tab="stats">Statistiky</button>
    <button class="tablink" data-tab="archive">Archiv sezón</button>
    <button class="tablink" data-tab="profile">Profil závodníka</button>
    <button class="tablink" data-tab="admin">Admin</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">
      <div class="toolbar" style="gap:12px">
        <strong style="margin-right:auto">Nejbližší závod</strong>
        <button id="btnRemind30" class="btn-ghost" title="Připomenout 30 minut před startem">Připomenout 30 min</button>
        <button id="btnDownloadICS" class="btn-ghost" title="Stáhnout .ics naplánovaných závodů">Stáhnout .ics</button>
        <a id="btnSubscribeCal" class="btn-ghost" href="webcal://p27-caldav.icloud.com/published/2/Mjk3NDA5Mjc3Mjk3NDA5MoioTkM23k1g9OTDkRvzh7hOWTwuJvgcjEeUEW-ECWs0eY6KpVzuGD8CJ8TM2nNF25TfpJPE-klPwkvar4ShrTQ" title="Odebírat sdílený kalendář">Odebírat sdílený kalendář</a>
      </div>
      <div id="nextRaceInfo" class="small" style="margin-top:8px">Načítám...</div>
    </div>

    <div class="card">
      <strong>Vývoj bodů</strong>
      <div id="driverLegend" class="small" style="margin-top:6px"></div>
      <canvas id="pointsChart" style="max-height:360px"></canvas>
    </div>

    <div class="card">
      <strong>Pořadí závodníků</strong>
      <table id="standings"><thead><tr><th>Závodník</th><th>Body</th><th>Pódiová umístění</th><th>DNS</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card">
      <strong>Výsledky závodů</strong>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Datum</th><th>Závod / Trať</th>
            <th>Q první řada</th>
            <th>1.</th><th>2.</th><th>3.</th><th>4.</th><th>5.</th>
            <th>Video</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Naplánované závody</strong>
      <table id="plannedTable">
        <thead><tr><th>Datum</th><th>Závod / Trať</th><th>Kategorie</th><th>Vozidla</th><th>Info</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- STATS -->
  <section id="stats">
    <div class="card">
      <strong>H2H porovnání</strong>
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label for="h2hA">Jezdec A</label>
          <select id="h2hA"></select>
        </div>
        <div class="col">
          <label for="h2hB">Jezdec B</label>
          <select id="h2hB"></select>
        </div>
      </div>
      <div style="margin-top:10px">
        <button id="btnH2H" class="formBtn">Vyhodnotit H2H</button>
      </div>
      <div id="h2hSummary" class="small" style="margin-top:12px"></div>
      <canvas id="h2hChart" style="max-height:300px;margin-top:10px"></canvas>

      <div class="card" style="margin-top:12px">
        <strong>Společné závody (H2H)</strong>
        <table id="h2hTable">
          <thead>
            <tr>
              <th>Datum</th><th>Závod / Trať</th>
              <th id="h2hColA">A</th><th id="h2hColB">B</th>
              <th>Body A</th><th>Body B</th>
              <th>Rozdíl (A–B)</th>
              <th>Výsledek</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="small" id="h2hNote" style="margin-top:8px;color:#9aa0a6"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Minigraf: body v čase (H2H)</strong>
        <canvas id="h2hMiniChart" style="max-height:220px;margin-top:10px"></canvas>
      </div>
    </div>

    <div class="card">
      <strong>Rekordy & série</strong>
      <table id="streaksTable">
        <thead><tr><th>Kategorie</th><th>Jezdec</th><th>Hodnota</th><th>Poznámka</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Průměry a konzistence</strong>
      <table id="consistencyTable">
        <thead><tr><th>Jezdec</th><th>Průměrné umístění</th><th>Směrodatná odchylka</th><th>Body / závod</th><th>Účast</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Kvalifikace vs. závod</strong>
      <table id="qualiRaceTable">
        <thead><tr><th>Jezdec</th><th>Pole</th><th>Front row</th><th>Pole→výhra</th><th>Ø získané pozice</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Forma (poslední 3 / 5 závodů)</strong>
      <table id="formTable">
        <thead><tr><th>Jezdec</th><th>Posl. 3 (Ø bodů)</th><th>Posl. 5 (Ø bodů)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Penalizace – dopad (body)</strong>
      <table id="penaltyImpactTable">
        <thead><tr><th>Jezdec</th><th>Skutečně</th><th>Bez penalizací</th><th>Rozdíl</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ARCHIVE -->
  <section id="archive">
    <div class="card"><strong>Archiv sezón</strong><div class="small" id="archiveArea" style="margin-top:8px">Zatím prázdné.</div></div>
  </section>

  <!-- PROFILE -->
  <section id="profile">
    <div class="card"><strong>Profil závodníka</strong><div class="small" style="margin-top:8px">Funkce profilu (fotka, oblíbené auto, trať...) doplníme později.</div></div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <div class="row">
        <div class="col">
          <strong>Admin</strong>
          <div style="margin-top:8px">
            <button id="loginBtn" class="formBtn">Přihlásit se přes Google</button>
            <button id="logoutBtn" class="btn-ghost" style="display:none;margin-left:8px">Odhlásit</button>
            <div id="adminUser" class="small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Přidat nový závod -->
    <div class="card admin-only" id="adminAddCard">
      <strong>Přidat nový závod</strong>
      <form id="addRaceForm" autocomplete="off">
        <div class="row">
          <div class="col">
            <label for="add_name">Název</label>
            <input id="add_name" required autocomplete="off"/>
          </div>
          <div class="col">
            <label for="add_date">Datum a čas</label>
            <input id="add_date" type="datetime-local" />
          </div>
        </div>

        <label for="add_track">Trať</label>
        <input id="add_track" autocomplete="off" data-track-input/>

        <div class="row">
          <div class="col">
            <label for="add_vehicles">Povolená vozidla</label>
            <input id="add_vehicles" autocomplete="off"/>
          </div>
          <div class="col">
            <label for="add_category">Kategorie</label>
            <select id="add_category">
              <option>Gr.1</option><option>Gr.2</option><option>Gr.3</option><option>Gr.4</option>
              <option>Gr.B</option><option>VGT</option><option>Open</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="add_tuning">Tuning</label>
            <select id="add_tuning"><option>ANO</option><option>NE</option></select>
          </div>
          <div class="col">
            <label for="add_bop">Rovnováha výkonu (BoP)</label>
            <select id="add_bop"><option>ANO</option><option>NE</option></select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="add_tyres">Povolené pneumatiky</label>
            <select id="add_tyres"><option>Komfortní</option><option>Sportovní</option><option>Závodní</option><option>Na sníh</option><option>Na šotolinu</option></select>
          </div>
          <div class="col">
            <label for="add_compound">Povinná směs</label>
            <select id="add_compound"><option>Tvrdá</option><option>Střední</option><option>Měkká</option></select>
          </div>
        </div>

        <div class="row">
          <div class="col"><label for="add_tyreWear">Opotřebení pneumatik</label><input id="add_tyreWear" autocomplete="off"/></div>
          <div class="col"><label for="add_fuel">Spotřeba paliva</label><input id="add_fuel" autocomplete="off"/></div>
          <div class="col"><label for="add_refuel">Rychlost doplňování paliva</label><input id="add_refuel" autocomplete="off"/></div>
        </div>

        <label for="add_pitstop">Povinný pit-stop</label>
        <select id="add_pitstop"><option>ANO</option><option>NE</option></select>

        <label for="add_info">Doplňující info</label><textarea id="add_info" autocomplete="off"></textarea>

        <label for="add_youtube">Odkaz na YouTube</label><input id="add_youtube" type="url" placeholder="https://www.youtube.com/watch?v=..." autocomplete="off"/>

        <div style="margin-top:10px">
          <button class="formBtn" type="submit">Uložit nový závod</button>
          <button id="add_clear" type="button" class="btn-ghost" style="margin-left:8px">Vyčistit</button>
        </div>
      </form>
    </div>

    <!-- Upravit existující závod -->
    <div class="card admin-only" id="adminEditCard">
      <strong>Upravit existující závod</strong>
      <div class="small" style="margin-top:8px">Vyber závod, uprav parametry / kvalifikaci / výsledky, přidej penalizace, ulož. Změny se logují.</div>
      <div style="margin-top:10px">
        <select id="edit_select" style="width:100%;padding:8px;margin-bottom:8px"></select>

        <form id="editRaceForm" autocomplete="off" style="display:none">
          <input id="edit_id" type="hidden"/>

          <div class="row">
            <div class="col">
              <label for="edit_name">Název</label>
              <input id="edit_name"/>
            </div>
            <div class="col">
              <label for="edit_date">Datum a čas</label>
              <input id="edit_date" type="datetime-local"/>
            </div>
          </div>

          <label for="edit_track">Trať</label>
          <input id="edit_track" data-track-input/>

          <div class="row">
            <div class="col"><label for="edit_vehicles">Povolená vozidla</label><input id="edit_vehicles"/></div>
            <div class="col">
              <label for="edit_category">Kategorie</label>
              <select id="edit_category">
                <option>Gr.1</option><option>Gr.2</option><option>Gr.3</option><option>Gr.4</option>
                <option>Gr.B</option><option>VGT</option><option>Open</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col"><label for="edit_tuning">Tuning</label><select id="edit_tuning"><option>ANO</option><option>NE</option></select></div>
            <div class="col"><label for="edit_bop">Rovnováha výkonu (BoP)</label><select id="edit_bop"><option>ANO</option><option>NE</option></select></div>
          </div>

          <div class="row">
            <div class="col"><label for="edit_tyres">Povolené pneumatiky</label><select id="edit_tyres"><option>Komfortní</option><option>Sportovní</option><option>Závodní</option><option>Na sníh</option><option>Na šotolinu</option></select></div>
            <div class="col"><label for="edit_compound">Povinná směs</label><select id="edit_compound"><option>Tvrdá</option><option>Střední</option><option>Měkká</option></select></div>
          </div>

          <div class="row">
            <div class="col"><label for="edit_tyreWear">Opotřebení pneumatik</label><input id="edit_tyreWear"/></div>
            <div class="col"><label for="edit_fuel">Spotřeba paliva</label><input id="edit_fuel"/></div>
            <div class="col"><label for="edit_refuel">Rychlost doplňování paliva</label><input id="edit_refuel"/></div>
          </div>

          <label for="edit_pitstop">Povinný pit-stop</label>
          <select id="edit_pitstop"><option>ANO</option><option>NE</option></select>

          <label for="edit_info">Doplňující info</label><textarea id="edit_info"></textarea>

          <label for="edit_youtube">Odkaz na YouTube</label><input id="edit_youtube" type="url" placeholder="https://www.youtube.com/watch?v=..." />

          <hr style="border-color:#333;margin:12px 0">

          <strong>Kvalifikace</strong>
          <div id="edit_quali" style="margin-top:8px"></div>

          <strong style="margin-top:10px;display:block">Výsledky závodu</strong>
          <div id="edit_positions" style="margin-top:8px"></div>

          <hr style="border-color:#333;margin:12px 0">
          <strong>Penalizace</strong>
          <div id="penaltiesWrap" style="margin-top:8px"></div>
          <button type="button" id="addPenaltyBtn" class="btn-ghost" style="margin-top:8px">+ Přidat penalizaci</button>

          <div style="margin-top:10px">
            <button class="formBtn" type="submit">Uložit změny</button>
            <button id="edit_clear" type="button" class="btn-ghost" style="margin-left:8px">Zrušit výběr</button>
            <button id="edit_delete" type="button" class="btn-ghost" style="margin-left:8px">Smazat závod</button>
          </div>

          <div class="card" style="margin-top:12px">
            <strong>Audit log</strong>
            <div id="auditList" class="small" style="margin-top:6px">Načítám…</div>
          </div>
        </form>
      </div>
    </div>

    <!-- Export / Import -->
    <div class="card admin-only">
      <strong>Export / Import</strong>
      <div class="row" style="margin-top:8px">
        <div class="col">
          <button id="btnExportJSON" class="btn-ghost">Export JSON</button>
          <button id="btnExportCSV" class="btn-ghost" style="margin-left:8px">Export CSV</button>
        </div>
        <div class="col" style="text-align:right">
          <label for="importFile">Import JSON (pole závodů)</label>
          <input id="importFile" type="file" accept="application/json"/>
          <button id="btnImport" class="formBtn" style="margin-top:8px">Importovat</button>
        </div>
      </div>
      <div class="small" style="margin-top:6px">Pozn.: Import zapíše/merge podle `id` (pokud je), jinak vytvoří nové dokumenty.</div>
    </div>
  </section>
</div>

<!-- ===== GT7 TRACKS DATALIST (UI) ===== -->
<datalist id="gt7Tracks"></datalist>

<script>
/* === Firebase === */
const firebaseConfig = {
  apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
  authDomain: "test-gt7.firebaseapp.com",
  projectId: "test-gt7",
  storageBucket: "test-gt7.firebasestorage.app",
  messagingSenderId: "928154989107",
  appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
  measurementId: "G-1SG8DW1KQ9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* === State / Constants === */
const drivers = ["Viki","Mára","Maty","Hardy","Ondra"];
const driverColors = { "Viki":"#ff058a","Maty":"#d0e0e3","Hardy":"#00ffea","Mára":"#ffff66","Ondra":"#7d85c0" };
const pointsMap = [10,8,6,4,2]; // 1..5
let racesCache = [];
let pointsChart = null;
let h2hChart = null;
let h2hMiniChart = null;

/* === Helpers === */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[ch])); }
function normName(raw){ return (!raw)?raw:String(raw).replace(/\s*\(.*\)\s*$/,'').trim(); }
function ytId(url){ if(!url) return null; try{const u=new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.searchParams.get('v')) return u.searchParams.get('v'); const seg=u.pathname.split('/').filter(Boolean).pop(); return seg&&seg.length>=10?seg:null;}catch(e){ return url.length===11?url:null; }}
function getResultsArray(r){ if(Array.isArray(r.vysledky)) return r.vysledky; if(Array.isArray(r.results)) return r.results; return []; }
function getQualiArray(r){ if(Array.isArray(r.kvalifikace)) return r.kvalifikace; if(Array.isArray(r.qualifying)) return r.qualifying; return []; }
function hasResults(r){ return getResultsArray(r).length>0; }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

/* === Tabs === */
$$('.tablink').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('section').forEach(s=>s.classList.remove('active'));
    $('#'+btn.dataset.tab).classList.add('active');
    $$('.tablink').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* === Auth UI === */
const loginBtn=$('#loginBtn'), logoutBtn=$('#logoutBtn'), adminUser=$('#adminUser');
function showAdminParts(visible){ $$('.admin-only').forEach(el=>{ el.style.display = visible ? 'block' : 'none'; }); }
loginBtn.addEventListener('click', async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try{ const res = await auth.signInWithPopup(provider); adminUser.textContent=`Přihlášen: ${res.user.displayName}`; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; showAdminParts(true); }
  catch(e){ console.error(e); alert('Chyba přihlášení: '+e.message); }
});
logoutBtn.addEventListener('click', ()=>auth.signOut());
auth.onAuthStateChanged(u=>{
  if(u){ adminUser.textContent=`Přihlášen: ${u.displayName}`; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; showAdminParts(true); }
  else{ adminUser.textContent=''; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; showAdminParts(false); $('#edit_select').value=''; $('#editRaceForm').style.display='none'; }
});

/* === Realtime Firestore === */
function startRealtime(){
  db.collection('zavody').onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    arr.sort((a,b)=>{
      const ad=a.datum||a.date||null, bd=b.datum||b.date||null;
      if(!ad && !bd) return 0; if(!ad) return 1; if(!bd) return -1;
      return new Date(ad)-new Date(bd);
    });
    racesCache=arr;
    renderAll();
  }, err=>{
    console.error('Snapshot error',err);
    db.collection('zavody').get().then(sn=>{ const arr=[]; sn.forEach(d=>arr.push({id:d.id,...d.data()})); racesCache=arr; renderAll(); });
  });
}

/* === Render orchestration === */
function renderAll(){
  renderNextRace();
  renderResultsTable();
  renderPlannedTable();
  renderStandingsAndChart();
  populateEditSelect();
  populateH2HDropdowns();
  renderDriverLegend();
  renderDerivedStats();
  renderAdvancedStats();
}

/* === Nejbližší závod + připomínka === */
function getNextScheduledRace(){
  const now = new Date();
  const fut = racesCache.filter(r=>{
    const d=r.datum||r.date||null; return d && new Date(d)>now && !hasResults(r);
  }).sort((a,b)=> new Date(a.datum||a.date)-new Date(b.datum||b.date));
  return fut[0]||null;
}
function renderNextRace(){
  const el=$('#nextRaceInfo');
  const next = getNextScheduledRace();
  if(!next){
    const plannedNoDate = racesCache.find(r=>!hasResults(r) && !(r.datum||r.date));
    if(plannedNoDate){
      el.innerHTML = `<strong>${escapeHtml(plannedNoDate.nazev||plannedNoDate.name||'')}</strong> / ${escapeHtml(plannedNoDate.trat||plannedNoDate.track||'')}`;
    }else{
      el.textContent='Žádný nadcházející závod.';
    }
    $('#btnRemind30').disabled = true;
    return;
  }
  $('#btnRemind30').disabled = false;
  const dt = new Date(next.datum||next.date);
  const diff = dt - new Date();
  const d = Math.floor(diff/1000/60/60/24);
  const h = Math.floor(diff/1000/60/60)%24;
  const m = Math.floor(diff/1000/60)%60;
  el.innerHTML = `<strong>${escapeHtml(next.nazev||next.name)}</strong> / ${escapeHtml(next.trat||next.track||'')} <div class="small">Do startu: ${d}d ${h}h ${m}m</div>`;
}

const REM_KEY='gt7_reminders';
function loadReminders(){ try{ return JSON.parse(localStorage.getItem(REM_KEY)||'[]'); }catch(e){ return []; } }
function saveReminders(arr){ localStorage.setItem(REM_KEY, JSON.stringify(arr)); }
function scheduleReminderIfDue(){
  const now = Date.now();
  const arr = loadReminders();
  let changed=false;
  arr.forEach(r=>{
    if(!r.triggered && now>=r.when){
      r.triggered = true; changed=true;
      notify(`GT7: ${r.name} za 30 minut`, `${r.track? r.track+' • ' : ''}${new Date(r.start).toLocaleString()}`);
    }
  });
  if(changed) saveReminders(arr);
}
function notify(title, body){
  if('Notification' in window){
    if(Notification.permission==='granted'){
      new Notification(title,{body});
    }else if(Notification.permission!=='denied'){
      Notification.requestPermission().then(p=>{
        if(p==='granted') new Notification(title,{body});
        else alert(`${title}\n${body}`);
      });
    }else{
      alert(`${title}\n${body}`);
    }
  }else{
    alert(`${title}\n${body}`);
  }
}
$('#btnRemind30').addEventListener('click', ()=>{
  const next = getNextScheduledRace(); if(!next || !(next.datum||next.date)) return;
  const start = new Date(next.datum||next.date).getTime();
  const when = start - 30*60*1000;
  const arr = loadReminders();
  arr.push({id: next.id||null, name: next.nazev||next.name||'Závod', track: next.trat||next.track||'', start, when, triggered:false});
  saveReminders(arr);
  scheduleReminderIfDue();
  alert('Připomenutí nastaveno.');
});
setInterval(scheduleReminderIfDue, 60*1000);

/* === Penalizace aplikace === */
function applyPenalties(baseResults, penalties){
  if(!Array.isArray(baseResults) || !baseResults.length) return baseResults||[];
  const arr = baseResults.slice(0,5).map(v=>v||'DNS');
  if(!Array.isArray(penalties) || !penalties.length) return arr;

  const drops = {};
  penalties.forEach(p=>{
    const drv = normName((p.driver||p.jezdec||'')+'');
    if(!drv) return;
    const kind = (p.kind||p.typ||'').toLowerCase();
    let drop = 0;
    if(kind==='pozice') drop = Math.max(0, Number(p.value)||0);
    else if(kind==='cas') drop = 1;
    if(drop>0){ drops[drv]=(drops[drv]||0)+drop; }
  });

  const meta = arr.map((name,idx)=>({
    name, idx, clean: normName(name),
    isDNS: (name==='DNS')
  }));

  meta.forEach(m=>{
    if(m.isDNS) { m.rankKey = 999 + m.idx; }
    else {
      const drop = drops[m.clean]||0;
      m.rankKey = m.idx + drop;
    }
  });

  meta.sort((a,b)=> a.rankKey - b.rankKey || a.idx - b.idx);
  return meta.map(m=>m.name).slice(0,5);
}

/* === Results (completed) === */
function renderResultsTable(){
  const tbody = $('#resultsTable tbody'); tbody.innerHTML='';
  const completed = racesCache.filter(hasResults)
    .sort((a,b)=> new Date(b.datum||b.date||0) - new Date(a.datum||a.date||0));
  completed.forEach(r=>{
    const dateStr = r.datum||r.date ? new Date(r.datum||r.date).toLocaleString() : '';
    const nameTrack = `${escapeHtml(r.nazev||r.name||'')} / ${escapeHtml(r.trat||r.track||'')}`;
    const qualiFrontRowHTML = (getQualiArray(r).length? getQualiArray(r) : []).slice(0,2).map(n=>{
      const clean = normName(n); const col = driverColors[clean]|| (n==='DNS' ? '#aaa' : '#ccc');
      return `<span class="name-chip" style="border-color:${col};color:${col}">${escapeHtml(n)}</span>`;
    }).join('');
    const penal = Array.isArray(r.penalties)? r.penalties : [];
    const applied = applyPenalties(getResultsArray(r), penal);
    const cells = Array.from({length:5},(_,i)=>applied[i]||'DNS').map((c,i)=>{
      const clean = normName(c); const col=driverColors[clean]||(c==='DNS'?'#aaa':'#ccc');
      return `<td style="color:${col}">${escapeHtml(c)}</td>`;
    }).join('');
    const yt = r.youtube || r.video || r.youtubeUrl || r.youtube_link || r.link || r.odkaz;
    const id = ytId(yt);
    const video = id ? `<a href="${escapeHtml(yt)}" target="_blank"><img class="youtube-thumb" src="https://img.youtube.com/vi/${id}/hqdefault.jpg" alt="video"></a>` :
                 (yt ? `<a href="${escapeHtml(yt)}" target="_blank">Video</a>` : '');
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${dateStr}</td><td>${nameTrack}</td><td>${qualiFrontRowHTML||''}</td>${cells}<td>${video}</td>`;
    tbody.appendChild(tr);
  });
}

/* === Planned (no results) === */
function renderPlannedTable(){
  const tbody=$('#plannedTable tbody'); tbody.innerHTML='';
  const planned = racesCache.filter(r=>!hasResults(r))
    .sort((a,b)=> new Date(a.datum||a.date||0) - new Date(b.datum||b.date||0));
  planned.forEach(r=>{
    const dateStr = r.datum||r.date ? new Date(r.datum||r.date).toLocaleString() : '';
    const nameTrack = `${escapeHtml(r.nazev||r.name||'')} / ${escapeHtml(r.trat||r.track||'')}`;
    const cat = escapeHtml(r.kategorie||r.category||'');
    const veh = escapeHtml(r.vozidla||r.vehicles||'');
    const info = escapeHtml(r.info||'');
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${dateStr}</td><td>${nameTrack}</td><td>${cat}</td><td>${veh}</td><td>${info}</td>`;
    tbody.appendChild(tr);
  });
}

/* === Standings + Chart (only completed) === */
function renderDriverLegend(){
  const el = $('#driverLegend'); el.innerHTML='';
  drivers.forEach(d=>{
    const span=document.createElement('span');
    span.className='legend-chip';
    span.innerHTML=`<span class="chip" style="background:${driverColors[d]||'#ccc'}"></span>${escapeHtml(d)}`;
    el.appendChild(span);
  });
}
function renderStandingsAndChart(){
  const completed = racesCache.filter(hasResults)
    .sort((a,b)=> new Date(a.datum||a.date||0) - new Date(b.datum||b.date||0));
  const stats={}; drivers.forEach(d=>stats[d]={points:0,podiums:0,dns:0});
  completed.forEach(r=>{
    const penal = Array.isArray(r.penalties)? r.penalties : [];
    const arr = applyPenalties(getResultsArray(r), penal);
    for(let i=0;i<5;i++){
      const raw=arr[i]; if(!raw || raw==='DNS') continue;
      const d=normName(raw);
      if(!stats[d]) stats[d]={points:0,podiums:0,dns:0};
      stats[d].points += (pointsMap[i]||0);
      if(i<3) stats[d].podiums++;
    }
    drivers.forEach(d=>{
      const present = arr.some(x=>normName(x)===d);
      if(!present) stats[d].dns++;
    });
  });

  const tbody=$('#standings tbody'); tbody.innerHTML='';
  Object.keys(stats).sort((a,b)=>stats[b].points - stats[a].points)
    .forEach(name=>{
      const s=stats[name];
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(name)}</td><td>${s.points}</td><td>${s.podiums}</td><td>${s.dns}</td>`;
      tbody.appendChild(tr);
    });

  const labels = completed.map(r=> r.nazev||r.name|| (r.trat||r.track||'Závod'));
  const datasets = drivers.map(d=>{
    let cum=0;
    const data = completed.map(r=>{
      const arr = applyPenalties(getResultsArray(r), Array.isArray(r.penalties)?r.penalties:[]);
      const idx = arr.findIndex(x=>normName(x)===d);
      if(idx===-1 || arr[idx]==='DNS') return cum;
      cum += (pointsMap[idx]||0);
      return cum;
    });
    return {label:d,data, borderColor:driverColors[d]||'#ccc', backgroundColor:driverColors[d]||'#ccc', fill:false, tension:0.2};
  });
  const ctx=$('#pointsChart').getContext('2d');
  if(pointsChart && typeof pointsChart.destroy==='function') pointsChart.destroy();
  pointsChart = new Chart(ctx,{ type:'line', data:{labels,datasets}, options:{ responsive:true, plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}, beginAtZero:true}} }});
}

/* === Odvozené statistiky: trať / kategorie / vozidla === */
function renderDerivedStats(){ /* …(ponecháno, neukazujeme tabulky, jsou interní výpočty pro advanced stats)… */ }

/* === Pokročilé statistiky (nové boxy) === */
function getCompletedSorted(){
  return racesCache.filter(hasResults).sort((a,b)=> new Date(a.datum||a.date||0) - new Date(b.datum||b.date||0));
}
function posForDriver(r, driver, withPenalties=true){
  const base = getResultsArray(r);
  const arr = withPenalties ? applyPenalties(base, r.penalties||[]) : base.slice(0,5);
  const idx = arr.findIndex(x=>normName(x)===driver);
  if(idx===-1) return 'DNS';
  if(arr[idx]==='DNS') return 'DNS';
  return idx+1;
}
function pointsForDriver(r, driver, withPenalties=true){
  const pos = posForDriver(r, driver, withPenalties);
  if(pos==='DNS') return 0;
  return pointsMap[pos-1]||0;
}
function longestStreak(values, predicate){
  let best=0, cur=0;
  values.forEach(v=>{ if(predicate(v)){ cur++; best=Math.max(best,cur);} else {cur=0;} });
  return best;
}
function renderAdvancedStats(){
  const completed = getCompletedSorted();

  // ---- Streaks
  const streaksBody = $('#streaksTable tbody'); if(streaksBody){ streaksBody.innerHTML='';
    function bestBy(fn){
      let bestVal=-Infinity, bestDriver='—', note='';
      drivers.forEach(d=>{
        const seq = completed.map(r=>posForDriver(r,d,true));
        const valNote = fn(seq);
        if(valNote.value>bestVal){ bestVal=valNote.value; bestDriver=d; note=valNote.note||''; }
      });
      return {driver:bestDriver, value:bestVal, note};
    }
    const rowHtml = (label, res)=>{
      const col = driverColors[res.driver]||'#ccc';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(label)}</td><td><span class="name-chip" style="border-color:${col};color:${col}">${escapeHtml(res.driver)}</span></td><td>${res.value}</td><td>${escapeHtml(res.note||'')}</td>`;
      streaksBody.appendChild(tr);
    };
    const sWins = bestBy(seq=>({ value: longestStreak(seq, x=>x===1), note:'nejdelší série P1' }));
    const sPodiums = bestBy(seq=>({ value: longestStreak(seq, x=>x!=='DNS' && x<=3), note:'umístění v top3 v řadě' }));
    const sLast = bestBy(seq=>{
      const values = seq.map((pos,i)=>{
        if(pos==='DNS') return false;
        const r = completed[i];
        const arr = applyPenalties(getResultsArray(r), r.penalties||[]);
        const participants = arr.filter(x=>x!=='DNS').length;
        return pos===participants && participants>0;
      });
      return { value: longestStreak(values, v=>v===true), note:'poslední místo v řadě (bez DNS)' };
    });
    const sNoPodium = bestBy(seq=>({ value: longestStreak(seq, x=>x!=='DNS' && x>3), note:'závody bez pódia v řadě (bez DNS)' }));
    rowHtml('Nejdelší série výher', sWins);
    rowHtml('Nejdelší série pódií', sPodiums);
    rowHtml('Nejdelší série posledních míst', sLast);
    rowHtml('Nejdelší série bez pódia', sNoPodium);
  }

  // ---- Consistency
  const consBody = $('#consistencyTable tbody'); if(consBody){ consBody.innerHTML='';
    function mean(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
    function stdev(arr){ if(arr.length<2) return 0; const m=mean(arr); const v=arr.reduce((a,b)=>a+(b-m)*(b-m),0)/(arr.length-1); return Math.sqrt(v); }
    drivers.forEach(d=>{
      const posArr = completed.map(r=>posForDriver(r,d,true)).filter(x=>x!=='DNS');
      const avgPos = posArr.length? mean(posArr) : 0;
      const sdPos = posArr.length? stdev(posArr) : 0;
      const ptsArr = completed.map(r=>pointsForDriver(r,d,true));
      const raced = posArr.length;
      const participation = completed.length? Math.round((raced/completed.length)*100) : 0;
      const avgPts = completed.length? mean(ptsArr) : 0;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${d}</td><td>${avgPos?avgPos.toFixed(2):'—'}</td><td>${sdPos?sdPos.toFixed(2):'—'}</td><td>${avgPts?avgPts.toFixed(2):'0.00'}</td><td>${participation}%</td>`;
      consBody.appendChild(tr);
    });
  }

  // ---- Quali vs Race
  const qrBody = $('#qualiRaceTable tbody'); if(qrBody){ qrBody.innerHTML='';
    drivers.forEach(d=>{
      let poles=0, front=0, poleWins=0, deltas=[];
      completed.forEach(r=>{
        const q = getQualiArray(r);
        const res = applyPenalties(getResultsArray(r), r.penalties||[]);
        const qi = q.findIndex(x=>normName(x)===d);
        const ri = res.findIndex(x=>normName(x)===d);
        if(qi===0) poles++;
        if(qi===0 || qi===1) front++;
        if(qi===0 && ri===0) poleWins++;
        if(qi>=0 && ri>=0) deltas.push((qi+1) - (ri+1));
      });
      const avgGain = deltas.length? (deltas.reduce((a,b)=>a+b,0)/deltas.length).toFixed(2) : '—';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${d}</td><td>${poles}</td><td>${front}</td><td>${poleWins}/${poles}</td><td>${avgGain}</td>`;
      qrBody.appendChild(tr);
    });
  }

  // ---- Form last 3 / 5
  const formBody = $('#formTable tbody'); if(formBody){ formBody.innerHTML='';
    drivers.forEach(d=>{
      const pts = completed.map(r=>pointsForDriver(r,d,true));
      const last3 = pts.slice(-3);
      const last5 = pts.slice(-5);
      const m3 = last3.length? (last3.reduce((a,b)=>a+b,0)/last3.length).toFixed(2) : '—';
      const m5 = last5.length? (last5.reduce((a,b)=>a+b,0)/last5.length).toFixed(2) : '—';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d}</td><td>${m3}</td><td>${m5}</td>`;
      formBody.appendChild(tr);
    });
  }

  // ---- Penalty impact
  const penBody = $('#penaltyImpactTable tbody'); if(penBody){ penBody.innerHTML='';
    const totalsActual={}, totalsHypo={}; drivers.forEach(d=>{ totalsActual[d]=0; totalsHypo[d]=0; });
    completed.forEach(r=>{
      drivers.forEach(d=>{
        totalsActual[d]+= pointsForDriver(r,d,true);
        totalsHypo[d]+= pointsForDriver(r,d,false);
      });
    });
    drivers.forEach(d=>{
      const diff = (totalsActual[d]-totalsHypo[d]);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d}</td><td>${totalsActual[d]}</td><td>${totalsHypo[d]}</td><td>${diff>0?'+':''}${diff}</td>`;
      penBody.appendChild(tr);
    });
  }
}

/* === H2H === */
function populateH2HDropdowns(){
  const a=$('#h2hA'), b=$('#h2hB'); if(!a||!b) return;
  const set=(sel)=>{ sel.innerHTML=''; drivers.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o); }); };
  set(a); set(b); if(drivers.length>1){ b.value=drivers[1]; }
}
function h2hCompute(A,B){
  const completed = getCompletedSorted();
  const rows=[];
  let races=0, winsA=0, winsB=0, draws=0, dnsA=0, dnsB=0;
  let ptsA=0, ptsB=0;
  let avgPosA=0, avgPosB=0, posCount=0;

  completed.forEach(r=>{
    const arr = applyPenalties(getResultsArray(r), Array.isArray(r.penalties)?r.penalties:[]);
    const idxA = arr.findIndex(x=>normName(x)===A || x===A);
    const idxB = arr.findIndex(x=>normName(x)===B || x===B);
    const aIsDNS = (idxA===-1) || arr[idxA]==='DNS';
    const bIsDNS = (idxB===-1) || arr[idxB]==='DNS';

    if(aIsDNS) dnsA++;
    if(bIsDNS) dnsB++;
    if(aIsDNS && bIsDNS) return;

    races++;

    const pA = aIsDNS ? 'DNS' : (idxA+1);
    const pB = bIsDNS ? 'DNS' : (idxB+1);
    const ptsRa = aIsDNS?0:(pointsMap[idxA]||0);
    const ptsRb = bIsDNS?0:(pointsMap[idxB]||0);

    ptsA += ptsRa; ptsB += ptsRb;

    let resultTxt='';
    if(!aIsDNS && !bIsDNS){
      avgPosA += (idxA+1);
      avgPosB += (idxB+1);
      posCount++;
      if(idxA < idxB){ winsA++; resultTxt = `${A} porazil ${B}`; }
      else if(idxB < idxA){ winsB++; resultTxt = `${B} porazil ${A}`; }
      else { draws++; resultTxt = 'Remíza'; }
    }else if(!aIsDNS && bIsDNS){ winsA++; resultTxt = `${A} vyhrál (B DNS)`; }
    else if(aIsDNS && !bIsDNS){ winsB++; resultTxt = `${B} vyhrál (A DNS)`; }

    let diff = '—';
    if(!aIsDNS && !bIsDNS){ diff = ( (idxA+1) - (idxB+1) ); }

    rows.push({
      date: r.datum||r.date ? new Date(r.datum||r.date).toLocaleString() : '',
      label: `${r.nazev||r.name||''} / ${r.trat||r.track||''}`,
      posA: pA, posB: pB, ptsA: ptsRa, ptsB: ptsRb, diff, result: resultTxt
    });
  });

  const avgA = posCount? (avgPosA/posCount).toFixed(2) : '—';
  const avgB = posCount? (avgPosB/posCount).toFixed(2) : '—';

  return {races, winsA, winsB, draws, dnsA, dnsB, ptsA, ptsB, avgA, avgB, rows};
}
function renderH2H(){
  const A=$('#h2hA').value, B=$('#h2hB').value;
  const colA=$('#h2hColA'), colB=$('#h2hColB');
  if(colA) colA.textContent = A || 'A';
  if(colB) colB.textContent = B || 'B';

  if(!A||!B||A===B){
    $('#h2hSummary').innerHTML='Vyber dva různé jezdce.';
    if(h2hChart){h2hChart.destroy();}
    if(h2hMiniChart){h2hMiniChart.destroy();}
    $('#h2hTable tbody').innerHTML='';
    return;
  }
  const r = h2hCompute(A,B);
  $('#h2hSummary').innerHTML = `
    <div><strong>${A} vs ${B}</strong></div>
    <div>Závodů (počítaných do H2H): ${r.races}</div>
    <div>Skóre: ${A} ${r.winsA} – ${r.winsB} ${B} ${r.draws?`(remíz: ${r.draws})`:''}</div>
    <div>Průměrné umístění: ${A}: ${r.avgA} &nbsp;|&nbsp; ${B}: ${r.avgB}</div>
    <div>Body celkem: ${A}: ${r.ptsA} &nbsp;|&nbsp; ${B}: ${r.ptsB}</div>
    <div>DNS: ${A}: ${r.dnsA} &nbsp;|&nbsp; ${B}: ${r.dnsB}</div>
  `;

  const avgPtsA = r.races? r.ptsA/r.races : 0;
  const avgPtsB = r.races? r.ptsB/r.races : 0;
  const ctx=$('#h2hChart').getContext('2d');
  if(h2hChart && typeof h2hChart.destroy==='function') h2hChart.destroy();
  h2hChart = new Chart(ctx,{
    type:'bar',
    data:{ labels:[A,B], datasets:[{label:'Body / závod', data:[avgPtsA,avgPtsB], backgroundColor:[driverColors[A]||'#ccc', driverColors[B]||'#ccc']}] },
    options:{ responsive:true, plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}, beginAtZero:true}} }
  });

  const tbody=$('#h2hTable tbody'); tbody.innerHTML='';
  r.rows.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${row.date}</td>
      <td>${escapeHtml(row.label)}</td>
      <td>${row.posA}</td>
      <td>${row.posB}</td>
      <td>${row.ptsA}</td>
      <td>${row.ptsB}</td>
      <td>${row.diff}</td>
      <td>${escapeHtml(row.result)}</td>`;
    tbody.appendChild(tr);
  });
  $('#h2hNote').textContent = 'Pozn.: H2H ignoruje závody, kde oba jezdci mají DNS. Pokud jeden DNS a druhý dojede, bere se to jako výhra finišujícího jezdce. „Rozdíl (A–B)“ je definován jen, když oba dojeli.';

  const miniCtx=$('#h2hMiniChart').getContext('2d');
  const labels = r.rows.map((row,i)=>`${i+1}.`);
  const dataA = r.rows.map(row=>row.ptsA);
  const dataB = r.rows.map(row=>row.ptsB);
  if(h2hMiniChart && typeof h2hMiniChart.destroy==='function') h2hMiniChart.destroy();
  h2hMiniChart = new Chart(miniCtx,{
    type:'line',
    data:{ labels, datasets:[
      {label:A, data:dataA, borderColor:driverColors[A]||'#ccc', backgroundColor:driverColors[A]||'#ccc', fill:false, tension:0.2},
      {label:B, data:dataB, borderColor:driverColors[B]||'#888', backgroundColor:driverColors[B]||'#888', fill:false, tension:0.2}
    ]},
    options:{ responsive:true, plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}, beginAtZero:true}} }
  });
}
$('#btnH2H').addEventListener('click', renderH2H);

/* === .ICS generování (naplánované závody) === */
function pad2(n){ return String(n).padStart(2,'0'); }
function toICSDate(dt){
  const d = new Date(dt);
  return d.getUTCFullYear()+pad2(d.getUTCMonth()+1)+pad2(d.getUTCDate())+'T'+pad2(d.getUTCHours())+pad2(d.getUTCMinutes())+'00Z';
}
function plusMinutes(dt, mins){ const d = new Date(dt); return new Date(d.getTime() + mins*60000); }
function buildICS(){
  const planned = racesCache.filter(r=>!hasResults(r) && r.datum).sort((a,b)=>new Date(a.datum)-new Date(b.datum));
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Tamayo.cz//GT7 Championship//CZ','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
  planned.forEach(r=>{
    const startDate = new Date(r.datum||r.date);
    const endDate = plusMinutes(startDate, 120);
    const start = toICSDate(startDate);
    const end = toICSDate(endDate);
    const uid = (r.id||Math.random().toString(36).slice(2))+'@tamayo.cz';
    const title = (r.nazev||r.name||'Závod').replace(/[\r\n]/g,' ');
    const location = (r.trat||r.track||'').replace(/[\r\n]/g,' ').replace(/,/g,'\\,');
    const descParts = [];
    if(r.kategorie) descParts.push('Kategorie: '+r.kategorie);
    if(r.vozidla) descParts.push('Vozidla: '+r.vozidla);
    if(r.pitstop) descParts.push('Povinný pitstop: '+r.pitstop);
    if(r.info) descParts.push(r.info);
    const desc = descParts.join('\\n');
    lines.push('BEGIN:VEVENT');
    lines.push('UID:'+uid);
    lines.push('DTSTAMP:'+toICSDate(new Date().toISOString()));
    lines.push('DTSTART:'+start);
    lines.push('DTEND:'+end);
    lines.push('SUMMARY:'+title);
    lines.push('LOCATION:'+location);
    lines.push('DESCRIPTION:'+desc);
    lines.push('BEGIN:VALARM'); lines.push('TRIGGER:-PT10M'); lines.push('ACTION:DISPLAY'); lines.push('DESCRIPTION:GT7 závod za 10 minut'); lines.push('END:VALARM');
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  return lines.join('\r\n');
}
$('#btnDownloadICS').addEventListener('click', ()=>{
  const ics = buildICS();
  const blob = new Blob([ics],{type:'text/calendar;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='GT7_naplanovane_zavody.ics';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
});

/* === Admin: Přidat nový závod === */
$('#add_clear').addEventListener('click', ()=> $('#addRaceForm').reset());
$('#addRaceForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    nazev: $('#add_name').value.trim(),
    datum: $('#add_date').value || null,
    trat: $('#add_track').value.trim(),
    vozidla: $('#add_vehicles').value.trim(),
    kategorie: $('#add_category').value,
    tuning: $('#add_tuning').value,
    bop: $('#add_bop').value,
    pneumatiky: $('#add_tyres').value,
    smes: $('#add_compound').value,
    opotrebovani: $('#add_tyreWear').value.trim(),
    spotreba: $('#add_fuel').value.trim(),
    rychlost_doplneni: $('#add_refuel').value.trim(),
    pitstop: $('#add_pitstop').value,
    info: $('#add_info').value.trim(),
    youtube: $('#add_youtube').value.trim() || null,
    penalties: []
  };
  try{
    const docRef = await db.collection('zavody').add(payload);
    await addAudit(docRef.id, {action:'create', summary:`Vytvořen závod "${payload.nazev}"`});
    $('#addRaceForm').reset();
    alert('Závod přidán.');
  }catch(e){ console.error(e); alert('Chyba ukládání závodu: '+e.message); }
});

/* === Admin: Edit – select naplnění === */
function populateEditSelect(){
  const sel=$('#edit_select'); if(!sel) return;
  const all = [...racesCache].sort((a,b)=>new Date(a.datum||a.date||0)-new Date(b.datum||b.date||0));
  const currentVal = sel.value;
  sel.innerHTML='<option value="">-- vyber závod --</option>';
  all.forEach(r=>{
    const label = `${r.nazev||r.name||''} — ${ r.datum ? new Date(r.datum).toLocaleString() : (r.date? new Date(r.date).toLocaleString() : 'datum neuvedeno') }`;
    const opt=document.createElement('option'); opt.value=r.id; opt.textContent=label; sel.appendChild(opt);
  });
  if(currentVal){ sel.value=currentVal; if(sel.value===currentVal) sel.dispatchEvent(new Event('change')); }
}

$('#edit_select').addEventListener('change', async ()=>{
  const id=$('#edit_select').value;
  const form=$('#editRaceForm'); const posWrap=$('#edit_positions'); const qualiWrap=$('#edit_quali'); const penWrap=$('#penaltiesWrap');
  form.style.display='none'; posWrap.innerHTML=''; qualiWrap.innerHTML=''; penWrap.innerHTML='';
  $('#auditList').textContent='Načítám…';
  if(!id) return;
  const r = racesCache.find(x=>x.id===id); if(!r) return;
  $('#edit_id').value=id;
  $('#edit_name').value=r.nazev||r.name||'';
  $('#edit_date').value=(r.datum||r.date)||'';
  $('#edit_track').value=r.trat||r.track||'';
  $('#edit_vehicles').value=r.vozidla||r.vehicles||'';
  $('#edit_category').value=r.kategorie||r.category||'Open';
  $('#edit_tuning').value=r.tuning||'NE';
  $('#edit_bop').value=r.bop||'NE';
  $('#edit_tyres').value=r.pneumatiky||r.tyres||'Závodní';
  $('#edit_compound').value=r.smes||r.compound||'Tvrdá';
  $('#edit_tyreWear').value=r.opotrebovani||r.tyreWear||'';
  $('#edit_fuel').value=r.spotreba||r.fuel||'';
  $('#edit_refuel').value=r.rychlost_doplneni||r.refuel||'';
  $('#edit_pitstop').value=r.pitstop||'NE';
  $('#edit_info').value=r.info||'';
  $('#edit_youtube').value=r.youtube||r.video||'';

  // kvalifikace 1..5 + DNS
  const q = getQualiArray(r);
  for(let i=1;i<=5;i++){
    const wrap=document.createElement('div'); wrap.style.marginBottom='6px';
    const lab=document.createElement('label'); lab.textContent=`Q ${i}. místo`; lab.setAttribute('for',`edit_q${i}`);
    const sel=document.createElement('select'); sel.id=`edit_q${i}`; sel.style.width='100%';
    [...drivers,'DNS'].forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; sel.appendChild(op); });
    if(q[i-1]) sel.value=q[i-1];
    wrap.appendChild(lab); wrap.appendChild(sel); qualiWrap.appendChild(wrap);
  }

  // závod 1..5 + DNS
  const existing = getResultsArray(r);
  for(let i=1;i<=5;i++){
    const wrap=document.createElement('div'); wrap.style.marginBottom='6px';
    const lab=document.createElement('label'); lab.textContent=`${i}. místo`; lab.setAttribute('for',`edit_pos${i}`);
    const sel=document.createElement('select'); sel.id=`edit_pos${i}`; sel.style.width='100%';
    [...drivers,'DNS'].forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; sel.appendChild(op); });
    if(existing[i-1]) sel.value=existing[i-1];
    wrap.appendChild(lab); wrap.appendChild(sel); posWrap.appendChild(wrap);
  }

  // penalizace
  const pens = Array.isArray(r.penalties)? deepClone(r.penalties) : [];
  renderPenaltiesEditor(penWrap, pens);

  form.style.display='block';
  loadAudit(id);
});

function renderPenaltiesEditor(container, pens){
  container.innerHTML='';
  if(pens.length===0){
    const p=document.createElement('div'); p.className='small muted'; p.textContent='Zatím bez penalizací.'; container.appendChild(p);
  }
  pens.forEach((p,idx)=>{
    const row=document.createElement('div'); row.className='row'; row.style.marginBottom='6px';

    const c1=document.createElement('div'); c1.className='col';
    const l1=document.createElement('label'); l1.textContent='Jezdec';
    const s1=document.createElement('select');
    [...drivers].forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; s1.appendChild(o); });
    s1.value = p.driver || p.jezdec || drivers[0];
    c1.appendChild(l1); c1.appendChild(s1);

    const c2=document.createElement('div'); c2.className='col';
    const l2=document.createElement('label'); l2.textContent='Typ';
    const s2=document.createElement('select');
    ['pozice','cas'].forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=(t==='pozice'?'Pozice +N':'Čas (+1 pozice)'); s2.appendChild(o); });
    s2.value = (p.kind||p.typ||'pozice');
    c2.appendChild(l2); c2.appendChild(s2);

    const c3=document.createElement('div'); c3.className='col';
    const l3=document.createElement('label'); l3.textContent='Hodnota';
    const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.step='1';
    inp.value = Number(p.value|| (s2.value==='cas'?1:1));
    c3.appendChild(l3); c3.appendChild(inp);

    const c4=document.createElement('div'); c4.className='col';
    const l4=document.createElement('label'); l4.textContent='Poznámka';
    const note=document.createElement('input'); note.value = p.note || '';
    c4.appendChild(l4); c4.appendChild(note);

    const c5=document.createElement('div'); c5.style.display='flex'; c5.style.alignItems='flex-end';
    const del=document.createElement('button'); del.type='button'; del.className='btn-ghost'; del.textContent='Smazat';
    del.addEventListener('click',()=>{ pens.splice(idx,1); renderPenaltiesEditor(container,pens); });
    c5.appendChild(del);

    row.appendChild(c1); row.appendChild(c2); row.appendChild(c3); row.appendChild(c4); row.appendChild(c5);
    container.appendChild(row);

    s1.addEventListener('change',()=>{ p.driver=s1.value; });
    s2.addEventListener('change',()=>{ p.kind=s2.value; if(s2.value==='cas' && Number(inp.value||0)===0) inp.value=1; });
    inp.addEventListener('input',()=>{ p.value=Number(inp.value||0); });
    note.addEventListener('input',()=>{ p.note=note.value; });
  });

  $('#addPenaltyBtn').onclick = ()=>{ pens.push({driver:drivers[0],kind:'pozice',value:1,note:''}); renderPenaltiesEditor(container,pens); };
  container._value = pens;
}

async function loadAudit(raceId){
  try{
    const snap = await db.collection('zavody').doc(raceId).collection('audit').orderBy('ts','desc').limit(20).get();
    if(snap.empty){ $('#auditList').textContent='Žádné záznamy.'; return; }
    const list = [];
    snap.forEach(d=>{
      const a=d.data();
      const when = a.ts ? new Date(a.ts).toLocaleString() : '';
      list.push(`<div>- <span class="pill">${escapeHtml(a.by||'neznámý')}</span> • ${when} • ${escapeHtml(a.summary||a.action||'')}</div>`);
    });
    $('#auditList').innerHTML = list.join('');
  }catch(e){
    console.error(e);
    $('#auditList').textContent='Chyba načtení auditu.';
  }
}
async function addAudit(raceId, {action, summary}){
  try{
    const by = (auth.currentUser && (auth.currentUser.displayName||auth.currentUser.email)) || 'anonymous';
    const ts = new Date().toISOString();
    await db.collection('zavody').doc(raceId).collection('audit').add({action, summary, by, ts});
  }catch(e){ console.error('Audit write error', e); }
}

$('#edit_clear').addEventListener('click', ()=>{ $('#edit_select').value=''; $('#editRaceForm').style.display='none'; });

$('#edit_delete').addEventListener('click', async ()=>{
  const id=$('#edit_id').value; if(!id) return;
  if(!confirm('Smazat závod? Tuto akci nelze vrátit.')) return;
  try{
    await db.collection('zavody').doc(id).delete();
    await addAudit(id, {action:'delete', summary:'Závod smazán'});
    $('#edit_select').value=''; $('#editRaceForm').style.display='none';
  }catch(e){ console.error(e); alert('Chyba mazání: '+e.message); }
});

$('#editRaceForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id=$('#edit_id').value; if(!id) return;

  const arr=[]; for(let i=1;i<=5;i++){ arr.push( $('#edit_pos'+i)?.value || 'DNS' ); }
  const qa=[]; for(let i=1;i<=5;i++){ qa.push( $('#edit_q'+i)?.value || 'DNS' ); }
  const pensWrap = $('#penaltiesWrap');
  const pens = (pensWrap && pensWrap._value) ? pensWrap._value : [];

  const before = racesCache.find(x=>x.id===id) || {};
  const payload = {
    nazev: $('#edit_name').value.trim(),
    datum: $('#edit_date').value || null,
    trat: $('#edit_track').value.trim(),
    vozidla: $('#edit_vehicles').value.trim(),
    kategorie: $('#edit_category').value,
    tuning: $('#edit_tuning').value,
    bop: $('#edit_bop').value,
    pneumatiky: $('#edit_tyres').value,
    smes: $('#edit_compound').value,
    opotrebovani: $('#edit_tyreWear').value.trim(),
    spotreba: $('#edit_fuel').value.trim(),
    rychlost_doplneni: $('#edit_refuel').value.trim(),
    pitstop: $('#edit_pitstop').value,
    info: $('#edit_info').value.trim(),
    youtube: ($('#edit_youtube').value.trim() || null),
    kvalifikace: qa, qualifying: qa,
    vysledky: arr, results: arr,
    penalties: pens
  };

  try{
    await db.collection('zavody').doc(id).set(payload,{merge:true});
    const diffs = [];
    const keys = ['nazev','datum','trat','vozidla','kategorie','tuning','bop','pneumatiky','smes','opotrebovani','spotreba','rychlost_doplneni','pitstop','info','youtube'];
    keys.forEach(k=>{
      const beforeVal = before[k] ?? '';
      const afterVal = payload[k] ?? '';
      if(String(beforeVal)!==String(afterVal)) diffs.push(`${k} změněno`);
    });
    if(JSON.stringify(getQualiArray(before))!==JSON.stringify(qa)) diffs.push('kvalifikace upravena');
    if(JSON.stringify(getResultsArray(before))!==JSON.stringify(arr)) diffs.push('výsledky upraveny');
    if(JSON.stringify(before.penalties||[])!==JSON.stringify(pens)) diffs.push('penalizace upraveny');

    await addAudit(id, {action:'update', summary: diffs.length? diffs.join(', ') : 'bez změn'});

    alert('Závod upraven.');
    loadAudit(id);
  }catch(e){ console.error(e); alert('Chyba ukládání: '+e.message); }
});

/* === Export / Import === */
function exportJSON(){
  const blob = new Blob([JSON.stringify(racesCache,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='gt7_races_export.json'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}
function toCSVValue(v){
  if(v==null) return '';
  const s = typeof v==='string' ? v : JSON.stringify(v);
  return `"${s.replace(/"/g,'""')}"`;
}
function exportCSV(){
  const headers = ['id','datum','nazev','trat','kategorie','vozidla','tuning','bop','pneumatiky','smes','opotrebovani','spotreba','rychlost_doplneni','pitstop','info','youtube','kvalifikace','vysledky','penalties'];
  const lines = [headers.join(',')];
  racesCache.forEach(r=>{
    const row = [
      r.id||'',
      r.datum||r.date||'',
      r.nazev||r.name||'',
      r.trat||r.track||'',
      r.kategorie||r.category||'',
      r.vozidla||r.vehicles||'',
      r.tuning||'',
      r.bop||'',
      r.pneumatiky||r.tyres||'',
      r.smes||r.compound||'',
      r.opotrebovani||r.tyreWear||'',
      r.spotreba||r.fuel||'',
      r.rychlost_doplneni||r.refuel||'',
      r.pitstop||'',
      r.info||'',
      r.youtube||'',
      JSON.stringify(getQualiArray(r)),
      JSON.stringify(getResultsArray(r)),
      JSON.stringify(r.penalties||[])
    ].map(toCSVValue).join(',');
    lines.push(row);
  });
  const blob = new Blob([lines.join('\r\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='gt7_races_export.csv'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}
async function importJSONFile(file){
  const text = await file.text();
  let data;
  try{ data = JSON.parse(text); }
  catch(e){ alert('Soubor není validní JSON.'); return; }
  if(!Array.isArray(data)){ alert('Očekávám pole závodů.'); return; }
  if(!confirm(`Importovat ${data.length} záznamů do Firestore?`)) return;

  for(const r of data){
    const payload = {...r};
    delete payload.id;
    try{
      if(r.id){
        await db.collection('zavody').doc(r.id).set(payload,{merge:true});
      }else{
        await db.collection('zavody').add(payload);
      }
    }catch(e){
      console.error('Import error', e, r);
      alert('Chyba při importu některých položek. Zkontroluj konzoli.');
      break;
    }
  }
  alert('Import hotový.');
}
$('#btnExportJSON').addEventListener('click', exportJSON);
$('#btnExportCSV').addEventListener('click', exportCSV);
$('#btnImport').addEventListener('click', async ()=>{
  const file = $('#importFile').files[0];
  if(!file){ alert('Vyber JSON soubor.'); return; }
  await importJSONFile(file);
});

/* === H2H ovladač === */
$('#btnH2H').addEventListener('click', renderH2H);

/* === GT7 TRACK LIST (fallback + optional tracks.json) === */
const GT7_TRACKS_FALLBACK = [
  "Autódromo José Carlos Pace (Interlagos)",
  "Autopolis",
  "Bathurst (Mount Panorama)",
  "Brands Hatch",
  "Circuit de Barcelona-Catalunya",
  "Circuit de la Sarthe (Le Mans)",
  "Daytona International Speedway",
  "Fuji Speedway",
  "Goodwood Motor Circuit",
  "WeatherTech Raceway Laguna Seca",
  "Autodromo Nazionale Monza",
  "Nürburgring",
  "Michelin Raceway Road Atlanta",
  "Red Bull Ring",
  "Spa-Francorchamps",
  "Suzuka Circuit",
  "Tsukuba Circuit",
  "Watkins Glen International",
  "Willow Springs International Raceway",
  "Alsace",
  "Autodrome Lago Maggiore",
  "Blue Moon Bay Speedway",
  "Broad Bean Raceway",
  "Deep Forest Raceway",
  "Dragon Trail",
  "Eiger Nordwand",
  "Grand Valley - Highway 1",
  "High Speed Ring",
  "Kyoto Driving Park",
  "Northern Isle Speedway",
  "Circuit de Sainte-Croix",
  "Sardegna - Road Track",
  "Special Stage Route X",
  "Tokyo Expressway",
  "Trial Mountain Circuit",
  "Barcelona-Catalunya Rallycross",
  "Colorado Springs",
  "Fishermans Ranch",
  "Lake Louise (Snow)",
  "Sardegna - Windmills (Dirt)"
];
async function installGt7TrackDatalist() {
  let tracks = null;
  try {
    const res = await fetch('./tracks.json', { cache: 'no-store' });
    if (res.ok) {
      const json = await res.json();
      if (Array.isArray(json) && json.length) tracks = json;
    }
  } catch {}
  if (!tracks) tracks = GT7_TRACKS_FALLBACK.slice();

  const datalist = document.getElementById('gt7Tracks');
  datalist.innerHTML = '';
  tracks.sort((a,b)=>a.localeCompare(b,'cs')).forEach(name=>{
    const opt=document.createElement('option'); opt.value=name; datalist.appendChild(opt);
  });

  document.querySelectorAll('input[data-track-input]').forEach(inp=>{
    inp.setAttribute('list','gt7Tracks');
    inp.addEventListener('blur', ()=>{
      const v=inp.value.trim().toLowerCase(); if(!v) return;
      const hit = tracks.find(t=>t.toLowerCase()===v);
      if(hit) inp.value=hit;
    });
  });
}

/* === Start === */
function initTabs(){
  $$('section').forEach(s=>s.classList.remove('active')); $('#home').classList.add('active');
  $$('.tablink').forEach(b=>b.classList.remove('active')); document.querySelector('[data-tab="home"]').classList.add('active');
}
initTabs();
startRealtime();
installGt7TrackDatalist();
setInterval(()=>{ renderNextRace(); scheduleReminderIfDue(); },60*1000);
</script>
</body>
</html>
