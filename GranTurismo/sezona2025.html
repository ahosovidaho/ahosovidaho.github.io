<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hric-Pic-Ma-Ma-Tama Championship 2025</title>
<style>
  :root{--bg:#121212;--card:#171717;--muted:#9aa0a6;--accent:#0d6efd;--accent2:#c62828}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  header{padding:18px;text-align:center;background:linear-gradient(90deg,#0d1b36,#610000)} header h1{margin:0;font-size:20px}
  .container{max-width:1100px;margin:16px auto;padding:0 12px}
  nav{display:flex;gap:8px;justify-content:center;background:#141414;padding:8px;border-radius:6px;flex-wrap:wrap}
  nav button{background:none;border:none;color:#fff;padding:8px 12px;cursor:pointer;font-size:15px}
  nav button.active{border-bottom:3px solid var(--accent2)}
  section{display:none;padding:12px 0}
  section.active{display:block}
  .card{background:var(--card);border:1px solid #2a2a2a;padding:12px;border-radius:8px;margin-top:12px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #2a2a2a;padding:8px;text-align:center;vertical-align:middle}
  th{background:#131313}
  label{display:block;font-size:13px;margin-top:8px}
  input,select,textarea,button{font-family:inherit}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff;box-sizing:border-box}
  textarea{min-height:80px}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .formBtn{background:var(--accent2);border:none;color:#fff;padding:10px 14px;border-radius:6px;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid #444;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .youtube-thumb{width:120px;height:auto;border-radius:6px}
  .actions button{margin:0 2px}
  @media(max-width:800px){ .row{flex-direction:column} .youtube-thumb{width:80px} th,td{font-size:13px} header h1{font-size:18px} }
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header><h1>Hric-Pic-Ma-Ma-Tama Championship 2025</h1></header>

<div class="container">
  <nav>
    <button class="tablink active" data-tab="home">Aktuální sezóna</button>
    <button class="tablink" data-tab="stats">Statistiky</button>
    <button class="tablink" data-tab="archive">Archiv sezón</button>
    <button class="tablink" data-tab="profile">Profil závodníka</button>
    <button class="tablink" data-tab="admin">Admin</button>
  </nav>

  <!-- HOME -->
  <section id="home" class="active">
    <div class="card">
      <strong>Nejbližší závod</strong>
      <div id="nextRaceInfo" class="small" style="margin-top:8px">Načítám...</div>
    </div>

    <div class="card">
      <strong>Vývoj bodů</strong>
      <canvas id="pointsChart" style="max-height:360px"></canvas>
    </div>

    <div class="card">
      <strong>Pořadí závodníků</strong>
      <table id="standings"><thead><tr><th>Závodník</th><th>Body</th><th>Pódiová umístění</th><th>DNS</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card">
      <strong>Výsledky závodů</strong>
      <table id="resultsTable">
        <thead><tr><th>Datum</th><th>Závod / Trať</th><th>1.</th><th>2.</th><th>3.</th><th>4.</th><th>5.</th><th>Video</th><th>Akce</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Naplánované závody</strong>
      <table id="plannedTable">
        <thead><tr><th>Datum</th><th>Závod / Trať</th><th>Kategorie</th><th>Vozidla</th><th>Info</th><th>Akce</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- STATS -->
  <section id="stats">
    <div class="card"><strong>Statistiky</strong><div class="small" id="statsArea" style="margin-top:8px">H2H, série výher a další statistiky budou dostupné zde.</div></div>
  </section>

  <!-- ARCHIVE -->
  <section id="archive">
    <div class="card"><strong>Archiv sezón</strong><div class="small" id="archiveArea" style="margin-top:8px">Zatím prázdné.</div></div>
  </section>

  <!-- PROFILE -->
  <section id="profile">
    <div class="card"><strong>Profil závodníka</strong><div class="small" style="margin-top:8px">Funkce profilu (fotka, oblíbené auto, trať...) doplníme později.</div></div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <div class="row">
        <div class="col">
          <strong>Admin</strong>
          <div style="margin-top:8px">
            <button id="loginBtn" class="formBtn">Přihlásit se přes Google</button>
            <button id="logoutBtn" class="btn-ghost" style="display:none;margin-left:8px">Odhlásit</button>
            <div id="adminUser" class="small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <strong>Přidat / upravit naplánovaný závod</strong>
      <form id="raceForm" autocomplete="off">
        <input id="raceDocId" type="hidden" autocomplete="off" />
        <div class="row">
          <div class="col">
            <label for="name">Název</label>
            <input id="name" autocomplete="off" required />
          </div>
          <div class="col">
            <label for="date">Datum a čas</label>
            <input id="date" type="datetime-local" autocomplete="off" />
          </div>
        </div>

        <label for="track">Trať</label>
        <input id="track" autocomplete="off" />

        <div class="row">
          <div class="col">
            <label for="vehicles">Povolená vozidla</label>
            <input id="vehicles" autocomplete="off" />
          </div>
          <div class="col">
            <label for="category">Kategorie</label>
            <select id="category" autocomplete="off">
              <option>Gr.1</option><option>Gr.2</option><option>Gr.3</option><option>Gr.4</option><option>Gr.B</option><option>VGT</option><option>Open</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="tuning">Tuning</label>
            <select id="tuning" autocomplete="off"><option>ANO</option><option>NE</option></select>
          </div>
          <div class="col">
            <label for="bop">Rovnováha výkonu (BoP)</label>
            <select id="bop" autocomplete="off"><option>ANO</option><option>NE</option></select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="tyres">Povolené pneumatiky</label>
            <select id="tyres" autocomplete="off"><option>Komfortní</option><option>Sportovní</option><option>Závodní</option><option>Na sníh</option><option>Na šotolinu</option></select>
          </div>
          <div class="col">
            <label for="compound">Povinná směs</label>
            <select id="compound" autocomplete="off"><option>Tvrdá</option><option>Střední</option><option>Měkká</option></select>
          </div>
        </div>

        <div class="row">
          <div class="col"><label for="tyreWear">Opotřebení pneumatik</label><input id="tyreWear" autocomplete="off"/></div>
          <div class="col"><label for="fuel">Spotřeba paliva</label><input id="fuel" autocomplete="off"/></div>
          <div class="col"><label for="refuel">Rychlost doplňování paliva</label><input id="refuel" autocomplete="off"/></div>
        </div>

        <label for="pitstop">Povinný pit-stop</label>
        <select id="pitstop" autocomplete="off"><option>ANO</option><option>NE</option></select>

        <label for="info">Doplňující info</label><textarea id="info" autocomplete="off"></textarea>

        <label for="youtube">Odkaz na YouTube</label><input id="youtube" type="url" autocomplete="off" placeholder="https://www.youtube.com/watch?v=..." />

        <div style="margin-top:10px">
          <button id="saveRace" class="formBtn" type="submit">Uložit závod</button>
          <button id="clearRace" type="button" class="btn-ghost" style="margin-left:8px">Vyčistit</button>
        </div>
      </form>
    </div>

    <div class="card">
      <strong>Úprava výsledků (dokončení závodu / doplnění videa)</strong>
      <div class="small" style="margin-top:8px">Vyber naplánovaný / hotový závod, zadej 1.–5. místo (nebo DNS) a ulož.</div>
      <div style="margin-top:10px">
        <select id="selectRaceEdit" style="width:100%;padding:8px;margin-bottom:8px"></select>
        <div id="resultsEditor" style="display:none">
          <div id="positionsContainer"></div>
          <label for="youtubeResult">YouTube odkaz</label>
          <input id="youtubeResult" type="url" autocomplete="off" placeholder="https://www.youtube.com/watch?v=..." />
          <div style="margin-top:8px">
            <button id="saveResults" class="formBtn" type="button">Uložit výsledky / video</button>
            <button id="cancelResults" class="btn-ghost" type="button" style="margin-left:8px">Zrušit</button>
          </div>
        </div>
      </div>
    </div>

  </section>
</div>

<script>
/* === Firebase === */
const firebaseConfig = {
  apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
  authDomain: "test-gt7.firebaseapp.com",
  projectId: "test-gt7",
  storageBucket: "test-gt7.firebasestorage.app",
  messagingSenderId: "928154989107",
  appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
  measurementId: "G-1SG8DW1KQ9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* === State / Constants === */
const drivers = ["Viki","Mára","Maty","Hardy","Ondra"];
const pointsMap = [10,8,6,4,2]; // 1..5
let racesCache = [];
let pointsChart = null;

/* === Helpers === */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[ch])); }
function randomColor(){ return '#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'); }
function normName(raw){ return (!raw)?raw:String(raw).replace(/\s*\(.*\)\s*$/,'').trim(); }
function ytId(url){ if(!url) return null; try{const u=new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.searchParams.get('v')) return u.searchParams.get('v'); const seg=u.pathname.split('/').filter(Boolean).pop(); return seg&&seg.length>=10?seg:null;}catch(e){ return url.length===11?url:null; }}

/* === Tabs === */
$$('.tablink').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('section').forEach(s=>s.classList.remove('active'));
    $('#'+btn.dataset.tab).classList.add('active');
    $$('.tablink').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* === Auth UI === */
const loginBtn=$('#loginBtn'), logoutBtn=$('#logoutBtn'), adminUser=$('#adminUser');
loginBtn.addEventListener('click', async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try{ const res = await auth.signInWithPopup(provider); adminUser.textContent=`Přihlášen: ${res.user.displayName}`; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; }
  catch(e){ console.error(e); alert('Chyba přihlášení: '+e.message); }
});
logoutBtn.addEventListener('click', ()=>auth.signOut());
auth.onAuthStateChanged(u=>{
  if(u){ adminUser.textContent=`Přihlášen: ${u.displayName}`; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; }
  else{ adminUser.textContent=''; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; }
});

/* === Realtime Firestore (kolekce 'zavody') === */
function startRealtime(){
  // objednáno dle 'datum', pokud nějaké dokumenty nemají datum, dojdou v snapshotu taky – seřadíme ručně
  db.collection('zavody').onSnapshot(snap=>{
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    // ruční sort: podle datum|date, null -> na konec
    arr.sort((a,b)=>{
      const ad=a.datum||a.date||null, bd=b.datum||b.date||null;
      if(!ad && !bd) return 0; if(!ad) return 1; if(!bd) return -1;
      return new Date(ad)-new Date(bd);
    });
    racesCache=arr;
    renderAll();
  }, err=>{
    console.error('Snapshot error',err);
    db.collection('zavody').get().then(sn=>{ const arr=[]; sn.forEach(d=>arr.push({id:d.id,...d.data()})); racesCache=arr; renderAll(); });
  });
}

/* === Render orchestration === */
function renderAll(){
  renderNextRace();
  renderResultsTable();
  renderPlannedTable();
  renderStandingsAndChart();
  populateRaceEditSelect();
}

/* === Next race banner (jen budoucí) === */
function renderNextRace(){
  const now = new Date();
  const future = racesCache.filter(r=>{
    const d=r.datum||r.date||null; return d && new Date(d)>now && !(Array.isArray(r.vysledky)?r.vysledky.length>0:(Array.isArray(r.results)?r.results.length>0:false));
  }).sort((a,b)=> new Date(a.datum||a.date)-new Date(b.datum||b.date));
  const el=$('#nextRaceInfo');
  if(!future.length){
    // pokud existuje naplánovaný bez data, zobraz jen info
    const plannedNoDate = racesCache.find(r=>!(Array.isArray(r.vysledky)?r.vysledky.length>0:(Array.isArray(r.results)?r.results.length>0:false)) && !(r.datum||r.date));
    if(plannedNoDate){
      el.innerHTML = `<strong>${escapeHtml(plannedNoDate.nazev||plannedNoDate.name||'')}</strong> / ${escapeHtml(plannedNoDate.trat||plannedNoDate.track||'')}`;
    }else{
      el.textContent='Žádný nadcházející závod.';
    }
    return;
  }
  const next = future[0];
  const dt = new Date(next.datum||next.date);
  const diff = dt - new Date();
  const d = Math.floor(diff/1000/60/60/24);
  const h = Math.floor(diff/1000/60/60)%24;
  const m = Math.floor(diff/1000/60)%60;
  el.innerHTML = `<strong>${escapeHtml(next.nazev||next.name)}</strong> / ${escapeHtml(next.trat||next.track||'')} <div class="small">Do startu: ${d}d ${h}h ${m}m</div>`;
}

/* === Results (completed) === */
function resultArray(r){
  if(Array.isArray(r.vysledky)) return r.vysledky;
  if(Array.isArray(r.results)) return r.results;
  return [];
}
function isCompleted(r){ const a=resultArray(r); return a.length>0; }

function renderResultsTable(){
  const tbody = $('#resultsTable tbody'); tbody.innerHTML='';
  const completed = racesCache.filter(isCompleted)
    .sort((a,b)=> new Date(b.datum||b.date||0) - new Date(a.datum||a.date||0));
  completed.forEach(r=>{
    const dateStr = r.datum||r.date ? new Date(r.datum||r.date).toLocaleString() : '';
    const nameTrack = `${escapeHtml(r.nazev||r.name||'')} / ${escapeHtml(r.trat||r.track||'')}`;
    const arr=resultArray(r);
    const cells = Array.from({length:5},(_,i)=>escapeHtml(arr[i]||'DNS')).map(c=>`<td>${c}</td>`).join('');
    const yt = r.youtube || r.video || r.youtubeUrl || r.youtube_link || r.link || r.odkaz;
    const id = ytId(yt);
    const video = id ? `<a href="${escapeHtml(yt)}" target="_blank"><img class="youtube-thumb" src="https://img.youtube.com/vi/${id}/hqdefault.jpg" alt="video"></a>` :
                 (yt ? `<a href="${escapeHtml(yt)}" target="_blank">Video</a>` : '');
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${dateStr}</td><td>${nameTrack}</td>${cells}<td>${video}</td>
      <td class="actions">
        <button class="btn-ghost" onclick="openEditor('${r.id}', true)">Upravit výsledky</button>
        <button class="btn-ghost" onclick="editPlanned('${r.id}')">Upravit závod</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* === Planned (no results) === */
function renderPlannedTable(){
  const tbody=$('#plannedTable tbody'); tbody.innerHTML='';
  const planned = racesCache.filter(r=>!isCompleted(r))
    .sort((a,b)=> new Date(a.datum||a.date||0) - new Date(b.datum||b.date||0));
  planned.forEach(r=>{
    const dateStr = r.datum||r.date ? new Date(r.datum||r.date).toLocaleString() : '';
    const nameTrack = `${escapeHtml(r.nazev||r.name||'')} / ${escapeHtml(r.trat||r.track||'')}`;
    const cat = escapeHtml(r.kategorie||r.category||'');
    const veh = escapeHtml(r.vozidla||r.vehicles||'');
    const info = escapeHtml(r.info||'');
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${dateStr}</td><td>${nameTrack}</td><td>${cat}</td><td>${veh}</td><td>${info}</td>
      <td class="actions">
        <button class="btn-ghost" onclick="editPlanned('${r.id}')">Upravit</button>
        <button class="btn-ghost" onclick="openEditor('${r.id}', false)">Upravit výsledky</button>
        <button class="btn-ghost" onclick="deleteRace('${r.id}')">Smazat</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* === Standings + Chart (only completed) === */
function renderStandingsAndChart(){
  const completed = racesCache.filter(isCompleted)
    .sort((a,b)=> new Date(a.datum||a.date||0) - new Date(b.datum||b.date||0));
  const stats={}; drivers.forEach(d=>stats[d]={points:0,podiums:0,dns:0});
  completed.forEach(r=>{
    const arr=resultArray(r);
    // body + podia
    for(let i=0;i<5;i++){
      const raw=arr[i]; if(!raw || raw==='DNS') continue;
      const d=normName(raw);
      if(!stats[d]) stats[d]={points:0,podiums:0,dns:0};
      stats[d].points += (pointsMap[i]||0);
      if(i<3) stats[d].podiums++;
    }
    // DNS: kdokoli z drivers, kdo není v arr (po normalizaci)
    drivers.forEach(d=>{
      const present = arr.some(x=>normName(x)===d);
      if(!present) stats[d].dns++;
    });
  });

  // tabulka
  const tbody=$('#standings tbody'); tbody.innerHTML='';
  Object.keys(stats).sort((a,b)=>stats[b].points - stats[a].points)
    .forEach(name=>{
      const s=stats[name];
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(name)}</td><td>${s.points}</td><td>${s.podiums}</td><td>${s.dns}</td>`;
      tbody.appendChild(tr);
    });

  // graf – kumulativně
  const labels = completed.map(r=> r.nazev||r.name|| (r.trat||r.track||'Závod'));
  const datasets = drivers.map(d=>{
    let cum=0;
    const data = completed.map(r=>{
      const arr=resultArray(r);
      const idx = arr.findIndex(x=>normName(x)===d);
      if(idx===-1 || arr[idx]==='DNS') return cum;
      cum += (pointsMap[idx]||0);
      return cum;
    });
    return {label:d,data, borderColor:randomColor(), fill:false, tension:0.2};
  });
  const ctx=$('#pointsChart').getContext('2d');
  if(pointsChart && typeof pointsChart.destroy==='function') pointsChart.destroy();
  pointsChart = new Chart(ctx,{ type:'line', data:{labels,datasets}, options:{ responsive:true, plugins:{legend:{labels:{color:'#fff'}}}, scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}, beginAtZero:true}} }});
}

/* === Admin: save/clear === */
$('#clearRace').addEventListener('click', ()=>{ $('#raceForm').reset(); $('#raceDocId').value=''; });
$('#raceForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = $('#raceDocId').value || db.collection('zavody').doc().id;
  const payload = {
    nazev: $('#name').value.trim(),
    datum: $('#date').value || null,
    trat: $('#track').value.trim(),
    vozidla: $('#vehicles').value.trim(),
    kategorie: $('#category').value,
    tuning: $('#tuning').value,
    bop: $('#bop').value,
    pneumatiky: $('#tyres').value,
    smes: $('#compound').value,
    opotrebovani: $('#tyreWear').value,
    spotreba: $('#fuel').value,
    rychlost_doplneni: $('#refuel').value,
    pitstop: $('#pitstop').value,
    info: $('#info').value.trim(),
    youtube: $('#youtube').value.trim()
  };
  try{ await db.collection('zavody').doc(id).set(payload,{merge:true}); $('#raceForm').reset(); $('#raceDocId').value=''; alert('Závod uložen.'); }
  catch(e){ console.error(e); alert('Chyba ukládání závodu: '+e.message); }
});

/* === Admin: edit existing planned/completed into form === */
window.editPlanned = async function(id){
  try{
    const doc = await db.collection('zavody').doc(id).get(); if(!doc.exists) return alert('Závod nenalezen');
    const r=doc.data();
    $('#raceDocId').value=id;
    $('#name').value=r.nazev||r.name||'';
    $('#date').value=r.datum||r.date||'';
    $('#track').value=r.trat||r.track||'';
    $('#vehicles').value=r.vozidla||r.vehicles||'';
    $('#category').value=r.kategorie||r.category||'Open';
    $('#tuning').value=r.tuning||'NE';
    $('#bop').value=r.bop||'NE';
    $('#tyres').value=r.pneumatiky||r.tyres||'Závodní';
    $('#compound').value=r.smes||r.compound||'Tvrdá';
    $('#tyreWear').value=r.opotrebovani||r.tyreWear||'';
    $('#fuel').value=r.spotreba||r.fuel||'';
    $('#refuel').value=r.rychlost_doplneni||r.refuel||'';
    $('#pitstop').value=r.pitstop||'NE';
    $('#info').value=r.info||'';
    $('#youtube').value=r.youtube||'';
    // přepnout do Admin
    $$('.tablink').forEach(b=>b.classList.remove('active')); $('[data-tab="admin"]').classList.add('active');
    $$('section').forEach(s=>s.classList.remove('active')); $('#admin').classList.add('active');
  }catch(e){ console.error(e); alert('Chyba při načítání závodu'); }
};

/* === Admin: výsledkový editor === */
function populateRaceEditSelect(){
  const sel=$('#selectRaceEdit'); if(!sel) return;
  sel.innerHTML='<option value="">-- vyber závod --</option>';
  const all = [...racesCache].sort((a,b)=>new Date(a.datum||a.date||0)-new Date(b.datum||b.date||0));
  all.forEach(r=>{
    const label = `${r.nazev||r.name||''} — ${ r.datum ? new Date(r.datum).toLocaleString() : (r.date? new Date(r.date).toLocaleString() : 'datum neuvedeno') }`;
    const opt=document.createElement('option'); opt.value=r.id; opt.textContent=label; sel.appendChild(opt);
  });
}
$('#selectRaceEdit').addEventListener('change', ()=>{
  const id=$('#selectRaceEdit').value;
  const editor=$('#resultsEditor');
  const container=$('#positionsContainer');
  container.innerHTML='';
  if(!id){ editor.style.display='none'; return; }
  const r = racesCache.find(x=>x.id===id);
  // 1..5 místa
  for(let i=1;i<=5;i++){
    const wrap=document.createElement('div'); wrap.style.marginBottom='6px';
    const lab=document.createElement('label'); lab.textContent=`${i}. místo`; lab.setAttribute('for',`pos${i}`);
    const sel=document.createElement('select'); sel.id=`pos${i}`; sel.style.width='100%';
    [...drivers,'DNS'].forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; sel.appendChild(op); });
    const existing = Array.isArray(r.vysledky)?r.vysledky[i-1] : (Array.isArray(r.results)? r.results[i-1] : null);
    if(existing) sel.value=existing;
    wrap.appendChild(lab); wrap.appendChild(sel); container.appendChild(wrap);
  }
  $('#youtubeResult').value = r.youtube || r.video || '';
  editor.style.display='';
});
window.openEditor = function(id/*, isCompleted*/){
  // otevři editor s vybraným závodem
  const sel=$('#selectRaceEdit');
  sel.value=id;
  const ev=new Event('change'); sel.dispatchEvent(ev);
  // přepni do Admin
  $$('.tablink').forEach(b=>b.classList.remove('active')); $('[data-tab="admin"]').classList.add('active');
  $$('section').forEach(s=>s.classList.remove('active')); $('#admin').classList.add('active');
};

$('#saveResults').addEventListener('click', async ()=>{
  const id=$('#selectRaceEdit').value; if(!id) return alert('Vyber závod.');
  const arr=[]; for(let i=1;i<=5;i++){ arr.push( $('#pos'+i)?.value || 'DNS' ); }
  const yt = $('#youtubeResult').value.trim() || null;
  try{
    await db.collection('zavody').doc(id).update({ vysledky: arr, results: arr, youtube: yt });
    alert('Výsledky/videa uloženy.');
    $('#resultsEditor').style.display='none'; $('#selectRaceEdit').value='';
  }catch(e){ console.error(e); alert('Chyba ukládání výsledků'); }
});
$('#cancelResults').addEventListener('click', ()=>{ $('#resultsEditor').style.display='none'; $('#selectRaceEdit').value=''; });

/* === Delete race === */
window.deleteRace = async function(id){
  if(!confirm('Smazat závod? Tuto akci nelze vrátit.')) return;
  try{ await db.collection('zavody').doc(id).delete(); }
  catch(e){ console.error(e); alert('Chyba mazání'); }
};

/* === Start === */
startRealtime();
setInterval(renderNextRace,60*1000); // jemnější odpočet
</script>
</body>
</html>
