<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GT7 Racing Championship</title>
  <style>
    /* Z√°kladn√≠ styly (zkr√°ceno) */
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f5f5f7;color:#111}
    .container{max-width:1100px;margin:40px auto;padding:20px}
    header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:24px;border-radius:12px;margin-bottom:20px}
    h1{margin:0;font-size:28px}
    .tabs{display:flex;gap:10px;margin:16px 0}
    .tab{padding:8px 14px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .tab.active{background:#667eea;color:#fff;border-color:#667eea}
    .section{background:#fff;padding:18px;border-radius:10px;margin-bottom:18px}
    .btn{background:#667eea;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.danger{background:#e55353}
    .form-group{margin-bottom:10px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:8px}
    .race-card{border-left:4px solid #667eea;padding:12px;margin-bottom:10px;background:#fafafa;border-radius:8px}
    .admin-list{display:flex;flex-direction:column;gap:8px}
    .admin-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fff;border:1px solid #eee}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèÅ GT7 Racing Championship</h1>
      <div class="small">Ofici√°ln√≠ p≈ôehled z√°vod≈Ø a v√Ωsledk≈Ø ‚Äî live s Firestore</div>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="showTab('current', event)">Aktu√°ln√≠ sez√≥na</button>
      <button class="tab" onclick="showTab('archive', event)">Archiv</button>
      <button class="tab" onclick="showTab('admin', event)">Admin</button>
    </div>

    <div id="current-tab">
      <div id="countdown-container"></div>
      <div class="section">
        <h2>Probƒõhl√© z√°vody</h2>
        <div id="past-races"></div>
      </div>
    </div>

    <div id="archive-tab" class="hidden">
      <div class="section">
        <h2>Archiv</h2>
        <div id="archive-content"></div>
      </div>
    </div>

    <div id="admin-tab" class="hidden">
      <div class="section">
        <h2>P≈ôidat / upravit z√°vod</h2>
        <form id="race-form">
          <input type="hidden" id="edit-id">
          <div class="form-group">
            <label>Datum</label>
            <input type="date" id="race-date" required>
          </div>
          <div class="form-group">
            <label>N√°zev okruhu</label>
            <input type="text" id="circuit-name" required>
          </div>
          <div class="form-group">
            <label>Povolen√° vozidla</label>
            <input type="text" id="allowed-cars" required>
          </div>
          <div class="form-group">
            <label>V√Ωrobce</label>
            <input id="manufacturer">
          </div>
          <div class="form-group">
            <label>Typ pohonu</label>
            <input id="drivetrain">
          </div>
          <div class="form-group">
            <label>Dopl≈àuj√≠c√≠ informace</label>
            <textarea id="additional-info" rows="2"></textarea>
          </div>
          <div style="display:flex;gap:10px">
            <button class="btn" type="submit">Ulo≈æit z√°vod</button>
            <button type="button" onclick="resetRaceForm()" class="btn" style="background:#999">Zru≈°it</button>
          </div>
        </form>

        <hr style="margin:12px 0">

        <h3>Seznam z√°vod≈Ø (admin)</h3>
        <div id="admin-race-list" class="admin-list"></div>
      </div>

      <div class="section">
        <h2>Zadat v√Ωsledky z√°vodu</h2>
        <form id="results-form">
          <div class="form-group">
            <label>Vyberte z√°vod</label>
            <select id="select-race" required></select>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>
              <label>1. m√≠sto - Jezdec</label>
              <select id="pos1" required>
                <option value="">Vyberte jezdce</option>
                <option>Viki</option><option>M√°ra</option><option>Maty</option><option>Hardy</option><option>Ondra</option>
              </select>
            </div>
            <div>
              <label>1. m√≠sto - Auto</label>
              <input id="pos1_car" placeholder="Znaƒçka / model">
            </div>
            <div>
              <label>1. m√≠sto - Pohon</label>
              <input id="pos1_drivetrain" placeholder="FR / MR / RR / 4WD">
            </div>

            <div>
              <label>2. m√≠sto - Jezdec</label>
              <select id="pos2" required>
                <option value="">Vyberte jezdce</option>
                <option>Viki</option><option>M√°ra</option><option>Maty</option><option>Hardy</option><option>Ondra</option>
              </select>
            </div>
            <div>
              <label>2. m√≠sto - Auto</label>
              <input id="pos2_car" placeholder="Znaƒçka / model">
            </div>
            <div>
              <label>2. m√≠sto - Pohon</label>
              <input id="pos2_drivetrain" placeholder="FR / MR / RR / 4WD">
            </div>

            <div>
              <label>3. m√≠sto - Jezdec</label>
              <select id="pos3" required>
                <option value="">Vyberte jezdce</option>
                <option>Viki</option><option>M√°ra</option><option>Maty</option><option>Hardy</option><option>Ondra</option>
              </select>
            </div>
            <div>
              <label>3. m√≠sto - Auto</label>
              <input id="pos3_car" placeholder="Znaƒçka / model">
            </div>
            <div>
              <label>3. m√≠sto - Pohon</label>
              <input id="pos3_drivetrain" placeholder="FR / MR / RR / 4WD">
            </div>
          </div>

          <div class="form-group">
            <label>YouTube URL (nepovinn√©)</label>
            <input type="url" id="youtube-url">
          </div>

          <div style="display:flex;gap:8px">
            <button class="btn" type="submit">Ulo≈æit v√Ωsledky</button>
            <button type="button" class="btn" style="background:#999" onclick="resetResultsForm()">Zru≈°it</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase SDK + konfigurace -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
      authDomain: "test-gt7.firebaseapp.com",
      projectId: "test-gt7",
      storageBucket: "test-gt7.firebasestorage.app",
      messagingSenderId: "928154989107",
      appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
      measurementId: "G-1SG8DW1KQ9"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    window._firestore = db;
    window._firestoreCollection = collection;
    window._firestoreAdd = addDoc;
    window._firestoreOnSnapshot = onSnapshot;
    window._firestoreDoc = doc;
    window._firestoreUpdate = updateDoc;
    window._firestoreDelete = deleteDoc;
  </script>

  <script>
    // --- Lok√°ln√≠ model ---
    let data = { currentSeason: { races: [] }, archive: [] };

    // --- Utility ---
    function showTab(tab, evt){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('[id$="-tab"]').forEach(t=>t.classList.add('hidden')); if (evt && evt.target) evt.target.classList.add('active'); const el = document.getElementById(tab+'-tab'); if (el) el.classList.remove('hidden'); }

    function formatDate(d){ if(!d) return '-'; const dt = new Date(d); return dt.toLocaleDateString('cs-CZ'); }

    function escapeHtml(s){ if (s===0) return '0'; if (!s) return ''; return String(s).replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // --- Naƒç√≠t√°n√≠ dat a reaktivn√≠ update ---
    function loadData(){
      const racesCol = window._firestoreCollection(window._firestore, 'races');
      window._firestoreOnSnapshot(racesCol, snapshot => {
        const races = [];
        snapshot.forEach(doc => races.push({ id: doc.id, ...doc.data() }));
        // uspo≈ô√°d√°me podle data
        races.sort((a,b)=> new Date(a.date) - new Date(b.date));
        data.currentSeason.races = races;
        renderAll();
      });
    }

    // --- Render funkce ---
    function renderAll(){ renderPastRaces(); renderAdminRaceList(); renderRaceSelect(); renderStandings(); }

    function renderStandings(){ /* jednoduch√© poƒç√≠t√°n√≠ pro uk√°zku */
      const tbody = document.getElementById('standings-body'); if(!tbody) return;
      const drivers = ['Viki','M√°ra','Maty','Hardy','Ondra'];
      const standings = drivers.map(d=>({driver:d,first:0,second:0,third:0,points:0}));
      data.currentSeason.races.forEach(r=>{ if(!r.results) return; const f = r.results.first?.driver || r.results.first; const s = r.results.second?.driver || r.results.second; const t = r.results.third?.driver || r.results.third; const a = standings.find(x=>x.driver===f); if(a){a.first++;a.points+=8} const b = standings.find(x=>x.driver===s); if(b){b.second++;b.points+=5} const c = standings.find(x=>x.driver===t); if(c){c.third++;c.points+=3} });
      tbody.innerHTML = standings.sort((a,b)=>b.points-a.points).map(s=>`<tr><td>${escapeHtml(s.driver)}</td><td>${s.first}</td><td>${s.second}</td><td>${s.third}</td><td><strong>${s.points}</strong></td></tr>`).join('');
    }

    function renderPastRaces(){ const container = document.getElementById('past-races'); if(!container) return; if(!data.currentSeason.races.length) { container.innerHTML = '<p class="small">≈Ω√°dn√© z√°vody</p>'; return; }
      container.innerHTML = data.currentSeason.races.map(r=>{
        const res = r.results ? (`<div style="margin-top:8px"><strong>V√Ωsledky:</strong><br>ü•á ${escapeHtml(r.results.first?.driver||r.results.first||'')} ${r.results.first?.car?'<span class="small">('+escapeHtml(r.results.first.car)+')</span>':''}<br>ü•à ${escapeHtml(r.results.second?.driver||r.results.second||'')} ${r.results.second?.car?'<span class="small">('+escapeHtml(r.results.second.car)+')</span>':''}<br>ü•â ${escapeHtml(r.results.third?.driver||r.results.third||'')} ${r.results.third?.car?'<span class="small">('+escapeHtml(r.results.third.car)+')</span>':''}</div>`) : '';
        return `<div class="race-card"><div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(r.circuit||'Nezn√°m√Ω')}</strong><div class="small">${formatDate(r.date)}</div></div><div><span class="small">${escapeHtml(r.manufacturer||'')}</span></div></div><div style="margin-top:8px" class="small">${escapeHtml(r.additionalInfo||'')}</div>${res}</div>`;
      }).join(''); }

    function renderAdminRaceList(){ const list = document.getElementById('admin-race-list'); if(!list) return; list.innerHTML = data.currentSeason.races.map(r=>{
        return `<div class="admin-row"><div><strong>${escapeHtml(r.circuit)}</strong> <div class="small">${formatDate(r.date)}</div></div><div style="display:flex;gap:8px"><button class="btn" onclick="editRace('${r.id}')">‚úèÔ∏è Uprav</button><button class="btn danger" onclick="deleteRace('${r.id}')">üóëÔ∏è Sma≈æ</button></div></div>`;
      }).join(''); }

    function renderRaceSelect(){ const sel = document.getElementById('select-race'); if(!sel) return; sel.innerHTML = '<option value="">Vyberte z√°vod</option>' + data.currentSeason.races.map(r=>`<option value="${r.id}">${escapeHtml(r.circuit)} - ${formatDate(r.date)}</option>`).join(''); }

    // --- Admin actions: add / edit / delete ---
    async function addRaceToFirestore(race){ await window._firestoreAdd(window._firestoreCollection(window._firestore,'races'), race); }
    async function updateRaceInFirestore(id, payload){ const ref = window._firestoreDoc(window._firestore,'races',id); await window._firestoreUpdate(ref, payload); }
    async function deleteRaceFromFirestore(id){ const ref = window._firestoreDoc(window._firestore,'races',id); await window._firestoreDelete(ref); }

    // edit form
    function editRace(id){ const race = data.currentSeason.races.find(r=>r.id===id); if(!race) return; document.getElementById('edit-id').value = id; document.getElementById('race-date').value = race.date || ''; document.getElementById('circuit-name').value = race.circuit || ''; document.getElementById('allowed-cars').value = race.cars || ''; document.getElementById('manufacturer').value = race.manufacturer || ''; document.getElementById('drivetrain').value = race.drivetrain || ''; document.getElementById('additional-info').value = race.additionalInfo || ''; window.scrollTo({top:0,behavior:'smooth'}); }
    function resetRaceForm(){ document.getElementById('edit-id').value=''; document.getElementById('race-form').reset(); }

    async function deleteRace(id){ if(!confirm('Opravdu smazat tento z√°vod?')) return; try{ await deleteRaceFromFirestore(id); }catch(e){ alert('Chyba p≈ôi maz√°n√≠: '+e.message); } }

    // results
    function resetResultsForm(){ document.getElementById('results-form').reset(); }

    async function saveResultsToFirestore(raceId, results, youtubeUrl){ const raceRef = window._firestoreDoc(window._firestore,'races',raceId); await window._firestoreUpdate(raceRef,{ results: results, youtubeUrl: youtubeUrl || null }); }

    // --- Eventy formul√°≈ô≈Ø ---
    document.addEventListener('DOMContentLoaded', ()=>{
      loadData();

      const raceForm = document.getElementById('race-form');
      raceForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const editId = document.getElementById('edit-id').value;
        const payload = {
          date: document.getElementById('race-date').value,
          circuit: document.getElementById('circuit-name').value,
          cars: document.getElementById('allowed-cars').value,
          manufacturer: document.getElementById('manufacturer').value,
          drivetrain: document.getElementById('drivetrain').value,
          additionalInfo: document.getElementById('additional-info').value
        };
        try{
          if(editId){ await updateRaceInFirestore(editId,payload); }
          else{ await addRaceToFirestore(payload); }
          resetRaceForm();
        }catch(err){ alert('Chyba p≈ôi ukl√°d√°n√≠ z√°vodu: '+err.message); }
      });

      const resultsForm = document.getElementById('results-form');
      resultsForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const raceId = document.getElementById('select-race').value; if(!raceId){ alert('Vyberte z√°vod'); return; }
        const results = {
          first: { driver: document.getElementById('pos1').value, car: document.getElementById('pos1_car').value, drivetrain: document.getElementById('pos1_drivetrain').value },
          second: { driver: document.getElementById('pos2').value, car: document.getElementById('pos2_car').value, drivetrain: document.getElementById('pos2_drivetrain').value },
          third: { driver: document.getElementById('pos3').value, car: document.getElementById('pos3_car').value, drivetrain: document.getElementById('pos3_drivetrain').value }
        };
        const youtubeUrl = document.getElementById('youtube-url').value;
        try{ await saveResultsToFirestore(raceId, results, youtubeUrl); resetResultsForm(); }catch(err){ alert('Chyba p≈ôi ukl√°d√°n√≠ v√Ωsledk≈Ø: '+err.message); }
      });
    });
  </script>
</body>
</html>
