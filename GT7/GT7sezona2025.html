<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GT7 ≈†ampion√°t 2025</title>
  <link rel="stylesheet" href="./GT7style.css">
  <!-- Chart.js jako glob√°ln√≠ script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üèÅ GT7 ≈†ampion√°t 2025</h1>
      <p class="subtitle">Ofici√°ln√≠ p≈ôehled z√°vod≈Ø, v√Ωsledk≈Ø a statistik jezdc≈Ø</p>
    </header>

    <!-- N√°sleduj√≠c√≠ z√°vod -->
    <section id="next-race" class="next-race-section">
      <h2>‚è±Ô∏è Nadch√°zej√≠c√≠ z√°vod</h2>
      <div id="next-race-content">Naƒç√≠t√°m informace...</div>
      <div id="countdown" class="countdown"></div>
    </section>

    <!-- Graf v√Ωvoje bod≈Ø -->
    <section id="points-progress" class="section">
      <h2>üìä V√Ωvoj bod≈Ø v sez√≥nƒõ</h2>
      <canvas id="points-chart"></canvas>
    </section>

    <!-- Statistiky -->
    <section id="stats" class="section">
      <h2>üìà Statistiky jezdc≈Ø a t√Ωm≈Ø</h2>
      <div id="stats-container"></div>
    </section>

    <!-- Hall of Fame -->
    <section id="hall" class="section">
      <h2>üèÜ Hall of Fame</h2>
      <div id="hall-of-fame"></div>
      <canvas id="hall-bar-chart"></canvas>
      <div id="fun-facts"></div>
    </section>

    <!-- Archiv -->
    <section id="archive" class="section">
      <h2>üìö Archiv z√°vod≈Ø</h2>
      <div id="archive-content"></div>
    </section>

    <!-- Admin sekce -->
    <section id="admin" class="section">
      <h2>üîê Admin sekce</h2>
      <div class="auth">
        <button id="btn-signin" class="btn">P≈ôihl√°sit se (admin)</button>
        <button id="btn-signout" class="btn hidden">Odhl√°sit se</button>
        <span id="user-email" class="small"></span>
      </div>

      <div id="not-admin" class="small">Pouze p≈ôihl√°≈°en√Ω admin m≈Ø≈æe p≈ôid√°vat nebo upravovat z√°vody.</div>

      <div id="admin-forms" class="hidden">
        <div class="section-inner">
          <h3>P≈ôidat / upravit z√°vod</h3>
          <form id="race-form">
            <input type="hidden" id="edit-id">

            <label>Datum a ƒças: <input type="datetime-local" id="race-date" required></label>
            <label>Okruh: <input type="text" id="circuit-name" required></label>
            <label>Povolen√° auta: <input type="text" id="allowed-cars"></label>
            <label>PP limit: <input type="number" id="pp-limit" min="100" max="999"></label>

            <label>Rovnov√°ha v√Ωkonu (BoP):
              <select id="bop">
                <option value="on">Zapnuto</option>
                <option value="off" selected>Vypnuto</option>
              </select>
            </label>

            <label>Povolen√Ω tuning:
              <select id="tuning">
                <option value="yes" selected>Povolen</option>
                <option value="no">Zak√°z√°n</option>
              </select>
            </label>

            <label>Kategorie pneumatik:
              <select id="tyre-category">
                <option>Komfortn√≠</option>
                <option selected>Sportovn√≠</option>
                <option>Z√°vodn√≠</option>
              </select>
            </label>

            <label>Povinn√° smƒõs:
              <select id="tyre-compound">
                <option>Bez povinn√© smƒõsi</option>
                <option>Mƒõkk√°</option>
                <option>St≈ôedn√≠</option>
                <option>Tvrd√°</option>
              </select>
            </label>

            <label>Poƒçet kol: <input type="number" id="laps" min="1" max="200"></label>
            <label>Spot≈ôeba paliva (x): <input type="number" id="fuel" min="1" max="10" value="1"></label>
            <label>Opot≈ôeben√≠ pneumatik (x): <input type="number" id="wear" min="1" max="10" value="1"></label>
            <label>Rychlost tankov√°n√≠ (l/s): <input type="number" id="pit" min="1" max="10" value="5"></label>

            <button type="submit" class="btn">üíæ Ulo≈æit z√°vod</button>
            <button type="reset" class="btn gray">Reset</button>
          </form>
        </div>

        <div class="section-inner">
          <h3>Zadat v√Ωsledky z√°vodu</h3>
          <form id="results-form">
            <label>Vyberte z√°vod:
              <select id="select-race"></select>
            </label>
            <div id="positions-container"></div>
            <label>Odkaz na YouTube:
              <input type="url" id="youtube-url" placeholder="https://www.youtube.com/watch?v=...">
            </label>
            <button type="submit" class="btn">üíæ Ulo≈æit v√Ωsledky</button>
          </form>
        </div>
      </div>
    </section>

    <!-- V√Ωsledky -->
    <section id="past" class="section">
      <h2>üìÖ V√Ωsledky z√°vod≈Ø</h2>
      <div id="past-races"></div>
    </section>
  </div>

  <!-- JS modul -->
  <script type="module">
    // Import Firebase moduly
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, 
      deleteDoc, getDoc, setDoc, getDocs 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { 
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Chart.js je dostupn√Ω glob√°lnƒõ z CDN
    const ChartJS = window.Chart;

    // Firebase konfigurace
    const firebaseConfig = {
      apiKey: "AIzaSyCkR-AyJK2vFnz0V2HTuz2b3zCaLMxbXtI",
      authDomain: "test-gt7.firebaseapp.com",
      projectId: "test-gt7",
      storageBucket: "test-gt7.firebasestorage.app",
      messagingSenderId: "928154989107",
      appId: "1:928154989107:web:20a34d0009fa75bd1ee946",
      measurementId: "G-1SG8DW1KQ9"
    };

    // Inicializace Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "viktor.tamayo@gmail.com";

    let allRaces = [];
    const maxPositions = 5;

    // Helpery
    function escapeHtml(str){ return str ? str.replace(/[&<>"']/g, m=>({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m])) : ""; }
    function formatDate(dateStr){ return new Date(dateStr).toLocaleDateString('cs-CZ', { day:'2-digit', month:'2-digit', year:'numeric' }); }

    // Naƒç√≠t√°n√≠ dat
    function loadData(){
      onSnapshot(collection(db,'races'),(snapshot)=>{
        allRaces = snapshot.docs.map(d=>({id:d.id,...d.data()}));
        allRaces.sort((a,b)=> new Date(b.date)-new Date(a.date));
        renderAll();
      });
    }

    // V√Ωpoƒçet leaderboardu
    function calculateLeaderboard(races){
      const pointsMap = {1:10,2:8,3:6,4:4,5:2};
      const drivers = {};
      races.forEach(r=>{
        if(!r.results) return;
        for(let i=1;i<=maxPositions;i++){
          const pos = r.results[`pos${i}`];
          if(pos && pos.driver){
            const d = pos.driver;
            if(!drivers[d]) drivers[d]={driver:d,points:0,wins:0,podiums:0,starts:0};
            drivers[d].points += pointsMap[i]||0;
            drivers[d].starts++;
            if(i===1) drivers[d].wins++;
            if(i<=3) drivers[d].podiums++;
          }
        }
      });
      return Object.values(drivers).sort((a,b)=>b.points-a.points);
    }

    // Zobrazen√≠ nejbli≈æ≈°√≠ho z√°vodu
    function renderNextRace(){
      const nextEl = document.getElementById('next-race-content');
      if(!nextEl) return;
      const upcoming = allRaces.filter(r=> new Date(r.date) > new Date()).sort((a,b)=> new Date(a.date)-new Date(b.date))[0];
      if(!upcoming){ nextEl.innerHTML = '<p>≈Ω√°dn√Ω nadch√°zej√≠c√≠ z√°vod</p>'; return; }

      nextEl.innerHTML = `
        <h3>${escapeHtml(upcoming.circuit)}</h3>
        <p><strong>Datum:</strong> ${formatDate(upcoming.date)}</p>
        <p><strong>Povolen√° auta:</strong> ${escapeHtml(upcoming.allowedCars || '-')}</p>
        <p><strong>PP limit:</strong> ${upcoming.ppLimit || '-'}</p>
        <p><strong>BoP:</strong> ${escapeHtml(upcoming.bop || '-')}, <strong>Tuning:</strong> ${escapeHtml(upcoming.tuning || '-')}</p>
        <p><strong>Pneumatiky:</strong> ${escapeHtml(upcoming.tireCat || '-')} (${escapeHtml(upcoming.tireComp || '-')})</p>
        <p><strong>Kol:</strong> ${upcoming.laps || '-'}, <strong>Palivo x:</strong> ${upcoming.fuel || '-'}, <strong>Opot≈ôeben√≠ x:</strong> ${upcoming.wear || '-'}</p>
        <p><strong>Tankov√°n√≠:</strong> ${upcoming.refuel || '-'} l/s</p>
      `;
      startCountdown(upcoming.date);
    }

    // Odpoƒçet
    function startCountdown(targetDate){
      const cd = document.getElementById('countdown');
      if(!cd) return;
      const target = new Date(targetDate).getTime();
      clearInterval(window._cdInterval);
      window._cdInterval = setInterval(()=>{
        const now = new Date().getTime();
        const diff = target - now;
        if(diff <= 0){ cd.innerHTML = "üèÅ Z√°vod pr√°vƒõ prob√≠h√° nebo skonƒçil!"; clearInterval(window._cdInterval); return; }
        const d = Math.floor(diff/(1000*60*60*24));
        const h = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
        const m = Math.floor((diff%(1000*60*60))/(1000*60));
        const s = Math.floor((diff%(1000*60))/1000);
        cd.innerHTML = `Start za: ${d}d ${h}h ${m}m ${s}s`;
      },1000);
    }

    // Zobrazen√≠ minul√Ωch z√°vod≈Ø
    function renderPastRaces(){
      const container = document.getElementById('past-races');
      if(!container) return;
      const past = allRaces.filter(r=> new Date(r.date) <= new Date());
      if(!past.length){ container.innerHTML='<p>≈Ω√°dn√© v√Ωsledky</p>'; return; }
      container.innerHTML = past.map(r=>{
        const resultsHtml = r.results
          ? `<div class="small"><strong>V√Ωsledky:</strong><br>
             ü•á ${escapeHtml(r.results.pos1?.driver||'-')}<br>
             ü•à ${escapeHtml(r.results.pos2?.driver||'-')}<br>
             ü•â ${escapeHtml(r.results.pos3?.driver||'-')}</div>`
          : '<div class="small">≈Ω√°dn√© v√Ωsledky</div>';
        const videoHtml = r.youtubeUrl
          ? `<iframe class="youtube-preview" src="${r.youtubeUrl.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/')}" allowfullscreen></iframe>`
          : '';
        return `<div class="section"><strong>${escapeHtml(r.circuit)}</strong> ‚Äî ${formatDate(r.date)}<br>${resultsHtml}${videoHtml}</div>`;
      }).join('');
    }

    // Render v≈°ech ƒç√°st√≠
    function renderAll(){
      renderNextRace();
      const lb = calculateLeaderboard(allRaces);
      renderLeaderboard(lb);
      renderPastRaces();
      renderArchive();
      renderHall();
    }

    // Leaderboard tabulka
    function renderLeaderboard(leaderboard){
      const container = document.getElementById('stats-container');
      if(!container) return;
      if(!leaderboard.length){ container.innerHTML = '<p>≈Ω√°dn√≠ jezdci</p>'; return; }
      let html = `<table class="leaderboard-table"><thead><tr><th>#</th><th>Jezdec</th><th>Body</th><th>V√Ωhry</th><th>P√≥dia</th><th>Starty</th></tr></thead><tbody>`;
      leaderboard.forEach((d,i)=>{
        html+=`<tr><td>${i+1}</td><td>${escapeHtml(d.driver)}</td><td>${d.points}</td><td>${d.wins}</td><td>${d.podiums}</td><td>${d.starts}</td></tr>`;
      });
      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    // Archiv
    function renderArchive(){
      const container = document.getElementById('archive-content');
      if(!container) return;
      if(!allRaces.length){ container.innerHTML='<p>Archiv je pr√°zdn√Ω</p>'; return; }
      const byYear = {};
      allRaces.forEach(r=>{
        const y = new Date(r.date).getFullYear();
        if(!byYear[y]) byYear[y]=[];
        byYear[y].push(r);
      });
      const years = Object.keys(byYear).sort((a,b)=>b-a);
      container.innerHTML = years.map(y=>{
        const items = byYear[y].map(r=>`<div class="archive-item"><strong>${escapeHtml(r.circuit)}</strong> ‚Äî ${formatDate(r.date)}<br>ü•á ${escapeHtml(r.results?.pos1?.driver||'-')} | ü•à ${escapeHtml(r.results?.pos2?.driver||'-')} | ü•â ${escapeHtml(r.results?.pos3?.driver||'-')}</div>`).join('');
        return `<h3>Sez√≥na ${y}</h3>${items}`;
      }).join('');
    }

    // Hall of Fame
    function renderHall(){
      const hallEl = document.getElementById('hall-of-fame');
      const funEl = document.getElementById('fun-facts');
      if(!hallEl) return;
      const stats = calculateLeaderboard(allRaces);
      const top5 = stats.slice(0,5);
      hallEl.innerHTML = `<ol>${top5.map(p=>`<li>${escapeHtml(p.driver)} ‚Äî ${p.points} b (${p.wins} v√≠tƒõzstv√≠)</li>`).join('')}</ol>`;
      
      const ctx = document.getElementById('hall-bar-chart');
      if(ctx && ChartJS){
        new ChartJS(ctx,{
          type:'bar',
          data:{
            labels:top5.map(p=>p.driver),
            datasets:[{label:'Body',data:top5.map(p=>p.points)}]
          },
          options:{responsive:true}
        });
      }
      
      const brandWins = {};
      const streaks={};
      let current={driver:null,count:0};
      allRaces.slice().reverse().forEach(r=>{
        if(!r.results?.pos1?.driver) return;
        const w = r.results.pos1.driver;
        brandWins[r.results.pos1.manufacturer||'Nezn√°m√©']=(brandWins[r.results.pos1.manufacturer||'Nezn√°m√©']||0)+1;
        if(current.driver===w) current.count++; 
        else { 
          if(current.driver) streaks[current.driver]=Math.max(streaks[current.driver]||0,current.count); 
          current={driver:w,count:1}; 
        }
      });
      if(current.driver) streaks[current.driver]=Math.max(streaks[current.driver]||0,current.count);
      const bestBrand=Object.entries(brandWins).sort((a,b)=>b[1]-a[1])[0]||['-','0'];
      const bestStreak=Object.entries(streaks).sort((a,b)=>b[1]-a[1])[0]||['-',0];
      if(funEl){
        funEl.innerHTML=`<div>üèÅ Nej√∫spƒõ≈°nƒõj≈°√≠ znaƒçka: <strong>${escapeHtml(bestBrand[0])}</strong> (${bestBrand[1]} v√≠tƒõzstv√≠)</div>
        <div>üî• Nejdel≈°√≠ s√©rie v√Ωher: <strong>${escapeHtml(bestStreak[0])}</strong> (${bestStreak[1]} v ≈ôadƒõ)</div>`;
      }
    }

    // Admin formul√°≈ô
    const raceForm=document.getElementById('race-form');
    if(raceForm){
      raceForm.addEventListener('submit',async e=>{
        e.preventDefault();
        const id=document.getElementById('edit-id').value;
        const payload={
          date:document.getElementById('race-date').value,
          circuit:document.getElementById('circuit-name').value,
          allowedCars:document.getElementById('allowed-cars').value,
          ppLimit:document.getElementById('pp-limit').value,
          bop:document.getElementById('bop').value,
          tuning:document.getElementById('tuning').value,
          tireCat:document.getElementById('tyre-category').value,
          tireComp:document.getElementById('tyre-compound').value,
          laps:Number(document.getElementById('laps').value||0),
          fuel:Number(document.getElementById('fuel').value||1),
          wear:Number(document.getElementById('wear').value||1),
          refuel:Number(document.getElementById('pit').value||0)
        };
        try{
          if(id) await updateDoc(doc(db,'races',id),payload);
          else await addDoc(collection(db,'races'),payload);
          alert('Z√°vod ulo≈æen');
          raceForm.reset();
        }catch(e){alert('Chyba p≈ôi ukl√°d√°n√≠: '+e.message);}
      });
    }

    loadData();
    console.log("‚úÖ GT7script.js naƒçteno a bƒõ≈æ√≠ spr√°vnƒõ.");
  </script>
</body>
</html>
